{% load static %}

<style>
    @keyframes slide-in-right {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    .animate-slide-in-right {
        animation: slide-in-right 0.3s ease-out forwards;
    }
</style>

<script>
    // Helper for XSS prevention (Global Scope - Defined once for all blocks)
    window.escapeHtml = function(text) {
      if (!text) return text;
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };
</script>

    <!-- Campos dinámicos según capacidades del modelo -->

{# Contenedor para botones de configuración horizontal #}
{% if supports.duration or supports.aspect_ratio or supports.resolution or supports.audio or supports.container_color or supports.text_color or supports.font_family %}
<div class="mb-4">
    <div class="flex flex-wrap gap-1.5">
        {# Duración #}
        {% if supports.duration %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" @click.away="open = false"
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <svg class="w-3 h-3 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-gray-700 font-medium" id="duration-display">
                    {% if supports.duration.fixed %}
                        {{ supports.duration.fixed }}s
                    {% elif supports.duration.options %}
                        {{ supports.duration.options.0 }}"
                    {% elif supports.duration.min and supports.duration.max %}
                        {{ supports.duration.min }}-{{ supports.duration.max }}"
                    {% endif %}
                </span>
            </button>
            <div x-show="open" x-cloak
                 class="absolute z-50 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[200px] py-1 max-h-64 overflow-y-auto">
                {% if supports.duration.fixed %}
                    <div class="px-4 py-2 text-sm text-gray-500">
                        Duración fija: {{ supports.duration.fixed }}s
                    </div>
                {% elif supports.duration.options %}
                    {% for opt in supports.duration.options %}
                    <button type="button" @click="document.getElementById('duration-input').value = '{{ opt }}'; document.getElementById('duration-display').textContent = '{{ opt }}s'; open = false;"
                            class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center justify-between">
                        <span>{{ opt }}s</span>
                        <span class="text-xs text-gray-500">{% if opt <= 6 %}Short{% else %}Long{% endif %}</span>
                    </button>
                    {% endfor %}
                {% endif %}
            </div>
            {% if supports.duration.fixed %}
                <input type="hidden" name="duration" value="{{ supports.duration.fixed }}">
            {% else %}
                <input type="hidden" name="duration" id="duration-input" value="{% if supports.duration.options %}{{ supports.duration.options.0 }}{% elif supports.duration.min %}{{ supports.duration.min }}{% endif %}">
            {% endif %}
        </div>
        {% endif %}

        {# Aspect Ratio - Ocultar si solo hay una opción (como Manim) #}
        {% if supports.aspect_ratio and supports.aspect_ratio|length > 1 %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" @click.away="open = false"
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <svg class="w-3 h-3 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                </svg>
                <span class="text-gray-700 font-medium" id="aspect-display">
                    {% for ar in supports.aspect_ratio %}
                        {% if forloop.first %}{{ ar }}{% endif %}
                    {% endfor %}
                </span>
            </button>
            <div x-show="open" x-cloak
                 class="absolute z-50 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[200px] py-1">
                {% for ar in supports.aspect_ratio %}
                <button type="button" @click="document.getElementById('aspect-input').value = '{{ ar }}'; document.getElementById('aspect-display').textContent = '{{ ar }}'; open = false;"
                        class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center gap-3">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {% if ar == "1:1" %}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5z"></path>
                        {% elif ar == "16:9" or ar == "4:3" or ar == "3:2" or ar == "5:4" %}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5z"></path>
                        {% else %}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v14a1 1 0 01-1 1H5a1 1 0 01-1-1V5z"></path>
                        {% endif %}
                    </svg>
                    <span>{{ ar }}{% if ar == "1:1" %} Square{% elif ar == "16:9" %} Widescreen{% elif ar == "4:3" %} Classic{% elif ar == "9:16" %} Social story{% endif %}</span>
                </button>
                {% endfor %}
            </div>
            <input type="hidden" name="aspect_ratio" id="aspect-input" value="{% for ar in supports.aspect_ratio %}{% if forloop.first %}{{ ar }}{% endif %}{% endfor %}">
        </div>
        {% elif supports.aspect_ratio and supports.aspect_ratio|length == 1 %}
        {# Si solo hay una opción, ocultar el campo pero mantener el valor #}
        <input type="hidden" name="aspect_ratio" value="{% for ar in supports.aspect_ratio %}{{ ar }}{% endfor %}">
        {% endif %}

        {# Resolución #}
        {% if supports.resolution and supports.resolution != False %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" @click.away="open = false"
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <svg class="w-3 h-3 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                <span class="text-gray-700 font-medium" id="resolution-display">
                    {% for res in supports.resolution %}
                        {% if forloop.first %}{{ res|upper }}{% endif %}
                    {% endfor %}
                </span>
            </button>
            <div x-show="open" x-cloak
                 class="absolute z-50 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[150px] py-1">
                {% for res in supports.resolution %}
                <button type="button" @click="document.getElementById('resolution-input').value = '{{ res }}'; document.getElementById('resolution-display').textContent = '{{ res|upper }}'; open = false;"
                        class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                    {{ res|upper }}
                </button>
                {% endfor %}
            </div>
            <input type="hidden" name="resolution" id="resolution-input" value="{% for res in supports.resolution %}{% if forloop.first %}{{ res }}{% endif %}{% endfor %}">
        </div>
        {% endif %}

        {# Audio #}
        {% if supports.audio %}
        <div class="flex-shrink-0" x-data="{ audioOn: false }">
            <button type="button" @click="audioOn = !audioOn; document.getElementById('audio-input').value = audioOn ? 'true' : '';"
                    :class="audioOn ? 'bg-gray-100 border-gray-300' : 'bg-gray-50 border-gray-200'"
                    class="flex items-center gap-1 px-1.5 py-1.5 border rounded-lg hover:bg-gray-200 transition-colors text-xs">
                <svg class="w-3 h-3 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                </svg>
                <span class="text-gray-700 font-medium" x-text="audioOn ? 'ON' : 'OFF'"></span>
            </button>
            <input type="hidden" name="generate_audio" id="audio-input" value="">
        </div>
        {% endif %}

        {# Calidad #}
        {% if supports.quality %}
        {% with default_q=supports.quality.0 %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" @click.away="open = false"
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <svg class="w-3 h-3 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10"></path>
                </svg>
                <span class="text-gray-700 font-medium" id="quality-display">
                    {% if default_q == 'l' %}Baja
                    {% elif default_q == 'm' %}Media
                    {% elif default_q == 'h' %}Alta
                    {% elif default_q == 'k' %}4K
                    {% else %}{{ default_q|upper }}
                    {% endif %}
                </span>
            </button>
            <div x-show="open" x-cloak
                 class="absolute z-50 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[150px] py-1">
                {% for q in supports.quality %}
                <button type="button" @click="document.getElementById('quality-input').value = '{{ q }}'; document.getElementById('quality-display').textContent = '{% if q == 'l' %}Baja{% elif q == 'm' %}Media{% elif q == 'h' %}Alta{% elif q == 'k' %}4K{% else %}{{ q|upper }}{% endif %}'; open = false;"
                        class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                    {% if q == 'l' %}Baja (480p)
                    {% elif q == 'm' %}Media (720p)
                    {% elif q == 'h' %}Alta (1080p)
                    {% elif q == 'k' %}4K (2160p)
                    {% else %}{{ q|upper }}
                    {% endif %}
                </button>
                {% endfor %}
            </div>
            <input type="hidden" name="quality" id="quality-input" value="{{ default_q }}">
        </div>
        {% endwith %}
        {% endif %}

        {# Color del Contenedor (para Manim Quote) #}
        {% if supports.container_color %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" 
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <svg class="w-3.5 h-3.5 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1v-2z"></path>
                </svg>
                <div class="w-3.5 h-3.5 rounded border border-gray-400 flex-shrink-0" id="container-color-preview" style="background-color: #0066CC;"></div>
            </button>
            <div x-show="open" 
                 x-cloak
                 @click.away="open = false"
                 x-transition
                 class="absolute z-[100] mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[250px] p-3">
                <div class="space-y-3" @click.stop>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-2">Color del Contenedor</label>
                        <div class="flex items-center gap-2">
                            <input type="color" name="container_color" id="container-color-picker" value="#0066CC"
                                   class="h-10 w-16 border border-gray-300 rounded cursor-pointer"
                                   onchange="document.getElementById('container-color-text').value = this.value; document.getElementById('container-color-preview').style.backgroundColor = this.value; if (typeof renderLivePreview === 'function') renderLivePreview();">
                            <input type="text" name="container_color_text" id="container-color-text" value="#0066CC" pattern="^#[0-9A-Fa-f]{6}$"
                                   placeholder="#0066CC"
                                   class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   oninput="const picker = document.getElementById('container-color-picker'); const preview = document.getElementById('container-color-preview'); if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) { picker.value = this.value; preview.style.backgroundColor = this.value; if (typeof renderLivePreview === 'function') renderLivePreview(); }">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Color del Texto (para Manim Quote) #}
        {% if supports.text_color %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" 
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <span class="text-gray-700 font-bold text-sm flex-shrink-0">A</span>
                <div class="w-3.5 h-3.5 rounded border border-gray-400 flex-shrink-0" id="text-color-preview" style="background-color: #FFFFFF;"></div>
            </button>
            <div x-show="open" 
                 x-cloak
                 @click.away="open = false"
                 x-transition
                 class="absolute z-[100] mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[250px] p-3">
                <div class="space-y-3" @click.stop>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-2">Color del Texto</label>
                        <div class="flex items-center gap-2">
                            <input type="color" name="text_color" id="text-color-picker" value="#FFFFFF"
                                   class="h-10 w-16 border border-gray-300 rounded cursor-pointer"
                                   onchange="document.getElementById('text-color-text').value = this.value; document.getElementById('text-color-preview').style.backgroundColor = this.value; if (typeof renderLivePreview === 'function') renderLivePreview();">
                            <input type="text" name="text_color_text" id="text-color-text" value="#FFFFFF" pattern="^#[0-9A-Fa-f]{6}$"
                                   placeholder="#FFFFFF"
                                   class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   oninput="const picker = document.getElementById('text-color-picker'); const preview = document.getElementById('text-color-preview'); if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) { picker.value = this.value; preview.style.backgroundColor = this.value; if (typeof renderLivePreview === 'function') renderLivePreview(); }">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Tipo de Fuente (para Manim Quote) #}
        {% if supports.font_family %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" @click.away="open = false"
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <svg class="w-3 h-3 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
                </svg>
                <span class="text-gray-700 font-medium" id="font-family-display">Normal</span>
            </button>
            <div x-show="open" x-cloak
                 class="absolute z-50 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[180px] py-1">
                {% for font in supports.font_family %}
                <button type="button" @click="document.getElementById('font-family-input').value = '{{ font }}'; document.getElementById('font-family-display').textContent = '{% if font == 'normal' %}Normal{% elif font == 'bold' %}Negrita{% elif font == 'italic' %}Cursiva{% elif font == 'bold_italic' %}Negrita y Cursiva{% else %}{{ font|title }}{% endif %}'; open = false;"
                        class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                    {% if font == 'normal' %}Normal
                    {% elif font == 'bold' %}Negrita
                    {% elif font == 'italic' %}Cursiva
                    {% elif font == 'bold_italic' %}Negrita y Cursiva
                    {% else %}{{ font|title }}
                    {% endif %}
                </button>
                {% endfor %}
            </div>
            <input type="hidden" name="font_family" id="font-family-input" value="normal">
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{# Imágenes de Referencia - Diseño mejorado con tarjetas #}
{% if has_references %}
<div class="mb-4">
    <label class="block text-xs font-semibold text-gray-700 uppercase mb-3">REFERENCIAS</label>
    <div class="grid grid-cols-2 gap-2" id="reference-images-container">
        {% if supports.references.start_image == True or supports.references.start_image %}
        <label class="relative group cursor-pointer">
            <input type="file" name="start_image" accept="image/*" class="hidden" onchange="updateImagePreview(this, 'start-preview')">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 transition-colors group-hover:bg-gray-50 h-24 flex items-center justify-center">
                <div class="flex flex-col items-center justify-center text-center relative w-full h-full">
                    <div class="absolute top-2 left-2 flex items-center gap-1">
                        <svg class="w-5 h-5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="2" width="10" height="10" rx="0.5" fill="none"/>
                            <rect x="6" y="6" width="10" height="10" rx="0.5" fill="none"/>
                            <path d="M9.5 7.5l3 2.5-3 2.5V7.5z" fill="currentColor"/>
                        </svg>
                        <div class="relative group/info">
                            <button type="button" class="text-gray-400 hover:text-gray-600 focus:outline-none" onclick="event.preventDefault();">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-48 p-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 invisible group-hover/info:opacity-100 group-hover/info:visible transition-all duration-200 pointer-events-none z-10">
                                <p class="text-center">Para HeyGen Avatar IV, sube aquí la imagen del avatar que quieres usar.</p>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                    <div class="border-4 border-transparent border-t-gray-800"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <span class="text-xs font-medium text-gray-900 mt-auto">Start image</span>
                    <img id="start-preview" class="hidden absolute inset-0 w-full h-full object-cover rounded" alt="Preview">
                </div>
            </div>
        </label>
        {% endif %}
        
        {% if supports.references.end_image == True or supports.references.end_image %}
        <label class="relative group cursor-pointer">
            <input type="file" name="end_image" accept="image/*" class="hidden" onchange="updateImagePreview(this, 'end-preview')">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 transition-colors group-hover:bg-gray-50 h-24 flex items-center justify-center">
                <div class="flex flex-col items-center justify-center text-center relative w-full h-full">
                    <div class="absolute top-2 left-2">
                        <svg class="w-5 h-5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="2" width="10" height="10" rx="0.5" fill="none"/>
                            <rect x="6" y="6" width="10" height="10" rx="0.5" fill="none"/>
                            <path d="M9.5 7.5l3 2.5-3 2.5V7.5z" fill="currentColor"/>
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-gray-900 mt-auto">End image</span>
                    <img id="end-preview" class="hidden absolute inset-0 w-full h-full object-cover rounded" alt="Preview">
                </div>
            </div>
        </label>
        {% endif %}
        
        {% if supports.references.style_image == True or supports.references.style_image %}
        <label class="relative group cursor-pointer ref-style-field" data-ref-type="style" id="style-field">
            <input type="file" name="style_image" accept="image/*" class="hidden reference-image-input" data-type="style" onchange="updateImagePreview(this, 'style-preview'); toggleReferenceFields('{{ model_id }}');">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 transition-colors group-hover:bg-gray-50 h-24 flex items-center justify-center">
                <div class="flex flex-col items-center justify-center text-center relative w-full h-full">
                    <div class="absolute top-2 left-2">
                        <svg class="w-5 h-5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.648 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42"/>
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-gray-900 mt-auto">Style</span>
                    <img id="style-preview" class="hidden absolute inset-0 w-full h-full object-cover rounded" alt="Preview">
                </div>
            </div>
        </label>
        {% endif %}
        
        {% if supports.references.asset_image == True or supports.references.asset_image %}
        {# Asset 1 - Siempre visible #}
        <label class="relative group cursor-pointer ref-asset-field" data-ref-type="asset" id="asset-field-1">
            <input type="file" name="asset_image_1" accept="image/*" class="hidden reference-image-input" data-type="asset" onchange="updateImagePreview(this, 'asset-preview-1'); toggleReferenceFields('{{ model_id }}');">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 transition-colors group-hover:bg-gray-50 h-24 flex items-center justify-center">
                <div class="flex flex-col items-center justify-center text-center relative w-full h-full">
                    <div class="absolute top-2 left-2">
                        <svg class="w-5 h-5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M16.5 8.25V6a2.25 2.25 0 00-2.25-2.25H6A2.25 2.25 0 003.75 6v8.25A2.25 2.25 0 006 16.5h2.25m8.25-8.25h2.25A2.25 2.25 0 0121 10.5v8.25a2.25 2.25 0 01-2.25 2.25H16.5m-9-8.25h8.25m0 0V12m0-3.75v3.75m0 0v3.75m0-3.75h8.25"/>
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-gray-900 mt-auto">Asset</span>
                    <img id="asset-preview-1" class="hidden absolute inset-0 w-full h-full object-cover rounded" alt="Preview">
                </div>
            </div>
        </label>
        
        {# Asset 2 - Oculto inicialmente #}
        <label class="relative group cursor-pointer ref-asset-field hidden" data-ref-type="asset" id="asset-field-2">
            <input type="file" name="asset_image_2" accept="image/*" class="hidden reference-image-input" data-type="asset" onchange="updateImagePreview(this, 'asset-preview-2'); toggleReferenceFields('{{ model_id }}');">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 transition-colors group-hover:bg-gray-50 h-24 flex items-center justify-center">
                <div class="flex flex-col items-center justify-center text-center relative w-full h-full">
                    <div class="absolute top-2 left-2">
                        <svg class="w-5 h-5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M16.5 8.25V6a2.25 2.25 0 00-2.25-2.25H6A2.25 2.25 0 003.75 6v8.25A2.25 2.25 0 006 16.5h2.25m8.25-8.25h2.25A2.25 2.25 0 0121 10.5v8.25a2.25 2.25 0 01-2.25 2.25H16.5m-9-8.25h8.25m0 0V12m0-3.75v3.75m0 0v3.75m0-3.75h8.25"/>
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-gray-900 mt-auto">Asset</span>
                    <img id="asset-preview-2" class="hidden absolute inset-0 w-full h-full object-cover rounded" alt="Preview">
                </div>
            </div>
        </label>
        
        {# Asset 3 - Oculto inicialmente #}
        <label class="relative group cursor-pointer ref-asset-field hidden" data-ref-type="asset" id="asset-field-3">
            <input type="file" name="asset_image_3" accept="image/*" class="hidden reference-image-input" data-type="asset" onchange="updateImagePreview(this, 'asset-preview-3'); toggleReferenceFields('{{ model_id }}');">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 transition-colors group-hover:bg-gray-50 h-24 flex items-center justify-center">
                <div class="flex flex-col items-center justify-center text-center relative w-full h-full">
                    <div class="absolute top-2 left-2">
                        <svg class="w-5 h-5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M16.5 8.25V6a2.25 2.25 0 00-2.25-2.25H6A2.25 2.25 0 003.75 6v8.25A2.25 2.25 0 006 16.5h2.25m8.25-8.25h2.25A2.25 2.25 0 0121 10.5v8.25a2.25 2.25 0 01-2.25 2.25H16.5m-9-8.25h8.25m0 0V12m0-3.75v3.75m0 0v3.75m0-3.75h8.25"/>
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-gray-900 mt-auto">Asset</span>
                    <img id="asset-preview-3" class="hidden absolute inset-0 w-full h-full object-cover rounded" alt="Preview">
                </div>
            </div>
        </label>
        
        {# Botón para añadir más assets #}
        {% if model_id == 'veo-2.0-generate-exp' or 'veo-3.1' in model_id %}
        <button type="button" id="add-asset-btn" class="hidden border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 hover:bg-gray-50 transition-colors h-24 flex items-center justify-center text-xs text-gray-600" onclick="addAssetField()">
            <div class="flex flex-col items-center gap-1">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>Añadir Asset</span>
            </div>
        </button>
        {% endif %}
        {% endif %}
    </div>
</div>
{% endif %}

{# Negative Prompt - Opcional, solo si el modelo lo permite #}
{% if supports.negative_prompt %}
<div class="mb-4">
    <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">PROMPT NEGATIVO <span class="text-gray-400 font-normal">(Opcional)</span></label>
    <textarea name="negative_prompt" rows="3"
              placeholder="Elementos a evitar en el video..."
              class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-black resize-none transition-all"></textarea>
</div>
{% endif %}

{# Seed #}
{% if supports.seed %}
<div class="mb-4">
    <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">SEED</label>
    <input type="number" name="seed" min="0" max="4294967295"
           placeholder="Opcional: número para reproducibilidad"
           class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-black transition-all">
</div>
{% endif %}

{# Modo (para Kling) #}
{% if supports.modes %}
<div class="mb-4">
    <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">MODO</label>
    <select name="mode"
            class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-black transition-all">
        {% for mode in supports.modes %}
            <option value="{{ mode }}" {% if forloop.first %}selected{% endif %}>{{ mode|upper }}</option>
        {% endfor %}
    </select>
</div>
{% endif %}

{# Campos específicos para gráficos de barras #}
{% if manim_animation_type|default:'quote' == 'bar_chart' or manim_animation_type == 'modern_bar_chart' %}
<div class="space-y-4">
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
        <h4 class="text-sm font-medium text-gray-900 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            Configuración del Gráfico
        </h4>

        <!-- Real-Time Live Preview -->
        <div class="mt-4 mb-6 relative">
            <div id="live-chart-preview" class="aspect-[16/9] w-full bg-white rounded-2xl overflow-hidden flex items-center justify-center shadow-lg border border-gray-100">
                <!-- SVG será inyectado aquí -->
                <p class="text-[10px] text-gray-300 font-medium">Cargando visualización...</p>
            </div>
            
            <!-- Botón para expandir -->
            <button type="button" 
                    @click="window.dispatchEvent(new CustomEvent('toggle-live-preview', { detail: { open: true } }))"
                    class="w-full mt-3 py-2 px-3 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded-xl flex items-center justify-center gap-2 transition-all group">
                <svg class="w-3.5 h-3.5 text-gray-500 group-hover:text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                </svg>
                <span class="text-[10px] font-bold text-gray-500 group-hover:text-black uppercase tracking-widest">Ver Preview Completa</span>
            </button>
        </div>

        <!-- Títulos y Ejes -->
        <div class="grid grid-cols-1 gap-4 mt-4">
            <div>
                <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1.5">Título del Gráfico</label>
                <input type="text" id="chart_title" name="chart_title" placeholder="Ej: Crecimiento Anual" 
                       oninput="renderLivePreview()"
                       class="w-full px-3 py-2 text-xs border border-gray-200 rounded-xl bg-white focus:ring-1 focus:ring-black focus:border-black transition-all font-medium">
            </div>
            
            {# Ejes solo para bar_chart clásico #}
            {% if manim_animation_type == 'bar_chart' %}
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1.5">Eje X (Cat.)</label>
                    <input type="text" id="x_axis_label" name="x_axis_label" placeholder="Categorías" 
                           oninput="renderLivePreview()"
                           class="w-full px-3 py-2 text-xs border border-gray-200 rounded-xl bg-white focus:ring-1 focus:ring-black focus:border-black transition-all font-medium">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1.5">Eje Y (Val.)</label>
                    <input type="text" id="y_axis_label" name="y_axis_label" placeholder="Valores" 
                           oninput="renderLivePreview()"
                           class="w-full px-3 py-2 text-xs border border-gray-200 rounded-xl bg-white focus:ring-1 focus:ring-black focus:border-black transition-all font-medium">
                </div>
            </div>
            {% endif %}

            {# Opciones Extra (Fix overlap: use space-y instead of tight grid) #}
            <div class="flex flex-col gap-5 py-4 border-t border-gray-100 mt-2">
                {# Ancho de barras solo para bar_chart clásico #}
                {% if manim_animation_type == 'bar_chart' %}
                <div class="flex flex-col gap-2">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Ancho de Barras</label>
                    <div class="flex items-center gap-4">
                        <input type="range" name="bar_width" min="0.1" max="1.0" step="0.1" value="0.8" 
                               class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-black"
                               oninput="this.nextElementSibling.innerText = this.value; renderLivePreview()">
                        <span class="text-[10px] font-black text-gray-900 w-6 text-center bg-gray-50 py-1 rounded border border-gray-100">0.8</span>
                    </div>
                </div>
                {% endif %}
                <div class="flex items-center justify-between">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest">Etiquetas Sup.</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="show_labels" value="true" class="sr-only peer" checked onchange="renderLivePreview()">
                        <div class="w-10 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-black"></div>
                        <span class="ms-3 text-[10px] font-bold text-gray-500">Mostrar</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="pt-4 border-t border-gray-100 mt-2">
            <h5 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Capas de Datos</h5>
        </div>

        {# Vista previa de barras #}
        <div id="bar-preview-container" class="space-y-2">
            {# Las barras se mostrarán aquí como preview #}
        </div>

        {# Botón para abrir modal (como una barra adicional) #}
        <div class="mt-3">
            <button type="button" 
                    onclick="openBarManagerModal()"
                    class="w-full flex items-center justify-center gap-2 py-2.5 bg-white border border-dashed border-gray-300 rounded-lg hover:border-black hover:bg-gray-50 transition-all text-xs font-medium text-gray-600 hover:text-black">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10"></path>
                </svg>
                Configurar Datos de Barras
            </button>
        </div>
    </div>

    <script>
    // Inicializar las barras cuando se cargan los campos dinámicos
    document.addEventListener('DOMContentLoaded', function() {
        // Pequeño delay para asegurar que el DOM esté listo
        setTimeout(function() {
            // Solo inicializar si estamos en modo bar_chart
            const manimType = '{{ manim_animation_type|default:"quote" }}';
            if (manimType === 'bar_chart' || manimType === 'modern_bar_chart') {
                updateBarPreview();
            }
        }, 100);
    });

    // También inicializar cuando HTMX recarga los campos dinámicos
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'dynamic-fields' || event.detail.target.id === 'dynamic-fields-container') {
            setTimeout(function() {
                const manimType = '{{ manim_animation_type|default:"quote" }}';
                if (manimType === 'bar_chart' || manimType === 'modern_bar_chart') {
                    updateBarPreview();
                    renderLivePreview();
                }
            }, 100);
        }
    });

    // Inicialización adicional para asegurar que las barras se muestren
    // cuando se selecciona bar_chart
    function initializeBarsIfNeeded() {
        const manimTypeInput = document.getElementById('manim-animation-type-input');
        if (manimTypeInput && (manimTypeInput.value === 'bar_chart' || manimTypeInput.value === 'modern_bar_chart')) {
            const container = document.getElementById('bar-preview-container');
            if (container && container.children.length === 0) {
                updateBarPreview();
            }
        }
    }

    // Ejecutar inicialización adicional después de un delay
    setTimeout(() => {
        initializeBarsIfNeeded();
        renderLivePreview();
    }, 200);

    function renderLivePreview() {
        // Expose to window for other components
        window.renderLivePreview = renderLivePreview;
        
        const sidebarContainer = document.getElementById('live-chart-preview');
        const largeContainer = document.getElementById('live-chart-preview-large');
        
        if (!sidebarContainer && !largeContainer) return;

        // Recoger datos
        const title = document.getElementById('chart_title')?.value || 'Sin Título';
        const xLabel = document.getElementById('x_axis_label')?.value || '';
        const yLabel = document.getElementById('y_axis_label')?.value || '';
        const barWidth = parseFloat(document.querySelector('input[name="bar_width"]')?.value || 0.8);
        const showLabels = document.querySelector('input[name="show_labels"]')?.checked;
        const bgColor = document.querySelector('input[name="container_color"]')?.value || '#FFFFFF';
        const textColor = document.querySelector('input[name="text_color"]')?.value || '#111827';

        const bars = [];
        let maxVal = 10;
        
        let barCount = 0;
        while (document.querySelector(`input[name="bar_label_${barCount + 1}"]:not(#bar-manager-modal input)`)) {
            barCount++;
        }

        for (let i = 1; i <= barCount; i++) {
            const label = document.querySelector(`input[name="bar_label_${i}"]:not(#bar-manager-modal input)`)?.value || `B${i}`;
            const value = parseFloat(document.querySelector(`input[name="bar_value_${i}"]:not(#bar-manager-modal input)`)?.value || 0);
            const color = document.querySelector(`input[name="bar_color_${i}"]:not(#bar-manager-modal input)`)?.value || '#0066CC';
            const topText = document.querySelector(`input[name="bar_top_text_${i}"]:not(#bar-manager-modal input)`)?.value || '';
            
            bars.push({ label, value, color, topText });
            if (value > maxVal) maxVal = value;
        }

        if (bars.length === 0) {
            if (sidebarContainer) sidebarContainer.innerHTML = '<p class="text-[10px] text-gray-300 font-medium">Configura algunas barras para ver la preview</p>';
            if (largeContainer) largeContainer.innerHTML = '<p class="text-sm text-gray-300">Configura el gráfico en el panel derecho</p>';
            return;
        }

        const manimTypeInput = document.getElementById('manim-animation-type-input');
        const manimType = manimTypeInput ? manimTypeInput.value : 'quote';
        const isModern = manimType === 'modern_bar_chart';

        function generateSvg(w, h, isLarge) {
            const padX = isLarge ? 100 : 50;
            const padY = isLarge ? 80 : 40;
            const chartW = w - (padX + (isLarge ? 60 : 30));
            const chartH = h - (padY * 2);
            
            const startX = isModern ? (isLarge ? 40 : 20) : padX;
            const startY = padY;
            const endY = h - padY;
            const actualMax = maxVal * 1.1 || 1;
            const scale = chartH / actualMax;
            const barGap = (isModern ? (w - (isLarge ? 80 : 40)) : chartW) / (bars.length || 1);
            const actualBarW = barGap * (isModern ? 0.7 : barWidth);

            const fontSizeTitle = isLarge ? 28 : 14;
            const fontSizeAxes = isLarge ? 20 : 10;
            const fontSizeLabels = isLarge ? 16 : 8;
            const markerSize = isLarge ? 12 : 6;
            
            const escTitle = escapeHtml(title);
            const escXLabel = escapeHtml(xLabel);
            const escYLabel = escapeHtml(yLabel);
            const escTextColor = escapeHtml(textColor);
            const escBgColor = escapeHtml(bgColor);

            let svgHtml = `
                <svg width="100%" height="100%" viewBox="0 0 ${w} ${h}" preserveAspectRatio="xMidYMid meet" style="background-color: ${escBgColor}; font-family: sans-serif;">
                    <defs>
                        <marker id="arrowhead" markerWidth="${markerSize}" markerHeight="${markerSize*0.7}" 
                        refX="${markerSize}" refY="${markerSize*0.35}" orient="auto">
                          <polygon points="0 0, ${markerSize} ${markerSize*0.35}, 0 ${markerSize*0.7}" fill="${escTextColor}" />
                        </marker>
                    </defs>

                    <!-- Card Background (Modern Only) -->
                    ${isModern ? `
                    <rect x="15" y="15" width="${w-30}" height="${h-30}" fill="${escBgColor}" rx="${isLarge ? 24 : 12}" stroke="${escTextColor}" stroke-width="1.5" stroke-opacity="0.15" />
                    ` : ''}

                    <!-- Título -->
                    <text x="${w/2}" y="${isLarge ? 50 : 25}" text-anchor="middle" font-size="${fontSizeTitle}" font-weight="900" fill="${escTextColor}" style="letter-spacing: 0.05em;">${escTitle.toUpperCase()}</text>
                    
                    ${!isModern ? `
                    <!-- Ejes (con flechas estilo Manim) -->
                    <line x1="${startX}" y1="${endY}" x2="${w - (isLarge ? 40 : 20)}" y2="${endY}" stroke="${escTextColor}" stroke-width="${isLarge ? 3 : 1.5}" marker-end="url(#arrowhead)" />
                    <line x1="${startX}" y1="${endY}" x2="${startX}" y2="${startY - (isLarge ? 20 : 10)}" stroke="${escTextColor}" stroke-width="${isLarge ? 3 : 1.5}" marker-end="url(#arrowhead)" />
                    
                    <!-- Ticks y Valores Eje Y -->
                    ${[0, 0.25, 0.5, 0.75, 1].map(p => {
                        const val = Math.round(maxVal * p * 10) / 10;
                        const yTick = endY - (maxVal * p * scale);
                        return `
                        <line x1="${startX - (isLarge ? 10 : 5)}" y1="${yTick}" x2="${startX}" y2="${yTick}" stroke="${escTextColor}" stroke-width="${isLarge ? 2 : 1}" />
                        <text x="${startX - (isLarge ? 20 : 10)}" y="${yTick + (isLarge ? 6 : 3)}" text-anchor="end" font-size="${fontSizeLabels}" font-weight="bold" fill="${escTextColor}" opacity="0.6">${val}</text>
                        `;
                    }).join('')}

                    <!-- Labels Ejes -->
                    <text x="${w/2}" y="${h-(isLarge ? 20 : 10)}" text-anchor="middle" font-size="${fontSizeAxes}" font-weight="bold" fill="${escTextColor}" opacity="0.4">${escXLabel}</text>
                    <text x="${isLarge ? 30 : 15}" y="${h/2}" text-anchor="middle" font-size="${fontSizeAxes}" font-weight="bold" fill="${escTextColor}" opacity="0.4" transform="rotate(-90, ${isLarge ? 30 : 15}, ${h/2})">${escYLabel}</text>
                    ` : ''}
            `;

            bars.forEach((bar, i) => {
                const x = (isModern ? (isLarge ? 40 : 20) : startX) + (i * barGap) + (barGap - actualBarW) / 2;
                const barH = bar.value * scale;
                const y = endY - barH;
                
                const escBarLabel = escapeHtml(bar.label);
                const escBarColor = escapeHtml(bar.color);

                svgHtml += `
                    <rect x="${x}" y="${y}" width="${actualBarW}" height="${barH}" fill="${escBarColor}" rx="${isModern ? (isLarge ? 10 : 5) : 0}">
                        <animate attributeName="height" from="0" to="${barH}" dur="0.6s" fill="freeze" />
                        <animate attributeName="y" from="${endY}" to="${y}" dur="0.6s" fill="freeze" />
                    </rect>
                `;

                // Label de barra
                svgHtml += `
                    <text x="${x + actualBarW/2}" y="${endY + (isLarge ? 35 : 18)}" text-anchor="middle" font-size="${fontSizeLabels}" font-weight="bold" fill="${escTextColor}" opacity="0.8">${escBarLabel}</text>
                `;

                // Top Label (Valor)
                if (showLabels) {
                    const displayTop = bar.topText || bar.value;
                    const escDisplayTop = escapeHtml(displayTop);
                    svgHtml += `
                        <text x="${x + actualBarW/2}" y="${y-(isLarge ? 15 : 8)}" text-anchor="middle" font-size="${fontSizeLabels}" font-weight="900" fill="${escTextColor}">${escDisplayTop}</text>
                    `;
                }
            });

            svgHtml += `</svg>`;
            return svgHtml;
        }

        if (sidebarContainer) sidebarContainer.innerHTML = generateSvg(320, 180, false);
        if (largeContainer) largeContainer.innerHTML = generateSvg(800, 450, true);
    }
    </script>

{# Modal para gestionar barras - Reposicionado a la derecha para no tapar la preview #}
<div id="bar-manager-modal" class="fixed inset-0 hidden z-[10000] pointer-events-none">
    <div class="absolute right-0 top-0 bottom-0 bg-white shadow-2xl w-full sm:max-w-xs flex flex-col overflow-hidden border-l border-gray-100 animate-slide-in-right pointer-events-auto">
        <!-- Header -->
        <div class="flex justify-between items-center p-5 border-b border-gray-100">
            <div>
                <h3 class="text-xs font-bold text-gray-900 uppercase tracking-widest">Datos del Gráfico</h3>
                <p class="text-[10px] text-gray-500 mt-0.5">Gestiona las etiquetas y valores de cada barra</p>
            </div>
            <button type="button" onclick="closeBarManagerModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-black transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Contenido -->
        <div class="flex-1 overflow-y-auto p-4">
            <div class="space-y-2">
                <div id="modal-bar-fields-container" class="space-y-2">
                    {# Los campos se generarán dinámicamente con JavaScript #}
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-5 border-t border-gray-100 bg-white flex justify-center">
            <button type="button" 
                    onclick="closeBarManagerModal()" 
                    class="px-8 py-2.5 bg-black text-white text-xs font-bold rounded-full hover:bg-gray-800 transition-all shadow-lg shadow-black/10">
                GUARDAR CAMBIOS
            </button>
        </div>
    </div>
</div>
{% endif %}

<script>
// Usar un namespace global para evitar colisiones en recargas HTMX
if (typeof window.ManimBarManager === 'undefined') {
    window.ManimBarManager = {
        currentBarCount: 3,
        maxBars: 8,
        minBars: 1,
        COLOR_PALETTE: [
            '#3B82F6', '#EF4444', '#10B981', '#F59E0B', 
            '#8B5CF6', '#EC4899', '#06B6D4', '#F97316'
        ],
        
        updateBarPreview: function() {
            const container = document.getElementById('bar-preview-container');
            if (!container) return; // Protección contra TypeError
            
            container.innerHTML = '';
        
            for (let i = 1; i <= this.currentBarCount; i++) {
                // Obtener valores actuales (con fallbacks)
                let labelValue = `Barra ${i}`;
                let valueValue = (Math.random() * 10).toFixed(2);
                
                // Usar color de la paleta por defecto según el índice
                let colorValue = this.COLOR_PALETTE[(i - 1) % this.COLOR_PALETTE.length];
        
                const hiddenLabel = document.querySelector(`form input[name="bar_label_${i}"]:not(#bar-manager-modal input)`);
                const hiddenValue = document.querySelector(`form input[name="bar_value_${i}"]:not(#bar-manager-modal input)`);
                const hiddenColor = document.querySelector(`form input[name="bar_color_${i}"]:not(#bar-manager-modal input)`);
        
                if (hiddenLabel && hiddenLabel.value) labelValue = hiddenLabel.value;
                if (hiddenValue && hiddenValue.value) valueValue = hiddenValue.value;
                if (hiddenColor && hiddenColor.value) colorValue = hiddenColor.value;
        
                const barDiv = document.createElement('div');
                barDiv.className = 'group flex flex-col gap-2 p-3 bg-white border border-gray-100 rounded-xl shadow-sm hover:border-black transition-all';
                
                let topTextValue = '';
                const hiddenTopText = document.querySelector(`form input[name="bar_top_text_${i}"]:not(#bar-manager-modal input)`);
                if (hiddenTopText && hiddenTopText.value) topTextValue = hiddenTopText.value;
        
                const barHtml = document.createElement('div');
                
                // --- Row 1: Flex Container (Color | Label | Value) ---
                const row1 = document.createElement('div');
                row1.className = 'flex items-center gap-2';
                
                // Color Input
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.name = `bar_color_${i}`;
                colorInput.value = colorValue;
                colorInput.setAttribute('oninput', `ManimBarManager.syncSidebarInput(${i}, 'color', this.value)`);
                colorInput.className = 'w-3 h-3 rounded-full border-none bg-transparent cursor-pointer overflow-hidden p-0 [&::-webkit-color-swatch-wrapper]:p-0 [&::-webkit-color-swatch]:border-none [&::-webkit-color-swatch]:rounded-full shadow-sm shadow-inner';
                
                // Label Container
                const labelContainer = document.createElement('div');
                labelContainer.className = 'flex-1 flex flex-col min-w-0';
                
                // Label Input
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.name = `bar_label_${i}`;
                labelInput.value = labelValue; // Safe assignment
                labelInput.setAttribute('oninput', `ManimBarManager.syncSidebarInput(${i}, 'label', this.value)`);
                labelInput.className = 'w-full p-0 text-[10px] font-bold text-gray-900 border-none bg-transparent focus:ring-0 placeholder-gray-300 truncate';
                labelInput.placeholder = 'Nombre';
                
                labelContainer.appendChild(labelInput);
                
                // Value Input
                const valueInput = document.createElement('input');
                valueInput.type = 'number';
                valueInput.name = `bar_value_${i}`;
                valueInput.value = valueValue; // Safe assignment
                valueInput.step = '0.1';
                valueInput.setAttribute('oninput', `ManimBarManager.syncSidebarInput(${i}, 'value', this.value)`);
                valueInput.className = 'w-12 p-0 text-[10px] font-black text-gray-900 border-none bg-transparent focus:ring-0 text-right';
                valueInput.placeholder = '0.0';

                row1.appendChild(colorInput);
                row1.appendChild(labelContainer);
                row1.appendChild(valueInput);
                
                // --- Row 2: Top Text (Optional) ---
                const row2 = document.createElement('div');
                row2.className = 'pl-5';
                
                const topTextInput = document.createElement('input');
                topTextInput.type = 'text';
                topTextInput.name = `bar_top_text_${i}`;
                topTextInput.value = topTextValue; // Safe assignment
                topTextInput.setAttribute('oninput', `ManimBarManager.syncSidebarInput(${i}, 'top_text', this.value)`);
                topTextInput.className = 'w-full p-0 text-[8px] text-gray-400 font-medium border-none bg-transparent focus:ring-0 transition-all hover:text-gray-600 truncate';
                topTextInput.placeholder = 'Texto sup.';
                
                row2.appendChild(topTextInput);
                
                // Assemble Bar Element
                barDiv.appendChild(row1);
                barDiv.appendChild(row2);
                container.appendChild(barDiv);
            }
            
            // Actualizar preview visual real-time
            if (typeof renderLivePreview === 'function') renderLivePreview();
        },
        
        syncSidebarInput: function(barIndex, field, value) {
            const hiddenInput = document.querySelector(`form input[name="bar_${field}_${barIndex}"]:not(#bar-manager-modal input)`);
            if (hiddenInput) hiddenInput.value = value;
            
            const modalInput = document.querySelector(`#bar-manager-modal input[name="bar_${field}_${barIndex}"]`);
            if (modalInput) modalInput.value = value;
            
            if (typeof renderLivePreview === 'function') renderLivePreview();
        },

        addBar: function() {
            if (this.currentBarCount < this.maxBars) {
                this.currentBarCount++;
                const nextColor = this.COLOR_PALETTE[(this.currentBarCount - 1) % this.COLOR_PALETTE.length];
                const form = document.querySelector('form');
                
                // Helper para crear inputs ocultos
                const ensureHiddenInput = (name, val) => {
                    let input = document.querySelector(`form input[name="${name}"]:not(#bar-manager-modal input)`);
                    if (!input) {
                        input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = name;
                        form.appendChild(input);
                    }
                    input.value = val;
                    return input;
                };

                ensureHiddenInput(`bar_color_${this.currentBarCount}`, nextColor);
                ensureHiddenInput(`bar_value_${this.currentBarCount}`, '10.0');

                this.updateModalFields();
                this.updateBarPreview();
            }
        },

        removeBar: function(barIndex = null) {
            if (this.currentBarCount > this.minBars) {
                if (barIndex !== null) {
                    for (let i = barIndex; i < this.currentBarCount; i++) {
                        const fields = ['label', 'value', 'color', 'top_text'];
                        fields.forEach(field => {
                            const next = document.querySelector(`#bar-manager-modal input[name="bar_${field}_${i + 1}"]`);
                            const current = document.querySelector(`#bar-manager-modal input[name="bar_${field}_${i}"]`);
                            if (next && current) current.value = next.value;
                        });
                    }
                }
                this.currentBarCount--;
                this.updateModalFields();
                this.updateBarPreview();
            }
        },

        updateModalFields: function() {
            const container = document.getElementById('modal-bar-fields-container');
            if (!container) return;
            container.innerHTML = '';
        
            for (let i = 1; i <= this.currentBarCount; i++) {
                // Recuperar valores o defaults
                const getVal = (name, def) => {
                    const el = document.querySelector(`form input[name="${name}"]:not(#bar-manager-modal input)`);
                    return el && el.value ? el.value : def;
                };

                let currentLabel = getVal(`bar_label_${i}`, `Barra ${i}`);
                let currentValue = getVal(`bar_value_${i}`, '10.0');
                
                // Usar color de la paleta por defecto según el índice
                const defaultColor = this.COLOR_PALETTE[(i - 1) % this.COLOR_PALETTE.length];
                let currentColor = getVal(`bar_color_${i}`, defaultColor);
                
                let currentTopText = getVal(`bar_top_text_${i}`, '');

                const barDiv = document.createElement('div');
                barDiv.className = 'group flex items-center gap-4 p-4 bg-white border border-gray-100 rounded-2xl transition-all hover:border-black hover:shadow-md';
                
                // --- DOM Creation Logic ---
                
                // Helper to update hidden inputs when modal inputs change
                const syncToHidden = (field, val) => {
                     const hidden = document.querySelector(`form input[name="bar_${field}_${i}"]:not(#bar-manager-modal input)`);
                     if (hidden) hidden.value = val;
                     if (typeof renderLivePreview === 'function') renderLivePreview();
                };

                const createInputWrapper = (colSpan, labelText, inputType, name, placeholder, value) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = `col-span-${colSpan} flex flex-col gap-1`;
                    
                    const label = document.createElement('span');
                    label.className = 'text-[8px] font-black text-gray-300 uppercase tracking-widest';
                    label.textContent = labelText;
                    
                    const input = document.createElement('input');
                    input.type = inputType;
                    input.name = name;
                    input.placeholder = placeholder;
                    input.value = value;
                    input.className = 'w-full px-0 py-0 text-xs border-none bg-transparent focus:ring-0 placeholder-gray-200 font-bold text-gray-900';
                    
                    if (inputType === 'number') {
                         input.step = '0.1';
                         input.className = 'w-full px-0 py-0 text-xs border-none bg-transparent focus:ring-0 placeholder-gray-200 font-black text-gray-900';
                    }
                    if (name.includes('top_text')) {
                        input.className = 'w-full px-0 py-0 text-xs border-none bg-transparent focus:ring-0 placeholder-gray-200 font-medium text-gray-900';
                    }
                    
                    input.oninput = function() {
                        const fieldType = name.replace(`bar_`, '').replace(`_${i}`, ''); 
                        const shortField = fieldType; 
                        syncToHidden(shortField, this.value);
                    };
                    
                    wrapper.appendChild(label);
                    wrapper.appendChild(input);
                    return wrapper;
                };

                // 1. Icono de Color
                const colorDiv = document.createElement('div');
                colorDiv.className = 'flex-shrink-0 relative';
                
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.name = `bar_color_${i}`;
                colorInput.value = currentColor;
                colorInput.className = 'w-5 h-5 rounded-full border-none bg-transparent cursor-pointer overflow-hidden p-0 [&::-webkit-color-swatch-wrapper]:p-0 [&::-webkit-color-swatch]:border-none [&::-webkit-color-swatch]:rounded-full shadow-sm hover:scale-110 transition-transform';
                colorInput.oninput = function() {
                    syncToHidden('color', this.value);
                };
                
                colorDiv.appendChild(colorInput);
                
                // 2. Grid de campos
                const gridDiv = document.createElement('div');
                gridDiv.className = 'flex-1 grid grid-cols-12 gap-1';
                
                const labelWrapper = createInputWrapper(4, 'Etiqueta', 'text', `bar_label_${i}`, 'Nombre', currentLabel);
                const valueWrapper = createInputWrapper(3, 'Valor', 'number', `bar_value_${i}`, '0.0', currentValue);
                const topTextWrapper = createInputWrapper(5, 'Texto Supp', 'text', `bar_top_text_${i}`, 'Ej: 80%', currentTopText);

                gridDiv.appendChild(labelWrapper);
                gridDiv.appendChild(valueWrapper);
                gridDiv.appendChild(topTextWrapper);
                
                // 3. Delete Button (Condition check)
                let delDiv = null;
                if (this.currentBarCount > this.minBars) {
                    delDiv = document.createElement('div');
                    delDiv.className = 'flex-shrink-0';
                    
                    const delBtn = document.createElement('button');
                    delBtn.type = 'button';
                    delBtn.onclick = function() { ManimBarManager.removeBar(i); };                    
                    delBtn.className = 'w-8 h-8 flex items-center justify-center text-gray-200 hover:text-black hover:bg-gray-100 transition-all rounded-full';
                    delBtn.title = 'Eliminar';
                    delBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>';
                    
                    delDiv = delBtn;
                }

                barDiv.appendChild(colorDiv);
                barDiv.appendChild(gridDiv);
                if (delDiv) barDiv.appendChild(delDiv);
                
                container.appendChild(barDiv);
            }
        
            // Botón añadir
            const addBarDiv = document.createElement('div');
            addBarDiv.className = 'flex items-center justify-center gap-2 p-3 bg-gray-50 border border-dashed border-gray-300 rounded-xl hover:bg-gray-100 hover:border-gray-400 cursor-pointer transition-all group';
            addBarDiv.onclick = () => this.addBar();
            addBarDiv.innerHTML = `
                <div class="w-5 h-5 flex items-center justify-center bg-white rounded-full border border-gray-200 text-gray-400 group-hover:text-black group-hover:border-black transition-all">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </div>
                <span class="text-[10px] font-bold text-gray-400 group-hover:text-black uppercase tracking-widest transition-all">Añadir nueva barra</span>
            `;
            container.appendChild(addBarDiv);
        },
        
        openModal: function() {
            this.updateModalFields();
            const modal = document.getElementById('bar-manager-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        },

        closeModal: function() {
            // Sincronizar modal -> inputs ocultos
            const form = document.querySelector('form');
            if (form) {
                for (let i = 1; i <= this.currentBarCount; i++) {
                    const getModalVal = (name) => {
                        const el = document.querySelector(`#bar-manager-modal input[name="${name}"]`);
                        return el ? el.value : null;
                    };
                    const setHiddenVal = (name, val) => {
                        if (val === null) return;
                        let input = form.querySelector(`input[name="${name}"]:not(#bar-manager-modal input)`);
                        if (!input) {
                            input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = name;
                            form.appendChild(input);
                        }
                        input.value = val;
                    };

                    setHiddenVal(`bar_label_${i}`, getModalVal(`bar_label_${i}`));
                    setHiddenVal(`bar_value_${i}`, getModalVal(`bar_value_${i}`));
                    setHiddenVal(`bar_color_${i}`, getModalVal(`bar_color_${i}`));
                    setHiddenVal(`bar_top_text_${i}`, getModalVal(`bar_top_text_${i}`));
                }

                // Limpiar sobrantes
                for (let i = this.currentBarCount + 1; i <= this.maxBars; i++) {
                    ['label', 'value', 'color', 'top_text'].forEach(f => {
                         const el = form.querySelector(`input[name="bar_${f}_${i}"]:not(#bar-manager-modal input)`);
                         if (el) el.remove();
                    });
                }
            }

            const modal = document.getElementById('bar-manager-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            this.updateBarPreview(); // Actualizar preview lateral
        }
    };
}

// Alias globales para onclicks en el HTML (estos deben existir globalmente)
window.updateBarPreview = () => window.ManimBarManager.updateBarPreview();
window.openBarManagerModal = () => window.ManimBarManager.openModal();
window.closeBarManagerModal = () => window.ManimBarManager.closeModal();

// Inicialización automática
(function() {
    function init() {
        // Solo para bar charts
        const manimTypeInput = document.getElementById('manim-animation-type-input');
        const manimType = manimTypeInput ? manimTypeInput.value : '{{ manim_animation_type|default:"quote" }}';
        
        if (manimType === 'bar_chart' || manimType === 'modern_bar_chart') {
            if (window.ManimBarManager) window.ManimBarManager.updateBarPreview();
            
            if (typeof forceUpdatePromptField === 'function') forceUpdatePromptField();
        }
    }

    // Ejecutar inmediatamente
    init();

    // Re-ejecutar en eventos HTMX
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.target.id === 'dynamic-fields-container' || evt.detail.target.id === 'dynamic-fields-container') {
             setTimeout(init, 50);
        }
    });
})();
</script>

{# Campos de configuración para Manim (Author, display_time) #}
<div class="space-y-4 mb-6">
    {# Autor (solo para quote) #}
    {% if supports.author and manim_animation_type == 'quote' %}
    <div class="mb-4">
        <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">AUTOR <span class="text-gray-400 font-normal">(Opcional)</span></label>
        <input type="text" name="author"
               placeholder="Nombre del autor (opcional)"
               class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-black transition-all">
    </div>
    {% endif %}

    {# Tiempo en pantalla (solo para quote) #}
    {% if supports.display_time and manim_animation_type == 'quote' %}
    <div class="mb-4">
        <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">TIEMPO EN PANTALLA</label>
        <div class="flex items-center gap-2">
            <input type="number" name="display_time" min="1" max="60" step="0.5"
                   placeholder="Auto"
                   class="flex-1 px-3 py-2.5 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-black transition-all">
            <span class="text-sm text-gray-500">segundos</span>
        </div>
    </div>
    {% endif %}
</div>


{# Campos específicos del modelo (avatares, voces, etc.) #}
{% for field in model_specific_fields %}
    {{ field.html|safe }}
{% endfor %}

{# Script para preview de imágenes y ajuste automático de duración #}
<script>
/**
 * Alterna la visibilidad de campos de referencia según lo seleccionado
 */
function toggleReferenceFields(modelId) {
    const styleImage = document.querySelector('input[name="style_image"]');
    const assetImage1 = document.querySelector('input[name="asset_image_1"]');
    const assetImage2 = document.querySelector('input[name="asset_image_2"]');
    const assetImage3 = document.querySelector('input[name="asset_image_3"]');
    const styleField = document.getElementById('style-field');
    const assetField1 = document.getElementById('asset-field-1');
    const assetField2 = document.getElementById('asset-field-2');
    const assetField3 = document.getElementById('asset-field-3');
    const addAssetBtn = document.getElementById('add-asset-btn');
    
    const hasStyle = styleImage && styleImage.files && styleImage.files[0];
    const hasAsset1 = assetImage1 && assetImage1.files && assetImage1.files[0];
    const hasAsset2 = assetImage2 && assetImage2.files && assetImage2.files[0];
    const hasAsset3 = assetImage3 && assetImage3.files && assetImage3.files[0];
    const hasAnyAsset = hasAsset1 || hasAsset2 || hasAsset3;
    
    // Solo aplicar lógica de exclusión para veo-2.0-generate-exp
    if (modelId === 'veo-2.0-generate-exp') {
        if (hasStyle) {
            // Si hay style, ocultar todos los assets
            if (assetField1) assetField1.classList.add('hidden');
            if (assetField2) assetField2.classList.add('hidden');
            if (assetField3) assetField3.classList.add('hidden');
            if (addAssetBtn) addAssetBtn.classList.add('hidden');
            // Limpiar assets si estaban seleccionados
            if (assetImage1 && assetImage1.files && assetImage1.files[0]) {
                assetImage1.value = '';
                const preview = document.getElementById('asset-preview-1');
                if (preview) preview.classList.add('hidden');
            }
            if (assetImage2 && assetImage2.files && assetImage2.files[0]) {
                assetImage2.value = '';
                const preview = document.getElementById('asset-preview-2');
                if (preview) preview.classList.add('hidden');
            }
            if (assetImage3 && assetImage3.files && assetImage3.files[0]) {
                assetImage3.value = '';
                const preview = document.getElementById('asset-preview-3');
                if (preview) preview.classList.add('hidden');
            }
        } else if (hasAnyAsset) {
            // Si hay asset, ocultar style
            if (styleField) styleField.classList.add('hidden');
            if (styleImage && styleImage.files && styleImage.files[0]) {
                styleImage.value = '';
                const preview = document.getElementById('style-preview');
                if (preview) preview.classList.add('hidden');
            }
            // Mostrar botón añadir si hay menos de 3 assets
            if (addAssetBtn && !hasAsset3) {
                addAssetBtn.classList.remove('hidden');
            } else if (addAssetBtn && hasAsset3) {
                addAssetBtn.classList.add('hidden');
            }
        } else {
            // Si no hay nada, mostrar todo
            if (styleField) styleField.classList.remove('hidden');
            if (assetField1) assetField1.classList.remove('hidden');
            if (addAssetBtn) addAssetBtn.classList.add('hidden');
        }
    } else {
        // Para otros modelos (veo-3.1), solo mostrar assets y botón añadir
        if (styleField) styleField.classList.add('hidden');
        if (assetField1) assetField1.classList.remove('hidden');
        if (addAssetBtn && !hasAsset3) {
            addAssetBtn.classList.remove('hidden');
        } else if (addAssetBtn && hasAsset3) {
            addAssetBtn.classList.add('hidden');
        }
    }
    
    // Cascada de assets: Asset 2 solo visible si Asset 1 tiene archivo
    if (hasAsset1 && assetField2) {
        assetField2.classList.remove('hidden');
    } else if (!hasAsset1 && assetField2) {
        assetField2.classList.add('hidden');
        // Limpiar asset 2 y también ocultar asset 3 en cascada
        if (assetImage2) {
            assetImage2.value = '';
            const preview2 = document.getElementById('asset-preview-2');
            if (preview2) preview2.classList.add('hidden');
        }
        // Si asset 1 no tiene archivo, ocultar también asset 3
        if (assetField3) {
            assetField3.classList.add('hidden');
            if (assetImage3) {
                assetImage3.value = '';
                const preview3 = document.getElementById('asset-preview-3');
                if (preview3) preview3.classList.add('hidden');
            }
        }
    }
    
    // Cascada de assets: Asset 3 solo visible si Asset 2 tiene archivo
    if (hasAsset2 && assetField3) {
        assetField3.classList.remove('hidden');
    } else if (!hasAsset2 && assetField3) {
        assetField3.classList.add('hidden');
        // Limpiar asset 3 cuando se elimina asset 2
        if (assetImage3) {
            assetImage3.value = '';
            const preview3 = document.getElementById('asset-preview-3');
            if (preview3) preview3.classList.add('hidden');
        }
    }
}

/**
 * Añade un campo de asset adicional
 */
function addAssetField() {
    const assetField2 = document.getElementById('asset-field-2');
    const assetField3 = document.getElementById('asset-field-3');
    const addAssetBtn = document.getElementById('add-asset-btn');
    
    if (assetField2 && assetField2.classList.contains('hidden')) {
        assetField2.classList.remove('hidden');
    } else if (assetField3 && assetField3.classList.contains('hidden')) {
        assetField3.classList.remove('hidden');
        if (addAssetBtn) addAssetBtn.classList.add('hidden');
    }
}

function updateImagePreview(input, previewId) {
    const preview = document.getElementById(previewId);
    const label = input.closest('label');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            // Ocultar el icono y el texto cuando hay preview
            const icon = label.querySelector('.absolute.top-2');
            const text = label.querySelector('span.text-xs');
            if (icon) icon.style.display = 'none';
            if (text) text.style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
        
        // IMPORTANTE: Si se selecciona una imagen de referencia (style_image o asset_image_*),
        // ajustar automáticamente la duración a 8s (requerido por Veo)
        const inputName = input.name;
        if (inputName === 'style_image' || inputName.startsWith('asset_image_')) {
            const durationInput = document.getElementById('duration-input');
            const durationDisplay = document.getElementById('duration-display');
            if (durationInput && durationDisplay) {
                durationInput.value = '8';
                durationDisplay.textContent = '8s';
            }
            // Obtener model_id del contexto del template y alternar campos
            const modelId = '{{ model_id }}';
            toggleReferenceFields(modelId);
        }
    } else {
        // Si se elimina la imagen, restaurar preview
        preview.classList.add('hidden');
        const icon = label.querySelector('.absolute.top-2');
        const text = label.querySelector('span.text-xs');
        if (icon) icon.style.display = '';
        if (text) text.style.display = '';
        
        // Si se elimina una imagen de referencia, actualizar visibilidad de campos
        const inputName = input.name;
        if (inputName === 'style_image' || inputName.startsWith('asset_image_')) {
            const modelId = '{{ model_id }}';
            toggleReferenceFields(modelId);
        }
    }

// Renderizar preview de cita en tiempo real
window.renderQuotePreview = function() {
    console.log('[DEBUG-QUOTE] Ejecutando renderQuotePreview');
    const previewContainer = document.getElementById('live-quote-preview');
    if (!previewContainer) {
        console.log('[DEBUG-QUOTE] No se encontró #live-quote-preview');
        return;
    }

    // Obtener el texto de la cita desde el prompt principal
    // Intentar obtener de Alpine data si es posible, o del DOM
    let quoteText = '';
    const promptTextarea = document.querySelector('textarea[name="prompt"]');
    
    if (promptTextarea) {
        quoteText = promptTextarea.value.trim();
        console.log('[DEBUG-QUOTE] Texto encontrado en textarea:', quoteText.substring(0, 20) + '...');
    } else {
        console.log('[DEBUG-QUOTE] No se encontró textarea[name="prompt"]');
    }
    
    // Obtener colores
    const containerColorInput = document.getElementById('container-color-picker');
    const textColorInput = document.getElementById('text-color-picker');
    const containerColor = containerColorInput ? containerColorInput.value : '#0066CC';
    const textColor = textColorInput ? textColorInput.value : '#FFFFFF';
    
    console.log('[DEBUG-QUOTE] Colores:', { containerColor, textColor });

    // Si no hay texto, mostrar placeholder
    if (!quoteText) {
        previewContainer.style.background = `linear-gradient(135deg, ${containerColor} 0%, ${adjustColor(containerColor, -30)} 100%)`;
        previewContainer.innerHTML = `
            <div class="text-center text-white space-y-4">
                <svg class="w-12 h-12 mx-auto opacity-30" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
                </svg>
                <p class="text-lg font-medium opacity-60">Escribe tu cita para ver la preview</p>
            </div>
        `;
        return;
    }
    
    // Truncar texto si es muy largo
    const maxLength = 200;
    const displayText = quoteText.length > maxLength ? quoteText.substring(0, maxLength) + '...' : quoteText;
    
    // Helper para ajuste de color
    function adjustColor(color, amount) {
        const num = parseInt(color.replace("#",""), 16);
        const r = Math.max(0, Math.min(255, (num >> 16) + amount));
        const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
        const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
        return "#" + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
    }

    // Helper para wrap text
    function wrapText(text, maxCharsPerLine) {
        const words = text.split(' ');
        const lines = [];
        let currentLine = '';
        for (const word of words) {
            if ((currentLine + word).length <= maxCharsPerLine) {
                currentLine += (currentLine ? ' ' : '') + word;
            } else {
                if (currentLine) lines.push(currentLine);
                currentLine = word;
            }
        }
        if (currentLine) lines.push(currentLine);
        return lines.slice(0, 6);
    }

    // Crear SVG con la cita
    const svg = `
        <svg viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
            <!-- Fondo con gradiente -->
            <defs>
                <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:${containerColor};stop-opacity:1" />
                    <stop offset="100%" style="stop-color:${adjustColor(containerColor, -30)};stop-opacity:1" />
                </linearGradient>
            </defs>
            <rect width="1920" height="1080" fill="url(#bgGradient)"/>
            
            <!-- Icono de comillas -->
            <g transform="translate(960, 300)" opacity="0.15">
                <path d="M-80,-40 Q-100,-60 -100,-80 Q-100,-120 -60,-120 Q-20,-120 -20,-80 Q-20,-60 -40,-40 L-60,-20 L-40,-20 L-40,20 L-100,20 L-100,-20 Z" 
                      fill="${textColor}"/>
                <path d="M20,-40 Q0,-60 0,-80 Q0,-120 40,-120 Q80,-120 80,-80 Q80,-60 60,-40 L40,-20 L60,-20 L60,20 L0,20 L0,-20 Z" 
                      fill="${textColor}"/>
            </g>
            
            <!-- Texto de la cita -->
            <text x="960" y="540" 
                  font-family="Arial, sans-serif" 
                  font-size="48" 
                  font-weight="500"
                  fill="${textColor}" 
                  text-anchor="middle"
                  dominant-baseline="middle">
                ${wrapText(displayText, 40).map((line, i) => 
                    `<tspan x="960" dy="${i === 0 ? 0 : 60}">${escapeHtml(line)}</tspan>`
                ).join('')}
            </text>
        </svg>
    `;
    
    previewContainer.style.background = 'transparent';
    previewContainer.innerHTML = svg;
};

// Inicialización robusta
(function() {
    console.log('[DEBUG-QUOTE] Inicializando script de campos dinámicos');
    
    // Función de setup centralizada
    function setupQuotePreview() {
        if (!document.getElementById('live-quote-preview')) return;
        
        console.log('[DEBUG-QUOTE] Configurando listeners');
        // Render inicial
        window.renderQuotePreview();
        
        const promptTextarea = document.querySelector('textarea[name="prompt"]');
        if (promptTextarea) {
            // Eliminar y añadir para evitar duplicados
            promptTextarea.removeEventListener('input', window.renderQuotePreview);
            promptTextarea.addEventListener('input', window.renderQuotePreview);
            console.log('[DEBUG-QUOTE] Listener añadido a textarea prompt');
        } else {
            console.error('[DEBUG-QUOTE] No se pudo añadir listener: textarea prompt no encontrado');
        }
        
        // Listeners colores
        ['container-color-picker', 'text-color-picker'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                // Usar onchange nativo + listener evento
                el.removeEventListener('input', window.renderQuotePreview);
                el.addEventListener('input', window.renderQuotePreview);
                el.removeEventListener('change', window.renderQuotePreview);
                el.addEventListener('change', window.renderQuotePreview);
            }
        });
    }

    // Ejecutar inmediatamente
    setupQuotePreview();
    
    // Ejecutar cuando HTMX termine el swap (por si acaso)
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        // Solo si el swap afectó a nuestra área
        if (evt.target.id === 'dynamic-fields-container' || evt.detail.target.id === 'dynamic-fields-container') {
             setTimeout(setupQuotePreview, 50);
        }
    });

    // Toggle reference fields logic (código original)
    const modelId = '{{ model_id }}';
    if (modelId) {
        toggleReferenceFields(modelId);
    }
})();
</script>

{# Costo Estimado - se actualiza dentro del botón Generar #}
{% if estimated_cost > 0 %}
<script>
// Actualizar el contenedor de costo estimado dentro del botón cuando se cargan los campos
(function() {
    const costContainer = document.getElementById('estimated-cost-container');
    if (costContainer) {
        costContainer.innerHTML = '{{ estimated_cost|floatformat:0 }}';
    }
})();
</script>
{% endif %}
