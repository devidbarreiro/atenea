{% load static %}

{# Campos dinámicos según capacidades del modelo #}

{# Contenedor para botones de configuración horizontal #}
{% if supports.duration or supports.aspect_ratio or supports.resolution or supports.audio or supports.container_color or supports.text_color or supports.font_family %}
<div class="mb-4">
    <div class="flex flex-wrap gap-1.5">
        {# Duración #}
        {% if supports.duration %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" @click.away="open = false"
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <svg class="w-3 h-3 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-gray-700 font-medium" id="duration-display">
                    {% if supports.duration.fixed %}
                        {{ supports.duration.fixed }}s
                    {% elif supports.duration.options %}
                        {{ supports.duration.options.0 }}"
                    {% elif supports.duration.min and supports.duration.max %}
                        {{ supports.duration.min }}-{{ supports.duration.max }}"
                    {% endif %}
                </span>
            </button>
            <div x-show="open" x-cloak
                 class="absolute z-50 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[200px] py-1 max-h-64 overflow-y-auto">
                {% if supports.duration.fixed %}
                    <div class="px-4 py-2 text-sm text-gray-500">
                        Duración fija: {{ supports.duration.fixed }}s
                    </div>
                {% elif supports.duration.options %}
                    {% for opt in supports.duration.options %}
                    <button type="button" @click="document.getElementById('duration-input').value = '{{ opt }}'; document.getElementById('duration-display').textContent = '{{ opt }}s'; open = false;"
                            class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center justify-between">
                        <span>{{ opt }}s</span>
                        <span class="text-xs text-gray-500">{% if opt <= 6 %}Short{% else %}Long{% endif %}</span>
                    </button>
                    {% endfor %}
                {% endif %}
            </div>
            {% if supports.duration.fixed %}
                <input type="hidden" name="duration" value="{{ supports.duration.fixed }}">
            {% else %}
                <input type="hidden" name="duration" id="duration-input" value="{% if supports.duration.options %}{{ supports.duration.options.0 }}{% elif supports.duration.min %}{{ supports.duration.min }}{% endif %}">
            {% endif %}
        </div>
        {% endif %}

        {# Aspect Ratio - Ocultar si solo hay una opción (como Manim) #}
        {% if supports.aspect_ratio and supports.aspect_ratio|length > 1 %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" @click.away="open = false"
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <svg class="w-3 h-3 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
                </svg>
                <span class="text-gray-700 font-medium" id="aspect-display">
                    {% for ar in supports.aspect_ratio %}
                        {% if forloop.first %}{{ ar }}{% endif %}
                    {% endfor %}
                </span>
            </button>
            <div x-show="open" x-cloak
                 class="absolute z-50 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[200px] py-1">
                {% for ar in supports.aspect_ratio %}
                <button type="button" @click="document.getElementById('aspect-input').value = '{{ ar }}'; document.getElementById('aspect-display').textContent = '{{ ar }}'; open = false;"
                        class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center gap-3">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {% if ar == "1:1" %}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5z"></path>
                        {% elif ar == "16:9" or ar == "4:3" or ar == "3:2" or ar == "5:4" %}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5z"></path>
                        {% else %}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v14a1 1 0 01-1 1H5a1 1 0 01-1-1V5z"></path>
                        {% endif %}
                    </svg>
                    <span>{{ ar }}{% if ar == "1:1" %} Square{% elif ar == "16:9" %} Widescreen{% elif ar == "4:3" %} Classic{% elif ar == "9:16" %} Social story{% endif %}</span>
                </button>
                {% endfor %}
            </div>
            <input type="hidden" name="aspect_ratio" id="aspect-input" value="{% for ar in supports.aspect_ratio %}{% if forloop.first %}{{ ar }}{% endif %}{% endfor %}">
        </div>
        {% elif supports.aspect_ratio and supports.aspect_ratio|length == 1 %}
        {# Si solo hay una opción, ocultar el campo pero mantener el valor #}
        <input type="hidden" name="aspect_ratio" value="{% for ar in supports.aspect_ratio %}{{ ar }}{% endfor %}">
        {% endif %}

        {# Resolución #}
        {% if supports.resolution and supports.resolution != False %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" @click.away="open = false"
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <svg class="w-3 h-3 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                <span class="text-gray-700 font-medium" id="resolution-display">
                    {% for res in supports.resolution %}
                        {% if forloop.first %}{{ res|upper }}{% endif %}
                    {% endfor %}
                </span>
            </button>
            <div x-show="open" x-cloak
                 class="absolute z-50 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[150px] py-1">
                {% for res in supports.resolution %}
                <button type="button" @click="document.getElementById('resolution-input').value = '{{ res }}'; document.getElementById('resolution-display').textContent = '{{ res|upper }}'; open = false;"
                        class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                    {{ res|upper }}
                </button>
                {% endfor %}
            </div>
            <input type="hidden" name="resolution" id="resolution-input" value="{% for res in supports.resolution %}{% if forloop.first %}{{ res }}{% endif %}{% endfor %}">
        </div>
        {% endif %}

        {# Audio #}
        {% if supports.audio %}
        <div class="flex-shrink-0" x-data="{ audioOn: false }">
            <button type="button" @click="audioOn = !audioOn; document.getElementById('audio-input').value = audioOn ? 'true' : '';"
                    :class="audioOn ? 'bg-gray-100 border-gray-300' : 'bg-gray-50 border-gray-200'"
                    class="flex items-center gap-1 px-1.5 py-1.5 border rounded-lg hover:bg-gray-200 transition-colors text-xs">
                <svg class="w-3 h-3 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                </svg>
                <span class="text-gray-700 font-medium" x-text="audioOn ? 'ON' : 'OFF'"></span>
            </button>
            <input type="hidden" name="generate_audio" id="audio-input" value="">
        </div>
        {% endif %}

        {# Color del Contenedor (para Manim Quote) #}
        {% if supports.container_color %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" 
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <svg class="w-3.5 h-3.5 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1v-2z"></path>
                </svg>
                <div class="w-3.5 h-3.5 rounded border border-gray-400 flex-shrink-0" id="container-color-preview" style="background-color: #0066CC;"></div>
            </button>
            <div x-show="open" 
                 x-cloak
                 @click.away="open = false"
                 x-transition
                 class="absolute z-[100] mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[250px] p-3">
                <div class="space-y-3" @click.stop>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-2">Color del Contenedor</label>
                        <div class="flex items-center gap-2">
                            <input type="color" name="container_color" id="container-color-picker" value="#0066CC"
                                   class="h-10 w-16 border border-gray-300 rounded cursor-pointer"
                                   onchange="document.getElementById('container-color-text').value = this.value; document.getElementById('container-color-preview').style.backgroundColor = this.value;">
                            <input type="text" name="container_color_text" id="container-color-text" value="#0066CC" pattern="^#[0-9A-Fa-f]{6}$"
                                   placeholder="#0066CC"
                                   class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   oninput="const picker = document.getElementById('container-color-picker'); const preview = document.getElementById('container-color-preview'); if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) { picker.value = this.value; preview.style.backgroundColor = this.value; }">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Color del Texto (para Manim Quote) #}
        {% if supports.text_color %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" 
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <span class="text-gray-700 font-bold text-sm flex-shrink-0">A</span>
                <div class="w-3.5 h-3.5 rounded border border-gray-400 flex-shrink-0" id="text-color-preview" style="background-color: #FFFFFF;"></div>
            </button>
            <div x-show="open" 
                 x-cloak
                 @click.away="open = false"
                 x-transition
                 class="absolute z-[100] mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[250px] p-3">
                <div class="space-y-3" @click.stop>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-2">Color del Texto</label>
                        <div class="flex items-center gap-2">
                            <input type="color" name="text_color" id="text-color-picker" value="#FFFFFF"
                                   class="h-10 w-16 border border-gray-300 rounded cursor-pointer"
                                   onchange="document.getElementById('text-color-text').value = this.value; document.getElementById('text-color-preview').style.backgroundColor = this.value;">
                            <input type="text" name="text_color_text" id="text-color-text" value="#FFFFFF" pattern="^#[0-9A-Fa-f]{6}$"
                                   placeholder="#FFFFFF"
                                   class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                   oninput="const picker = document.getElementById('text-color-picker'); const preview = document.getElementById('text-color-preview'); if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) { picker.value = this.value; preview.style.backgroundColor = this.value; }">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {# Tipo de Fuente (para Manim Quote) #}
        {% if supports.font_family %}
        <div class="relative flex-shrink-0" x-data="{ open: false }">
            <button type="button" @click="open = !open" @click.away="open = false"
                    class="flex items-center justify-center gap-1 px-2 py-1.5 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition-colors text-xs h-[28px]">
                <svg class="w-3 h-3 text-gray-700 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
                </svg>
                <span class="text-gray-700 font-medium" id="font-family-display">Normal</span>
            </button>
            <div x-show="open" x-cloak
                 class="absolute z-50 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg min-w-[180px] py-1">
                {% for font in supports.font_family %}
                <button type="button" @click="document.getElementById('font-family-input').value = '{{ font }}'; document.getElementById('font-family-display').textContent = '{% if font == 'normal' %}Normal{% elif font == 'bold' %}Negrita{% elif font == 'italic' %}Cursiva{% elif font == 'bold_italic' %}Negrita y Cursiva{% else %}{{ font|title }}{% endif %}'; open = false;"
                        class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                    {% if font == 'normal' %}Normal
                    {% elif font == 'bold' %}Negrita
                    {% elif font == 'italic' %}Cursiva
                    {% elif font == 'bold_italic' %}Negrita y Cursiva
                    {% else %}{{ font|title }}
                    {% endif %}
                </button>
                {% endfor %}
            </div>
            <input type="hidden" name="font_family" id="font-family-input" value="normal">
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{# Imágenes de Referencia - Diseño mejorado con tarjetas #}
{% if has_references %}
<div class="mb-4">
    <label class="block text-xs font-semibold text-gray-700 uppercase mb-3">REFERENCIAS</label>
    <div class="grid grid-cols-2 gap-2" id="reference-images-container">
        {% if supports.references.start_image == True or supports.references.start_image %}
        <label class="relative group cursor-pointer">
            <input type="file" name="start_image" accept="image/*" class="hidden" onchange="updateImagePreview(this, 'start-preview')">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 transition-colors group-hover:bg-gray-50 h-24 flex items-center justify-center">
                <div class="flex flex-col items-center justify-center text-center relative w-full h-full">
                    <div class="absolute top-2 left-2 flex items-center gap-1">
                        <svg class="w-5 h-5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="2" width="10" height="10" rx="0.5" fill="none"/>
                            <rect x="6" y="6" width="10" height="10" rx="0.5" fill="none"/>
                            <path d="M9.5 7.5l3 2.5-3 2.5V7.5z" fill="currentColor"/>
                        </svg>
                        <div class="relative group/info">
                            <button type="button" class="text-gray-400 hover:text-gray-600 focus:outline-none" onclick="event.preventDefault();">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-48 p-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 invisible group-hover/info:opacity-100 group-hover/info:visible transition-all duration-200 pointer-events-none z-10">
                                <p class="text-center">Para HeyGen Avatar IV, sube aquí la imagen del avatar que quieres usar.</p>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                    <div class="border-4 border-transparent border-t-gray-800"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <span class="text-xs font-medium text-gray-900 mt-auto">Start image</span>
                    <img id="start-preview" class="hidden absolute inset-0 w-full h-full object-cover rounded" alt="Preview">
                </div>
            </div>
        </label>
        {% endif %}
        
        {% if supports.references.end_image == True or supports.references.end_image %}
        <label class="relative group cursor-pointer">
            <input type="file" name="end_image" accept="image/*" class="hidden" onchange="updateImagePreview(this, 'end-preview')">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 transition-colors group-hover:bg-gray-50 h-24 flex items-center justify-center">
                <div class="flex flex-col items-center justify-center text-center relative w-full h-full">
                    <div class="absolute top-2 left-2">
                        <svg class="w-5 h-5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="2" width="10" height="10" rx="0.5" fill="none"/>
                            <rect x="6" y="6" width="10" height="10" rx="0.5" fill="none"/>
                            <path d="M9.5 7.5l3 2.5-3 2.5V7.5z" fill="currentColor"/>
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-gray-900 mt-auto">End image</span>
                    <img id="end-preview" class="hidden absolute inset-0 w-full h-full object-cover rounded" alt="Preview">
                </div>
            </div>
        </label>
        {% endif %}
        
        {% if supports.references.style_image == True or supports.references.style_image %}
        <label class="relative group cursor-pointer ref-style-field" data-ref-type="style" id="style-field">
            <input type="file" name="style_image" accept="image/*" class="hidden reference-image-input" data-type="style" onchange="updateImagePreview(this, 'style-preview'); toggleReferenceFields('{{ model_id }}');">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 transition-colors group-hover:bg-gray-50 h-24 flex items-center justify-center">
                <div class="flex flex-col items-center justify-center text-center relative w-full h-full">
                    <div class="absolute top-2 left-2">
                        <svg class="w-5 h-5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.648 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42"/>
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-gray-900 mt-auto">Style</span>
                    <img id="style-preview" class="hidden absolute inset-0 w-full h-full object-cover rounded" alt="Preview">
                </div>
            </div>
        </label>
        {% endif %}
        
        {% if supports.references.asset_image == True or supports.references.asset_image %}
        {# Asset 1 - Siempre visible #}
        <label class="relative group cursor-pointer ref-asset-field" data-ref-type="asset" id="asset-field-1">
            <input type="file" name="asset_image_1" accept="image/*" class="hidden reference-image-input" data-type="asset" onchange="updateImagePreview(this, 'asset-preview-1'); toggleReferenceFields('{{ model_id }}');">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 transition-colors group-hover:bg-gray-50 h-24 flex items-center justify-center">
                <div class="flex flex-col items-center justify-center text-center relative w-full h-full">
                    <div class="absolute top-2 left-2">
                        <svg class="w-5 h-5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M16.5 8.25V6a2.25 2.25 0 00-2.25-2.25H6A2.25 2.25 0 003.75 6v8.25A2.25 2.25 0 006 16.5h2.25m8.25-8.25h2.25A2.25 2.25 0 0121 10.5v8.25a2.25 2.25 0 01-2.25 2.25H16.5m-9-8.25h8.25m0 0V12m0-3.75v3.75m0 0v3.75m0-3.75h8.25"/>
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-gray-900 mt-auto">Asset</span>
                    <img id="asset-preview-1" class="hidden absolute inset-0 w-full h-full object-cover rounded" alt="Preview">
                </div>
            </div>
        </label>
        
        {# Asset 2 - Oculto inicialmente #}
        <label class="relative group cursor-pointer ref-asset-field hidden" data-ref-type="asset" id="asset-field-2">
            <input type="file" name="asset_image_2" accept="image/*" class="hidden reference-image-input" data-type="asset" onchange="updateImagePreview(this, 'asset-preview-2'); toggleReferenceFields('{{ model_id }}');">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 transition-colors group-hover:bg-gray-50 h-24 flex items-center justify-center">
                <div class="flex flex-col items-center justify-center text-center relative w-full h-full">
                    <div class="absolute top-2 left-2">
                        <svg class="w-5 h-5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M16.5 8.25V6a2.25 2.25 0 00-2.25-2.25H6A2.25 2.25 0 003.75 6v8.25A2.25 2.25 0 006 16.5h2.25m8.25-8.25h2.25A2.25 2.25 0 0121 10.5v8.25a2.25 2.25 0 01-2.25 2.25H16.5m-9-8.25h8.25m0 0V12m0-3.75v3.75m0 0v3.75m0-3.75h8.25"/>
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-gray-900 mt-auto">Asset</span>
                    <img id="asset-preview-2" class="hidden absolute inset-0 w-full h-full object-cover rounded" alt="Preview">
                </div>
            </div>
        </label>
        
        {# Asset 3 - Oculto inicialmente #}
        <label class="relative group cursor-pointer ref-asset-field hidden" data-ref-type="asset" id="asset-field-3">
            <input type="file" name="asset_image_3" accept="image/*" class="hidden reference-image-input" data-type="asset" onchange="updateImagePreview(this, 'asset-preview-3'); toggleReferenceFields('{{ model_id }}');">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 transition-colors group-hover:bg-gray-50 h-24 flex items-center justify-center">
                <div class="flex flex-col items-center justify-center text-center relative w-full h-full">
                    <div class="absolute top-2 left-2">
                        <svg class="w-5 h-5 text-gray-900" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M16.5 8.25V6a2.25 2.25 0 00-2.25-2.25H6A2.25 2.25 0 003.75 6v8.25A2.25 2.25 0 006 16.5h2.25m8.25-8.25h2.25A2.25 2.25 0 0121 10.5v8.25a2.25 2.25 0 01-2.25 2.25H16.5m-9-8.25h8.25m0 0V12m0-3.75v3.75m0 0v3.75m0-3.75h8.25"/>
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-gray-900 mt-auto">Asset</span>
                    <img id="asset-preview-3" class="hidden absolute inset-0 w-full h-full object-cover rounded" alt="Preview">
                </div>
            </div>
        </label>
        
        {# Botón para añadir más assets #}
        {% if model_id == 'veo-2.0-generate-exp' or 'veo-3.1' in model_id %}
        <button type="button" id="add-asset-btn" class="hidden border-2 border-dashed border-gray-300 rounded-lg p-3 hover:border-gray-400 hover:bg-gray-50 transition-colors h-24 flex items-center justify-center text-xs text-gray-600" onclick="addAssetField()">
            <div class="flex flex-col items-center gap-1">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>Añadir Asset</span>
            </div>
        </button>
        {% endif %}
        {% endif %}
    </div>
</div>
{% endif %}

{# Negative Prompt - Opcional, solo si el modelo lo permite #}
{% if supports.negative_prompt %}
<div class="mb-4">
    <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">PROMPT NEGATIVO <span class="text-gray-400 font-normal">(Opcional)</span></label>
    <textarea name="negative_prompt" rows="3"
              placeholder="Elementos a evitar en el video..."
              class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-black resize-none transition-all"></textarea>
</div>
{% endif %}

{# Seed #}
{% if supports.seed %}
<div class="mb-4">
    <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">SEED</label>
    <input type="number" name="seed" min="0" max="4294967295"
           placeholder="Opcional: número para reproducibilidad"
           class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-black transition-all">
</div>
{% endif %}

{# Modo (para Kling) #}
{% if supports.modes %}
<div class="mb-4">
    <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">MODO</label>
    <select name="mode"
            class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-black transition-all">
        {% for mode in supports.modes %}
            <option value="{{ mode }}" {% if forloop.first %}selected{% endif %}>{{ mode|upper }}</option>
        {% endfor %}
    </select>
</div>
{% endif %}

{# Autor (para Manim Quote) #}
{% if supports.author %}
<div class="mb-4">
    <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">AUTOR <span class="text-gray-400 font-normal">(Opcional)</span></label>
    <input type="text" name="author"
           placeholder="Nombre del autor (opcional)"
           class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-black transition-all">
</div>
{% endif %}

{# Calidad (para Manim Quote) #}
{% if supports.quality %}
<div class="mb-4">
    <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">CALIDAD</label>
    <select name="quality"
            class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-black transition-all">
        {% for q in supports.quality %}
            <option value="{{ q }}" {% if q == 'k' %}selected{% endif %}>
                {% if q == 'l' %}Baja (480p)
                {% elif q == 'm' %}Media (720p)
                {% elif q == 'h' %}Alta (1080p)
                {% elif q == 'k' %}4K Máxima (2160p)
                {% else %}{{ q|upper }}
                {% endif %}
            </option>
        {% endfor %}
    </select>
</div>
{% endif %}


{# Campos específicos del modelo (avatares, voces, etc.) #}
{% for field in model_specific_fields %}
    {{ field.html|safe }}
{% endfor %}

{# Script para preview de imágenes y ajuste automático de duración #}
<script>
/**
 * Alterna la visibilidad de campos de referencia según lo seleccionado
 */
function toggleReferenceFields(modelId) {
    const styleImage = document.querySelector('input[name="style_image"]');
    const assetImage1 = document.querySelector('input[name="asset_image_1"]');
    const assetImage2 = document.querySelector('input[name="asset_image_2"]');
    const assetImage3 = document.querySelector('input[name="asset_image_3"]');
    const styleField = document.getElementById('style-field');
    const assetField1 = document.getElementById('asset-field-1');
    const assetField2 = document.getElementById('asset-field-2');
    const assetField3 = document.getElementById('asset-field-3');
    const addAssetBtn = document.getElementById('add-asset-btn');
    
    const hasStyle = styleImage && styleImage.files && styleImage.files[0];
    const hasAsset1 = assetImage1 && assetImage1.files && assetImage1.files[0];
    const hasAsset2 = assetImage2 && assetImage2.files && assetImage2.files[0];
    const hasAsset3 = assetImage3 && assetImage3.files && assetImage3.files[0];
    const hasAnyAsset = hasAsset1 || hasAsset2 || hasAsset3;
    
    // Solo aplicar lógica de exclusión para veo-2.0-generate-exp
    if (modelId === 'veo-2.0-generate-exp') {
        if (hasStyle) {
            // Si hay style, ocultar todos los assets
            if (assetField1) assetField1.classList.add('hidden');
            if (assetField2) assetField2.classList.add('hidden');
            if (assetField3) assetField3.classList.add('hidden');
            if (addAssetBtn) addAssetBtn.classList.add('hidden');
            // Limpiar assets si estaban seleccionados
            if (assetImage1 && assetImage1.files && assetImage1.files[0]) {
                assetImage1.value = '';
                const preview = document.getElementById('asset-preview-1');
                if (preview) preview.classList.add('hidden');
            }
            if (assetImage2 && assetImage2.files && assetImage2.files[0]) {
                assetImage2.value = '';
                const preview = document.getElementById('asset-preview-2');
                if (preview) preview.classList.add('hidden');
            }
            if (assetImage3 && assetImage3.files && assetImage3.files[0]) {
                assetImage3.value = '';
                const preview = document.getElementById('asset-preview-3');
                if (preview) preview.classList.add('hidden');
            }
        } else if (hasAnyAsset) {
            // Si hay asset, ocultar style
            if (styleField) styleField.classList.add('hidden');
            if (styleImage && styleImage.files && styleImage.files[0]) {
                styleImage.value = '';
                const preview = document.getElementById('style-preview');
                if (preview) preview.classList.add('hidden');
            }
            // Mostrar botón añadir si hay menos de 3 assets
            if (addAssetBtn && !hasAsset3) {
                addAssetBtn.classList.remove('hidden');
            } else if (addAssetBtn && hasAsset3) {
                addAssetBtn.classList.add('hidden');
            }
        } else {
            // Si no hay nada, mostrar todo
            if (styleField) styleField.classList.remove('hidden');
            if (assetField1) assetField1.classList.remove('hidden');
            if (addAssetBtn) addAssetBtn.classList.add('hidden');
        }
    } else {
        // Para otros modelos (veo-3.1), solo mostrar assets y botón añadir
        if (styleField) styleField.classList.add('hidden');
        if (assetField1) assetField1.classList.remove('hidden');
        if (addAssetBtn && !hasAsset3) {
            addAssetBtn.classList.remove('hidden');
        } else if (addAssetBtn && hasAsset3) {
            addAssetBtn.classList.add('hidden');
        }
    }
    
    // Cascada de assets: Asset 2 solo visible si Asset 1 tiene archivo
    if (hasAsset1 && assetField2) {
        assetField2.classList.remove('hidden');
    } else if (!hasAsset1 && assetField2) {
        assetField2.classList.add('hidden');
        // Limpiar asset 2 y también ocultar asset 3 en cascada
        if (assetImage2) {
            assetImage2.value = '';
            const preview2 = document.getElementById('asset-preview-2');
            if (preview2) preview2.classList.add('hidden');
        }
        // Si asset 1 no tiene archivo, ocultar también asset 3
        if (assetField3) {
            assetField3.classList.add('hidden');
            if (assetImage3) {
                assetImage3.value = '';
                const preview3 = document.getElementById('asset-preview-3');
                if (preview3) preview3.classList.add('hidden');
            }
        }
    }
    
    // Cascada de assets: Asset 3 solo visible si Asset 2 tiene archivo
    if (hasAsset2 && assetField3) {
        assetField3.classList.remove('hidden');
    } else if (!hasAsset2 && assetField3) {
        assetField3.classList.add('hidden');
        // Limpiar asset 3 cuando se elimina asset 2
        if (assetImage3) {
            assetImage3.value = '';
            const preview3 = document.getElementById('asset-preview-3');
            if (preview3) preview3.classList.add('hidden');
        }
    }
}

/**
 * Añade un campo de asset adicional
 */
function addAssetField() {
    const assetField2 = document.getElementById('asset-field-2');
    const assetField3 = document.getElementById('asset-field-3');
    const addAssetBtn = document.getElementById('add-asset-btn');
    
    if (assetField2 && assetField2.classList.contains('hidden')) {
        assetField2.classList.remove('hidden');
    } else if (assetField3 && assetField3.classList.contains('hidden')) {
        assetField3.classList.remove('hidden');
        if (addAssetBtn) addAssetBtn.classList.add('hidden');
    }
}

function updateImagePreview(input, previewId) {
    const preview = document.getElementById(previewId);
    const label = input.closest('label');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            // Ocultar el icono y el texto cuando hay preview
            const icon = label.querySelector('.absolute.top-2');
            const text = label.querySelector('span.text-xs');
            if (icon) icon.style.display = 'none';
            if (text) text.style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
        
        // IMPORTANTE: Si se selecciona una imagen de referencia (style_image o asset_image_*),
        // ajustar automáticamente la duración a 8s (requerido por Veo)
        const inputName = input.name;
        if (inputName === 'style_image' || inputName.startsWith('asset_image_')) {
            const durationInput = document.getElementById('duration-input');
            const durationDisplay = document.getElementById('duration-display');
            if (durationInput && durationDisplay) {
                durationInput.value = '8';
                durationDisplay.textContent = '8s';
            }
            // Obtener model_id del contexto del template y alternar campos
            const modelId = '{{ model_id }}';
            toggleReferenceFields(modelId);
        }
    } else {
        // Si se elimina la imagen, restaurar preview
        preview.classList.add('hidden');
        const icon = label.querySelector('.absolute.top-2');
        const text = label.querySelector('span.text-xs');
        if (icon) icon.style.display = '';
        if (text) text.style.display = '';
        
        // Si se elimina una imagen de referencia, actualizar visibilidad de campos
        const inputName = input.name;
        if (inputName === 'style_image' || inputName.startsWith('asset_image_')) {
            const modelId = '{{ model_id }}';
            toggleReferenceFields(modelId);
        }
    }
}

// Inicializar estado de campos al cargar
document.addEventListener('DOMContentLoaded', function() {
    const modelId = '{{ model_id }}';
    if (modelId) {
        toggleReferenceFields(modelId);
    }
});
</script>

{# Costo Estimado - se actualiza dentro del botón Generar #}
{% if estimated_cost > 0 %}
<script>
// Actualizar el contenedor de costo estimado dentro del botón cuando se cargan los campos
(function() {
    const costContainer = document.getElementById('estimated-cost-container');
    if (costContainer) {
        costContainer.innerHTML = '{{ estimated_cost|floatformat:0 }}';
    }
})();
</script>
{% endif %}
