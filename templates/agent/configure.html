{% extends 'base.html' %}

{% block title %}Configure Scenes{% if project %} - {{ project.name }}{% endif %}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Progress Bar -->
    <div class="mb-8">
        <div class="flex items-center justify-center space-x-4">
            <!-- Step 1: Completed -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-green-500 text-white font-bold">
                    ‚úì
                </div>
                <span class="ml-2 text-sm font-medium text-gray-500">Contenido</span>
            </div>
            <div class="w-16 h-1 bg-green-500"></div>
            
            <!-- Step 2: Active -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-600 text-white font-bold">
                    2
                </div>
                <span class="ml-2 text-sm font-medium text-gray-900">Configurar</span>
            </div>
            <div class="w-16 h-1 bg-gray-300"></div>
            
            <!-- Step 3: Inactive -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-300 text-gray-600 font-bold">
                    3
                </div>
                <span class="ml-2 text-sm font-medium text-gray-500">Escenas</span>
            </div>
            <div class="w-16 h-1 bg-gray-300"></div>
            
            <!-- Step 4: Inactive -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-300 text-gray-600 font-bold">
                    4
                </div>
                <span class="ml-2 text-sm font-medium text-gray-500">Final</span>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex gap-6 relative">
    <div class="flex-1">
    {% if not script %}
    <!-- Processing Screen -->
    <div id="processing-screen" class="flex items-center justify-center min-h-[60vh]">
        <div class="text-center w-full max-w-3xl">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mb-8"></div>
            <h2 class="text-3xl font-bold text-gray-900 mb-4">Procesando Gui√≥n con IA...</h2>
            <p class="text-gray-600 mb-8">Nuestro agente de IA est√° analizando tu contenido</p>
            <div class="max-w-2xl mx-auto bg-blue-50 rounded-lg p-6 mb-8">
                <div id="processing-status" class="text-left space-y-2">
                    <p class="text-sm text-gray-700">‚è≥ Analizando estructura del gui√≥n...</p>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Scenes Ready Screen -->
    <div id="scenes-ready">
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-4xl font-bold text-gray-900 mb-2">Escenas Listas</h1>
                <p class="text-gray-600">Revisa y configura tus escenas generadas por IA</p>
            </div>
            <button 
                onclick="openAddSceneModal()"
                class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                A√±adir Escena
            </button>
        </div>

        <!-- Scenes Grid -->
        <div class="space-y-6 mb-8">
            {% for scene_data in scenes_with_urls %}
            {% with scene=scene_data.scene %}
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6" x-data="{ expanded: false }">
                <!-- Scene Header -->
                <div class="flex items-start gap-6">
                    <!-- Checkbox -->
                    <div class="flex items-center h-6 mt-1">
                        <input type="checkbox" 
                               id="scene-checkbox-{{ scene.id }}"
                               {% if scene.is_included %}checked{% endif %}
                               onchange="toggleSceneIncluded({{ scene.id }}, this.checked)"
                               class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    </div>

                    <!-- Preview Image -->
                    <div class="w-48 h-32 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0 relative group">
                        {% if scene.preview_image_status == 'completed' and scene_data.preview_image_url %}
                            <img src="{{ scene_data.preview_image_url }}" 
                                 alt="{{ scene.scene_id }}" 
                                 class="w-full h-full object-cover">
                            <!-- Badge de fuente de imagen -->
                            <div class="absolute top-1 right-1 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                                {% if scene.image_source == 'freepik_stock' %}
                                    üì∏ Stock
                                {% elif scene.image_source == 'user_upload' %}
                                    ‚¨ÜÔ∏è Subida
                                {% else %}
                                    ü§ñ IA
                                {% endif %}
                            </div>
                        {% elif scene.preview_image_status == 'generating' %}
                            <div class="w-full h-full flex items-center justify-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            </div>
                        {% else %}
                            <div class="w-full h-full flex items-center justify-center text-gray-400 bg-gray-100">
                                <div class="text-center">
                                    <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <p class="text-xs text-gray-500">Sin preview</p>
                                </div>
                            </div>
                        {% endif %}
                        <!-- Botones de acci√≥n (siempre visibles cuando no hay preview, o en hover si hay preview) -->
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-2 {% if not scene.preview_image_status == 'completed' or not scene_data.preview_image_url %}opacity-100{% else %}opacity-0 group-hover:opacity-100{% endif %} transition-opacity">
                            <div class="flex gap-1">
                                <button onclick="openFreepikSearch({{ scene.id }})" 
                                        class="flex-1 text-xs text-white bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded">
                                    üì∏ Stock
                                </button>
                                <button onclick="uploadCustomImage({{ scene.id }})" 
                                        class="flex-1 text-xs text-white bg-green-600 hover:bg-green-700 px-2 py-1 rounded">
                                    ‚¨ÜÔ∏è Subir
                                </button>
                                <button onclick="openGenerateAIImageModal({{ scene.id }})" 
                                        class="flex-1 text-xs text-white bg-purple-600 hover:bg-purple-700 px-2 py-1 rounded">
                                    ü§ñ IA
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Scene Info -->
                    <div class="flex-1">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">{{ scene.scene_id }}</h3>
                                <p class="text-sm text-gray-600">{{ scene.summary }}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex flex-col items-end">
                                    <label class="text-xs text-gray-500 mb-1">Duraci√≥n Video</label>
                                    <select class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded border-0 focus:ring-2 focus:ring-blue-500"
                                            id="scene-duration-select-{{ scene.id }}"
                                            onchange="handleDurationChange({{ scene.id }}, parseInt(this.value))">
                                        {% if scene.ai_service == 'gemini_veo' %}
                                            <option value="4" {% if scene.duration_sec == 4 %}selected{% endif %}>4s</option>
                                            <option value="6" {% if scene.duration_sec == 6 %}selected{% endif %}>6s</option>
                                            <option value="8" {% if scene.duration_sec == 8 %}selected{% endif %}>8s</option>
                                        {% elif scene.ai_service == 'sora' %}
                                            <option value="4" {% if scene.duration_sec == 4 %}selected{% endif %}>4s</option>
                                            <option value="8" {% if scene.duration_sec == 8 %}selected{% endif %}>8s</option>
                                            <option value="12" {% if scene.duration_sec == 12 %}selected{% endif %}>12s</option>
                                        {% else %}
                                            <option value="{{ scene.duration_sec }}" selected>{{ scene.duration_sec }}s</option>
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="flex flex-col items-end">
                                    <label class="text-xs text-gray-500 mb-1">Est. Audio</label>
                                    <span id="estimated-duration-{{ scene.id }}" class="px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded cursor-help" title="Duraci√≥n estimada del audio seg√∫n el gui√≥n (calculada autom√°ticamente). Compara con la duraci√≥n del video configurada arriba. Si el audio estimado es mayor que la duraci√≥n del video, el audio puede cortarse.">~-s</span>
                                </div>
                                <button 
                                    onclick="openInspector({{ scene.id }})"
                                    class="px-3 py-1 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 transition-colors">
                                    üîß Inspector
                                </button>
                            </div>
                        </div>

                        <!-- Script Text Preview (Click to edit in Inspector) -->
                        <div class="mt-4">
                            <label class="text-sm font-medium text-gray-700 mb-1 block">Texto del Gui√≥n</label>
                            <div class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm bg-gray-50 text-gray-700 cursor-pointer hover:border-blue-400 transition-colors"
                                 onclick="openInspector({{ scene.id }})">
                                <p class="line-clamp-3">{{ scene.script_text }}</p>
                            </div>
                            <p class="mt-1 text-xs text-blue-600">üí° Haz clic en "Inspector" para editar el gui√≥n y prompt visual</p>
                        </div>

                        <!-- Service Selector -->
                        <div class="mt-4">
                            <div class="mb-3">
                                <label class="text-sm font-medium text-gray-700 mb-1 block">Servicio IA</label>
                                <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" 
                                        data-scene-id="{{ scene.id }}"
                                        data-video-type="{{ video_type }}"
                                        onchange="changeServiceAndSave({{ scene.id }}, this.value)">
                                    {% if video_type == 'ultra' %}
                                        {# Modo Ultra: Solo Veo3 y Sora2 #}
                                        <option value="gemini_veo" {% if scene.ai_service == 'gemini_veo' %}selected{% endif %}>Gemini Veo 3</option>
                                        <option value="sora" {% if scene.ai_service == 'sora' %}selected{% endif %}>Sora 2</option>
                                    {% elif video_type == 'avatar' %}
                                        {# Con Avatares: Principalmente HeyGen, pero permitir otros #}
                                        <option value="heygen_v2" {% if scene.ai_service == 'heygen' or scene.ai_service == 'heygen_v2' %}selected{% endif %}>HeyGen Avatar V2 (Recomendado)</option>
                                        <option value="heygen_avatar_iv" {% if scene.ai_service == 'heygen_avatar_iv' %}selected{% endif %}>HeyGen Avatar IV</option>
                                        <option value="gemini_veo" {% if scene.ai_service == 'gemini_veo' %}selected{% endif %}>Gemini Veo</option>
                                        <option value="sora" {% if scene.ai_service == 'sora' %}selected{% endif %}>Sora</option>
                                        <option value="vuela_ai" {% if scene.ai_service == 'vuela_ai' %}selected{% endif %}>Vuela.ai</option>
                                    {% else %}
                                        {# Video General: Todos los servicios #}
                                        <option value="gemini_veo" {% if scene.ai_service == 'gemini_veo' %}selected{% endif %}>Gemini Veo</option>
                                        <option value="sora" {% if scene.ai_service == 'sora' %}selected{% endif %}>Sora</option>
                                        <option value="heygen_v2" {% if scene.ai_service == 'heygen' or scene.ai_service == 'heygen_v2' %}selected{% endif %}>HeyGen Avatar V2</option>
                                        <option value="heygen_avatar_iv" {% if scene.ai_service == 'heygen_avatar_iv' %}selected{% endif %}>HeyGen Avatar IV</option>
                                        <option value="vuela_ai" {% if scene.ai_service == 'vuela_ai' %}selected{% endif %}>Vuela.ai</option>
                                    {% endif %}
                                </select>
                                {% if video_type == 'ultra' %}
                                <p class="mt-1 text-xs text-blue-600">
                                    <svg class="inline w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                                    Modo Ultra: Solo Veo3 y Sora2 disponibles
                                </p>
                                {% endif %}
                            </div>
                            
                            <!-- Config Container (din√°mico) -->
                            <div id="config-{{ scene.id }}" class="grid grid-cols-2 gap-4">
                                <!-- Se llenar√° din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endwith %}
            {% endfor %}
        </div>

        <!-- Actions -->
        <div class="flex justify-between items-center">
            <a href="{% if project %}{% url 'core:project_detail' project.uuid %}{% else %}{% url 'core:dashboard' %}{% endif %}" 
               class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                Cancelar
            </a>
            <div class="flex flex-col items-end gap-2">
                <p class="text-xs text-gray-500">
                    üí° Tip: Las configuraciones se guardan autom√°ticamente
                </p>
                <a href="{% if project %}{% url 'core:agent_scenes' project.uuid %}{% else %}{% url 'core:agent_scenes_standalone' %}{% endif %}?script_id={{ script.id }}" 
                   class="px-8 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors shadow-sm">
                    Continuar a Escenas ‚Üí
                </a>
            </div>
        </div>
    {% endif %}
    </div>
    
    <!-- Inspector Panel (Right Side) -->
    <div id="inspector-panel" class="hidden fixed right-0 top-0 h-full w-1/2 bg-white shadow-2xl border-l border-gray-200 z-40 overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-900">Inspector de Escena</h3>
            <button onclick="closeInspector()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="p-4 space-y-6">
            <!-- Scene Title -->
            <div>
                <h4 id="inspector-scene-title" class="text-xl font-bold text-gray-900 mb-2"></h4>
                <p id="inspector-scene-summary" class="text-sm text-gray-600"></p>
            </div>
            
            <!-- Script Text Editor with Character Counter -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <label class="text-sm font-medium text-gray-700">üéôÔ∏è Gui√≥n/Narraci√≥n (para Audio)</label>
                    <div class="flex items-center gap-2">
                        <button type="button" 
                                onclick="toggleVoiceTagsHelp()"
                                class="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors"
                                title="Ayuda con tags de voz">
                            üé≠ Tags de Voz
                        </button>
                        <span id="inspector-char-count" class="text-xs text-gray-500">0 / 1000</span>
                    </div>
                </div>
                
                <!-- Ayuda de Tags de Voz (colapsable) -->
                <div id="voice-tags-help" class="hidden mb-3 p-3 bg-purple-50 border border-purple-200 rounded-lg text-xs">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-purple-900">üí° Tags de Voz para ElevenLabs</h4>
                        <button onclick="toggleVoiceTagsHelp()" class="text-purple-600 hover:text-purple-800">‚úï</button>
                    </div>
                    <p class="text-purple-800 mb-2">Mejora la interpretaci√≥n a√±adiendo tags de emoci√≥n y pausas:</p>
                    <div class="space-y-1 text-purple-700 mb-2">
                        <p><strong>Emociones:</strong> <code class="bg-purple-100 px-1 rounded">[Confident]</code>, <code class="bg-purple-100 px-1 rounded">[Energetic]</code>, <code class="bg-purple-100 px-1 rounded">[Whisper]</code>, <code class="bg-purple-100 px-1 rounded">[Storytelling]</code></p>
                        <p><strong>Pausas:</strong> <code class="bg-purple-100 px-1 rounded">[Pause: 0.4s]</code> (corta), <code class="bg-purple-100 px-1 rounded">[Pause: 0.6s]</code> (media), <code class="bg-purple-100 px-1 rounded">[Pause: 0.8s]</code> (larga)</p>
                        <p><strong>Ejemplo:</strong> <code class="bg-purple-100 px-1 rounded">[Confident] Hola [Pause: 0.3s] esto es un ejemplo [Energetic] ¬°genial!</code></p>
                    </div>
                    <div class="mt-2 flex flex-wrap gap-1">
                        <button onclick="insertVoiceTag('[Confident]')" class="px-2 py-1 bg-purple-200 text-purple-800 rounded text-xs hover:bg-purple-300">Confident</button>
                        <button onclick="insertVoiceTag('[Energetic]')" class="px-2 py-1 bg-purple-200 text-purple-800 rounded text-xs hover:bg-purple-300">Energetic</button>
                        <button onclick="insertVoiceTag('[Whisper]')" class="px-2 py-1 bg-purple-200 text-purple-800 rounded text-xs hover:bg-purple-300">Whisper</button>
                        <button onclick="insertVoiceTag('[Storytelling]')" class="px-2 py-1 bg-purple-200 text-purple-800 rounded text-xs hover:bg-purple-300">Storytelling</button>
                        <button onclick="insertVoiceTag('[Pause: 0.4s]')" class="px-2 py-1 bg-purple-200 text-purple-800 rounded text-xs hover:bg-purple-300">Pausa</button>
                    </div>
                </div>
                
                <textarea 
                    id="inspector-script-text"
                    rows="5"
                    maxlength="1000"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 font-mono"
                    oninput="updateCharCounter()"
                    placeholder="Texto que se narrar√° con ElevenLabs o HeyGen... Usa tags como [Confident] o [Pause: 0.4s] para mejorar la interpretaci√≥n"
                ></textarea>
                <p class="mt-1 text-xs text-gray-500">Este texto se usa para generar el audio con ElevenLabs o la voz del avatar en HeyGen. <span class="text-purple-600 font-medium">üí° Usa tags de voz para mejorar la interpretaci√≥n</span></p>
            </div>
            
            <!-- Visual Prompt Editor -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <label class="text-sm font-medium text-gray-700">üé¨ Prompt Visual (para Video)</label>
                    <span id="inspector-visual-char-count" class="text-xs text-gray-500">0 caracteres</span>
                </div>
                <textarea 
                    id="inspector-visual-prompt"
                    rows="8"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500"
                    oninput="updateVisualCharCounter()"
                    placeholder="Descripci√≥n visual cinematogr√°fica para Veo, Sora o Vuela (en ingl√©s)... ‚ú® SIN L√çMITES - S√© tan detallado como necesites para lograr la visi√≥n cinematogr√°fica perfecta"
                ></textarea>
                <p class="mt-1 text-xs text-blue-600">üí° <strong>Sin l√≠mites de caracteres.</strong> M√°s detalle = mejor resultado. Describe todos los aspectos visuales, c√°mara, iluminaci√≥n, composici√≥n, atm√≥sfera, estilo y continuidad.</p>
            </div>
            
            <!-- Voice Selector (for audio scenes) -->
            <div id="inspector-voice-section">
                <label class="text-sm font-medium text-gray-700 mb-2 block">üéôÔ∏è Voz de Narraci√≥n</label>
                <input type="hidden" id="inspector-voice-id" value="">
                <input type="hidden" id="inspector-voice-name" value="">
                
                <div id="inspector-voice-selected" class="mb-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <p class="text-sm font-bold text-green-900" id="inspector-selected-voice-name">Voz por defecto del script</p>
                            <p class="text-xs text-green-600" id="inspector-selected-voice-category">Se usar√° la voz global</p>
                        </div>
                        <button type="button" onclick="openInspectorVoiceModal()" 
                                class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                            Cambiar
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-500">Solo aplica a escenas Veo/Sora/Vuela con audio habilitado</p>
            </div>
            
            <!-- AI Service Selector -->
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Servicio IA</label>
                <select 
                    id="inspector-service-select"
                    onchange="updateInspectorConfig()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="gemini_veo">Gemini Veo</option>
                    <option value="sora">Sora</option>
                    <option value="heygen_v2">HeyGen Avatar V2</option>
                    <option value="heygen_avatar_iv">HeyGen Avatar IV</option>
                    <option value="vuela_ai">Vuela.ai</option>
                </select>
            </div>
            
            <!-- Dynamic Config Container -->
            <div id="inspector-config-container">
                <!-- Se llenar√° din√°micamente -->
            </div>
            
            <!-- Save Button -->
            <div class="sticky bottom-0 bg-white pt-4 border-t border-gray-200">
                <button 
                    onclick="saveInspectorChanges()"
                    class="w-full px-4 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors">
                    üíæ Guardar Cambios
                </button>
            </div>
        </div>
    </div>
    
    <!-- Overlay when inspector is open -->
    <div id="inspector-overlay" class="hidden fixed inset-0 bg-black bg-opacity-30 z-30" onclick="closeInspector()"></div>
    </div>
</div>

<!-- Modal para Generar Imagen con IA -->
<div id="generate-ai-image-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-900">Generar Imagen con IA</h3>
            <button onclick="closeGenerateAIImageModal()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <form onsubmit="generateAIImageFromPrompt(event)">
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-gray-700 mb-2 block">Prompt para Generar Imagen</label>
                    <textarea 
                        id="generate-ai-image-prompt"
                        rows="5"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500"
                        placeholder="Describe la imagen que quieres generar... Ej: 'Una escena de oficina moderna con personas trabajando en computadoras, iluminaci√≥n natural, estilo profesional'"
                        required
                    ></textarea>
                    <p class="mt-1 text-xs text-gray-500">Describe detalladamente la imagen que quieres como preview de la escena</p>
                </div>
            </div>
            
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="closeGenerateAIImageModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                    ü§ñ Generar Imagen
                </button>
            </div>
        </form>
    </div>
</div>

<div id="generate-ai-image-overlay" class="hidden fixed inset-0 bg-black bg-opacity-30 z-40" onclick="closeGenerateAIImageModal()"></div>

<!-- Modal para A√±adir Escena Manual (Paso 2) -->
<div id="add-scene-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-900">A√±adir Escena Manualmente</h3>
            <button onclick="closeAddSceneModal()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <form id="add-scene-form" onsubmit="saveNewScene(event)">
            <div class="space-y-4">
                <!-- Script Text -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm font-medium text-gray-700">Texto del Gui√≥n</label>
                        <span id="add-scene-char-count" class="text-xs text-gray-500">0 / 1000</span>
                    </div>
                    <textarea 
                        id="add-scene-script-text"
                        name="script_text"
                        rows="5"
                        maxlength="1000"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500"
                        oninput="updateAddSceneCharCounter()"
                        required
                    ></textarea>
                </div>
                
                <!-- Summary (opcional) -->
                <div>
                    <label class="text-sm font-medium text-gray-700 mb-2 block">Resumen (opcional)</label>
                    <input 
                        type="text"
                        id="add-scene-summary"
                        name="summary"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                        placeholder="Breve descripci√≥n de la escena">
                </div>
                
                <!-- AI Service -->
                <div>
                    <label class="text-sm font-medium text-gray-700 mb-2 block">Servicio IA</label>
                    <select 
                        id="add-scene-service"
                        name="ai_service"
                        onchange="updateAddSceneConfig()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                        required>
                        {% if video_type == 'ultra' %}
                            <option value="gemini_veo">Gemini Veo</option>
                            <option value="sora">Sora</option>
                        {% elif video_type == 'avatar' %}
                            <option value="heygen_v2">HeyGen Avatar V2</option>
                            <option value="heygen_avatar_iv">HeyGen Avatar IV</option>
                            <option value="gemini_veo">Gemini Veo</option>
                            <option value="sora">Sora</option>
                            <option value="vuela_ai">Vuela.ai</option>
                        {% else %}
                            <option value="gemini_veo">Gemini Veo</option>
                            <option value="sora">Sora</option>
                            <option value="heygen_v2">HeyGen Avatar V2</option>
                            <option value="heygen_avatar_iv">HeyGen Avatar IV</option>
                            <option value="vuela_ai">Vuela.ai</option>
                        {% endif %}
                    </select>
                </div>
                
                <!-- Dynamic Config Container -->
                <div id="add-scene-config-container">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>
            
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="closeAddSceneModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Crear Escena
                </button>
            </div>
        </form>
    </div>
</div>

{% if script %}
<script>
// ==========================================
// VARIABLES GLOBALES - DEBEN IR AL INICIO
// ==========================================
var scenesInspectorData = {};
var currentInspectorSceneId = null;
var avatarsCache = null;
var voicesCache = null;

// Obtener valores por defecto del script (si est√°n disponibles)
var scriptDefaultAvatarId = null;
var scriptDefaultVoiceId = null;
try {
    {% if script_model_preferences_json %}
    const scriptModelPrefs = {{ script_model_preferences_json|safe }};
    scriptDefaultAvatarId = scriptModelPrefs?.default_heygen_avatar_id || null;
    scriptDefaultVoiceId = scriptModelPrefs?.default_heygen_voice_id || null;
    console.log('Valores por defecto del script:', { avatar: scriptDefaultAvatarId, voice: scriptDefaultVoiceId });
    {% endif %}
} catch (e) {
    console.warn('Error obteniendo defaults del script:', e);
}

var scenesRawData = `{
    {% for scene_data in scenes_with_urls %}
    "{{ scene_data.scene.id }}": {
        "scene_id": "{{ scene_data.scene.scene_id }}",
        "summary": "{{ scene_data.scene.summary|escapejs }}",
        "script_text": "{{ scene_data.scene.script_text|escapejs }}",
        "visual_prompt": "{{ scene_data.scene.visual_prompt|default:""|escapejs }}",
        "ai_service": "{{ scene_data.scene.ai_service }}",
        "ai_config": {{ scene_data.ai_config_json|safe }},
        "duration_sec": {{ scene_data.scene.duration_sec }},
        "audio_voice_id": "{{ scene_data.scene.audio_voice_id|default:"" }}",
        "audio_voice_name": "{{ scene_data.scene.audio_voice_name|default:"" }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
}`;

console.log('Raw scenes data:', scenesRawData);

try {
    scenesInspectorData = JSON.parse(scenesRawData);
    console.log('‚úì scenesInspectorData inicializado correctamente con', Object.keys(scenesInspectorData).length, 'escenas');
} catch(e) {
    console.error('‚ùå Error inicializando scenesInspectorData:', e);
    console.error('Raw data que caus√≥ el error:', scenesRawData);
    scenesInspectorData = {};
}

// ==================
// FUNCIONES GLOBALES (deben estar antes de cualquier uso en onclick/onchange)
// ==================

// Abrir inspector (FUNCI√ìN GLOBAL - debe estar disponible antes de que se renderice el HTML)
function openInspector(sceneId) {
    console.log('üîµ [openInspector] Iniciando apertura del inspector para escena:', sceneId);
    console.log('üîµ [openInspector] typeof scenesInspectorData:', typeof scenesInspectorData);
    console.log('üîµ [openInspector] scenesInspectorData keys:', scenesInspectorData ? Object.keys(scenesInspectorData) : 'null');
    
    try {
        // Verificar que scenesInspectorData existe
        if (!scenesInspectorData || typeof scenesInspectorData !== 'object') {
            console.error('‚ùå [openInspector] scenesInspectorData no est√° disponible');
            alert('Error: Los datos de las escenas no est√°n disponibles. Por favor recarga la p√°gina.');
            return;
        }
        
        console.log('üîµ [openInspector] Available scenes:', Object.keys(scenesInspectorData));
        
        // Verificar que la escena existe
        currentInspectorSceneId = sceneId;
        const scene = scenesInspectorData[sceneId];
        
        if (!scene) {
            console.error('‚ùå [openInspector] Escena no encontrada:', sceneId);
            console.error('‚ùå [openInspector] scenesInspectorData completo:', scenesInspectorData);
            alert(`Error: No se encontr√≥ la escena ${sceneId} en los datos. Escenas disponibles: ${Object.keys(scenesInspectorData).join(', ')}`);
            return;
        }
        
        console.log('üîµ [openInspector] Escena encontrada:', scene);
        
        // Verificar que el panel existe ANTES de intentar llenarlo
        const panelEl = document.getElementById('inspector-panel');
        const overlayEl = document.getElementById('inspector-overlay');
        
        if (!panelEl) {
            console.error('‚ùå [openInspector] Panel del inspector no encontrado en el DOM');
            console.error('‚ùå [openInspector] Buscando elemento con id="inspector-panel"');
            alert('Error: No se encontr√≥ el panel del inspector. Por favor recarga la p√°gina.');
            return;
        }
        
        if (!overlayEl) {
            console.error('‚ùå [openInspector] Overlay del inspector no encontrado en el DOM');
            alert('Error: No se encontr√≥ el overlay del inspector. Por favor recarga la p√°gina.');
            return;
        }
        
        console.log('‚úì [openInspector] Panel y overlay encontrados');
        
        // Llenar datos del inspector
        const titleEl = document.getElementById('inspector-scene-title');
        const summaryEl = document.getElementById('inspector-scene-summary');
        const scriptTextEl = document.getElementById('inspector-script-text');
        const visualPromptEl = document.getElementById('inspector-visual-prompt');
        const serviceSelectEl = document.getElementById('inspector-service-select');
        
        if (!titleEl || !summaryEl || !scriptTextEl || !visualPromptEl || !serviceSelectEl) {
            console.error('‚ùå [openInspector] Elementos del inspector no encontrados:', {
                titleEl: !!titleEl,
                summaryEl: !!summaryEl,
                scriptTextEl: !!scriptTextEl,
                visualPromptEl: !!visualPromptEl,
                serviceSelectEl: !!serviceSelectEl
            });
            // Continuar de todas formas, algunos elementos pueden ser opcionales
        }
        
        if (titleEl) titleEl.textContent = scene.scene_id || '';
        if (summaryEl) summaryEl.textContent = scene.summary || '';
        if (scriptTextEl) scriptTextEl.value = scene.script_text || '';
        if (visualPromptEl) visualPromptEl.value = scene.visual_prompt || '';
        if (serviceSelectEl) serviceSelectEl.value = scene.ai_service || 'gemini_veo';
        
        // Llenar datos de voz
        const voiceIdEl = document.getElementById('inspector-voice-id');
        const voiceNameEl = document.getElementById('inspector-voice-name');
        if (voiceIdEl) voiceIdEl.value = scene.audio_voice_id || '';
        if (voiceNameEl) voiceNameEl.value = scene.audio_voice_name || '';
        
        const selectedVoiceNameEl = document.getElementById('inspector-selected-voice-name');
        const selectedVoiceCategoryEl = document.getElementById('inspector-selected-voice-category');
        if (selectedVoiceNameEl && selectedVoiceCategoryEl) {
            if (scene.audio_voice_name) {
                selectedVoiceNameEl.textContent = scene.audio_voice_name;
                selectedVoiceCategoryEl.textContent = 'Voz personalizada para esta escena';
            } else {
                selectedVoiceNameEl.textContent = 'Voz por defecto del script';
                selectedVoiceCategoryEl.textContent = 'Se usar√° la voz global';
            }
        }
        
        // Actualizar contadores de caracteres (solo si existen)
        try {
            if (typeof updateCharCounter === 'function') {
                updateCharCounter();
            }
        } catch(e) {
            console.warn('‚ö†Ô∏è [openInspector] Error actualizando contadores:', e);
        }
        
        // Actualizar duraci√≥n estimada en el inspector
        const inspectorDurationSec = scene.duration_sec || 8;
        updateSceneEstimatedDuration(sceneId, scene.script_text || '', inspectorDurationSec);
        
        // Mostrar panel
        panelEl.classList.remove('hidden');
        overlayEl.classList.remove('hidden');
        
        // Actualizar configuraci√≥n del inspector seg√∫n el servicio
        try {
            if (typeof updateInspectorConfig === 'function') {
                // Esperar un momento para que el DOM est√© completamente renderizado
                setTimeout(() => {
                    updateInspectorConfig();
                }, 50);
            }
        } catch(e) {
            console.warn('‚ö†Ô∏è [openInspector] Error actualizando configuraci√≥n:', e);
        }
        
        console.log('‚úì [openInspector] Inspector abierto correctamente');
    } catch (error) {
        console.error('‚ùå [openInspector] Error:', error);
        alert('Error al abrir el inspector: ' + error.message);
    }
}

// Cerrar inspector (FUNCI√ìN GLOBAL)
function closeInspector() {
    try {
        const panelEl = document.getElementById('inspector-panel');
        const overlayEl = document.getElementById('inspector-overlay');
        
        if (panelEl) {
            panelEl.classList.add('hidden');
        }
        
        if (overlayEl) {
            overlayEl.classList.add('hidden');
        }
        
        currentInspectorSceneId = null;
        console.log('‚úì Inspector cerrado');
    } catch (error) {
        console.error('‚ùå [closeInspector] Error:', error);
        // No mostrar alert, solo loggear
    }
}

// ==================
// FUNCIONES DE C√ÅLCULO DE DURACI√ìN (GLOBALES)
// ==================

// Funci√≥n para calcular duraci√≥n estimada seg√∫n el gui√≥n
function calculateEstimatedDurationFromText(text, durationSec) {
    if (!text || !text.trim()) {
        return null;
    }
    
    // Contar palabras
    const words = text.trim().split(/\s+/).filter(word => word.length > 0);
    const wordCount = words.length;
    
    // Velocidad de narraci√≥n: 2.5 palabras por segundo (espa√±ol)
    const WORDS_PER_SECOND = 2.5;
    const estimatedSeconds = wordCount / WORDS_PER_SECOND;
    
    return {
        wordCount: wordCount,
        estimatedSeconds: estimatedSeconds,
        configuredSeconds: durationSec,
        difference: estimatedSeconds - durationSec,
        isValid: Math.abs(estimatedSeconds - durationSec) <= (durationSec * 0.1) // ¬±10% de margen
    };
}

// Funci√≥n para actualizar la duraci√≥n estimada en una card de escena (GLOBAL)
function updateSceneEstimatedDuration(sceneId, scriptText, durationSec) {
    const result = calculateEstimatedDurationFromText(scriptText, durationSec);
    const badgeElement = document.getElementById(`estimated-duration-${sceneId}`);
    
    if (!badgeElement) {
        console.warn(`‚ö†Ô∏è Badge de duraci√≥n estimada no encontrado para escena ${sceneId}`);
        return;
    }
    
    if (!result) {
        console.warn(`‚ö†Ô∏è No se pudo calcular duraci√≥n estimada para escena ${sceneId}`);
        badgeElement.textContent = '-';
        badgeElement.className = 'px-2 py-1 bg-gray-100 text-gray-600 text-xs font-medium rounded';
        return;
    }
    
    const estimatedSec = Math.round(result.estimatedSeconds);
    const diff = result.difference;
    const diffPercent = ((diff / durationSec) * 100).toFixed(0);
    
    // Determinar color seg√∫n si est√° dentro del rango v√°lido
    let badgeClass = 'bg-green-100 text-green-800';
    let badgeText = `~${estimatedSec}s`;
    
    if (diff > durationSec * 0.1) {
        // Texto demasiado largo (supera el tiempo)
        badgeClass = 'bg-red-100 text-red-800';
        badgeText = `~${estimatedSec}s ‚ö†Ô∏è`;
    } else if (diff < -(durationSec * 0.1)) {
        // Texto demasiado corto
        badgeClass = 'bg-yellow-100 text-yellow-800';
        badgeText = `~${estimatedSec}s`;
    }
    
    badgeElement.className = `px-2 py-1 ${badgeClass} text-xs font-medium rounded`;
    badgeElement.textContent = badgeText;
    badgeElement.title = `${result.wordCount} palabras ‚Üí ~${estimatedSec}s (configurado: ${durationSec}s, diferencia: ${diffPercent > 0 ? '+' : ''}${diffPercent}%)`;
}

// Script ya procesado, mostrar escenas
document.addEventListener('DOMContentLoaded', function() {
    console.log('Script procesado, mostrando escenas');
    console.log('scenesInspectorData:', scenesInspectorData);
    
    // Inicializar configuraciones de cada escena
    {% for scene_data in scenes_with_urls %}
    (function() {
        // Usar IIFE para evitar redeclaraci√≥n de sceneId
        const sceneId = {{ scene_data.scene.id }};
        updateServiceConfig(sceneId, '{{ scene_data.scene.ai_service }}');
        
        // Calcular y mostrar duraci√≥n estimada para cada escena
        const sceneData = scenesInspectorData[sceneId];
        
        if (sceneData) {
            const scriptText = sceneData.script_text || '';
            const durationSec = sceneData.duration_sec || {{ scene_data.scene.duration_sec }};
            
            console.log(`üîµ Calculando duraci√≥n estimada para escena ${sceneId}:`, {
                scriptText: scriptText.substring(0, 50) + (scriptText.length > 50 ? '...' : ''),
                durationSec: durationSec,
                wordCount: scriptText.trim().split(/\s+/).filter(w => w.length > 0).length
            });
            
            // Llamar inmediatamente
            updateSceneEstimatedDuration(sceneId, scriptText, durationSec);
            
            // Tambi√©n verificar despu√©s de un peque√±o delay por si acaso
            setTimeout(() => {
                const badgeEl = document.getElementById(`estimated-duration-${sceneId}`);
                if (badgeEl && badgeEl.textContent === '-') {
                    console.warn(`‚ö†Ô∏è Badge a√∫n muestra "-" para escena ${sceneId}, reintentando...`);
                    updateSceneEstimatedDuration(sceneId, scriptText, durationSec);
                }
            }, 100);
        } else {
            console.warn(`‚ö†Ô∏è No se encontraron datos para escena ${sceneId} en scenesInspectorData`);
            console.warn(`   Escenas disponibles:`, Object.keys(scenesInspectorData));
        }
    })();
    {% endfor %}
    
    // Cargar avatares y voces de HeyGen (solo una vez gracias al cache)
    loadHeyGenAssets();
    
    console.log('‚úì DOMContentLoaded completado');
    console.log('‚úì Total de escenas procesadas:', Object.keys(scenesInspectorData).length);
});

// ==================
// FUNCIONES GLOBALES (deben estar fuera de DOMContentLoaded para estar disponibles en onclick/onchange)
// ==================

// Funci√≥n para manejar cambios de duraci√≥n en las cards
function handleDurationChange(sceneId, newDuration) {
    console.log(`Cambiando duraci√≥n de escena ${sceneId} a ${newDuration}s`);
    
    // Guardar configuraci√≥n
    saveSceneAiConfig(sceneId, 'duration', newDuration);
    
    // Actualizar scenesInspectorData
    if (scenesInspectorData[sceneId]) {
        scenesInspectorData[sceneId].duration_sec = newDuration;
        
        // Recalcular duraci√≥n estimada
        const sceneData = scenesInspectorData[sceneId];
        const scriptText = sceneData.script_text || '';
        updateSceneEstimatedDuration(sceneId, scriptText, newDuration);
    }
}

// Cambiar servicio y guardar (FUNCI√ìN GLOBAL)
function changeServiceAndSave(sceneId, service) {
    console.log(`üîµ [changeServiceAndSave] Cambiando servicio de escena ${sceneId} a ${service}`);
    if (typeof updateServiceConfig === 'function') {
        updateServiceConfig(sceneId, service);
    } else {
        console.error('‚ùå updateServiceConfig no est√° definida');
    }
    if (typeof saveSceneConfig === 'function') {
        saveSceneConfig(sceneId, { ai_service: service });
    } else {
        console.error('‚ùå saveSceneConfig no est√° definida');
    }
}

// Actualizar configuraci√≥n seg√∫n el servicio seleccionado (FUNCI√ìN GLOBAL)
function updateServiceConfig(sceneId, service) {
    const container = document.getElementById(`config-${sceneId}`);
    if (!container) {
        console.warn(`‚ö†Ô∏è [updateServiceConfig] Container config-${sceneId} no encontrado (puede ser normal si es inspector)`);
        return; // Puede ser normal si se llama desde el inspector
    }
    container.innerHTML = ''; // Limpiar contenido anterior
    
    // Obtener orientaci√≥n heredada del script
    const videoOrientation = '{{ video_orientation }}';
    
    if (service === 'gemini_veo') {
        // Obtener duraci√≥n guardada o usar duration_sec del modelo
        const sceneData = scenesInspectorData[sceneId] || {};
        const config = sceneData.ai_config || {};
        const durationFromModel = parseInt(sceneData.duration_sec);
        const durationFromConfig = parseInt(config.duration);
        const duration = (!isNaN(durationFromModel) && durationFromModel > 0) ? durationFromModel : 
                        (!isNaN(durationFromConfig) && durationFromConfig > 0) ? durationFromConfig : 8;
        
        container.innerHTML = `
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Duraci√≥n</label>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                        id="scene-duration-${sceneId}"
                        onchange="handleDurationChange(${sceneId}, parseInt(this.value))">
                    <option value="4" ${duration === 4 ? 'selected' : ''}>4s</option>
                    <option value="6" ${duration === 6 ? 'selected' : ''}>6s</option>
                    <option value="8" ${duration === 8 ? 'selected' : ''}>8s</option>
                </select>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Orientaci√≥n (Heredada)</label>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50"
                        onchange="saveSceneAiConfig(${sceneId}, 'aspect_ratio', this.value)" disabled>
                    <option value="16:9" ${videoOrientation === '16:9' ? 'selected' : ''}>Horizontal (16:9)</option>
                    <option value="9:16" ${videoOrientation === '9:16' ? 'selected' : ''}>Vertical (9:16)</option>
                </select>
                <p class="mt-1 text-xs text-gray-500">Configurado en Paso 1</p>
            </div>
        `;
    } else if (service === 'sora') {
        // Determinar tama√±o seg√∫n orientaci√≥n
        const soraSize = videoOrientation === '9:16' ? '720x1280' : '1280x720';
        const soraLabel = videoOrientation === '9:16' ? 'Vertical (9:16)' : 'Horizontal (16:9)';
        
        // Obtener duraci√≥n guardada o usar duration_sec del modelo
        const sceneData = scenesInspectorData[sceneId] || {};
        const config = sceneData.ai_config || {};
        const durationFromModel = parseInt(sceneData.duration_sec);
        const durationFromConfig = parseInt(config.duration);
        const duration = (!isNaN(durationFromModel) && durationFromModel > 0) ? durationFromModel : 
                        (!isNaN(durationFromConfig) && durationFromConfig > 0) ? durationFromConfig : 8;
        
        container.innerHTML = `
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Duraci√≥n</label>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                        id="scene-duration-${sceneId}"
                        onchange="handleDurationChange(${sceneId}, parseInt(this.value))">
                    <option value="4" ${duration === 4 ? 'selected' : ''}>4s</option>
                    <option value="8" ${duration === 8 ? 'selected' : ''}>8s</option>
                    <option value="12" ${duration === 12 ? 'selected' : ''}>12s</option>
                </select>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Tama√±o (Heredado)</label>
                <input type="text" 
                       value="${soraSize} (${soraLabel})" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50" 
                       disabled>
                <p class="mt-1 text-xs text-gray-500">Configurado en Paso 1</p>
            </div>
        `;
    } else if (service === 'heygen' || service === 'heygen_v2' || service === 'heygen_avatar_iv') {
        const orientationLabel = videoOrientation === '9:16' ? 'Vertical (9:16)' : 'Horizontal (16:9)';
        
        container.innerHTML = `
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Avatar</label>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" 
                        data-scene-id="${sceneId}" 
                        data-config-field="avatar_id">
                    <option value="">Cargando avatares...</option>
                </select>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Voz</label>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                        data-scene-id="${sceneId}" 
                        data-config-field="voice_id">
                    <option value="">Cargando voces...</option>
                </select>
            </div>
            <div class="col-span-2">
                <label class="text-sm font-medium text-gray-700 mb-1 block">Orientaci√≥n (Heredada)</label>
                <input type="text" 
                       value="${orientationLabel}" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50" 
                       disabled>
                <p class="mt-1 text-xs text-gray-500">Configurado en Paso 1</p>
            </div>
        `;
        
        // Recargar avatares y voces para esta escena (usa cache si est√° disponible)
        // Los eventos onchange se a√±aden autom√°ticamente en populateAvatarSelects y populateVoiceSelects
        if (avatarsCache) {
            populateAvatarSelects(avatarsCache);
        } else {
            // Si no hay cache, esperar a que se carguen
            setTimeout(() => {
                if (avatarsCache) populateAvatarSelects(avatarsCache);
            }, 1000);
        }
        
        if (voicesCache) {
            populateVoiceSelects(voicesCache);
        } else {
            // Si no hay cache, esperar a que se carguen
            setTimeout(() => {
                if (voicesCache) populateVoiceSelects(voicesCache);
            }, 1000);
        }
    } else if (service === 'vuela_ai') {
        const orientationLabel = videoOrientation === '9:16' ? 'Vertical (9:16)' : 'Horizontal (16:9)';
        
        container.innerHTML = `
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Voz</label>
                <input type="text" 
                       placeholder="Voice ID de Vuela.ai" 
                       value=""
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                       onchange="saveSceneAiConfig(${sceneId}, 'voice_id', this.value)">
                <p class="mt-1 text-xs text-gray-500">Ingresa el ID de voz desde Vuela.ai</p>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Estilo de Voz</label>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                        onchange="saveSceneAiConfig(${sceneId}, 'voice_style', this.value)">
                    <option value="narrative">Narrativo</option>
                    <option value="expressive" selected>Expresivo</option>
                    <option value="dynamic">Din√°mico</option>
                </select>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Tipo de Animaci√≥n</label>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                        onchange="saveSceneAiConfig(${sceneId}, 'animation_type', this.value)">
                    <option value="moving_image" selected>Efecto Ken Burns</option>
                    <option value="ai_video">Animaci√≥n IA</option>
                </select>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-1 block">Estilo Visual</label>
                <select class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                        onchange="saveSceneAiConfig(${sceneId}, 'style', this.value)">
                    <option value="photorealistic" selected>Fotorealista</option>
                    <option value="flat_design">Dise√±o Plano</option>
                    <option value="anime">Anime</option>
                    <option value="3d">3D</option>
                    <option value="watercolor">Acuarela</option>
                    <option value="comic">C√≥mic</option>
                </select>
            </div>
            <div class="col-span-2">
                <label class="text-sm font-medium text-gray-700 mb-1 block">Orientaci√≥n (Heredada)</label>
                <input type="text" 
                       value="${orientationLabel}" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50" 
                       disabled>
                <p class="mt-1 text-xs text-gray-500">Configurado en Paso 1</p>
            </div>
        `;
    }
}

// Guardar configuraci√≥n de escena
// Guardar configuraci√≥n de escena (FUNCI√ìN GLOBAL)
async function saveSceneConfig(sceneId, data) {
    try {
        const response = await fetch(`/scenes/${sceneId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.status === 'success') {
            // Actualizar scenesInspectorData localmente
            if (!scenesInspectorData[sceneId]) {
                scenesInspectorData[sceneId] = {};
            }
            
            // Actualizar campos seg√∫n lo que se guard√≥
            if (data.script_text !== undefined) {
                scenesInspectorData[sceneId].script_text = data.script_text;
            }
            if (data.duration_sec !== undefined) {
                scenesInspectorData[sceneId].duration_sec = data.duration_sec;
            }
            if (data.ai_config !== undefined) {
                scenesInspectorData[sceneId].ai_config = {
                    ...(scenesInspectorData[sceneId].ai_config || {}),
                    ...data.ai_config
                };
            }
            
            // Recalcular duraci√≥n estimada si cambi√≥ el texto o la duraci√≥n
            const sceneData = scenesInspectorData[sceneId];
            if (sceneData && (data.script_text !== undefined || data.duration_sec !== undefined || data.ai_config?.duration !== undefined)) {
                const scriptText = sceneData.script_text || '';
                const durationSec = data.duration_sec || 
                                  (data.ai_config?.duration ? parseInt(data.ai_config.duration) : null) ||
                                  sceneData.duration_sec || 8;
                updateSceneEstimatedDuration(sceneId, scriptText, durationSec);
            }
            
            // Mostrar indicador visual temporal
            showSaveIndicator(sceneId);
        } else {
            console.error(`Error al guardar configuraci√≥n:`, result.message);
            alert(`Error al guardar configuraci√≥n: ${result.message}`);
        }
    } catch (error) {
        console.error(`Error al guardar configuraci√≥n:`, error);
        alert(`Error de conexi√≥n al guardar configuraci√≥n`);
    }
}

// Mostrar indicador visual de guardado
function showSaveIndicator(sceneId) {
    const card = document.querySelector(`[data-scene-id="${sceneId}"]`)?.closest('.bg-white');
    if (card) {
        card.classList.add('ring-2', 'ring-green-500');
        setTimeout(() => {
            card.classList.remove('ring-2', 'ring-green-500');
        }, 1000);
    }
}

// Guardar configuraci√≥n espec√≠fica de AI
// Guardar configuraci√≥n AI de escena (FUNCI√ìN GLOBAL)
function saveSceneAiConfig(sceneId, key, value) {
    const aiConfig = {};
    aiConfig[key] = value;
    saveSceneConfig(sceneId, { ai_config: aiConfig });
}

// Funci√≥n para actualizar is_included cuando se marca/desmarca el checkbox
function toggleSceneIncluded(sceneId, isIncluded) {
    saveSceneConfig(sceneId, { is_included: isIncluded });
    console.log(`Escena ${sceneId} ${isIncluded ? 'incluida' : 'excluida'} del video final`);
}

// Cargar avatares y voces de HeyGen
async function loadHeyGenAssets() {
    await Promise.all([
        loadAvatars(),
        loadVoices()
    ]);
}

async function loadAvatars(retryCount = 0) {
    // Usar cache si existe
    if (avatarsCache) {
        populateAvatarSelects(avatarsCache);
        return;
    }
    
    const selects = document.querySelectorAll('[data-config-field="avatar_id"]');
    const maxRetries = 2;
    const loadingMsg = retryCount > 0 
        ? `Reintentando avatares (${retryCount}/${maxRetries})...`
        : 'Cargando avatares...';
    
    selects.forEach(select => {
        select.innerHTML = `<option value="">${loadingMsg}</option>`;
    });
    
    try {
        const response = await fetch('{% url "core:api_list_avatars" %}');
        const data = await response.json();
        
        // Verificar si hay error en la respuesta
        if (data.error && data.avatars.length === 0) {
            throw new Error(data.error);
        }
        
        avatarsCache = data.avatars; // Guardar en cache
        populateAvatarSelects(data.avatars);
        
        // Log si es data cacheada del servidor
        if (data.cached) {
            console.log('Avatares cargados desde cach√© del servidor');
        }
    } catch (error) {
        console.error('Error cargando avatares:', error);
        
        // Reintentar autom√°ticamente si no hemos alcanzado el m√°ximo
        if (retryCount < maxRetries) {
            setTimeout(() => loadAvatars(retryCount + 1), 2000);
        } else {
            selects.forEach(select => {
                select.innerHTML = '<option value="">‚ö†Ô∏è Error. Recarga la p√°gina</option>';
            });
        }
    }
}

async function loadVoices(retryCount = 0) {
    // Usar cache si existe
    if (voicesCache) {
        populateVoiceSelects(voicesCache);
        return;
    }
    
    const selects = document.querySelectorAll('[data-config-field="voice_id"]');
    const maxRetries = 2;
    const loadingMsg = retryCount > 0 
        ? `Reintentando voces (${retryCount}/${maxRetries})...`
        : 'Cargando voces...';
    
    selects.forEach(select => {
        select.innerHTML = `<option value="">${loadingMsg}</option>`;
    });
    
    try {
        const response = await fetch('{% url "core:api_list_voices" %}');
        const data = await response.json();
        
        // Verificar si hay error en la respuesta
        if (data.error && data.voices.length === 0) {
            throw new Error(data.error);
        }
        
        voicesCache = data.voices; // Guardar en cache
        populateVoiceSelects(data.voices);
        
        // Log si es data cacheada del servidor
        if (data.cached) {
            console.log('Voces cargadas desde cach√© del servidor');
        }
    } catch (error) {
        console.error('Error cargando voces:', error);
        
        // Reintentar autom√°ticamente si no hemos alcanzado el m√°ximo
        if (retryCount < maxRetries) {
            setTimeout(() => loadVoices(retryCount + 1), 2000);
        } else {
            selects.forEach(select => {
                select.innerHTML = '<option value="">‚ö†Ô∏è Error. Recarga la p√°gina</option>';
            });
        }
    }
}

function populateAvatarSelects(avatars) {
    const avatarSelects = document.querySelectorAll('[data-config-field="avatar_id"]');
    
    // Obtener avatar por defecto del paso 1 (desde sessionStorage o desde el script)
    let defaultAvatarId = null;
    try {
        const agentContent = JSON.parse(sessionStorage.getItem('agentContent') || '{}');
        defaultAvatarId = agentContent.default_heygen_avatar_id || 
                         agentContent.model_preferences?.default_heygen_avatar_id || 
                         scriptDefaultAvatarId ||  // Desde el script
                         null;
    } catch (e) {
        console.warn('Error obteniendo avatar por defecto:', e);
        // Fallback al valor del script
        defaultAvatarId = scriptDefaultAvatarId || null;
    }
    
    avatarSelects.forEach(select => {
        const sceneId = select.dataset.sceneId;
        const sceneData = scenesInspectorData[sceneId] || {};
        const config = sceneData.ai_config || {};
        // Usar avatar guardado o el por defecto del paso 1
        const savedAvatarId = config.avatar_id || defaultAvatarId || '';
        
        select.innerHTML = '<option value="">Selecciona un avatar</option>';
        
        avatars.forEach(avatar => {
            const option = document.createElement('option');
            option.value = avatar.avatar_id;
            option.textContent = avatar.avatar_name || avatar.avatar_id;
            // Agregar preview como data attribute para poder mostrarlo despu√©s
            if (avatar.preview_image_url) {
                option.dataset.previewImage = avatar.preview_image_url;
            }
            if (avatar.preview_video_url) {
                option.dataset.previewVideo = avatar.preview_video_url;
            }
            if (savedAvatarId && avatar.avatar_id === savedAvatarId) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // Si no hay avatar guardado pero hay uno por defecto, aplicarlo autom√°ticamente
        if (!config.avatar_id && defaultAvatarId) {
            // Seleccionar el avatar por defecto
            select.value = defaultAvatarId;
            // Guardar autom√°ticamente
            saveSceneAiConfig(sceneId, 'avatar_id', defaultAvatarId);
            // Disparar evento change para mostrar preview
            select.dispatchEvent(new Event('change'));
        }
        
        // Agregar preview de avatar cuando se selecciona
        select.onchange = function() {
            const avatarId = this.value;
            const selectedOption = this.options[this.selectedIndex];
            const previewImage = selectedOption.dataset.previewImage;
            const previewVideo = selectedOption.dataset.previewVideo;
            
            // Mostrar preview si existe
            let previewContainer = select.parentElement.querySelector('.avatar-preview-container');
            if (!previewContainer && (previewImage || previewVideo)) {
                previewContainer = document.createElement('div');
                previewContainer.className = 'avatar-preview-container mt-2 rounded-lg overflow-hidden bg-gray-100';
                previewContainer.style.cssText = 'width: 100%; aspect-ratio: 16/9; max-width: 300px;';
                select.parentElement.appendChild(previewContainer);
            }
            
            if (previewContainer) {
                if (previewVideo) {
                    previewContainer.innerHTML = `<video src="${previewVideo}" class="w-full h-full object-cover" muted loop playsinline></video>`;
                } else if (previewImage) {
                    previewContainer.innerHTML = `<img src="${previewImage}" alt="Avatar preview" class="w-full h-full object-cover">`;
                } else {
                    previewContainer.innerHTML = '';
                }
            }
            
            // Guardar avatar_id
            if (avatarId) {
                saveSceneAiConfig(sceneId, 'avatar_id', avatarId);
            }
        };
        
        // Mostrar preview del avatar seleccionado inicialmente
        if (savedAvatarId) {
            const savedOption = Array.from(select.options).find(opt => opt.value === savedAvatarId);
            if (savedOption) {
                select.dispatchEvent(new Event('change'));
            }
        }
        
    });
}

function populateVoiceSelects(voices) {
    const voiceSelects = document.querySelectorAll('[data-config-field="voice_id"]');
    
    // Obtener voz por defecto del paso 1 (desde sessionStorage o desde el script)
    let defaultVoiceId = null;
    try {
        const agentContent = JSON.parse(sessionStorage.getItem('agentContent') || '{}');
        defaultVoiceId = agentContent.default_heygen_voice_id || 
                        agentContent.model_preferences?.default_heygen_voice_id || 
                        scriptDefaultVoiceId ||  // Desde el script
                        null;
    } catch (e) {
        console.warn('Error obteniendo voz por defecto:', e);
        // Fallback al valor del script
        defaultVoiceId = scriptDefaultVoiceId || null;
    }
    
    voiceSelects.forEach(select => {
        const sceneId = select.dataset.sceneId;
        const sceneData = scenesInspectorData[sceneId] || {};
        const config = sceneData.ai_config || {};
        // Usar voz guardada o la por defecto del paso 1
        const savedVoiceId = config.voice_id || defaultVoiceId || '';
        
        
        select.innerHTML = '<option value="">Selecciona una voz</option>';
        
        voices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.voice_id;
            // Arreglar nombres undefined - usar name o display_name o un fallback
            const voiceName = voice.name || voice.display_name || voice.voice_name || `Voz ${voice.voice_id?.substring(0, 8) || 'Desconocida'}`;
            const language = voice.language || 'Desconocido';
            option.textContent = `${voiceName} (${language})`;
            if (savedVoiceId && voice.voice_id === savedVoiceId) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // Si no hay voz guardada pero hay una por defecto, aplicarla autom√°ticamente
        if (!config.voice_id && defaultVoiceId) {
            // Seleccionar la voz por defecto
            select.value = defaultVoiceId;
            // Guardar autom√°ticamente
            saveSceneAiConfig(sceneId, 'voice_id', defaultVoiceId);
        }
        
        // A√±adir evento onchange para guardar autom√°ticamente
        select.onchange = function() {
            const voiceId = this.value;
            if (voiceId) {
                saveSceneAiConfig(sceneId, 'voice_id', voiceId);
            }
        };
    });
}

// ==================
// FREEPIK INTEGRATION
// ==================

let currentSceneForImageSearch = null;

function openFreepikSearch(sceneId) {
    currentSceneForImageSearch = sceneId;
    
    // Crear modal de b√∫squeda de Freepik
    const modal = document.createElement('div');
    modal.id = 'freepik-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-900">Buscar Imagen en Freepik Stock</h3>
                <button onclick="closeFreepikModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="p-4 border-b border-gray-200">
                <div class="flex gap-2 mb-3">
                    <input type="text" 
                           id="freepik-search-input"
                           placeholder="Buscar im√°genes..."
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           onkeypress="if(event.key==='Enter'){event.preventDefault(); searchFreepik();}">
                    <button type="button" onclick="event.preventDefault(); searchFreepik();" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Buscar
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700">Filtrar por:</label>
                    <select id="freepik-license-filter" 
                            onchange="searchFreepik()"
                            class="px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500">
                        <option value="all">Todas las im√°genes</option>
                        <option value="free">Solo gratuitas</option>
                        <option value="premium">Solo Premium</option>
                    </select>
                </div>
            </div>
            
            <div id="freepik-results" class="flex-1 overflow-y-auto p-4">
                <p class="text-gray-500 text-center py-8">Ingresa un t√©rmino de b√∫squeda</p>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.getElementById('freepik-search-input').focus();
}

function closeFreepikModal() {
    const modal = document.getElementById('freepik-modal');
    if (modal) {
        modal.remove();
    }
}

// Variables globales para paginaci√≥n de Freepik
let freepikCurrentPage = 1;
let freepikCurrentQuery = '';
let freepikTotalResults = 0;
let freepikHasMore = false;

async function searchFreepik(page = 1, append = false) {
    const query = document.getElementById('freepik-search-input').value.trim();
    if (!query) return;
    
    // Si es una nueva b√∫squeda, resetear
    if (!append || query !== freepikCurrentQuery) {
        freepikCurrentPage = 1;
        freepikCurrentQuery = query;
        page = 1;
        append = false;
    }
    
    const resultsDiv = document.getElementById('freepik-results');
    if (!append) {
        resultsDiv.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div></div>';
    } else {
        // Mostrar loading en el bot√≥n "Cargar m√°s"
        const loadMoreBtn = document.getElementById('freepik-load-more-btn');
        if (loadMoreBtn) {
            loadMoreBtn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';
            loadMoreBtn.disabled = true;
        }
    }
    
    try {
        const orientation = '{{ video_orientation }}' === '9:16' ? 'vertical' : 'horizontal';
        const licenseFilter = document.getElementById('freepik-license-filter').value;
        const response = await fetch(`{% url 'core:freepik_search_images' %}?query=${encodeURIComponent(query)}&orientation=${orientation}&limit=20&page=${page}&license=${licenseFilter}`);
        const data = await response.json();
        
        if (data.status === 'success' && data.results && data.results.length > 0) {
            // Actualizar estado de paginaci√≥n
            freepikCurrentPage = page;
            freepikTotalResults = data.meta?.total || 0;
            const currentPage = data.meta?.current_page || page;
            const lastPage = data.meta?.last_page || 1;
            freepikHasMore = currentPage < lastPage;
            
            // Crear o obtener el grid
            let gridDiv;
            if (append) {
                gridDiv = document.querySelector('#freepik-results .grid');
                if (!gridDiv) {
                    gridDiv = document.createElement('div');
                    gridDiv.className = 'grid grid-cols-3 gap-4';
                    resultsDiv.innerHTML = '';
                    resultsDiv.appendChild(gridDiv);
                }
            } else {
                gridDiv = document.createElement('div');
                gridDiv.className = 'grid grid-cols-3 gap-4';
            }
            
            data.results.filter(img => img.thumbnail || img.preview).forEach((img, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'relative group cursor-pointer transition-transform hover:scale-105';
                
                // Escapar y validar datos
                const imgId = String(img.id || '');
                const downloadUrl = String(img.download_url || img.preview || '');
                const thumbnail = String(img.thumbnail || img.preview || '');
                const title = String(img.title || 'Sin t√≠tulo');
                const isPremium = img.is_premium === true;
                
                // Crear elemento de imagen
                const imgElement = document.createElement('img');
                imgElement.src = thumbnail;
                imgElement.alt = title;
                imgElement.className = 'w-full h-32 object-cover rounded-lg border-2 border-gray-200 group-hover:border-blue-500';
                imgElement.onerror = function() {
                    this.closest('.relative').style.display = 'none';
                };
                
                // Crear overlay
                const overlayDiv = document.createElement('div');
                overlayDiv.className = 'absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity rounded-lg pointer-events-none';
                
                // Badge Premium si aplica
                let premiumBadge = null;
                if (isPremium) {
                    premiumBadge = document.createElement('div');
                    premiumBadge.className = 'absolute top-2 right-2 bg-yellow-500 text-white text-xs px-2 py-1 rounded-full font-semibold shadow-lg z-10';
                    premiumBadge.innerHTML = '‚≠ê Premium';
                    premiumBadge.title = 'Esta imagen requiere suscripci√≥n Premium de Freepik';
                }
                
                // Crear t√≠tulo
                const titleP = document.createElement('p');
                titleP.className = 'text-xs text-gray-600 mt-1 truncate';
                titleP.textContent = title;
                
                // Event handler para click
                itemDiv.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    selectFreepikImage(imgId);
                    return false;
                };
                
                // Agregar elementos
                itemDiv.appendChild(imgElement);
                itemDiv.appendChild(overlayDiv);
                if (premiumBadge) {
                    itemDiv.appendChild(premiumBadge);
                }
                itemDiv.appendChild(titleP);
                
                gridDiv.appendChild(itemDiv);
            });
            
            if (!append) {
                resultsDiv.innerHTML = '';
                resultsDiv.appendChild(gridDiv);
            }
            
            // Agregar bot√≥n "Cargar m√°s" si hay m√°s p√°ginas
            let loadMoreContainer = document.getElementById('freepik-load-more-container');
            if (!loadMoreContainer) {
                loadMoreContainer = document.createElement('div');
                loadMoreContainer.id = 'freepik-load-more-container';
                loadMoreContainer.className = 'mt-4 text-center';
                resultsDiv.appendChild(loadMoreContainer);
            }
            
            if (freepikHasMore) {
                const loadedCount = (freepikCurrentPage * 20);
                const remainingCount = freepikTotalResults - loadedCount;
                
                loadMoreContainer.innerHTML = `
                    <p class="text-sm text-gray-600 mb-2">
                        Mostrando ${Math.min(loadedCount, freepikTotalResults)} de ${freepikTotalResults} resultados
                    </p>
                    <button id="freepik-load-more-btn" 
                            onclick="loadMoreFreepik()" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        Cargar m√°s (${Math.min(20, remainingCount)} restantes)
                    </button>
                `;
            } else {
                loadMoreContainer.innerHTML = `
                    <p class="text-sm text-gray-600">
                        Mostrando todos los ${freepikTotalResults} resultados
                    </p>
                `;
            }
        } else {
            if (!append) {
                resultsDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No se encontraron resultados</p>';
            }
        }
    } catch (error) {
        console.error('Error buscando en Freepik:', error);
        if (!append) {
            resultsDiv.innerHTML = '<p class="text-red-500 text-center py-8">Error al buscar. Verifica que FREEPIK_API_KEY est√© configurada.</p>';
        } else {
            const loadMoreBtn = document.getElementById('freepik-load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.innerHTML = 'Error - Reintentar';
                loadMoreBtn.disabled = false;
            }
        }
    }
}

async function loadMoreFreepik() {
    await searchFreepik(freepikCurrentPage + 1, true);
}

async function selectFreepikImage(resourceId) {
    const sceneId = currentSceneForImageSearch;
    if (!sceneId) {
        console.error('No scene ID set for image search');
        return;
    }
    
    // Validar par√°metros
    if (!resourceId) {
        console.error('Missing resourceId', {resourceId});
        alert('Error: ID de recurso faltante');
        return;
    }
    
    closeFreepikModal();
    
    // Mostrar loading
    if (window.showLoading) window.showLoading('Descargando imagen de Freepik...');
    
    try {
        const response = await fetch(`/scenes/${sceneId}/set-freepik-image/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                resource_id: String(resourceId)
            })
        });
        
        const result = await response.json();
        if (result.status === 'success') {
            console.log('‚úì Imagen de Freepik establecida');
            // Recargar la p√°gina para mostrar la nueva imagen
            location.reload();
        } else {
            if (window.hideLoading) window.hideLoading();
            alert('Error: ' + result.message);
        }
    } catch (error) {
        if (window.hideLoading) window.hideLoading();
        console.error('Error:', error);
        alert('Error al establecer imagen de Freepik');
    }
}

let currentUploadImageSceneId = null;

function uploadCustomImage(sceneId) {
    currentUploadImageSceneId = sceneId;
    
    // Crear modal din√°micamente
    const modal = document.createElement('div');
    modal.id = 'upload-image-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.onclick = (e) => {
        if (e.target === modal) closeUploadImageModal();
    };
    
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-900">Subir Imagen Personalizada</h3>
                <button onclick="closeUploadImageModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <form id="upload-image-form" class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Selecciona una imagen
                    </label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-gray-400 transition-colors">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="custom-image-file" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                    <span>Selecciona un archivo</span>
                                    <input id="custom-image-file" name="image_file" type="file" class="sr-only" accept="image/*" onchange="previewCustomImage(event)" required>
                                </label>
                                <p class="pl-1">o arrastra y suelta</p>
                            </div>
                            <p class="text-xs text-gray-500">PNG, JPG, WEBP hasta 10MB</p>
                        </div>
                    </div>
                </div>
                
                <div id="image-preview-container" class="hidden mb-4">
                    <img id="image-preview" class="max-h-64 mx-auto rounded-lg border border-gray-300" alt="Preview">
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="closeUploadImageModal()" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" 
                            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Subir Imagen
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Agregar event listener al formulario
    document.getElementById('upload-image-form').addEventListener('submit', handleCustomImageUpload);
}

function closeUploadImageModal() {
    const modal = document.getElementById('upload-image-modal');
    if (modal) {
        modal.remove();
    }
    currentUploadImageSceneId = null;
}

function previewCustomImage(event) {
    const file = event.target.files[0];
    if (file) {
        // Validar tama√±o (10MB max)
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('La imagen es demasiado grande. Tama√±o m√°ximo: 10MB');
            event.target.value = '';
            return;
        }
        
        // Validar tipo
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            alert('Formato no soportado. Use: JPG, PNG, WEBP o GIF');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('image-preview');
            const container = document.getElementById('image-preview-container');
            preview.src = e.target.result;
            container.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
}

async function handleCustomImageUpload(event) {
    event.preventDefault();
    
    if (!currentUploadImageSceneId) return;
    
    const formData = new FormData(event.target);
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'Subiendo...';
    
    try {
        const response = await fetch(`/scenes/${currentUploadImageSceneId}/upload-custom-image/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            console.log('‚úì Imagen personalizada subida exitosamente');
            closeUploadImageModal();
            // Recargar la p√°gina para mostrar la nueva imagen
            location.reload();
        } else {
            alert('Error: ' + result.message);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al subir la imagen');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

function openGenerateAIImageModal(sceneId) {
    currentGenerateAISceneId = sceneId;
    document.getElementById('generate-ai-image-modal').classList.remove('hidden');
    document.getElementById('generate-ai-image-overlay').classList.remove('hidden');
}

function closeGenerateAIImageModal() {
    document.getElementById('generate-ai-image-modal').classList.add('hidden');
    document.getElementById('generate-ai-image-overlay').classList.add('hidden');
    document.getElementById('generate-ai-image-prompt').value = '';
    currentGenerateAISceneId = null;
}

async function generateAIImageFromPrompt(event) {
    event.preventDefault();
    
    if (!currentGenerateAISceneId) return;
    
    const prompt = document.getElementById('generate-ai-image-prompt').value.trim();
    if (!prompt) {
        alert('Por favor ingresa un prompt');
        return;
    }
    
    const generateBtn = event.target.querySelector('button[type="submit"]');
    const originalText = generateBtn.innerHTML;
    generateBtn.disabled = true;
    generateBtn.innerHTML = 'Generando...';
    
    try {
        const response = await fetch(`/scenes/${currentGenerateAISceneId}/generate-ai-image/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                prompt: prompt
            })
        });
        
        const result = await response.json();
        if (result.status === 'success') {
            console.log('‚úì Imagen generada con IA');
            closeGenerateAIImageModal();
            location.reload();
        } else {
            alert('Error: ' + result.message);
            generateBtn.disabled = false;
            generateBtn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al generar imagen');
        generateBtn.disabled = false;
        generateBtn.innerHTML = originalText;
    }
}

let currentGenerateAISceneId = null;

// ==================
// ADD SCENE MODAL (Paso 2)
// ==================

const scriptId = {{ script.id }};

function openAddSceneModal() {
    document.getElementById('add-scene-modal').classList.remove('hidden');
    updateAddSceneConfig();
}

function closeAddSceneModal() {
    document.getElementById('add-scene-modal').classList.add('hidden');
    document.getElementById('add-scene-form').reset();
    document.getElementById('add-scene-char-count').textContent = '0 / 1000';
}

function updateAddSceneCharCounter() {
    const text = document.getElementById('add-scene-script-text').value;
    const charCount = text.length;
    const counter = document.getElementById('add-scene-char-count');
    counter.textContent = `${charCount} / 1000`;
    
    if (charCount > 900) {
        counter.classList.add('text-red-600', 'font-bold');
        counter.classList.remove('text-gray-500');
    } else if (charCount > 800) {
        counter.classList.add('text-yellow-600', 'font-bold');
        counter.classList.remove('text-gray-500', 'text-red-600');
    } else {
        counter.classList.remove('text-red-600', 'text-yellow-600', 'font-bold');
        counter.classList.add('text-gray-500');
    }
}

function updateAddSceneConfig() {
    const service = document.getElementById('add-scene-service').value;
    const container = document.getElementById('add-scene-config-container');
    const videoOrientation = '{{ video_orientation }}';
    
    if (service === 'gemini_veo') {
        container.innerHTML = `
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Duraci√≥n</label>
                <select name="duration" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="5">5 segundos</option>
                    <option value="8" selected>8 segundos</option>
                </select>
            </div>
        `;
    } else if (service === 'sora') {
        container.innerHTML = `
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Duraci√≥n</label>
                <select name="duration" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="4">4 segundos</option>
                    <option value="8" selected>8 segundos</option>
                    <option value="12">12 segundos</option>
                </select>
            </div>
        `;
    } else if (service === 'heygen' || service === 'heygen_v2' || service === 'heygen_avatar_iv') {
        container.innerHTML = `
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Avatar</label>
                <select name="avatar_id" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" required>
                    <option value="">Cargando avatares...</option>
                </select>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Voz</label>
                <select name="voice_id" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" required>
                    <option value="">Cargando voces...</option>
                </select>
            </div>
        `;
        loadHeyGenAssetsForAddScene();
    } else if (service === 'vuela_ai') {
        container.innerHTML = `
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Voice ID</label>
                <input type="text" 
                       name="voice_id"
                       placeholder="ID de voz de Vuela.ai"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                       required>
            </div>
        `;
    }
}

async function loadHeyGenAssetsForAddScene() {
    try {
        if (!avatarsCache) {
            const avatarResponse = await fetch('{% url "core:api_list_avatars" %}');
            const avatarData = await avatarResponse.json();
            avatarsCache = avatarData.avatars;
        }
        
        if (!voicesCache) {
            const voiceResponse = await fetch('{% url "core:api_list_voices" %}');
            const voiceData = await voiceResponse.json();
            voicesCache = voiceData.voices;
        }
        
        // Obtener valores por defecto del paso 1 (desde sessionStorage o desde el script)
        let defaultAvatarId = null;
        let defaultVoiceId = null;
        try {
            const agentContent = JSON.parse(sessionStorage.getItem('agentContent') || '{}');
            defaultAvatarId = agentContent.default_heygen_avatar_id || 
                             agentContent.model_preferences?.default_heygen_avatar_id || 
                             scriptDefaultAvatarId ||  // Desde el script
                             null;
            defaultVoiceId = agentContent.default_heygen_voice_id || 
                            agentContent.model_preferences?.default_heygen_voice_id || 
                            scriptDefaultVoiceId ||  // Desde el script
                            null;
        } catch (e) {
            console.warn('Error obteniendo valores por defecto:', e);
            // Fallback a valores del script
            defaultAvatarId = scriptDefaultAvatarId || null;
            defaultVoiceId = scriptDefaultVoiceId || null;
        }
        
        const avatarSelect = document.querySelector('#add-scene-config-container select[name="avatar_id"]');
        avatarSelect.innerHTML = '<option value="">Selecciona un avatar</option>';
        avatarsCache.forEach(avatar => {
            const option = document.createElement('option');
            option.value = avatar.avatar_id;
            option.textContent = avatar.avatar_name;
            if (defaultAvatarId && avatar.avatar_id === defaultAvatarId) {
                option.selected = true;
            }
            avatarSelect.appendChild(option);
        });
        
        const voiceSelect = document.querySelector('#add-scene-config-container select[name="voice_id"]');
        voiceSelect.innerHTML = '<option value="">Selecciona una voz</option>';
        voicesCache.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.voice_id;
            const voiceName = voice.name || voice.display_name || voice.voice_name || `Voz ${voice.voice_id?.substring(0, 8) || 'Desconocida'}`;
            option.textContent = `${voiceName} (${voice.language || 'Desconocido'})`;
            if (defaultVoiceId && voice.voice_id === defaultVoiceId) {
                option.selected = true;
            }
            voiceSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando assets de HeyGen:', error);
    }
}

async function saveNewScene(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const scriptText = formData.get('script_text');
    const summary = formData.get('summary') || scriptText.substring(0, 100);
    const service = formData.get('ai_service');
    
    const data = {
        scene_type: 'ai_generated',
        script_text: scriptText,
        summary: summary,
        ai_service: service,
        ai_config: {}
    };
    
    // Recoger configuraci√≥n seg√∫n el servicio
    if (service === 'gemini_veo') {
        data.duration_sec = parseInt(formData.get('duration') || 8);
    } else if (service === 'sora') {
        data.duration_sec = parseInt(formData.get('duration') || 8);
    } else if (service === 'heygen' || service === 'heygen_v2' || service === 'heygen_avatar_iv') {
        const avatarId = formData.get('avatar_id');
        const voiceId = formData.get('voice_id');
        
        if (!avatarId || !voiceId) {
            alert('Debes seleccionar un avatar y una voz');
            return;
        }
        
        data.ai_config.avatar_id = avatarId;
        data.ai_config.voice_id = voiceId;
    } else if (service === 'vuela_ai') {
        const voiceId = formData.get('voice_id');
        if (!voiceId) {
            alert('Debes ingresar un Voice ID de Vuela.ai');
            return;
        }
        data.ai_config.voice_id = voiceId;
    }
    
    try {
        const response = await fetch(`/scripts/${scriptId}/scenes/create/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.status === 'success') {
            console.log('‚úì Escena creada:', result.scene_id);
            closeAddSceneModal();
            // Recargar p√°gina para mostrar la nueva escena
            location.reload();
        } else {
            alert('Error al crear escena: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al crear escena');
    }
}

// (openInspector ya est√° definida arriba, antes de DOMContentLoaded)

// ==================
// INSPECTOR PANEL (FUNCIONES GLOBALES - DUPLICADAS, ELIMINAR)
// ==================
// (openInspector y closeInspector ya est√°n definidas arriba, antes de DOMContentLoaded - NO DUPLICAR)

function updateInspectorDurationAndRecalculate() {
    if (!currentInspectorSceneId) return;
    
    const durationSelect = document.getElementById('inspector-duration');
    if (!durationSelect) return;
    
    const newDuration = parseInt(durationSelect.value);
    const sceneData = scenesInspectorData[currentInspectorSceneId];
    
    if (sceneData && newDuration) {
        // Guardar la nueva duraci√≥n
        saveSceneAiConfig(currentInspectorSceneId, 'duration', newDuration);
        
        // Actualizar duration_sec en scenesInspectorData
        sceneData.duration_sec = newDuration;
        
        // Recalcular duraci√≥n estimada
        const scriptText = document.getElementById('inspector-script-text')?.value || sceneData.script_text || '';
        updateSceneEstimatedDuration(currentInspectorSceneId, scriptText, newDuration);
    }
}

function updateCharCounter() {
    const textEl = document.getElementById('inspector-script-text');
    if (!textEl) {
        console.warn('‚ö†Ô∏è [updateCharCounter] inspector-script-text no encontrado');
        return;
    }
    
    const text = textEl.value;
    const charCount = text.length;
    const counter = document.getElementById('inspector-char-count');
    
    if (!counter) {
        console.warn('‚ö†Ô∏è [updateCharCounter] inspector-char-count no encontrado');
        return;
    }
    
    counter.textContent = `${charCount} / 1000`;
    
    // Cambiar color si se acerca al l√≠mite
    if (charCount > 900) {
        counter.classList.add('text-red-600', 'font-bold');
        counter.classList.remove('text-gray-500');
    } else if (charCount > 800) {
        counter.classList.add('text-yellow-600', 'font-bold');
        counter.classList.remove('text-gray-500', 'text-red-600');
    } else {
        counter.classList.remove('text-red-600', 'text-yellow-600', 'font-bold');
        counter.classList.add('text-gray-500');
    }
    
    // Recalcular duraci√≥n estimada si hay una escena abierta
    if (currentInspectorSceneId) {
        const sceneData = scenesInspectorData[currentInspectorSceneId];
        if (sceneData) {
            // Obtener duraci√≥n actual (del select si existe, sino del sceneData)
            const durationSelect = document.getElementById('inspector-duration');
            const durationSec = durationSelect ? parseInt(durationSelect.value) : (sceneData.duration_sec || 8);
            
            updateSceneEstimatedDuration(currentInspectorSceneId, text, durationSec);
            
            // Actualizar tambi√©n en scenesInspectorData para mantener sincronizado
            sceneData.script_text = text;
        }
    }
}

function updateVisualCharCounter() {
    const text = document.getElementById('inspector-visual-prompt').value;
    const charCount = text.length;
    const counter = document.getElementById('inspector-visual-char-count');
    
    // Sin l√≠mites - solo muestra el conteo
    counter.textContent = `${charCount} caracteres`;
    
    // Color verde para prompts extensos (mejor calidad)
    if (charCount > 1000) {
        counter.classList.add('text-green-600', 'font-semibold');
        counter.classList.remove('text-gray-500', 'text-blue-600');
    } else if (charCount > 500) {
        counter.classList.add('text-blue-600', 'font-semibold');
        counter.classList.remove('text-gray-500', 'text-green-600');
    } else {
        counter.classList.remove('text-green-600', 'text-blue-600', 'font-semibold', 'font-bold');
        counter.classList.add('text-gray-500');
    }
}

function updateInspectorConfig() {
    if (!currentInspectorSceneId) return;
    
    const serviceSelect = document.getElementById('inspector-service-select');
    if (!serviceSelect) {
        console.warn('‚ö†Ô∏è [updateInspectorConfig] inspector-service-select no encontrado');
        return;
    }
    
    const service = serviceSelect.value;
    const scene = scenesInspectorData[currentInspectorSceneId];
    if (!scene) {
        console.warn('‚ö†Ô∏è [updateInspectorConfig] Escena no encontrada en scenesInspectorData');
        return;
    }
    
    const config = scene.ai_config || {};
    const videoOrientation = '{{ video_orientation }}';
    const container = document.getElementById('inspector-config-container');
    
    if (!container) {
        console.warn('‚ö†Ô∏è [updateInspectorConfig] inspector-config-container no encontrado');
        return;
    }
    
    if (service === 'gemini_veo') {
        container.innerHTML = `
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Duraci√≥n</label>
                <select id="inspector-duration" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                        onchange="updateInspectorDurationAndRecalculate()">
                    <option value="4" ${config.duration == 4 ? 'selected' : ''}>4 segundos</option>
                    <option value="6" ${config.duration == 6 ? 'selected' : ''}>6 segundos</option>
                    <option value="8" ${config.duration == 8 || !config.duration ? 'selected' : ''}>8 segundos</option>
                </select>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Modelo Veo</label>
                <select id="inspector-veo-model" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="veo-2.0-generate-001" ${config.veo_model == 'veo-2.0-generate-001' ? 'selected' : ''}>Veo 2.0</option>
                    <option value="veo-3.0-generate-001" ${config.veo_model == 'veo-3.0-generate-001' ? 'selected' : ''}>Veo 3.0</option>
                    <option value="veo-3.1-generate-preview" ${config.veo_model == 'veo-3.1-generate-preview' ? 'selected' : ''}>Veo 3.1 Preview</option>
                </select>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Orientaci√≥n (Heredada)</label>
                <input type="text" 
                       value="${videoOrientation === '9:16' ? 'Vertical (9:16)' : 'Horizontal (16:9)'}" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50" 
                       disabled>
            </div>
        `;
    } else if (service === 'sora') {
        const soraSize = videoOrientation === '9:16' ? '720x1280' : '1280x720';
        
        // Usar duration_sec del modelo como fuente de verdad, luego ai_config.duration como fallback
        const sceneData = scenesInspectorData[currentInspectorSceneId] || {};
        const durationFromModel = parseInt(sceneData.duration_sec);
        const durationFromConfig = parseInt(config.duration);
        const duration = (!isNaN(durationFromModel) && durationFromModel > 0) ? durationFromModel : 
                        (!isNaN(durationFromConfig) && durationFromConfig > 0) ? durationFromConfig : 8;
        
        container.innerHTML = `
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Duraci√≥n</label>
                <select id="inspector-duration" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm"
                        onchange="updateInspectorDurationAndRecalculate()">
                    <option value="4" ${duration === 4 ? 'selected' : ''}>4 segundos</option>
                    <option value="8" ${duration === 8 ? 'selected' : ''}>8 segundos</option>
                    <option value="12" ${duration === 12 ? 'selected' : ''}>12 segundos</option>
                </select>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Modelo Sora</label>
                <select id="inspector-sora-model" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="sora-2" ${config.sora_model == 'sora-2' || !config.sora_model ? 'selected' : ''}>Sora 2</option>
                </select>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Tama√±o (Heredado)</label>
                <input type="text" 
                       value="${soraSize}" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50" 
                       disabled>
            </div>
        `;
    } else if (service === 'heygen' || service === 'heygen_v2' || service === 'heygen_avatar_iv') {
        container.innerHTML = `
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Avatar</label>
                <select id="inspector-avatar" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="">Cargando avatares...</option>
                </select>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Voz</label>
                <select id="inspector-voice" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="">Cargando voces...</option>
                </select>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Velocidad de Voz</label>
                <input type="number" 
                       id="inspector-voice-speed"
                       value="${config.voice_speed || 1.0}"
                       step="0.1"
                       min="0.5"
                       max="2.0"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Tono de Voz</label>
                <input type="number" 
                       id="inspector-voice-pitch"
                       value="${config.voice_pitch || 50}"
                       min="0"
                       max="100"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Orientaci√≥n (Heredada)</label>
                <input type="text" 
                       value="${videoOrientation === '9:16' ? 'Vertical (9:16)' : 'Horizontal (16:9)'}" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50" 
                       disabled>
            </div>
        `;
        
        // Cargar avatares y voces - usar valores de config o valores vac√≠os
        const avatarId = config.avatar_id || '';
        const voiceId = config.voice_id || '';
        loadHeyGenAssetsForInspector(avatarId, voiceId);
    } else if (service === 'vuela_ai') {
        container.innerHTML = `
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Voice ID</label>
                <input type="text" 
                       id="inspector-voice-id"
                       value="${config.voice_id || ''}"
                       placeholder="ID de voz de Vuela.ai"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Estilo de Voz</label>
                <select id="inspector-voice-style" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="narrative" ${config.voice_style == 'narrative' ? 'selected' : ''}>Narrativo</option>
                    <option value="expressive" ${config.voice_style == 'expressive' || !config.voice_style ? 'selected' : ''}>Expresivo</option>
                    <option value="dynamic" ${config.voice_style == 'dynamic' ? 'selected' : ''}>Din√°mico</option>
                </select>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Tipo de Animaci√≥n</label>
                <select id="inspector-animation-type" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="moving_image" ${config.animation_type == 'moving_image' || !config.animation_type ? 'selected' : ''}>Efecto Ken Burns</option>
                    <option value="ai_video" ${config.animation_type == 'ai_video' ? 'selected' : ''}>Animaci√≥n IA</option>
                </select>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Estilo Visual</label>
                <select id="inspector-style" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                    <option value="photorealistic" ${config.style == 'photorealistic' || !config.style ? 'selected' : ''}>Fotorealista</option>
                    <option value="flat_design" ${config.style == 'flat_design' ? 'selected' : ''}>Dise√±o Plano</option>
                    <option value="anime" ${config.style == 'anime' ? 'selected' : ''}>Anime</option>
                    <option value="3d" ${config.style == '3d' ? 'selected' : ''}>3D</option>
                    <option value="watercolor" ${config.style == 'watercolor' ? 'selected' : ''}>Acuarela</option>
                    <option value="comic" ${config.style == 'comic' ? 'selected' : ''}>C√≥mic</option>
                </select>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-700 mb-2 block">Orientaci√≥n (Heredada)</label>
                <input type="text" 
                       value="${videoOrientation === '9:16' ? 'Vertical (9:16)' : 'Horizontal (16:9)'}" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-50" 
                       disabled>
            </div>
        `;
    }
}

async function loadHeyGenAssetsForInspector(selectedAvatarId, selectedVoiceId) {
    try {
        // Usar cache si est√° disponible
        if (!avatarsCache) {
            const avatarResponse = await fetch('{% url "core:api_list_avatars" %}');
            const avatarData = await avatarResponse.json();
            avatarsCache = avatarData.avatars;
        }
        
        if (!voicesCache) {
            const voiceResponse = await fetch('{% url "core:api_list_voices" %}');
            const voiceData = await voiceResponse.json();
            voicesCache = voiceData.voices;
        }
        
        // Poblar avatares
        const avatarSelect = document.getElementById('inspector-avatar');
        avatarSelect.innerHTML = '<option value="">Selecciona un avatar</option>';
        avatarsCache.forEach(avatar => {
            const option = document.createElement('option');
            option.value = avatar.avatar_id;
            option.textContent = avatar.avatar_name;
            if (selectedAvatarId && avatar.avatar_id === selectedAvatarId) {
                option.selected = true;
            }
            avatarSelect.appendChild(option);
        });
        
        // Poblar voces
        const voiceSelect = document.getElementById('inspector-voice');
        voiceSelect.innerHTML = '<option value="">Selecciona una voz</option>';
        voicesCache.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.voice_id;
            option.textContent = `${voice.display_name} (${voice.language})`;
            if (selectedVoiceId && voice.voice_id === selectedVoiceId) {
                option.selected = true;
            }
            voiceSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando assets de HeyGen:', error);
    }
}

async function saveInspectorChanges() {
    if (!currentInspectorSceneId) return;
    
    const scriptText = document.getElementById('inspector-script-text').value;
    const visualPrompt = document.getElementById('inspector-visual-prompt').value;
    const service = document.getElementById('inspector-service-select').value;
    const voiceId = document.getElementById('inspector-voice-id').value;
    const voiceName = document.getElementById('inspector-voice-name').value;
    
    const data = {
        script_text: scriptText,
        visual_prompt: visualPrompt,
        ai_service: service,
        audio_voice_id: voiceId,
        audio_voice_name: voiceName,
        ai_config: {}
    };
    
    // Recoger configuraci√≥n seg√∫n el servicio
    if (service === 'gemini_veo') {
        data.ai_config.duration = parseInt(document.getElementById('inspector-duration').value);
        const veoModel = document.getElementById('inspector-veo-model').value;
        if (veoModel) data.ai_config.veo_model = veoModel;
    } else if (service === 'sora') {
        data.ai_config.duration = parseInt(document.getElementById('inspector-duration').value);
        const soraModel = document.getElementById('inspector-sora-model')?.value;
        if (soraModel) data.ai_config.sora_model = soraModel;
    } else if (service === 'heygen' || service === 'heygen_v2' || service === 'heygen_avatar_iv') {
        const avatarId = document.getElementById('inspector-avatar').value;
        const voiceId = document.getElementById('inspector-voice').value;
        const voiceSpeed = parseFloat(document.getElementById('inspector-voice-speed').value);
        const voicePitch = parseInt(document.getElementById('inspector-voice-pitch').value);
        
        if (!avatarId || !voiceId) {
            alert('Debes seleccionar un avatar y una voz');
            return;
        }
        
        data.ai_config.avatar_id = avatarId;
        data.ai_config.voice_id = voiceId;
        data.ai_config.voice_speed = voiceSpeed;
        data.ai_config.voice_pitch = voicePitch;
    } else if (service === 'vuela_ai') {
        const voiceId = document.getElementById('inspector-voice-id').value;
        
        if (!voiceId) {
            alert('Debes ingresar un Voice ID de Vuela.ai');
            return;
        }
        
        data.ai_config.voice_id = voiceId;
        data.ai_config.voice_style = document.getElementById('inspector-voice-style').value;
        data.ai_config.animation_type = document.getElementById('inspector-animation-type').value;
        data.ai_config.style = document.getElementById('inspector-style').value;
    }
    
    try {
        const response = await fetch(`/scenes/${currentInspectorSceneId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.status === 'success') {
            console.log('‚úì Inspector: Cambios guardados');
            
            // Actualizar cache local
            if (!scenesInspectorData[currentInspectorSceneId]) {
                scenesInspectorData[currentInspectorSceneId] = {};
            }
            scenesInspectorData[currentInspectorSceneId].script_text = scriptText;
            if (data.ai_config.duration) {
                scenesInspectorData[currentInspectorSceneId].duration_sec = data.ai_config.duration;
            }
            
            // Recalcular duraci√≥n estimada
            const durationSec = data.ai_config.duration || scenesInspectorData[currentInspectorSceneId].duration_sec || 8;
            updateSceneEstimatedDuration(currentInspectorSceneId, scriptText, durationSec);
            
            // Actualizar cache local
            scenesInspectorData[currentInspectorSceneId].script_text = scriptText;
            scenesInspectorData[currentInspectorSceneId].visual_prompt = visualPrompt;
            scenesInspectorData[currentInspectorSceneId].ai_service = service;
            scenesInspectorData[currentInspectorSceneId].audio_voice_id = voiceId;
            scenesInspectorData[currentInspectorSceneId].audio_voice_name = voiceName;
            scenesInspectorData[currentInspectorSceneId].ai_config = data.ai_config;
            
            // Mostrar indicador de √©xito
            const saveBtn = document.querySelector('#inspector-panel button[onclick="saveInspectorChanges()"]');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '‚úÖ Guardado!';
            saveBtn.classList.add('bg-green-600');
            saveBtn.classList.remove('bg-blue-600');
            
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.classList.remove('bg-green-600');
                saveBtn.classList.add('bg-blue-600');
            }, 2000);
        } else {
            alert('Error al guardar: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar cambios');
    }
}

// ==================
// VOICE SELECTOR FOR INSPECTOR (REUTILIZANDO FUNCIONES GEN√âRICAS)
// ==================

// Usar el cache global de voces si existe, sino crear uno espec√≠fico
let voicesCacheInspector = null;

async function openInspectorVoiceModal() {
    // Usar funci√≥n gen√©rica del modal de voces
    openVoiceModal({
        modalId: 'voice-modal-inspector',
        filterPrefix: 'inspector',
        apiUrl: '{% url "core:api_list_elevenlabs_voices" %}',
        onSelect: function(voiceId, voiceName, voiceCategory) {
            // Actualizar campos hidden
            document.getElementById('inspector-voice-id').value = voiceId;
            document.getElementById('inspector-voice-name').value = voiceName;
            
            // Actualizar UI
            document.getElementById('inspector-selected-voice-name').textContent = voiceName;
            document.getElementById('inspector-selected-voice-category').textContent = voiceCategory + ' (personalizada)';
            
            console.log('Voz seleccionada para escena:', voiceName, voiceId);
        }
    });
}

// Funci√≥n obsoleta - eliminada, usar openInspectorVoiceModal() directamente

// ==================
// VOICE TAGS HELPER FUNCTIONS
// ==================

function toggleVoiceTagsHelp() {
    const helpDiv = document.getElementById('voice-tags-help');
    if (helpDiv) {
        helpDiv.classList.toggle('hidden');
    }
}

function insertVoiceTag(tag) {
    const textarea = document.getElementById('inspector-script-text');
    if (!textarea) return;
    
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    
    // Insertar tag con espacio despu√©s si es necesario
    const tagWithSpace = tag.endsWith(']') && !textAfter.startsWith(' ') && textAfter.length > 0 ? tag + ' ' : tag;
    
    textarea.value = textBefore + tagWithSpace + textAfter;
    
    // Reposicionar cursor despu√©s del tag
    const newCursorPos = cursorPos + tagWithSpace.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
    
    // Actualizar contador
    if (typeof updateCharCounter === 'function') {
        updateCharCounter();
    }
    
    // Actualizar duraci√≥n estimada si existe la funci√≥n
    if (typeof updateSceneEstimatedDuration === 'function') {
        const sceneId = currentInspectorSceneId;
        if (sceneId) {
            const durationSec = scenesInspectorData[sceneId]?.duration_sec || 8;
            updateSceneEstimatedDuration(sceneId, textarea.value, durationSec);
        }
    }
}
</script>
{% endif %}

{% if not script %}
<script>
// Enviar script a backend para procesamiento
document.addEventListener('DOMContentLoaded', function() {
    // Obtener datos del sessionStorage
    const agentContent = JSON.parse(sessionStorage.getItem('agentContent'));
    
    if (!agentContent) {
        {% if project %}
            window.location.href = "{% url 'core:agent_create' project.uuid %}";
        {% else %}
            window.location.href = "{% url 'core:agent_create_standalone' %}";
        {% endif %}
        return;
    }
    
    // Actualizar UI
    updateProcessingStatus('Enviando gui√≥n a procesamiento...');
    
    // Enviar a backend
    fetch("{% if project %}{% url 'core:agent_configure' project.uuid %}{% else %}{% url 'core:agent_configure_standalone' %}{% endif %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'title': 'Video con Agente',
            'script_content': agentContent.content,
            'desired_duration_min': agentContent.duration,
            'video_type': agentContent.video_type || 'general',
            'video_format': agentContent.video_format || 'educational',
            'video_orientation': agentContent.video_orientation || '16:9',
            'generate_previews': agentContent.generate_previews !== false ? 'true' : 'false',
            'enable_audio': agentContent.enable_audio !== false ? 'true' : 'false',
            'default_voice_id': agentContent.default_voice_id || 'pFZP5JQG7iQjIQuC4Bku',
            'default_voice_name': agentContent.default_voice_name || 'Aria',
            // HeyGen defaults
            'default_heygen_avatar_id': agentContent.default_heygen_avatar_id || agentContent.model_preferences?.default_heygen_avatar_id || '',
            'default_heygen_avatar_name': agentContent.default_heygen_avatar_name || agentContent.model_preferences?.default_heygen_avatar_name || '',
            'default_heygen_voice_id': agentContent.default_heygen_voice_id || agentContent.model_preferences?.default_heygen_voice_id || '',
            'default_heygen_voice_name': agentContent.default_heygen_voice_name || agentContent.model_preferences?.default_heygen_voice_name || '',
            // Preferencias de modelos
            'model_pref_veo': agentContent.model_preferences?.gemini_veo || '',
            'model_pref_sora': agentContent.model_preferences?.sora || '',
            'model_pref_heygen': agentContent.model_preferences?.heygen || ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            updateProcessingStatus('‚úì Gui√≥n enviado. Esperando procesamiento de n8n...');
            // Polling para esperar a que n8n procese
            pollScriptStatus(data.script_id);
        } else {
            alert('Error: ' + data.message);
            {% if project %}
                window.location.href = "{% url 'core:agent_create' project.uuid %}";
            {% else %}
                window.location.href = "{% url 'core:agent_create_standalone' %}";
            {% endif %}
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar script');
        {% if project %}
            window.location.href = "{% url 'core:agent_create' project.uuid %}";
        {% else %}
            window.location.href = "{% url 'core:agent_create_standalone' %}";
        {% endif %}
    });
});

function updateProcessingStatus(message) {
    const statusDiv = document.getElementById('processing-status');
    if (statusDiv) {
        const timestamp = new Date().toLocaleTimeString();
        statusDiv.innerHTML += `<p class="text-sm text-gray-700">${timestamp} - ${message}</p>`;
    }
}

function pollScriptStatus(scriptId) {
    let pollCount = 0;
    const maxPolls = 60; // 3 minutos m√°ximo (60 * 3 segundos)
    
    updateProcessingStatus('Consultando estado del gui√≥n...');
    
    const interval = setInterval(async () => {
        pollCount++;
        
        if (pollCount > maxPolls) {
            clearInterval(interval);
            updateProcessingStatus('‚ö†Ô∏è Timeout: El procesamiento est√° tardando m√°s de lo esperado.');
            alert('El procesamiento est√° tardando m√°s de lo esperado. Por favor, verifica el estado del script en el proyecto.');
            {% if project %}
                window.location.href = "{% url 'core:project_detail' project.uuid %}";
            {% else %}
                window.location.href = "{% url 'core:dashboard' %}";
            {% endif %}
            return;
        }
        
        try {
            // Usar el endpoint de status partial que ya existe
            const response = await fetch(`{% url 'core:script_status_partial' 0 %}`.replace('/0/', `/${scriptId}/`));
            
            if (!response.ok) {
                throw new Error('Error al consultar estado');
            }
            
            const html = await response.text();
            
            // Verificar si est√° completado
            if (html.includes('Completado') || html.includes('bg-green-500')) {
                clearInterval(interval);
                updateProcessingStatus('‚úì Gui√≥n procesado exitosamente. Generando escenas...');
                
                // Esperar 2 segundos para que terminen de generarse las preview images
                setTimeout(() => {
                    // Redirigir a la misma p√°gina con script_id para mostrar escenas
                    {% if project %}
                        window.location.href = "{% url 'core:agent_configure' project.uuid %}?script_id=" + scriptId;
                    {% else %}
                        window.location.href = "{% url 'core:agent_configure_standalone' %}?script_id=" + scriptId;
                    {% endif %}
                }, 2000);
                
            } else if (html.includes('Error') || html.includes('bg-red-500')) {
                clearInterval(interval);
                updateProcessingStatus('‚úó Error al procesar gui√≥n');
                alert('Error al procesar el gui√≥n. Por favor, intenta nuevamente.');
                {% if project %}
                    window.location.href = "{% url 'core:agent_create' project.uuid %}";
                {% else %}
                    window.location.href = "{% url 'core:agent_create_standalone' %}";
                {% endif %}
            } else {
                // Actualizar mensaje de progreso
                if (pollCount % 5 === 0) { // Cada 15 segundos
                    updateProcessingStatus(`‚è≥ Procesando... (${pollCount * 3}s transcurridos)`);
                }
            }
        } catch (error) {
            console.error('Error checking status:', error);
            // No detener el polling por errores individuales
        }
    }, 3000); // Poll cada 3 segundos
}
</script>
{% endif %}
{% endblock %}

