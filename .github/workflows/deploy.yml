name: Deploy to Server

# Se ejecuta automÃ¡ticamente cuando:
# - Push a dev â†’ despliega a DEV
# - Push a demo â†’ despliega a DEMO
# - Push a main â†’ despliega a PROD
on:
  push:
    branches: [ dev, demo, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run tests
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY_CI || 'test-secret-key-for-ci' }}
        USE_SQLITE: 'True'
        DEBUG: 'False'
        ALLOWED_HOSTS: 'localhost,127.0.1'
        GCS_BUCKET_NAME: 'test-bucket'
        GCS_PROJECT_ID: 'test-project'
        GOOGLE_APPLICATION_CREDENTIALS: '/tmp/fake-credentials.json'
        HEYGEN_API_KEY: 'test-key'
        GEMINI_API_KEY: 'test-key'
      run: |
        python manage.py test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    name: Deploy to Server
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Determine environment
      id: env
      run: |
        BRANCH="${{ github.ref_name }}"
        if [ "$BRANCH" == "dev" ]; then
          echo "env=dev" >> $GITHUB_OUTPUT
        elif [ "$BRANCH" == "demo" ]; then
          echo "env=demo" >> $GITHUB_OUTPUT
        elif [ "$BRANCH" == "main" ]; then
          echo "env=prod" >> $GITHUB_OUTPUT
        else
          echo "âŒ Branch desconocido: $BRANCH"
          exit 1
        fi
        echo "âœ… Desplegando a: ${{ steps.env.outputs.env }}"
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        # Guardar la clave SSH preservando saltos de lÃ­nea correctamente
        # Usar printf para preservar saltos de lÃ­nea y caracteres especiales
        printf '%s\n' "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        # Verificar que la clave es vÃ¡lida
        if ! ssh-keygen -l -f ~/.ssh/deploy_key > /dev/null 2>&1; then
          echo "âŒ Error: La clave SSH no es vÃ¡lida"
          echo "Primeras lÃ­neas de la clave:"
          head -3 ~/.ssh/deploy_key
          exit 1
        fi
        echo "âœ… Clave SSH vÃ¡lida"
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
        chmod 644 ~/.ssh/known_hosts
    
    - name: Deploy to ${{ steps.env.outputs.env }}
      env:
        SSH_KEY: ~/.ssh/deploy_key
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USER: ${{ secrets.SSH_USERNAME }}
        BRANCH: ${{ github.ref_name }}
        ENV: ${{ steps.env.outputs.env }}
        REPO: ${{ github.repository }}
      run: |
        # Ejecutar despliegue directamente en el servidor
        ssh -i $SSH_KEY -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST bash -s << 'EOF'
        set -e
        
        ENV="$ENV"
        BRANCH="$BRANCH"
        REPO="$REPO"
        ENV_DIR="$HOME/$ENV"
        
        echo "ðŸ“ Preparando directorio $ENV_DIR"
        mkdir -p $ENV_DIR
        cd $ENV_DIR
        
        # Crear directorio html si no existe
        mkdir -p html
        
        # Actualizar cÃ³digo
        if [ -d "html/.git" ]; then
          echo "ðŸ“¥ Actualizando cÃ³digo desde branch $BRANCH"
          cd html
          git fetch origin
          git checkout $BRANCH || git checkout -b $BRANCH origin/$BRANCH
          git pull origin $BRANCH
          cd ..
        else
          echo "ðŸ“¥ Clonando repositorio branch $BRANCH"
          rm -rf html
          git clone -b $BRANCH https://github.com/$REPO.git html
        fi
        
        # Copiar docker-compose
        echo "ðŸ“‹ Copiando docker-compose.yml"
        if [ ! -f "html/docker/docker-compose.$ENV.yml" ]; then
          echo "âŒ Error: No se encontrÃ³ docker-compose.$ENV.yml en el repositorio"
          exit 1
        fi
        cp html/docker/docker-compose.$ENV.yml docker-compose.yml
        
        # Desplegar
        echo "ðŸ”¨ Construyendo y reiniciando contenedores"
        docker compose down || true
        docker compose build --no-cache
        docker compose up -d
        
        echo "â³ Esperando a que los servicios estÃ©n listos..."
        sleep 15
        
        echo "ðŸ”„ Ejecutando migraciones"
        docker compose run --rm migrate || echo "âš ï¸  Advertencia: Error en migraciones"
        
        echo "ðŸ“¦ Recolectando archivos estÃ¡ticos"
        docker compose run --rm collectstatic || echo "âš ï¸  Advertencia: Error en collectstatic"
        
        echo "âœ… Despliegue a $ENV completado!"
        if [ "$ENV" == "prod" ]; then
          echo "ðŸŒ URL: https://atenea.nxhumans.com"
        else
          echo "ðŸŒ URL: https://$ENV.atenea.nxhumans.com"
        fi
        EOF
