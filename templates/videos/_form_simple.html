{% load static %}

<form method="post" id="videoForm" enctype="multipart/form-data" class="p-6">
    {% csrf_token %}
    
    <!-- T√≠tulo -->
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">
            T√≠tulo <span class="text-red-500">*</span>
        </label>
        <input 
            type="text" 
            name="title" 
            required 
            placeholder="Mi video generado con IA"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
        >
    </div>
    
    <!-- Selector de Modelo -->
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">
            Modelo <span class="text-red-500">*</span>
        </label>
        <select 
            name="model_id" 
            id="model-select"
            required
            hx-get="{% url 'core:dynamic_form_fields' %}"
            hx-target="#dynamic-fields-container"
            hx-trigger="change"
            hx-include="[name='model_id']"
            hx-indicator="#loading-indicator"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
        >
            <option value="">Selecciona un modelo</option>
            {% for model_id, model in models.items %}
                <option value="{{ model_id }}">{{ model.name }}{% if model.description %} - {{ model.description }}{% endif %}</option>
            {% endfor %}
        </select>
        <p class="text-xs text-gray-500 mt-1">Selecciona el modelo de IA para generar tu video</p>
    </div>
    
    <!-- Prompt / Gui√≥n -->
    <div class="mb-6">
        <label id="script-label" class="block text-sm font-medium text-gray-700 mb-2">
            Prompt / Gui√≥n <span class="text-red-500">*</span>
        </label>
        <textarea 
            name="script" 
            id="script-textarea"
            rows="5"
            placeholder="Describe el video que quieres generar..."
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"
        ></textarea>
        <p id="script-help" class="text-xs text-gray-500 mt-1">S√© espec√≠fico y descriptivo. Incluye detalles sobre movimiento, estilo, colores, etc.</p>
    </div>
    
    <!-- Campos Din√°micos (se cargan v√≠a HTMX) -->
    <div id="dynamic-fields-container">
        <!-- Los campos se cargar√°n aqu√≠ cuando se seleccione un modelo -->
        <p class="text-sm text-gray-400 italic">Selecciona un modelo para ver las opciones disponibles</p>
    </div>
    
    <!-- Indicador de carga -->
    <div id="loading-indicator" class="htmx-indicator mb-4">
        <div class="flex items-center gap-2 text-blue-600">
            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Cargando opciones del modelo...</span>
        </div>
    </div>
    
    <!-- Botones -->
    <div class="flex gap-3 justify-end items-center pt-6 border-t border-gray-200">
        {% if project %}
        <a href="{% url 'core:project_videos_library' project.uuid %}" 
           class="bg-gray-100 text-gray-700 hover:bg-gray-200 px-6 py-3 rounded-md font-medium transition-colors">
            Cancelar
        </a>
        {% else %}
        <a href="{% url 'core:dashboard' %}" 
           class="bg-gray-100 text-gray-700 hover:bg-gray-200 px-6 py-3 rounded-md font-medium transition-colors">
            Cancelar
        </a>
        {% endif %}
        <button 
            type="submit" 
            class="bg-black text-white hover:bg-gray-800 px-6 py-3 rounded-md font-medium transition-colors flex items-center gap-2">
            <span>Generar</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
        </button>
    </div>
</form>

<script>
// Funci√≥n global para ocultar/mostrar prompt basado en bar_chart
// (Duplicada aqu√≠ para asegurar disponibilidad en el contexto del formulario)
function updatePromptVisibilityForBarChart() {
    console.log('üîç updatePromptVisibilityForBarChart called at', new Date().toISOString());
    
    const scriptLabel = document.getElementById('script-label');
    const scriptTextarea = document.getElementById('script-textarea');
    const scriptHelp = document.getElementById('script-help');
    const manimTypeInput = document.getElementById('manim-animation-type-input');
    
    console.log('üîç Elements found:', {
        scriptLabel: !!scriptLabel,
        scriptTextarea: !!scriptTextarea,
        scriptHelp: !!scriptHelp,
        manimTypeInput: !!manimTypeInput,
        manimTypeValue: manimTypeInput?.value
    });
    
    if (!scriptLabel || !scriptTextarea || !scriptHelp) {
        console.log('‚ùå Script elements not found, retrying in 100ms...');
        setTimeout(updatePromptVisibilityForBarChart, 100);
        return;
    }
    
    const isBarChart = manimTypeInput && (manimTypeInput.value === 'bar_chart' || manimTypeInput.value === 'modern_bar_chart');
    console.log('üîç isBarChart:', isBarChart);
    
    if (isBarChart) {
        console.log('‚úÖ HIDING prompt for bar_chart');
        scriptLabel.style.display = 'none';
        scriptTextarea.style.display = 'none';
        scriptHelp.style.display = 'none';
        scriptTextarea.removeAttribute('required');
    } else {
        console.log('‚úÖ SHOWING prompt (not bar_chart)');
        scriptLabel.style.display = 'block';
        scriptTextarea.style.display = 'block';
        scriptHelp.style.display = 'block';
        scriptTextarea.setAttribute('required', 'required');
    }
}

// Hacer la funci√≥n global disponible
window.updatePromptVisibilityForBarChart = updatePromptVisibilityForBarChart;
console.log('‚úÖ updatePromptVisibilityForBarChart assigned to window at', new Date().toISOString());

// Hacer la funci√≥n global disponible
// (Ahora asignada en creation_sidebar.html)

// Observer para vigilar cambios en el tipo de animaci√≥n
function setupManimTypeObserver() {
    const manimTypeInput = document.getElementById('manim-animation-type-input');
    if (!manimTypeInput) {
        console.log('ManIM type input not found, will retry...');
        setTimeout(setupManimTypeObserver, 100);
        return;
    }
    
    console.log('Setting up ManIM type observer');
    
    // Usar MutationObserver para vigilar cambios en el atributo value
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                const newValue = manimTypeInput.value;
                console.log('ManIM type changed via observer:', newValue);
                updatePromptVisibilityForBarChart();
            }
        });
    });
    
    observer.observe(manimTypeInput, {
        attributes: true,
        attributeFilter: ['value']
    });
    
    // Tambi√©n vigilar cambios via input/change events
    manimTypeInput.addEventListener('change', function() {
        console.log('ManIM type changed via event:', this.value);
        updatePromptVisibilityForBarChart();
    });
    
    manimTypeInput.addEventListener('input', function() {
        console.log('ManIM type input event:', this.value);
        updatePromptVisibilityForBarChart();
    });
    
    // Verificar estado inicial
    updatePromptVisibilityForBarChart();
}

// Funci√≥n global para actualizar el campo de script seg√∫n el modelo
function updateScriptFieldForModel(modelId) {
    const scriptLabel = document.getElementById('script-label');
    const scriptTextarea = document.getElementById('script-textarea');
    const scriptHelp = document.getElementById('script-help');
    const manimTypeInput = document.getElementById('manim-animation-type-input');
    const manimType = manimTypeInput ? manimTypeInput.value : 'quote';
    
    console.log('üîç updateScriptFieldForModel called:', {
        modelId,
        manimType,
        manimTypeInput: !!manimTypeInput,
        scriptLabel: !!scriptLabel,
        scriptTextarea: !!scriptTextarea,
        scriptHelp: !!scriptHelp
    });
    
    if (!scriptLabel || !scriptTextarea || !scriptHelp) {
        console.log('‚ùå Script elements not found, skipping update');
        return;
    }
    
    // Usar la funci√≥n dedicada para bar_chart
    if (modelId === 'manim-quote' && (manimType === 'bar_chart' || manimType === 'modern_bar_chart')) {
        updatePromptVisibilityForBarChart();
        return;
    }
    
    if (modelId === 'manim-quote') {
        console.log('‚úÖ Showing prompt for manim-quote');
        scriptLabel.style.display = 'block';
        scriptTextarea.style.display = 'block';
        scriptHelp.style.display = 'block';
        scriptLabel.innerHTML = 'Texto de la cita <span class="text-red-500">*</span>';
        scriptTextarea.placeholder = 'Escribe el texto de la cita que quieres animar...';
        scriptHelp.textContent = 'Escribe el texto de la cita. Puedes incluir saltos de l√≠nea para dividir en m√∫ltiples l√≠neas.';
        scriptTextarea.rows = 4;
        // A√±adir required
        scriptTextarea.setAttribute('required', 'required');
    } else {
        // Restaurar valores por defecto
        console.log('‚úÖ Showing default prompt');
        scriptLabel.style.display = 'block';
        scriptTextarea.style.display = 'block';
        scriptHelp.style.display = 'block';
        scriptLabel.innerHTML = 'Prompt / Gui√≥n <span class="text-red-500">*</span>';
        scriptTextarea.placeholder = 'Describe el video que quieres generar...';
        scriptHelp.textContent = 'S√© espec√≠fico y descriptivo. Incluye detalles sobre movimiento, estilo, colores, etc.';
        scriptTextarea.rows = 5;
        // A√±adir required
        scriptTextarea.setAttribute('required', 'required');
    }
}

// Debug: Verificar que HTMX est√© cargado
document.addEventListener('DOMContentLoaded', function() {
    const modelSelect = document.getElementById('model-select');
    
    if (modelSelect) {
        modelSelect.addEventListener('change', function() {
            console.log('Modelo seleccionado:', this.value);
            updateScriptFieldForModel(this.value);
        });
        
        // Ejecutar al cargar la p√°gina para el modelo inicialmente seleccionado
        updateScriptFieldForModel(modelSelect.value);
    }
    
    // Configurar observer para ManIM type
    setupManimTypeObserver();
    
    // Verificar estado inicial del prompt para bar_chart
    setTimeout(function() {
        console.log('Checking initial bar_chart state...');
        if (typeof updatePromptVisibilityForBarChart === 'function') {
            updatePromptVisibilityForBarChart();
        } else {
            console.log('updatePromptVisibilityForBarChart not available yet');
        }
    }, 100);
    
    // Listen for custom events from the sidebar
    window.addEventListener('manimDesignChanged', function(event) {
        console.log('üéØ Received manimDesignChanged event:', event.detail);
        const animationType = event.detail.animationType;
        
        // Update the hidden input
        const manimTypeInput = document.getElementById('manim-animation-type-input');
        if (manimTypeInput) {
            manimTypeInput.value = animationType;
            console.log('‚úÖ Updated manimTypeInput to:', animationType);
        }
        
        // Update prompt visibility
        if (typeof updatePromptVisibilityForBarChart === 'function') {
            updatePromptVisibilityForBarChart();
        } else {
            console.log('‚ùå updatePromptVisibilityForBarChart function not available');
        }
    });
});
    
    // Tambi√©n verificar el estado inicial del tipo de animaci√≥n
    const initialManimTypeInput = document.getElementById('manim-animation-type-input');
    if (initialManimTypeInput && (initialManimTypeInput.value === 'bar_chart' || initialManimTypeInput.value === 'modern_bar_chart')) {
        console.log('Initial state: bar_chart detected, updating prompt');
        updatePromptVisibilityForBarChart();
    }
    
    // Escuchar cuando HTMX actualiza los campos din√°micos
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'dynamic-fields' || event.detail.target.id === 'dynamic-fields-container') {
            const currentModel = modelSelect.value;
            // Peque√±o delay para asegurar que el input hidden se haya actualizado
            setTimeout(function() {
                updateScriptFieldForModel(currentModel);
                
                // Verificar si hay que inicializar barras
                const manimTypeInput = document.getElementById('manim-animation-type-input');
                if (manimTypeInput && (manimTypeInput.value === 'bar_chart' || manimTypeInput.value === 'modern_bar_chart')) {
                    setTimeout(function() {
                        if (typeof updateBarPreview === 'function') {
                            updateBarPreview();
                        }
                        // Forzar actualizaci√≥n del prompt
                        updatePromptVisibilityForBarChart();
                    }, 100);
                }
                
                // Configurar observer nuevamente despu√©s de HTMX
                setupManimTypeObserver();
            }, 50);
        }
    });
    
    // Escuchar cambios en el tipo de animaci√≥n de Manim
    const manimTypeInput = document.getElementById('manim-animation-type-input');
    if (manimTypeInput) {
        manimTypeInput.addEventListener('change', function() {
            const currentModel = modelSelect.value;
            // Peque√±o delay para asegurar que el valor se haya actualizado
            setTimeout(function() {
                updateScriptFieldForModel(currentModel);
                
                // Si cambi√≥ a bar_chart, inicializar las barras
                if (manimTypeInput.value === 'bar_chart' || manimTypeInput.value === 'modern_bar_chart') {
                    setTimeout(function() {
                        if (typeof updateBarPreview === 'function') {
                            updateBarPreview();
                        }
                        // Forzar actualizaci√≥n del prompt
                        updatePromptVisibilityForBarChart();
                    }, 50);
                }
            }, 50);
        });
    }
});
</script>

