{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Documentaci√≥n API - Atenea</title>
  {% csrf_token %}
  <meta name="csrf-token" content="{{ csrf_token }}">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/@tailwindcss/typography/dist/typography.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --primary-light: #dbeafe;
      --sidebar-width: 280px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    }

    /* Sidebar */
    .sidebar-link {
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .sidebar-link:hover {
      background-color: #f3f4f6;
      border-left-color: var(--primary-light);
    }

    .sidebar-link.active {
      color: var(--primary-dark);
      font-weight: 600;
      background-color: var(--primary-light);
      border-left-color: var(--primary);
    }

    .sidebar-folder {
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
      border-left: 2px solid transparent;
      transition: all 0.2s ease;
      cursor: default;
    }
    
    .sidebar-folder:hover {
      color: #374151;
    }
    
    .sidebar-folder img {
      filter: grayscale(0.3);
      opacity: 0.8;
    }

    /* Content */
    .doc-content h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e5e7eb;
    }

    .doc-content h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }

    .doc-content h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #374151;
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
    }

    .doc-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .doc-content table th {
      background-color: #f9fafb;
      font-weight: 600;
      text-align: left;
      padding: 0.75rem 1rem;
      border-bottom: 2px solid #e5e7eb;
      color: #374151;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .doc-content table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f3f4f6;
      color: #4b5563;
    }

    .doc-content table tr:last-child td {
      border-bottom: none;
    }

    .doc-content table tr:hover {
      background-color: #f9fafb;
    }

    .doc-content code {
      background-color: #f3f4f6;
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-size: 0.875em;
      color: #dc2626;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }

    .doc-content pre {
      background-color: #1f2937;
      color: #f9fafb;
      padding: 1.25rem;
      border-radius: 8px;
      overflow-x: auto;
      margin: 1.5rem 0;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .doc-content pre code {
      background-color: transparent;
      color: inherit;
      padding: 0;
    }

    .doc-content blockquote {
      border-left: 4px solid var(--primary);
      background-color: #eff6ff;
      padding: 1rem 1.5rem;
      margin: 1.5rem 0;
      border-radius: 0 8px 8px 0;
    }

    .doc-content blockquote p {
      margin: 0;
      color: #1e40af;
    }

    .doc-content ul, .doc-content ol {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }

    .doc-content li {
      margin: 0.5rem 0;
      color: #4b5563;
    }

    .doc-content hr {
      border: none;
      border-top: 2px solid #e5e7eb;
      margin: 2rem 0;
    }

    .endpoint-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .endpoint-badge.post {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .endpoint-badge.get {
      background-color: #dcfce7;
      color: #166534;
    }

    .endpoint-badge.put {
      background-color: #fef3c7;
      color: #92400e;
    }

    .endpoint-badge.delete {
      background-color: #fee2e2;
      color: #991b1b;
    }

    /* Breadcrumbs */
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 1.5rem;
    }

    .breadcrumb a {
      color: var(--primary);
      text-decoration: none;
      transition: color 0.2s;
    }

    .breadcrumb a:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    .breadcrumb-separator {
      color: #9ca3af;
    }

    /* Search */
    .search-container {
      position: relative;
    }

    .search-icon {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }

    .search-input {
      padding-left: 2.5rem;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -100%;
        transition: left 0.3s ease;
        z-index: 50;
        height: 100vh;
      }

      .sidebar.open {
        left: 0;
      }

      .content-wrapper {
        width: 100%;
      }
    }

    /* Chat styles */
    [x-cloak] { 
      display: none !important; 
    }

    .prose {
      color: inherit;
    }
    .prose p {
      margin-top: 0.5em;
      margin-bottom: 0.5em;
    }
    .prose ul, .prose ol {
      margin-top: 0.5em;
      margin-bottom: 0.5em;
    }
    .prose code {
      background-color: rgba(0, 0, 0, 0.1);
      padding: 0.125em 0.25em;
      border-radius: 0.25rem;
      font-size: 0.875em;
    }
    .prose pre {
      background-color: rgba(0, 0, 0, 0.05);
      padding: 0.75em;
      border-radius: 0.5rem;
      overflow-x: auto;
    }
    .prose pre code {
      background-color: transparent;
      padding: 0;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar w-70 bg-white border-r border-gray-200 flex flex-col shadow-sm">
      <!-- Header -->
      <div class="p-4 border-b border-gray-200">
        <button 
          onclick="window.location.href='/'" 
          class="flex items-center gap-2 w-full px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors text-sm font-medium"
        >
          <i class="fas fa-arrow-left"></i>
          <span>Volver al dashboard</span>
        </button>
      </div>

      <!-- Search -->
      <div class="p-4 border-b border-gray-200">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input 
            id="sidebar-search" 
            type="text" 
            placeholder="Buscar en documentaci√≥n..."
            class="search-input w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
          />
        </div>
      </div>

      <!-- Navigation -->
      <div class="flex-1 overflow-y-auto p-4">
        <!-- User Guide destacado -->
        <div class="mb-4 pb-4 border-b border-gray-200">
          <a href="/docs/app/GUIA_USUARIO" 
             class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg hover:from-blue-100 hover:to-indigo-100 transition-all group">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            <span class="text-sm font-semibold text-blue-900 group-hover:text-blue-950">Gu√≠a de Usuario</span>
            <span class="ml-auto text-xs bg-blue-200 text-blue-800 px-2 py-0.5 rounded">‚≠ê</span>
          </a>
        </div>
        
        <ul id="sidebar-list" class="space-y-1"></ul>
      </div>
    </div>

    <!-- Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Top Bar -->
      <div class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button id="mobile-menu-btn" class="md:hidden text-gray-600 hover:text-gray-900">
            <i class="fas fa-bars text-xl"></i>
          </button>
          <div>
            <h1 class="text-xl font-bold text-gray-900">Documentaci√≥n de Atenea</h1>
            <p class="text-sm text-gray-500 mt-1">Gu√≠as de usuario y referencia t√©cnica</p>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1 overflow-y-auto">
        <div class="max-w-4xl mx-auto px-6 py-8">
          <!-- Breadcrumbs -->
          <div id="breadcrumbs" class="breadcrumb"></div>

          <!-- Content -->
          <div id="doc-content" class="doc-content">
            <div class="text-center py-12">
              <i class="fas fa-book-open text-6xl text-gray-300 mb-4"></i>
              <h2 class="text-2xl font-semibold text-gray-700 mb-2">Bienvenido a la documentaci√≥n</h2>
              <p class="text-gray-500 mb-6">Selecciona un documento en el sidebar para ver su contenido.</p>
              <div class="flex gap-4 justify-center">
                <a href="/docs/app/GUIA_USUARIO" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                  üìñ Gu√≠a de Usuario
                </a>
                <a href="/docs/api/README" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors font-medium">
                  üîå API Reference
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// Configurar marked para mejor renderizado (solo si est√° disponible)
if (typeof marked !== 'undefined') {
  marked.setOptions({
    breaks: true,
    gfm: true,
    headerIds: true,
    mangle: false
  });
} else {
  console.warn('marked.js no est√° disponible. El renderizado de markdown puede fallar.');
}

// Utilidades
function formatEndpointBadge(method) {
  const colors = {
    'POST': 'post',
    'GET': 'get',
    'PUT': 'put',
    'DELETE': 'delete',
    'PATCH': 'put'
  };
  return `<span class="endpoint-badge ${colors[method] || 'post'}">${method}</span>`;
}

function formatPath(path) {
  return path.split('/').filter(Boolean).map(part => {
    return part.split('-').map(word => 
      word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
  });
}

function formatBreadcrumbName(name) {
  return name
    .replace(/_/g, ' ')
    .replace(/\b\w/g, l => l.toUpperCase())
    .replace('README', 'Overview')
    .replace('GUIA USUARIO', 'Gu√≠a de Usuario')
    .replace('TTS', 'Text-to-Speech');
}

function updateBreadcrumbs(path) {
  const breadcrumbs = document.getElementById('breadcrumbs');
  if (!path || path === 'README') {
    breadcrumbs.innerHTML = '<a href="/docs">Documentaci√≥n</a>';
    return;
  }

  const parts = path.split('/').filter(Boolean);
  let html = '<a href="/docs">Documentaci√≥n</a>';
  
  let currentPath = '';
  parts.forEach((part, index) => {
    currentPath += '/' + part;
    const formatted = formatBreadcrumbName(part);
    
    if (index < parts.length - 1) {
      html += `<span class="breadcrumb-separator">/</span><a href="/docs${currentPath}">${formatted}</a>`;
    } else {
      html += `<span class="breadcrumb-separator">/</span><span class="text-gray-900">${formatted}</span>`;
    }
  });

  breadcrumbs.innerHTML = html;
}

// Sidebar
async function loadSidebar() {
  try {
    const res = await fetch('/docs/structure/');
    const data = await res.json();
    const sidebarList = document.getElementById('sidebar-list');
    sidebarList.innerHTML = '';

    // Logos disponibles
    const logos = {
      'google': '/static/img/logos/google.png',
      'heygen': '/static/img/logos/heygen.png',
      'openai': '/static/img/logos/openai.svg',
      'elevenlabs': '/static/img/logos/elevenlabs.png',
      'freepik': '/static/img/logos/freepik.png',
      'vuela': '/static/img/logos/vuela.png',
      'manim': '/static/img/logos/manim.png'
    };

    // Iconos por tipo de carpeta
    const folderIcons = {
      'app': 'üìñ',
      'api': 'üîå',
      'getting-started': 'üöÄ',
      'services': '‚öôÔ∏è',
      'system': '‚öôÔ∏è',
      'video': 'üé¨',
      'image': 'üñºÔ∏è',
      'tts': 'üéôÔ∏è',
      'voices': 'üé§',
      'avatar': 'üë§',
      'images': 'üñºÔ∏è',
      'videos': 'üé¨',
      'resources': 'üì¶'
    };

    function getFolderIcon(key) {
      return folderIcons[key.toLowerCase()] || 'üìÅ';
    }

    function getLogo(key) {
      return logos[key.toLowerCase()] || null;
    }

    function formatName(name) {
      return name
        .replace(/_/g, ' ')
        .replace(/\b\w/g, l => l.toUpperCase())
        .replace('README', 'Overview')
        .replace('GUIA USUARIO', 'Gu√≠a de Usuario')
        .replace('TTS', 'Text-to-Speech');
    }

    function createList(obj, parentPath = '', level = 0) {
      const ul = document.createElement('ul');
      if (level === 0) {
        ul.classList.add('space-y-1');
      } else if (level === 1) {
        // Nivel de servicios (google, heygen, etc.)
        ul.classList.add('ml-2', 'mt-1', 'space-y-0.5', 'border-l-2', 'border-gray-100', 'pl-2');
      } else {
        // Niveles m√°s profundos
        ul.classList.add('ml-4', 'mt-0.5', 'space-y-0.5');
      }

      // Ordenar: primero READMEs, luego carpetas, luego archivos
      const sortedKeys = Object.keys(obj).sort((a, b) => {
        const aIsReadme = a === 'README.md';
        const bIsReadme = b === 'README.md';
        const aIsDir = typeof obj[a] === 'object';
        const bIsDir = typeof obj[b] === 'object';
        
        if (aIsReadme && !bIsReadme) return -1;
        if (!aIsReadme && bIsReadme) return 1;
        if (aIsDir && !bIsDir) return -1;
        if (!aIsDir && bIsDir) return 1;
        return a.localeCompare(b);
      });

      for (const key of sortedKeys) {
        const li = document.createElement('li');

        if (typeof obj[key] === 'string') {
          // Es un archivo
          // obj[key] es la ruta relativa desde docs/public/, ej: "app/GUIA_USUARIO.md"
          const urlPath = obj[key].replace('.md', '').replace(/\/$/, '');
          console.log('Creating sidebar link - key:', key, 'obj[key]:', obj[key], 'urlPath:', urlPath);
          const a = document.createElement('a');
          a.href = '#';
          
          const name = formatName(key.replace('.md', ''));
          a.textContent = name;
          a.classList.add('sidebar-link', 'block', 'px-2', 'py-1.5', 'rounded-md', 'text-sm', 'hover:bg-gray-50', 'truncate');
          a.dataset.route = urlPath;
          a.title = name; // Tooltip para texto truncado

          a.onclick = (e) => {
            e.preventDefault();
            console.log('Sidebar link clicked - urlPath:', urlPath);
            setActiveLink(a);
            history.pushState({ path: urlPath }, '', `/docs/${urlPath}`);
            loadDoc(urlPath);
            document.getElementById('sidebar').classList.remove('open');
          };

          li.appendChild(a);
        } else {
          // Es una carpeta
          const folderDiv = document.createElement('div');
          const icon = getFolderIcon(key);
          const logo = getLogo(key);
          const name = formatName(key);
          
          // Estilos diferentes seg√∫n nivel
          if (level === 0) {
            // Nivel ra√≠z (app, api)
            folderDiv.classList.add('sidebar-folder', 'px-2', 'py-2', 'mt-3', 'mb-1', 'flex', 'items-center', 'gap-2', 'text-xs', 'font-bold');
          } else if (level === 1 && logo) {
            // Nivel de servicios con logo
            folderDiv.classList.add('sidebar-folder', 'px-2', 'py-1.5', 'mt-2', 'mb-1', 'flex', 'items-center', 'gap-2', 'text-xs', 'font-semibold');
          } else {
            // Niveles m√°s profundos
            folderDiv.classList.add('sidebar-folder', 'px-2', 'py-1', 'mt-1.5', 'mb-0.5', 'flex', 'items-center', 'gap-1.5', 'text-xs');
          }
          
          if (logo) {
            folderDiv.innerHTML = `<img src="${logo}" alt="${name}" class="w-4 h-4 object-contain flex-shrink-0" onerror="this.style.display='none'"><span class="truncate">${name}</span>`;
          } else {
            folderDiv.innerHTML = `<span class="flex-shrink-0">${icon}</span><span class="truncate">${name}</span>`;
          }
          
          li.appendChild(folderDiv);
          
          const subList = createList(obj[key], parentPath + key + '/', level + 1);
          if (subList.children.length > 0) {
            li.appendChild(subList);
          }
        }

        ul.appendChild(li);
      }

      return ul;
    }

    sidebarList.appendChild(createList(data));

    // B√∫squeda mejorada
    const searchInput = document.getElementById('sidebar-search');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        const allItems = document.querySelectorAll('#sidebar-list li');
        
        if (!query) {
          // Si no hay query, mostrar todos los items
          allItems.forEach(li => {
            li.style.display = '';
            // Mostrar todos los padres tambi√©n
            let parent = li.parentElement;
            while (parent && parent !== sidebarList) {
              if (parent.tagName === 'UL') {
                parent.style.display = '';
              }
              parent = parent.parentElement;
            }
          });
          return;
        }
        
        allItems.forEach(li => {
          const link = li.querySelector('.sidebar-link');
          const folder = li.querySelector('.sidebar-folder');
          
          if (link) {
            const text = link.textContent.toLowerCase();
            if (text.includes(query)) {
              li.style.display = '';
              // Mostrar padres
              let parent = li.parentElement;
              while (parent && parent !== sidebarList) {
                if (parent.tagName === 'UL') {
                  parent.style.display = '';
                }
                parent = parent.parentElement;
              }
            } else {
              li.style.display = 'none';
            }
          } else if (folder) {
            // Verificar si alg√∫n hijo coincide
            const childLinks = Array.from(li.querySelectorAll('.sidebar-link'));
            const hasMatch = childLinks.some(
              link => link.textContent.toLowerCase().includes(query)
            );
            const folderMatches = folder.textContent.toLowerCase().includes(query);
            
            if (hasMatch || folderMatches) {
              li.style.display = '';
              // Mostrar todos los hijos que coinciden
              childLinks.forEach(childLink => {
                const childLi = childLink.closest('li');
                if (childLi && childLink.textContent.toLowerCase().includes(query)) {
                  childLi.style.display = '';
                }
              });
            } else if (query) {
              li.style.display = 'none';
            } else {
              li.style.display = '';
            }
          }
        });
      });
    }

    // Cargar doc de la URL actual si existe
    let pathFromUrl = window.location.pathname.replace(/^\/docs\/?/, '').replace(/\.md$/, '').replace(/\/$/, '');
    console.log('Path from URL:', pathFromUrl, 'Full pathname:', window.location.pathname);
    
    if (pathFromUrl && pathFromUrl !== '') {
      // Buscar el link en el sidebar
      let activeLink = document.querySelector(`a[data-route="${pathFromUrl}"]`);
      
      // Si no se encuentra, intentar buscar todos los links y ver cu√°l coincide
      if (!activeLink) {
        console.log('No se encontr√≥ link exacto, buscando alternativas...');
        const allLinks = document.querySelectorAll('a[data-route]');
        allLinks.forEach(link => {
          console.log('Link encontrado:', link.dataset.route);
        });
      }
      
      if (activeLink) {
        setActiveLink(activeLink);
        activeLink.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        console.warn('No se encontr√≥ link activo para:', pathFromUrl);
      }
      
      await loadDoc(pathFromUrl);
    } else {
      // Si no hay path, cargar el README principal
      console.log('No hay path en URL, cargando README principal');
      await loadDoc('README');
    }

  } catch (err) {
    console.error('Error cargando el sidebar:', err);
    document.getElementById('sidebar-list').innerHTML = '<li class="text-red-500 px-3 py-2">Error al cargar la documentaci√≥n</li>';
  }
}

function setActiveLink(link) {
  document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
  if (link) link.classList.add('active');
}

async function loadDoc(servicePath) {
  try {
    // servicePath puede ser: "app/GUIA_USUARIO" o "api/services/google/video/text_to_video"
    // Eliminar trailing slash y .md si existe
    servicePath = servicePath.replace(/\/$/, '').replace(/\.md$/, '');
    
    console.log('Loading doc with path:', servicePath);
    
    const contentDiv = document.getElementById('doc-content');
    if (!contentDiv) {
      console.error('No se encontr√≥ el elemento doc-content');
      return;
    }
    
    // Mostrar loading
    contentDiv.innerHTML = '<div class="flex items-center justify-center py-12"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>';
    
    // Crear AbortController para timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 segundos timeout
    
    const fetchUrl = `/docs/${servicePath}/`;
    console.log('Fetching URL:', fetchUrl);
    
    let res;
    try {
      res = await fetch(fetchUrl, {
        signal: controller.signal,
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      });
    } catch (fetchError) {
      clearTimeout(timeoutId);
      if (fetchError.name === 'AbortError') {
        throw new Error('La petici√≥n tard√≥ demasiado. Por favor, intenta de nuevo.');
      }
      throw new Error(`Error de red: ${fetchError.message}`);
    }
    
    clearTimeout(timeoutId);
    
    // Verificar Content-Type
    const contentType = res.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      const text = await res.text();
      console.error('Respuesta no es JSON:', text.substring(0, 200));
      throw new Error(`Respuesta inv√°lida del servidor. Content-Type: ${contentType}`);
    }
    
    if (!res.ok) {
      const errorText = await res.text();
      console.error('Error en respuesta:', errorText);
      throw new Error(`Documento no encontrado: ${servicePath} (${res.status})`);
    }
    
    let data;
    try {
      data = await res.json();
    } catch (jsonError) {
      const text = await res.text();
      console.error('Error parseando JSON:', jsonError, 'Respuesta:', text.substring(0, 200));
      throw new Error('Error al procesar la respuesta del servidor');
    }
    
    // Validar que data tiene content
    if (!data || typeof data !== 'object') {
      console.error('Respuesta inv√°lida:', data);
      throw new Error('Formato de respuesta inv√°lido');
    }
    
    // Verificar si hay un error en la respuesta
    if (data.error) {
      throw new Error(data.error || 'Error desconocido del servidor');
    }
    
    // Verificar que tiene content
    if (!data.content && data.content !== '') {
      console.error('Respuesta sin content:', data);
      throw new Error('El documento no tiene contenido');
    }
    
    // Preprocesar bloques Mermaid antes de parsear con marked
    let content = data.content;
    
    // Validar que content es string
    if (typeof content !== 'string') {
      console.error('Content no es string:', typeof content, content);
      throw new Error('El contenido del documento no es v√°lido');
    }
    
    // Detectar bloques de c√≥digo mermaid y marcarlos
    content = content.replace(/```mermaid\n([\s\S]*?)```/g, (match, diagram) => {
      return `<div class="mermaid-diagram" data-mermaid="${encodeURIComponent(diagram.trim())}"></div>`;
    });
    
    // Validar que marked est√© disponible
    if (typeof marked === 'undefined') {
      throw new Error('La librer√≠a marked.js no est√° cargada. Por favor, recarga la p√°gina.');
    }
    
    // Parsear markdown
    let html = marked.parse(content);
    
    // Validar que el parseo fue exitoso
    if (!html || typeof html !== 'string') {
      console.error('Error parseando markdown:', html);
      throw new Error('Error al procesar el contenido markdown');
    }
    
    // Reemplazar marcadores de Mermaid con divs reales
    html = html.replace(/<div class="mermaid-diagram" data-mermaid="([^"]+)"><\/div>/g, (match, encoded) => {
      const diagram = decodeURIComponent(encoded);
      return `<div class="mermaid my-8">${diagram}</div>`;
    });
    
    // Mejorar formato de endpoints
    html = html.replace(/\*\*Endpoint:\*\*\s*`([A-Z]+)\s+([^`]+)`/g, (match, method, url) => {
      return `<div class="flex items-center gap-3 mb-4">
        ${formatEndpointBadge(method)}
        <code class="text-base font-mono">${url}</code>
      </div>`;
    });

    // Mejorar formato de funciones
    html = html.replace(/\*\*Funci[√≥o]n:\*\*\s*`([^`]+)`/g, (match, func) => {
      return `<div class="mb-4">
        <span class="text-sm text-gray-500">Funci√≥n:</span>
        <code class="ml-2 text-base">${func}</code>
      </div>`;
    });

    // Ocultar pantalla de bienvenida
    const welcomeScreen = document.getElementById('welcome-screen');
    if (welcomeScreen) {
      welcomeScreen.style.display = 'none';
    }
    
    contentDiv.innerHTML = html;

    // Renderizar diagramas Mermaid despu√©s de insertar HTML
    if (typeof mermaid !== 'undefined') {
      mermaid.initialize({ 
        startOnLoad: false,
        theme: 'default',
        securityLevel: 'loose',
        flowchart: {
          useMaxWidth: true,
          htmlLabels: true
        }
      });
      
      // Renderizar todos los divs con clase mermaid
      const mermaidElements = contentDiv.querySelectorAll('.mermaid');
      if (mermaidElements.length > 0) {
        mermaid.run({ nodes: mermaidElements });
      }
    }

    // Actualizar breadcrumbs
    updateBreadcrumbs(servicePath);

    // Reiniciar scroll
    const scrollContainer = document.querySelector('.flex-1.overflow-y-auto');
    if (scrollContainer) scrollContainer.scrollTop = 0;

    // Crear los SVG
    const svg1HTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12Zm0 3h.008v.008H6.75V15Zm0 3h.008v.008H6.75V18Z"/>
    </svg>`;

    const svg2HTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1">
      <path stroke-linecap="round" stroke-linejoin="round" d="M11.35 3.836c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m8.9-4.414c.376.023.75.05 1.124.08 1.131.094 1.976 1.057 1.976 2.192V16.5A2.25 2.25 0 0 1 18 18.75h-2.25m-7.5-10.5H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V18.75m-7.5-10.5h6.375c.621 0 1.125.504 1.125 1.125v9.375m-8.25-3 1.5 1.5 3-3.75"/>
    </svg>`;

    // Bot√≥n de copiar con estado
    contentDiv.querySelectorAll('pre code').forEach(codeBlock => {
      const pre = codeBlock.parentElement;
      pre.style.position = 'relative';
      pre.style.paddingTop = '2.5rem';  // deja espacio arriba

      const button = document.createElement('button');
      button.className = 'flex items-center absolute top-2 right-2 text-gray-300 px-2 py-1 border border-gray-300 rounded hover:bg-balck';
      button.innerHTML =  svg1HTML + `<span class="text-sm">Copiar</span>`;

      button.addEventListener('click', () => {
        navigator.clipboard.writeText(codeBlock.textContent).then(() => {
          // Cambiar estado
          button.innerHTML = svg2HTML + `<span class="text-sm">¬°Copiado!</span>`;
          setTimeout(() => {
            button.innerHTML = svg1HTML +  `<span class="text-sm">Copiar</span>`;
          }, 1500);
        });
      });

      pre.appendChild(button);
    });

    // Procesar enlaces internos de documentaci√≥n (convertir enlaces markdown a enlaces funcionales)
    contentDiv.querySelectorAll('a[href]').forEach(a => {
      const href = a.getAttribute('href');
      
      // Si es un enlace interno de documentaci√≥n (empieza con /docs/ o es relativo a docs/)
      if (href.startsWith('/docs/')) {
        e.preventDefault();
        const docPath = href.replace('/docs/', '').replace(/\.md$/, '').replace(/\/$/, '');
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const sidebarLink = document.querySelector(`a[data-route="${docPath}"]`);
          if (sidebarLink) {
            setActiveLink(sidebarLink);
          }
          history.pushState({ path: docPath }, '', `/docs/${docPath}`);
          loadDoc(docPath);
        });
        // Cambiar href para que sea clickeable
        a.href = '#';
        a.style.cursor = 'pointer';
      }
      // Si es un enlace relativo que apunta a otro documento markdown
      else if (href.includes('.md') && !href.startsWith('http') && !href.startsWith('#')) {
        // Convertir rutas relativas a rutas absolutas
        // Ejemplo: "public/app/GUIA_USUARIO.md" -> "app/GUIA_USUARIO"
        let docPath = href.replace(/\.md$/, '').replace(/\/$/, '');
        // Si empieza con "public/", quitarlo
        if (docPath.startsWith('public/')) {
          docPath = docPath.replace('public/', '');
        }
        // Si empieza con "private/", ignorarlo (documentaci√≥n privada)
        if (docPath.startsWith('private/')) {
          a.style.opacity = '0.5';
          a.title = 'Documentaci√≥n privada (solo disponible en el repositorio)';
          return;
        }
        
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const sidebarLink = document.querySelector(`a[data-route="${docPath}"]`);
          if (sidebarLink) {
            setActiveLink(sidebarLink);
          }
          history.pushState({ path: docPath }, '', `/docs/${docPath}`);
          loadDoc(docPath);
        });
        a.href = '#';
        a.style.cursor = 'pointer';
      }
    });

    // Delegar click de enlaces internos con data-route
    contentDiv.querySelectorAll('a[data-route]').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        const sidebarLink = document.querySelector(`a[data-route="${a.dataset.route}"]`);
        setActiveLink(sidebarLink);
        history.pushState({ path: a.dataset.route }, '', `/docs/${a.dataset.route}`);
        loadDoc(a.dataset.route);
      });
    });

    // Scroll suave para anclas
    contentDiv.querySelectorAll('a[href^="#"]').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        const targetId = a.getAttribute('href').substring(1);
        const target = document.getElementById(targetId);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });

  } catch (err) {
    console.error('Error cargando doc:', err);
    const contentDiv = document.getElementById('doc-content');
    if (!contentDiv) {
      console.error('No se encontr√≥ el elemento doc-content para mostrar el error');
      return;
    }
    
    const welcomeScreen = document.getElementById('welcome-screen');
    if (welcomeScreen) {
      welcomeScreen.style.display = 'none';
    }
    
    const errorMessage = err.message || 'Error desconocido al cargar el documento';
    contentDiv.innerHTML = `
      <div class="bg-red-50 border border-red-200 rounded-lg p-6 max-w-2xl mx-auto">
        <div class="flex items-center gap-2 text-red-800 mb-3">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span class="font-semibold text-lg">Error al cargar el documento</span>
        </div>
        <p class="text-red-600 mt-2 mb-4">${errorMessage}</p>
        <div class="flex gap-3">
          <a href="/docs" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
            ‚Üê Volver al inicio
          </a>
          <button onclick="location.reload()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">
            Recargar p√°gina
          </button>
        </div>
        ${err.stack ? `<details class="mt-4"><summary class="text-sm text-gray-600 cursor-pointer">Detalles t√©cnicos</summary><pre class="mt-2 text-xs text-gray-500 overflow-auto">${err.stack}</pre></details>` : ''}
      </div>
    `;
  }
}

// Manejo de back/forward
window.addEventListener('popstate', (event) => {
  const path = (event.state && event.state.path) || window.location.pathname.replace(/^\/docs\//, '');
    if (!path || path === '') {
      updateBreadcrumbs('');
      const welcomeScreen = document.getElementById('welcome-screen');
      if (welcomeScreen) {
        welcomeScreen.style.display = 'block';
      }
      const contentDiv = document.getElementById('doc-content');
      // Limpiar contenido excepto welcome screen
      Array.from(contentDiv.children).forEach(child => {
        if (child.id !== 'welcome-screen') {
          child.remove();
        }
      });
      return;
    }
  const activeLink = document.querySelector(`a[data-route="${path}"]`);
  setActiveLink(activeLink);
  loadDoc(path);
});

// Men√∫ m√≥vil
document.getElementById('mobile-menu-btn')?.addEventListener('click', () => {
  document.getElementById('sidebar').classList.toggle('open');
});

// Cerrar sidebar al hacer click fuera en m√≥vil
document.addEventListener('click', (e) => {
  const sidebar = document.getElementById('sidebar');
  const menuBtn = document.getElementById('mobile-menu-btn');
  if (window.innerWidth <= 768 && 
      sidebar.classList.contains('open') && 
      !sidebar.contains(e.target) && 
      !menuBtn?.contains(e.target)) {
    sidebar.classList.remove('open');
  }
});

// Inicializar
loadSidebar();
</script>

<!-- Asistente de Chat -->
{% if user.is_authenticated %}
<!-- Bot√≥n flotante -->
<button x-data="{ chatOpen: false }"
        @click="chatOpen = true; window.dispatchEvent(new CustomEvent('open-chat'))"
        x-show="!chatOpen"
        class="fixed bottom-6 right-6 z-50 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-all hover:scale-110 flex items-center justify-center"
        style="z-index: 9999;"
        title="Asistente de Documentaci√≥n">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
    </svg>
</button>

<!-- Chat Modal -->
<div x-data="{
    open: false,
    messages: [],
    inputMessage: '',
    loading: false,
    init() {
        // Escuchar eventos de apertura del chat
        window.addEventListener('open-chat', () => {
            this.open = true;
            sessionStorage.setItem('docs_chat_open', 'true');
            this.$nextTick(() => {
                const container = this.$refs.messagesContainer;
                if (container) container.scrollTop = container.scrollHeight;
            });
        });
        
        // Escuchar eventos de cierre del chat
        window.addEventListener('close-chat', () => {
            this.open = false;
        });
        
        // Mantener el estado del chat al navegar (opcional: persistir en sessionStorage)
        const savedState = sessionStorage.getItem('docs_chat_open');
        if (savedState === 'true') {
            this.open = true;
        }
    },
    close() {
        this.open = false;
        sessionStorage.setItem('docs_chat_open', 'false');
        window.dispatchEvent(new CustomEvent('close-chat'));
    },
    async sendMessage() {
        if (!this.inputMessage.trim() || this.loading) return;
        
        const question = this.inputMessage.trim();
        this.inputMessage = '';
        
        this.messages.push({
            role: 'user',
            content: question,
            sources: []
        });
        
        this.loading = true;
        this.scrollToBottom();
        
        try {
            const chatHistory = this.messages
                .filter(m => m.role !== 'assistant' || !m.sources)
                .map(m => ({ role: m.role, content: m.content }));
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             document.querySelector('meta[name=csrf-token]')?.content;
            
            const response = await fetch('{% url "core:doc_assistant_chat" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    question: question,
                    chat_history: JSON.stringify(chatHistory)
                })
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            this.messages.push({
                role: 'assistant',
                content: data.answer,
                sources: data.sources || []
            });
            
        } catch (error) {
            console.error('Error:', error);
            this.messages.push({
                role: 'assistant',
                content: `Lo siento, ocurri√≥ un error: ${error.message}`,
                sources: []
            });
        } finally {
            this.loading = false;
            this.scrollToBottom();
        }
    },
    scrollToBottom() {
        this.$nextTick(() => {
            const container = this.$refs.messagesContainer;
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        });
    },
    
    renderMarkdown(text) {
        if (typeof marked !== 'undefined') {
            return marked.parse(text);
        }
        // Fallback si marked no est√° disponible
        return text.replace(/\n/g, '<br>');
    }
}"
x-show="open"
x-cloak
class="fixed bottom-6 right-6"
style="display: none; z-index: 10000;"
    <div class="bg-white rounded-lg shadow-2xl flex flex-col border border-gray-200"
         style="width: 420px; height: 600px; max-height: calc(100vh - 120px);">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0 bg-gradient-to-r from-blue-50 to-white">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Asistente de Documentaci√≥n</h2>
                    <p class="text-xs text-gray-500">Chatea con la documentaci√≥n de Atenea</p>
                </div>
            </div>
            <button @click="close()"
                    class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Chat Messages -->
        <div class="flex-1 overflow-y-auto p-4 space-y-3"
             x-ref="messagesContainer">
            <!-- Mensaje de bienvenida -->
            <template x-if="messages.length === 0">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="bg-gradient-to-br from-blue-50 to-gray-50 rounded-lg p-4 text-sm text-gray-800 border border-blue-100 shadow-sm">
                            <p class="font-semibold mb-2 text-gray-900">¬°Hola! üëã Soy tu asistente de documentaci√≥n de Atenea.</p>
                            <p class="mb-2 text-gray-700">Puedo ayudarte a:</p>
                            <ul class="list-disc list-inside space-y-1 ml-2 text-gray-700">
                                <li>Entender qu√© puede hacer la aplicaci√≥n</li>
                                <li>Navegar por la documentaci√≥n</li>
                                <li>Encontrar informaci√≥n sobre funcionalidades espec√≠ficas</li>
                                <li>Responder preguntas sobre c√≥mo usar Atenea</li>
                            </ul>
                            <p class="mt-3 text-gray-900 font-medium">¬øEn qu√© puedo ayudarte hoy?</p>
                        </div>
                    </div>
                </div>
            </template>
            
            <!-- Mensajes del chat -->
            <template x-for="(message, index) in messages" :key="index">
                <div class="flex items-start space-x-3"
                     :class="message.role === 'user' ? 'flex-row-reverse space-x-reverse' : ''">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0"
                         :class="message.role === 'user' ? 'bg-blue-600' : 'bg-gray-200'">
                        <template x-if="message.role === 'user'">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </template>
                        <template x-if="message.role === 'assistant'">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                        </template>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="rounded-lg p-3 text-sm shadow-sm"
                             :class="message.role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-50 text-gray-800 border border-gray-100'">
                            <template x-if="message.role === 'user'">
                                <p x-text="message.content" class="whitespace-pre-wrap"></p>
                            </template>
                            <template x-if="message.role === 'assistant'">
                                <div x-html="renderMarkdown(message.content)" class="prose prose-sm max-w-none"></div>
                            </template>
                            <!-- Fuentes -->
                            <template x-if="message.role === 'assistant' && message.sources && message.sources.length > 0">
                                <div class="mt-3 pt-2 border-t border-gray-200">
                                    <p class="text-xs font-semibold mb-1.5 text-gray-500 uppercase tracking-wide">Fuentes:</p>
                                    <ul class="text-xs space-y-1 text-gray-600">
                                        <template x-for="source in message.sources" :key="source">
                                            <li class="flex items-center space-x-1.5 hover:text-gray-900 transition-colors">
                                                <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                                <span class="truncate" x-text="source"></span>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
            
            <!-- Indicador de carga -->
            <div x-show="loading" class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-gray-600 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="bg-gray-50 rounded-lg p-3 text-sm text-gray-600 border border-gray-100 shadow-sm">
                        <span class="inline-flex items-center">
                            <span class="animate-pulse">‚óè</span>
                            <span class="ml-2">Pensando...</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="p-3 border-t border-gray-200 flex-shrink-0 bg-gray-50">
            <form @submit.prevent="sendMessage()"
                  class="space-y-1">
                <div class="flex gap-2">
                    <div class="flex-1 relative">
                        <textarea x-model="inputMessage"
                                  @keydown.enter="if (!$event.shiftKey) { $event.preventDefault(); sendMessage(); }"
                                  placeholder="¬øQu√© quieres saber sobre Atenea?"
                                  rows="2"
                                  class="w-full px-3 py-2 pr-20 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none bg-white placeholder-gray-400"
                                  :disabled="loading"
                                  style="line-height: 1.5;"></textarea>
                        <div class="absolute bottom-2 right-2 text-xs text-gray-400 pointer-events-none">
                            <span>Enter</span><span class="text-gray-300"> ‚Ä¢ </span><span>Shift+Enter</span>
                        </div>
                    </div>
                    <button type="submit"
                            :disabled="loading || !inputMessage.trim()"
                            class="bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center flex-shrink-0"
                            style="width: 2.5rem; height: 3.5rem; align-self: flex-end; margin-bottom: 0.5rem;">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

</body>
</html>
