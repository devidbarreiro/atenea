{% extends 'base.html' %}
{% load static %}

{% block title %}Chat de Creaci√≥n - Atenea{% endblock %}

{% block extra_css %}
<style>
    [x-cloak] { 
        display: none !important; 
    }
    
    .chat-container {
        height: calc(100vh - 220px);
        display: flex;
        flex-direction: column;
        min-height: 400px;
    }
    
    .messages-area {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
        scroll-behavior: smooth;
    }
    
    .message-bubble {
        max-width: 85%;
    }
    
    @media (max-width: 640px) {
        .message-bubble {
            max-width: 90%;
        }
        .chat-container {
            height: calc(100vh - 200px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div x-data="Object.assign(chatApp(), { sidebarCollapsed: localStorage.getItem('sidebarCollapsed') === 'true' })" 
     x-init="
        window.addEventListener('sidebar-toggled', (e) => { sidebarCollapsed = e.detail.collapsed; });
        init();
     "
     class="max-w-5xl mx-auto">
    
    <!-- Chat Container -->
    <div class="chat-container bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 flex-shrink-0 bg-gradient-to-r from-blue-50 to-white rounded-t-xl">
            <div class="flex items-center gap-3">
                <img src="{% static 'img/logos/atenea.png' %}" alt="Atenea" class="h-10">
                <div>
                    <div class="flex items-center gap-2">
                        <h1 class="text-lg font-semibold text-gray-900">Chat de Creaci√≥n</h1>
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded font-medium">Beta</span>
                    </div>
                    <p class="text-xs text-gray-500">Crea contenido audiovisual con IA</p>
                </div>
            </div>
        </div>
        
        <!-- Messages Area -->
        <div class="messages-area p-6 space-y-4" x-ref="messagesContainer">
            <template x-for="(message, index) in messages" :key="message.id">
                <div class="flex items-start gap-3"
                     :class="message.role === 'user' ? 'flex-row-reverse' : ''">
                    <!-- Avatar -->
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden"
                         :class="message.role === 'user' ? 'bg-blue-600' : 'bg-gray-200'">
                        <template x-if="message.role === 'user'">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </template>
                        <template x-if="message.role === 'assistant'">
                            <img src="{% static 'img/logos/atenea.png' %}" alt="Atenea" class="w-full h-full object-cover">
                        </template>
                    </div>
                    
                    <!-- Message Content -->
                    <div class="flex-1 min-w-0 message-bubble"
                         :class="message.role === 'user' ? 'ml-auto' : ''">
                        <div class="rounded-lg p-4 shadow-sm"
                             :class="message.role === 'user' ? 'bg-blue-600 text-white' : 'bg-white border border-gray-200'">
                            <template x-if="message.role === 'user'">
                                <p x-text="message.content" class="whitespace-pre-wrap text-sm"></p>
                            </template>
                            <template x-if="message.role === 'assistant'">
                                <div>
                                    <div x-html="message.renderedContent || renderMarkdown(message.content)" class="prose prose-sm max-w-none text-sm"></div>
                                    
                                    <!-- Tool Results -->
                                    <template x-if="message.tool_results && message.tool_results.length > 0">
                                        <div class="mt-4 space-y-3">
                                            <template x-for="(result, idx) in message.tool_results" :key="idx">
                                                <div>
                                                    <!-- Image -->
                                                    <template x-if="result[1] && result[1].image_id">
                                                        <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                                                            <template x-if="result[1].preview_url && result[1].status_current === 'completed'">
                                                                <img :src="result[1].preview_url" 
                                                                     :alt="result[1].title || 'Imagen'" 
                                                                     class="w-full rounded-lg mb-2">
                                                            </template>
                                                            <a :href="result[1].detail_url" 
                                                               class="text-sm text-green-700 hover:text-green-900 underline">
                                                                Ver imagen ‚Üí
                                                            </a>
                                                        </div>
                                                    </template>
                                                    
                                                    <!-- Video -->
                                                    <template x-if="result[1] && result[1].video_id">
                                                        <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg" 
                                                             x-data="videoLoader(result[1].video_id, result[1].status_current, result[1].preview_url)"
                                                             x-init="init()">
                                                            <!-- Loading State -->
                                                            <template x-if="status === 'pending' || status === 'processing'">
                                                                <div class="space-y-3">
                                                                    <div class="flex items-center gap-3 p-4 bg-white rounded-lg border border-blue-200">
                                                                        <svg class="w-6 h-6 text-blue-600 animate-spin" fill="none" viewBox="0 0 24 24">
                                                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                                        </svg>
                                                                        <div class="flex-1">
                                                                            <p class="text-sm font-medium text-blue-900" x-text="message"></p>
                                                                            <p class="text-xs text-blue-600 mt-1">El video se cargar√° autom√°ticamente cuando est√© listo</p>
                                                                        </div>
                                                                    </div>
                                                                    <a :href="detailUrl" 
                                                                       class="inline-flex items-center gap-2 text-sm text-blue-700 hover:text-blue-900 underline">
                                                                        <span>Ver video ‚Üí</span>
                                                                    </a>
                                                                </div>
                                                            </template>
                                                            
                                                            <!-- Completed State -->
                                                            <template x-if="status === 'completed' && previewUrl">
                                                                <div class="space-y-2">
                                                                    <video :src="previewUrl" controls class="w-full rounded-lg"></video>
                                                                    <a :href="detailUrl" 
                                                                       class="inline-flex items-center gap-2 text-sm text-blue-700 hover:text-blue-900 underline">
                                                                        <span>Ver video completo ‚Üí</span>
                                                                    </a>
                                                                </div>
                                                            </template>
                                                            
                                                            <!-- Error State -->
                                                            <template x-if="status === 'error'">
                                                                <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                                                                    <p class="text-sm text-red-800">‚ùå Error al generar el video</p>
                                                                    <a :href="detailUrl" 
                                                                       class="text-sm text-red-700 hover:text-red-900 underline mt-2 inline-block">
                                                                        Ver detalles ‚Üí
                                                                    </a>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    
                                                    <!-- Audio -->
                                                    <template x-if="result[1] && result[1].audio_id">
                                                        <div class="mt-3 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                                                            <template x-if="result[1].preview_url && result[1].status_current === 'completed'">
                                                                <audio controls class="w-full mb-2">
                                                                    <source :src="result[1].preview_url" type="audio/mpeg">
                                                                </audio>
                                                            </template>
                                                            <a :href="result[1].detail_url" 
                                                               class="text-sm text-purple-700 hover:text-purple-900 underline">
                                                                Ver audio ‚Üí
                                                            </a>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
            
            <!-- Loading Indicator -->
            <div x-show="loading" 
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 class="flex items-start gap-3">
                <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                    <img src="{% static 'img/logos/atenea.png' %}" alt="Atenea" class="w-full h-full object-cover">
                </div>
                <div class="flex-1 message-bubble">
                    <div class="bg-white border border-gray-200 rounded-lg p-4 text-sm text-gray-600 shadow-sm">
                        <span class="inline-flex items-center gap-2">
                            <span class="animate-pulse">‚óè</span>
                            <span>Creando contenido...</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="border-t border-gray-200 p-4 bg-gray-50 rounded-b-xl flex-shrink-0">
            <form @submit.prevent="sendMessage()" class="flex gap-3 items-end">
                <div class="flex-1 relative">
                    <textarea x-model="inputMessage"
                              @keydown.enter="if (!$event.shiftKey) { $event.preventDefault(); sendMessage(); }"
                              placeholder="Ej: Crea una imagen de un perro haciendo surf"
                              rows="2"
                              class="w-full px-4 py-3 pr-20 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none bg-white"
                              :disabled="loading"
                              style="min-height: 3rem; max-height: 8rem;"></textarea>
                    <div class="absolute bottom-2 right-2 text-xs text-gray-400 pointer-events-none flex items-center gap-1">
                        <kbd class="px-1.5 py-0.5 bg-gray-100 rounded text-xs">Enter</kbd>
                        <span class="text-gray-300">‚Ä¢</span>
                        <kbd class="px-1.5 py-0.5 bg-gray-100 rounded text-xs">Shift+Enter</kbd>
                    </div>
                </div>
                <button type="submit"
                        :disabled="loading || !inputMessage.trim()"
                        class="bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed px-6 py-3 flex items-center justify-center flex-shrink-0 transition-colors shadow-sm hover:shadow-md"
                        style="min-height: 3rem;">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
function chatApp() {
    return {
        messages: [],
        inputMessage: '',
        loading: false,
        
        init() {
            // Detectar si hay un mensaje en la URL (viene del dashboard)
            const urlParams = new URLSearchParams(window.location.search);
            const messageFromUrl = urlParams.get('message');
            
            if (messageFromUrl && messageFromUrl.trim()) {
                // Limpiar la URL para que no se vea el par√°metro
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Establecer el mensaje en el input y enviarlo autom√°ticamente
                this.inputMessage = decodeURIComponent(messageFromUrl.trim());
                
                // Esperar un momento para que Alpine renderice y luego enviar
                this.$nextTick(() => {
                    setTimeout(() => {
                        this.sendMessage();
                    }, 300);
                });
            }
        },
        
        async sendMessage() {
            if (!this.inputMessage.trim() || this.loading) return;
            
            const message = this.inputMessage.trim();
            this.inputMessage = '';
            
            // Agregar mensaje del usuario
            this.messages.push({
                id: 'user-' + Date.now(),
                role: 'user',
                content: message,
                tool_results: []
            });
            
            this.loading = true;
            this.scrollToBottom();
            
            try {
                // Preparar historial (solo mensajes sin tool_results)
                const chatHistory = this.messages
                    .filter(m => !m.tool_results || m.tool_results.length === 0)
                    .map(m => ({ role: m.role, content: m.content }));
                
                const response = await fetch('{% url "core:creation_agent_chat" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: new URLSearchParams({
                        message: message,
                        chat_history: JSON.stringify(chatHistory)
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Agregar respuesta del asistente con contenido pre-renderizado
                const assistantMessage = {
                    id: 'assistant-' + Date.now(),
                    role: 'assistant',
                    content: data.answer,
                    renderedContent: this.renderMarkdown(data.answer), // Pre-renderizar markdown
                    tool_results: data.tool_results || []
                };
                this.messages.push(assistantMessage);
                
            } catch (error) {
                console.error('Error:', error);
                const errorMessage = `‚ùå Lo siento, ocurri√≥ un error: ${error.message}`;
                this.messages.push({
                    id: 'error-' + Date.now(),
                    role: 'assistant',
                    content: errorMessage,
                    renderedContent: this.renderMarkdown(errorMessage), // Pre-renderizar markdown
                    tool_results: []
                });
            } finally {
                this.loading = false;
                this.scrollToBottom();
            }
        },
        
        scrollToBottom() {
            this.$nextTick(() => {
                const container = this.$refs.messagesContainer;
                if (container) {
                    container.scrollTo({
                        top: container.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            });
        },
        
        renderMarkdown(text) {
            if (!text) return '';
            
            // Si marked est√° disponible, usarlo
            if (typeof marked !== 'undefined') {
                try {
                    return marked.parse(text);
                } catch (e) {
                    console.warn('Error al renderizar markdown:', e);
                    // Fallback si hay error
                    return text.replace(/\n/g, '<br>');
                }
            }
            
            // Fallback: convertir saltos de l√≠nea a <br> y mantener formato b√°sico
            return text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Negrita b√°sica
                .replace(/\*(.*?)\*/g, '<em>$1</em>'); // Cursiva b√°sica
        }
    };
}

// Video Loader Component
    function videoLoader(videoId, initialStatus, initialPreviewUrl = null) {
    return {
        videoId: videoId,
        status: initialStatus || 'pending',
        previewUrl: initialPreviewUrl || null,
        detailUrl: `/videos/${videoId}/`,
        message: 'El video est√° en proceso de creaci√≥n. Una vez finalizado, podr√°s verlo aqu√≠. ¬°Espero que te guste!',
        pollInterval: null,
        maxPollAttempts: 120, // 10 minutos m√°ximo (120 * 5s = 600s)
        pollAttempts: 0,
        
        init() {
            // Si ya est√° completado y tiene preview_url, no hacer polling
            if (this.status === 'completed' && this.previewUrl) {
                this.message = '‚úÖ ¬°Video generado exitosamente!';
                return;
            }
            
            if (this.status === 'pending' || this.status === 'processing') {
                this.startPolling();
            }
        },
        
        startPolling() {
            this.pollInterval = setInterval(() => {
                this.checkStatus();
            }, 5000); // Poll cada 5 segundos
        },
        
        stopPolling() {
            if (this.pollInterval) {
                clearInterval(this.pollInterval);
                this.pollInterval = null;
            }
        },
        
        async checkStatus() {
            if (this.pollAttempts >= this.maxPollAttempts) {
                this.stopPolling();
                this.message = '‚è±Ô∏è El video est√° tardando m√°s de lo esperado. Puedes verificar el estado m√°s tarde.';
                return;
            }
            
            this.pollAttempts++;
            
            try {
                const response = await fetch(`/videos/${this.videoId}/status/`);
                const data = await response.json();
                
                if (data.status === 'completed') {
                    this.status = 'completed';
                    this.stopPolling();
                    
                    // Si la URL viene en la respuesta, usarla
                    if (data.video_url) {
                        this.previewUrl = data.video_url;
                        this.message = '‚úÖ ¬°Video generado exitosamente!';
                    } else {
                        // Si no viene, intentar obtenerla
                        await this.fetchVideoUrl();
                    }
                } else if (data.status === 'error') {
                    this.status = 'error';
                    this.message = 'Error al generar el video';
                    this.stopPolling();
                } else {
                    // Actualizar mensaje seg√∫n el estado
                    if (data.status === 'processing') {
                        this.message = 'üé¨ Generando el video... Esto puede tardar unos minutos.';
                    } else {
                        this.message = '‚è≥ El video est√° en cola de procesamiento...';
                    }
                }
            } catch (error) {
                console.error('Error al verificar estado del video:', error);
                // Continuar intentando
            }
        },
        
        async fetchVideoUrl() {
            try {
                // Intentar obtener la URL desde el endpoint de status (ya deber√≠a venir)
                // Si no, hacer una petici√≥n adicional al detalle del video
                const response = await fetch(`/videos/${this.videoId}/status/`);
                const data = await response.json();
                
                if (data.video_url) {
                    this.previewUrl = data.video_url;
                }
            } catch (error) {
                console.error('Error al obtener URL del video:', error);
            }
        }
    };
}
</script>
{% endblock %}
