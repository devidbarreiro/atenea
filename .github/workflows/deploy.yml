name: Deploy to Server

# Se ejecuta autom√°ticamente cuando:
# - Push a dev ‚Üí despliega a DEV
# - Push a demo ‚Üí despliega a DEMO
# - Push a main ‚Üí despliega a PROD
on:
  push:
    branches: [ dev, demo, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run tests
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY_CI || 'test-secret-key-for-ci' }}
        USE_SQLITE: 'True'
        DEBUG: 'False'
        ALLOWED_HOSTS: 'localhost,127.0.1'
        GCS_BUCKET_NAME: 'test-bucket'
        GCS_PROJECT_ID: 'test-project'
        GOOGLE_APPLICATION_CREDENTIALS: '/tmp/fake-credentials.json'
        HEYGEN_API_KEY: 'test-key'
        GEMINI_API_KEY: 'test-key'
      run: |
        python manage.py test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    name: Deploy to Server
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Determine environment
      id: env
      run: |
        BRANCH="${{ github.ref_name }}"
        if [ "$BRANCH" == "dev" ]; then
          echo "env=dev" >> $GITHUB_OUTPUT
        elif [ "$BRANCH" == "demo" ]; then
          echo "env=demo" >> $GITHUB_OUTPUT
        elif [ "$BRANCH" == "main" ]; then
          echo "env=prod" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Branch desconocido: $BRANCH"
          exit 1
        fi
        echo "‚úÖ Desplegando a: ${{ steps.env.outputs.env }}"
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        # Guardar la clave SSH preservando saltos de l√≠nea correctamente
        # Usar printf para preservar saltos de l√≠nea y caracteres especiales
        printf '%s\n' "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        # Verificar que la clave es v√°lida
        if ! ssh-keygen -l -f ~/.ssh/deploy_key > /dev/null 2>&1; then
          echo "‚ùå Error: La clave SSH no es v√°lida"
          echo "Primeras l√≠neas de la clave:"
          head -3 ~/.ssh/deploy_key
          exit 1
        fi
        echo "‚úÖ Clave SSH v√°lida"
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
        chmod 644 ~/.ssh/known_hosts
    
    - name: Deploy to ${{ steps.env.outputs.env }}
      env:
        SSH_KEY: ~/.ssh/deploy_key
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USER: ${{ secrets.SSH_USERNAME }}
        BRANCH: ${{ github.ref_name }}
        ENV: ${{ steps.env.outputs.env }}
        REPO: ${{ github.repository }}
      run: |
        # Ejecutar despliegue directamente en el servidor
        # Pasar variables expl√≠citamente al comando SSH
        ssh -i $SSH_KEY -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST \
          ENV="$ENV" BRANCH="$BRANCH" REPO="$REPO" bash -s << 'DEPLOY_SCRIPT'
        set -e
        ENV_DIR="$HOME/$ENV"
        echo "üìÅ Preparando directorio $ENV_DIR"
        echo "üîß Variables: ENV=$ENV, BRANCH=$BRANCH, REPO=$REPO"
        mkdir -p $ENV_DIR
        cd $ENV_DIR
        mkdir -p html
        if [ -d "html/.git" ]; then
          echo "üì• Actualizando c√≥digo desde branch $BRANCH"
          cd html
          git fetch origin
          git checkout $BRANCH || git checkout -b $BRANCH origin/$BRANCH
          git pull origin $BRANCH
          cd ..
        else
          echo "üì• Clonando repositorio branch $BRANCH"
          rm -rf html
          git clone -b "$BRANCH" "https://github.com/$REPO.git" html
        fi
        echo "üìã Copiando docker-compose.yml"
        if [ ! -f "html/docker/docker-compose.$ENV.yml" ]; then
          echo "‚ùå Error: No se encontr√≥ docker-compose.$ENV.yml en el repositorio"
          ls -la html/docker/ || echo "Directorio docker no existe"
          exit 1
        fi
        cp html/docker/docker-compose.$ENV.yml docker-compose.yml
        echo "üî® Construyendo y reiniciando contenedores"
        docker compose down || true
        docker compose build --no-cache
        docker compose up -d
        echo "‚è≥ Esperando a que los servicios est√©n listos..."
        sleep 15
        echo "üîÑ Ejecutando migraciones"
        docker compose run --rm migrate || echo "‚ö†Ô∏è  Advertencia: Error en migraciones"
        echo "üì¶ Recolectando archivos est√°ticos"
        docker compose run --rm collectstatic || echo "‚ö†Ô∏è  Advertencia: Error en collectstatic"
        echo "‚úÖ Despliegue a $ENV completado!"
        if [ "$ENV" == "prod" ]; then
          echo "üåê URL: https://atenea.nxhumans.com"
        else
          echo "üåê URL: https://$ENV.atenea.nxhumans.com"
        fi
        DEPLOY_SCRIPT
