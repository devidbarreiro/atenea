{% extends 'base.html' %}

{% block title %}Generar Video con Agente - {{ project.name }}{% endblock %}

{% block content %}
<div class="flex min-h-screen bg-gray-50">
    {% include 'includes/sidebar.html' %}
    {% include 'includes/project_sidebar.html' with project=project user_role=user_role project_owner=project_owner project_members=project_members %}
    {% include 'includes/project_tabs_bar.html' with active_tab='agent' project=project %}

    <!-- Contenido principal - Con margen para ambas sidebars y la barra fija -->
    <main class="flex-1 min-w-0 lg:ml-80 pt-[57px]">
        <div class="p-6 max-w-5xl mx-auto">
            <!-- Progress Bar -->
            <div class="mb-8">
        <div class="flex items-center justify-center space-x-4">
            <!-- Step 1: Content (Active) -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-600 text-white font-bold">
                    1
                </div>
                <span class="ml-2 text-sm font-medium text-gray-900">Contenido</span>
            </div>
            <div class="w-16 h-1 bg-gray-300"></div>
            
            <!-- Step 2: Configure (Inactive) -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-300 text-gray-600 font-bold">
                    2
                </div>
                <span class="ml-2 text-sm font-medium text-gray-500">Configurar</span>
            </div>
            <div class="w-16 h-1 bg-gray-300"></div>
            
            <!-- Step 3: Scenes (Inactive) -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-300 text-gray-600 font-bold">
                    3
                </div>
                <span class="ml-2 text-sm font-medium text-gray-500">Escenas</span>
            </div>
            <div class="w-16 h-1 bg-gray-300"></div>
            
            <!-- Step 4: Final (Inactive) -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-300 text-gray-600 font-bold">
                    4
                </div>
                <span class="ml-2 text-sm font-medium text-gray-500">Final</span>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">Crear Nuevo Video</h1>
        <p class="text-gray-600">Elige c√≥mo quieres proporcionar tu contenido</p>
    </div>

    <!-- Content Options -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Write Script Manually Card -->
        <div id="script-manual-card" 
             onclick="selectContentType('script-manual')"
             class="content-card cursor-pointer bg-white rounded-lg border-2 border-gray-300 p-6 hover:border-blue-600 hover:shadow-xl transition-all duration-300">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Escribir Gui√≥n</h3>
                <p class="text-gray-600 text-sm">Escribe o pega el gui√≥n de tu video directamente</p>
            </div>
        </div>

        <!-- Write Script with AI Card -->
        <div id="script-ai-card" 
             onclick="selectContentType('script-ai')"
             class="content-card cursor-pointer bg-white rounded-lg border-2 border-blue-600 p-6 hover:shadow-xl transition-all duration-300">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Escribir Gui√≥n con IA</h3>
                <p class="text-gray-600 text-sm">Crea tu gui√≥n con ayuda de un asistente inteligente</p>
                <span class="mt-2 text-xs font-medium text-blue-600 bg-blue-50 px-3 py-1 rounded-full">Recomendado</span>
            </div>
        </div>

        <!-- Upload PDF Card (Disabled) -->
        <div class="content-card bg-gray-100 rounded-lg border-2 border-gray-300 p-6 opacity-50 cursor-not-allowed">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Subir Gui√≥n</h3>
                <p class="text-gray-500 text-sm">Sube un documento con tu gui√≥n</p>
                <span class="mt-2 text-xs font-medium text-gray-500 bg-gray-200 px-3 py-1 rounded-full">Pr√≥ximamente</span>
            </div>
        </div>
    </div>

    <!-- Script Form - Manual -->
    <div id="script-manual-form" class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 hidden">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Tu Gui√≥n</h2>
        <p class="text-gray-600 mb-6">Configura tu video e ingresa el gui√≥n</p>

        <form id="agentCreateFormManual" method="post">
            {% csrf_token %}
            <input type="hidden" name="content_type" value="script-manual">

            <!-- Video Type and Orientation -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="video_type_manual" class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo de Video
                    </label>
                    <select 
                        id="video_type_manual" 
                        name="video_type" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                    >
                        <option value="general">Video General (Todos los servicios)</option>
                        <option value="ultra">Modo Ultra (Solo Veo3 y Sora2)</option>
                        <option value="avatar">Con Avatares (Principalmente HeyGen)</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Define qu√© servicios de IA estar√°n disponibles</p>
                </div>

                <div>
                    <label for="video_orientation_manual" class="block text-sm font-medium text-gray-700 mb-2">
                        Orientaci√≥n
                    </label>
                    <select 
                        id="video_orientation_manual" 
                        name="video_orientation" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                    >
                        <option value="16:9">Horizontal (16:9)</option>
                        <option value="9:16">Vertical (9:16)</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Se aplicar√° a todas las escenas</p>
                </div>
            </div>

            <!-- Preview Options -->
            <div class="mb-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="flex items-start space-x-3">
                    <input 
                        type="checkbox" 
                        id="generate_previews_manual" 
                        name="generate_previews" 
                        checked
                        class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    >
                    <div class="flex-1">
                        <label for="generate_previews_manual" class="text-sm font-medium text-gray-700 cursor-pointer">
                            Generar previews autom√°ticamente con IA
                        </label>
                        <p class="text-xs text-gray-500 mt-1">Se generar√° una imagen preview para cada escena. Si no est√° marcado, podr√°s a√±adir previews manualmente en el Paso 2.</p>
                    </div>
                </div>
            </div>

            <!-- Audio Options -->
            <div class="mb-6 bg-green-50 rounded-lg p-4 border border-green-200">
                <div class="flex items-start space-x-3 mb-4">
                    <input 
                        type="checkbox" 
                        id="enable_audio_manual" 
                        name="enable_audio" 
                        checked
                        class="mt-1 w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500"
                        onchange="document.getElementById('voice_selection_manual').style.display = this.checked ? 'block' : 'none';"
                    >
                    <div class="flex-1">
                        <label for="enable_audio_manual" class="text-sm font-medium text-gray-700 cursor-pointer">
                            üéôÔ∏è Generar narraci√≥n autom√°tica con ElevenLabs TTS
                        </label>
                        <p class="text-xs text-gray-500 mt-1">Para escenas Veo/Sora: se generar√° voz en off y se combinar√° con el video</p>
                    </div>
                </div>
                
                <!-- Voice Selection -->
                <div id="voice_selection_manual" class="ml-7 mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Voz de narraci√≥n (se aplicar√° a todas las escenas)
                    </label>
                    <input type="hidden" id="default_voice_id_manual" name="default_voice_id" value="pFZP5JQG7iQjIQuC4Bku">
                    <input type="hidden" id="default_voice_name_manual" name="default_voice_name" value="Aria">
                    
                    <div id="voice-selected-manual" class="mb-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-sm font-bold text-green-900" id="selected-voice-name-manual">Aria</p>
                                <p class="text-xs text-green-600" id="selected-voice-category-manual">Voz por defecto en espa√±ol</p>
                            </div>
                            <button type="button" onclick="openVoiceModalManual()" 
                                    class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                                Cambiar
                            </button>
                        </div>
                    </div>
                    
                    <p class="text-xs text-gray-500">Puedes cambiar la voz por escena en el paso 2</p>
                </div>
            </div>

            <!-- Script Content -->
            <div class="mb-6">
                <label for="script_content_manual" class="block text-sm font-medium text-gray-700 mb-2">
                    Contenido del Gui√≥n
                </label>
                <textarea 
                    id="script_content_manual" 
                    name="script_content" 
                    rows="12"
                    placeholder="Escribe tu gui√≥n de video aqu√≠..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    required
                    oninput="calculateEstimatedDuration()"
                ></textarea>
                <p class="mt-2 text-sm text-gray-500">
                    La IA analizar√° este contenido y lo dividir√° en escenas para tu video
                </p>
            </div>

            <!-- Duration -->
            <div class="mb-6">
                <label for="desired_duration_min_manual" class="block text-sm font-medium text-gray-700 mb-2">
                    Duraci√≥n Deseada (minutos)
                </label>
                <div class="flex items-center gap-4">
                    <input 
                        type="number" 
                        id="desired_duration_min_manual" 
                        name="desired_duration_min" 
                        value="5" 
                        min="1" 
                        max="60"
                        class="w-full max-w-xs px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                    <div id="estimated_duration_manual" class="text-sm text-gray-600 hidden">
                        <span class="font-medium text-blue-600">Duraci√≥n estimada:</span>
                        <span id="estimated_duration_value_manual" class="ml-1">-</span>
                    </div>
                </div>
                <p class="mt-2 text-xs text-gray-500">
                    La duraci√≥n estimada se calcula autom√°ticamente seg√∫n el contenido del gui√≥n
                </p>
            </div>

            <!-- Actions -->
            <div class="flex justify-between items-center">
                <a href="{% url 'core:project_agent' project.id %}" 
                   class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                    Cancelar
                </a>
                <button 
                    type="submit"
                    class="px-8 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors shadow-sm">
                    Continuar ‚Üí
                </button>
            </div>
        </form>
    </div>

    <!-- Script Form - AI Assisted -->
    <div id="script-ai-form" class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Escritura Asistida con IA</h2>
        <p class="text-gray-600 mb-6">Configura tu video antes de comenzar con el asistente</p>

        <form id="agentCreateFormAI" action="{% url 'core:agent_ai_assistant' project.id %}" method="get">
            <!-- Video Type and Orientation -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="video_type_ai" class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo de Video
                    </label>
                    <select 
                        id="video_type_ai" 
                        name="video_type" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                    >
                        <option value="general">Video General (Todos los servicios)</option>
                        <option value="ultra">Modo Ultra (Solo Veo3 y Sora2)</option>
                        <option value="avatar">Con Avatares (Principalmente HeyGen)</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Define qu√© servicios de IA estar√°n disponibles</p>
                </div>

                <div>
                    <label for="video_orientation_ai" class="block text-sm font-medium text-gray-700 mb-2">
                        Orientaci√≥n
                    </label>
                    <select 
                        id="video_orientation_ai" 
                        name="video_orientation" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                    >
                        <option value="16:9">Horizontal (16:9)</option>
                        <option value="9:16">Vertical (9:16)</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Se aplicar√° a todas las escenas</p>
                </div>
            </div>

            <!-- Preview Options -->
            <div class="mb-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="flex items-start space-x-3">
                    <input 
                        type="checkbox" 
                        id="generate_previews_ai" 
                        name="generate_previews" 
                        value="true"
                        checked
                        class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    >
                    <div class="flex-1">
                        <label for="generate_previews_ai" class="text-sm font-medium text-gray-700 cursor-pointer">
                            Generar previews autom√°ticamente con IA
                        </label>
                        <p class="text-xs text-gray-500 mt-1">Se generar√° una imagen preview para cada escena</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-center">
                <button 
                    type="submit"
                    class="px-8 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors shadow-sm inline-flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    Comenzar con IA ‚Üí
                </button>
            </div>
        </form>
    </div>
        </div>
    </main>
</div>

<script>
function selectContentType(type) {
    // Resetear todos los cards
    document.getElementById('script-manual-card').classList.remove('border-blue-600');
    document.getElementById('script-manual-card').classList.add('border-gray-300');
    document.getElementById('script-ai-card').classList.remove('border-blue-600');
    document.getElementById('script-ai-card').classList.add('border-gray-300');
    
    // Ocultar todos los forms
    document.getElementById('script-manual-form').classList.add('hidden');
    document.getElementById('script-ai-form').classList.add('hidden');
    
    // Mostrar el form seleccionado
    if (type === 'script-manual') {
        document.getElementById('script-manual-card').classList.add('border-blue-600');
        document.getElementById('script-manual-card').classList.remove('border-gray-300');
        document.getElementById('script-manual-form').classList.remove('hidden');
        document.getElementById('script-manual-form').scrollIntoView({ behavior: 'smooth' });
    } else if (type === 'script-ai') {
        document.getElementById('script-ai-card').classList.add('border-blue-600');
        document.getElementById('script-ai-card').classList.remove('border-gray-300');
        document.getElementById('script-ai-form').classList.remove('hidden');
        document.getElementById('script-ai-form').scrollIntoView({ behavior: 'smooth' });
    }
}

// Por defecto, seleccionar "Escribir con IA"
selectContentType('script-ai');

document.getElementById('agentCreateFormManual').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const scriptContent = document.getElementById('script_content_manual').value;
    const duration = document.getElementById('desired_duration_min_manual').value;
    const videoType = document.getElementById('video_type_manual').value;
    const videoOrientation = document.getElementById('video_orientation_manual').value;
    const generatePreviews = document.getElementById('generate_previews_manual').checked;
    
    if (!scriptContent.trim()) {
        alert('Por favor ingresa un gui√≥n');
        return;
    }
    
    // Obtener datos de audio
    const enableAudio = document.getElementById('enable_audio_manual').checked;
    const defaultVoiceId = document.getElementById('default_voice_id_manual').value;
    const defaultVoiceName = document.getElementById('default_voice_name_manual').value;
    
    // Guardar en sessionStorage con todos los datos
    sessionStorage.setItem('agentContent', JSON.stringify({
        type: 'script',
        content: scriptContent,
        duration: duration,
        video_type: videoType,
        video_orientation: videoOrientation,
        generate_previews: generatePreviews,
        enable_audio: enableAudio,
        default_voice_id: defaultVoiceId,
        default_voice_name: defaultVoiceName
    }));
    
    // Redirigir a configure
    window.location.href = "{% url 'core:agent_configure' project.id %}";
});

// ==================
// VOICE SELECTOR FUNCTIONS
// ==================

let voicesCache = null;

async function openVoiceModalManual() {
    // Cargar voces si no est√°n en cache
    if (!voicesCache) {
        try {
            const response = await fetch('{% url "core:api_list_elevenlabs_voices" %}');
            const data = await response.json();
            voicesCache = data.voices || [];
        } catch (error) {
            console.error('Error cargando voces:', error);
            alert('Error al cargar voces de ElevenLabs');
            return;
        }
    }
    
    // Crear y mostrar modal
    createVoiceModal();
}

function createVoiceModal() {
    // Eliminar modal anterior si existe
    const existingModal = document.getElementById('voice-modal-manual');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Crear modal
    const modal = document.createElement('div');
    modal.id = 'voice-modal-manual';
    modal.className = 'fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4';
    
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-green-500 to-green-600 px-6 py-5 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-white">Cat√°logo de Voces ElevenLabs</h2>
                    <p class="text-green-100 text-sm mt-1">${voicesCache.length} voces disponibles</p>
                </div>
                <button type="button" onclick="closeVoiceModalManual()" 
                        class="text-white hover:text-green-100 text-3xl leading-none">
                    &times;
                </button>
            </div>
            
            <!-- Buscador -->
            <div class="px-6 py-4 bg-gray-50 border-b">
                <input type="text" id="voice-search-manual" placeholder="üîç Buscar por nombre, acento, g√©nero..." 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                       oninput="filterVoicesManual(this.value)">
            </div>
            
            <!-- Lista de Voces -->
            <div class="overflow-y-auto p-6" style="max-height: calc(90vh - 200px);">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="voices-grid-manual">
                    ${renderVoiceCards()}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function renderVoiceCards() {
    if (!voicesCache || voicesCache.length === 0) {
        return '<div class="col-span-3 text-center py-12"><p class="text-gray-500">No hay voces disponibles</p></div>';
    }
    
    return voicesCache.map(voice => {
        const labels = voice.labels || {};
        const labelsHtml = Object.values(labels).map(label => 
            `<span class="inline-block bg-gray-100 text-gray-700 rounded-full px-2 py-1 text-xs">${label}</span>`
        ).join('');
        
        return `
            <div class="voice-card border-2 border-gray-200 rounded-xl p-5 hover:border-green-500 hover:shadow-lg transition-all cursor-pointer bg-white" 
                 data-voice-id="${voice.voice_id}"
                 data-voice-name="${voice.name}"
                 data-voice-category="${voice.category || 'premade'}"
                 onclick="selectVoiceManual('${voice.voice_id}', '${voice.name}', '${voice.category || 'premade'}')">
                
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-900 text-lg">${voice.name}</h3>
                        <p class="text-xs text-gray-500 uppercase tracking-wide mt-1">${voice.category || 'premade'}</p>
                    </div>
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-xl">üéôÔ∏è</span>
                    </div>
                </div>
                
                ${voice.description ? `<p class="text-sm text-gray-700 mb-3">${voice.description}</p>` : ''}
                
                ${labelsHtml ? `<div class="flex flex-wrap gap-1 mb-3">${labelsHtml}</div>` : ''}
                
                ${voice.preview_url ? `
                    <div class="mt-3" onclick="event.stopPropagation();">
                        <audio controls preload="none" class="w-full h-8">
                            <source src="${voice.preview_url}" type="audio/mpeg">
                        </audio>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function closeVoiceModalManual() {
    const modal = document.getElementById('voice-modal-manual');
    if (modal) {
        modal.remove();
    }
}

function selectVoiceManual(voiceId, voiceName, voiceCategory) {
    // Actualizar campos hidden
    document.getElementById('default_voice_id_manual').value = voiceId;
    document.getElementById('default_voice_name_manual').value = voiceName;
    
    // Actualizar UI
    document.getElementById('selected-voice-name-manual').textContent = voiceName;
    document.getElementById('selected-voice-category-manual').textContent = voiceCategory;
    
    // Cerrar modal
    closeVoiceModalManual();
    
    console.log('Voz seleccionada:', voiceName, voiceId);
}

function filterVoicesManual(searchTerm) {
    const cards = document.querySelectorAll('#voices-grid-manual .voice-card');
    const term = searchTerm.toLowerCase();
    
    cards.forEach(card => {
        const voiceName = card.dataset.voiceName.toLowerCase();
        const voiceCategory = card.dataset.voiceCategory.toLowerCase();
        const text = card.textContent.toLowerCase();
        
        if (voiceName.includes(term) || voiceCategory.includes(term) || text.includes(term)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// ==================
// ESTIMATED DURATION CALCULATION
// ==================

/**
 * Calcula la duraci√≥n estimada del video basada en el n√∫mero de palabras del script
 * F√≥rmula: palabras / palabras_por_segundo / 60 = minutos
 * Velocidad promedio de lectura/narraci√≥n: ~2.5 palabras por segundo
 */
function calculateEstimatedDuration() {
    const scriptTextarea = document.getElementById('script_content_manual');
    const estimatedDurationDiv = document.getElementById('estimated_duration_manual');
    const estimatedDurationValue = document.getElementById('estimated_duration_value_manual');
    
    if (!scriptTextarea || !estimatedDurationDiv || !estimatedDurationValue) {
        return;
    }
    
    const scriptText = scriptTextarea.value.trim();
    
    if (!scriptText) {
        estimatedDurationDiv.classList.add('hidden');
        return;
    }
    
    // Contar palabras (separadas por espacios, saltos de l√≠nea, etc.)
    const words = scriptText.split(/\s+/).filter(word => word.length > 0);
    const wordCount = words.length;
    
    if (wordCount === 0) {
        estimatedDurationDiv.classList.add('hidden');
        return;
    }
    
    // Calcular duraci√≥n estimada
    // Velocidad promedio de narraci√≥n: 2.5 palabras por segundo
    const WORDS_PER_SECOND = 2.5;
    const estimatedTotalSeconds = wordCount / WORDS_PER_SECOND;
    const estimatedMinutes = Math.floor(estimatedTotalSeconds / 60);
    const estimatedSeconds = Math.floor(estimatedTotalSeconds % 60);
    
    // Formatear como "X min Y seg"
    let durationText = '';
    if (estimatedMinutes > 0) {
        durationText = `${estimatedMinutes} min`;
        if (estimatedSeconds > 0) {
            durationText += ` ${estimatedSeconds} seg`;
        }
    } else {
        durationText = `${estimatedSeconds} seg`;
    }
    
    estimatedDurationValue.textContent = durationText;
    estimatedDurationDiv.classList.remove('hidden');
}

// Calcular duraci√≥n estimada cuando se carga la p√°gina (por si hay contenido inicial)
document.addEventListener('DOMContentLoaded', function() {
    calculateEstimatedDuration();
});
</script>
{% endblock %}

