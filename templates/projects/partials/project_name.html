<div class="flex items-center gap-2 group">
    {% if projects %}
    <div 
        class="relative" 
        x-data="{
            open: false,
            search: '',
            hasVisibleProjects() {
                const list = this.$refs.projectList;
                if (!list) return false;
                return Array.from(list.querySelectorAll('[data-dropdown-project]'))
                    .some(el => el.offsetParent !== null);
            }
        }" 
        @click.away="open = false"
    >
        <div 
            role="button" 
            tabindex="0" 
            class="flex items-center gap-2 cursor-pointer select-none focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-black rounded-md px-2 -ml-2"
            @click="open = !open"
            @keydown.enter.prevent="open = !open"
            @keydown.space.prevent="open = !open"
        >
            <h1 class="text-2xl font-bold text-gray-900" id="project-name-display">{{ project.name }}</h1>
            <svg class="w-5 h-5 text-gray-500 transition-transform duration-200" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
        <div 
            x-show="open" 
            x-transition
            x-cloak
            class="absolute left-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 z-20"
        >
            <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wide border-b border-gray-100">
                Mis proyectos
            </div>
            <div class="px-3 py-2 border-b border-gray-100">
                <div class="relative">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1010.5 18a7.5 7.5 0 006.15-3.35z"></path>
                    </svg>
                    <input 
                        type="text" 
                        x-model="search"
                        placeholder="Buscar proyecto..."
                        class="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-md focus:ring-2 focus:ring-black/30 focus:border-black outline-none"
                    >
                </div>
            </div>
            <div class="max-h-64 overflow-y-auto py-1" x-ref="projectList">
                {% with active_tab|default:'videos' as current_tab %}
                {% for project_item in projects %}
                    {% if current_tab == 'videos' %}
                        {% url 'core:project_videos_library' project_item.id as project_switch_url %}
                    {% elif current_tab == 'images' %}
                        {% url 'core:project_images_library' project_item.id as project_switch_url %}
                    {% elif current_tab == 'audios' %}
                        {% url 'core:project_audios_library' project_item.id as project_switch_url %}
                    {% elif current_tab == 'scripts' %}
                        {% url 'core:project_scripts' project_item.id as project_switch_url %}
                    {% elif current_tab == 'agent' %}
                        {% url 'core:project_agent' project_item.id as project_switch_url %}
                    {% else %}
                        {% url 'core:project_videos_library' project_item.id as project_switch_url %}
                    {% endif %}
                    <a 
                        href="{{ project_switch_url }}"
                        class="flex items-center justify-between px-4 py-2 text-sm transition-colors {% if project_item.id == project.uuid %}bg-gray-100 text-gray-900{% else %}text-gray-700 hover:bg-gray-50{% endif %}"
                        x-show="!search || '{{ project_item.name|lower|escapejs }}'.includes(search.toLowerCase())"
                        x-cloak
                        data-dropdown-project
                    >
                        <span class="truncate">{{ project_item.name }}</span>
                        {% if project_item.id == project.uuid %}
                        <span class="ml-2 text-xs font-semibold text-blue-600">Actual</span>
                        {% endif %}
                    </a>
                {% empty %}
                    <div class="px-4 py-3 text-sm text-gray-500">
                        No tienes proyectos aún.
                    </div>
                {% endfor %}
                {% endwith %}
                <div class="px-4 py-3 text-sm text-gray-500" x-show="search && !hasVisibleProjects()" x-cloak>
                    No se encontraron resultados.
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <h1 class="text-2xl font-bold text-gray-900" id="project-name-display">{{ project.name }}</h1>
    {% endif %}
    {% if user_role == 'owner' or user_role == 'editor' %}
    <button 
        onclick="editProjectName()"
        class="opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-gray-600"
        title="Editar nombre del proyecto">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
    </button>
    {% endif %}
</div>

<script>
function editProjectName() {
    const displayElement = document.getElementById('project-name-display');
    const currentName = displayElement.textContent.trim();
    
    // Crear input
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentName;
    input.className = 'text-2xl font-bold text-gray-900 bg-transparent border-b-2 border-gray-300 focus:border-black focus:outline-none px-1';
    input.style.maxWidth = '200px';
    input.style.minWidth = '200px';
    
    // Reemplazar display con input
    const parent = displayElement.parentElement;
    displayElement.style.display = 'none';
    parent.insertBefore(input, displayElement);
    input.focus();
    input.select();
    
    // Función para guardar
    const saveName = () => {
        const newName = input.value.trim();
        if (newName && newName !== currentName) {
            // Enviar actualización via HTMX
            // Función helper para obtener CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            // Obtener CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                              document.querySelector('meta[name=csrf-token]')?.content ||
                              getCookie('csrftoken');
            
            fetch(`{% url 'core:project_update_name' project.uuid %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `name=${encodeURIComponent(newName)}`
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                return response.text().then(text => {
                    throw new Error(text || 'Error al actualizar');
                });
            })
            .then(html => {
                // Reemplazar el contenedor completo con la respuesta
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const newContent = tempDiv.querySelector('.flex');
                if (newContent) {
                    parent.innerHTML = newContent.innerHTML;
                    // Re-ejecutar el script si existe
                    const script = tempDiv.querySelector('script');
                    if (script) {
                        eval(script.textContent);
                    }
                } else {
                    // Si no hay contenido nuevo, solo actualizar el nombre
                    displayElement.textContent = newName;
                    displayElement.style.display = '';
                    input.remove();
                }
            })
            .catch(error => {
                alert('Error al actualizar el nombre: ' + error.message);
                // Restaurar display
                input.remove();
                displayElement.style.display = '';
            });
        } else {
            // Cancelar: restaurar display
            input.remove();
            displayElement.style.display = '';
        }
    };
    
    // Guardar al presionar Enter
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveName();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            input.remove();
            displayElement.style.display = '';
        }
    });
    
    // Guardar al perder foco
    input.addEventListener('blur', saveName);
}
</script>

