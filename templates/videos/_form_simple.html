{% load static %}

<form method="post" id="videoForm" enctype="multipart/form-data" class="p-6">
    {% csrf_token %}
    
    <!-- Título -->
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">
            Título <span class="text-red-500">*</span>
        </label>
        <input 
            type="text" 
            name="title" 
            required 
            placeholder="Mi video generado con IA"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
        >
    </div>
    
    <!-- Selector de Modelo -->
    <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">
            Modelo <span class="text-red-500">*</span>
        </label>
        <select 
            name="model_id" 
            id="model-select"
            required
            hx-get="{% url 'core:dynamic_form_fields' %}"
            hx-target="#dynamic-fields"
            hx-trigger="change"
            hx-include="[name='model_id']"
            hx-indicator="#loading-indicator"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
        >
            <option value="">Selecciona un modelo</option>
            {% for model_id, model in models.items %}
                <option value="{{ model_id }}">{{ model.name }}{% if model.description %} - {{ model.description }}{% endif %}</option>
            {% endfor %}
        </select>
        <p class="text-xs text-gray-500 mt-1">Selecciona el modelo de IA para generar tu video</p>
    </div>
    
    <!-- Prompt / Guión -->
    <div class="mb-6">
        <label id="script-label" class="block text-sm font-medium text-gray-700 mb-2">
            Prompt / Guión <span class="text-red-500">*</span>
        </label>
        <textarea 
            name="script" 
            id="script-textarea"
            required 
            rows="5"
            placeholder="Describe el video que quieres generar..."
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"
        ></textarea>
        <p id="script-help" class="text-xs text-gray-500 mt-1">Sé específico y descriptivo. Incluye detalles sobre movimiento, estilo, colores, etc.</p>
    </div>
    
    <!-- Campos Dinámicos (se cargan vía HTMX) -->
    <div id="dynamic-fields">
        <!-- Los campos se cargarán aquí cuando se seleccione un modelo -->
        <p class="text-sm text-gray-400 italic">Selecciona un modelo para ver las opciones disponibles</p>
    </div>
    
    <!-- Indicador de carga -->
    <div id="loading-indicator" class="htmx-indicator mb-4">
        <div class="flex items-center gap-2 text-blue-600">
            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Cargando opciones del modelo...</span>
        </div>
    </div>
    
    <!-- Botones -->
    <div class="flex gap-3 justify-end items-center pt-6 border-t border-gray-200">
        {% if project %}
        <a href="{% url 'core:project_videos_library' project.uuid %}" 
           class="bg-gray-100 text-gray-700 hover:bg-gray-200 px-6 py-3 rounded-md font-medium transition-colors">
            Cancelar
        </a>
        {% else %}
        <a href="{% url 'core:dashboard' %}" 
           class="bg-gray-100 text-gray-700 hover:bg-gray-200 px-6 py-3 rounded-md font-medium transition-colors">
            Cancelar
        </a>
        {% endif %}
        <button 
            type="submit" 
            class="bg-black text-white hover:bg-gray-800 px-6 py-3 rounded-md font-medium transition-colors flex items-center gap-2">
            <span>Generar</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
        </button>
    </div>
</form>

<script>
// Debug: Verificar que HTMX esté cargado
document.addEventListener('DOMContentLoaded', function() {
    const modelSelect = document.getElementById('model-select');
    const scriptLabel = document.getElementById('script-label');
    const scriptTextarea = document.getElementById('script-textarea');
    const scriptHelp = document.getElementById('script-help');
    
    function updateScriptFieldForModel(modelId) {
        if (modelId === 'manim-quote') {
            // Personalizar para Manim Quote
            scriptLabel.innerHTML = 'Texto de la cita <span class="text-red-500">*</span>';
            scriptTextarea.placeholder = 'Escribe el texto de la cita que quieres animar...';
            scriptHelp.textContent = 'Escribe el texto de la cita. Puedes incluir saltos de línea para dividir en múltiples líneas.';
            scriptTextarea.rows = 4;
        } else {
            // Restaurar valores por defecto
            scriptLabel.innerHTML = 'Prompt / Guión <span class="text-red-500">*</span>';
            scriptTextarea.placeholder = 'Describe el video que quieres generar...';
            scriptHelp.textContent = 'Sé específico y descriptivo. Incluye detalles sobre movimiento, estilo, colores, etc.';
            scriptTextarea.rows = 5;
        }
    }
    
    if (modelSelect) {
        modelSelect.addEventListener('change', function() {
            console.log('Modelo seleccionado:', this.value);
            updateScriptFieldForModel(this.value);
        });
        
        // Verificar HTMX
        if (typeof htmx === 'undefined') {
            console.error('HTMX no está cargado!');
        } else {
            console.log('HTMX está cargado correctamente');
            
            // Escuchar cuando HTMX actualiza los campos dinámicos
            document.body.addEventListener('htmx:afterSwap', function(event) {
                if (event.detail.target.id === 'dynamic-fields') {
                    const currentModel = modelSelect.value;
                    updateScriptFieldForModel(currentModel);
                }
            });
        }
    }
});
</script>

