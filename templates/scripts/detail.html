{% extends 'base.html' %}
{% load static %}

{% block title %}{{ script.title }} - {{ script.project.name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">

    <div class="grid grid-cols-1 gap-6">
        <!-- Informaci贸n del Gui贸n -->
        <div>
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">
                        <span class="mr-2"></span>
                        {{ script.title }}
                    </h2>
                    <div class="relative">
                        <button class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <!-- Estado del Gui贸n -->
                    <div class="mb-6" id="script-status-container">
                        {% include 'partials/script_status.html' with script=script %}
                    </div>

                    <!-- Gui贸n Original (Colapsable) -->
                    <div class="mb-6" x-data="{ expanded: false }">
                        <button @click="expanded = !expanded" 
                                class="w-full flex justify-between items-center text-lg font-semibold text-gray-900 mb-3 hover:text-gray-700 transition-colors">
                            <span>
                                <span class="mr-2"></span>Gui贸n Original
                            </span>
                            <svg class="w-5 h-5 transition-transform" :class="expanded ? 'rotate-180' : ''" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <div x-show="expanded" 
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 transform -translate-y-2"
                             x-transition:enter-end="opacity-100 transform translate-y-0"
                             class="bg-gray-50 p-4 rounded-lg border">
                            <pre class="whitespace-pre-wrap text-sm text-gray-700">{{ script.original_script }}</pre>
                        </div>
                        <div x-show="!expanded" class="text-sm text-gray-500 italic bg-gray-50 p-3 rounded border border-gray-200">
                            Click para ver el gui贸n original completo...
                        </div>
                    </div>

                    <!-- Datos Procesados -->
                    {% if script.status == 'completed' and script.processed_data %}
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <span class="mr-2">锔</span>Datos Procesados
                            </h3>
                            
                            <!-- Informaci贸n del Proyecto -->
                            {% if script.project_data %}
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="text-sm font-medium text-blue-600">Modo de Plataforma</div>
                                        <div class="text-lg font-semibold text-blue-900">{{ script.project_data.platform_mode|default:"N/A" }}</div>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <div class="text-sm font-medium text-green-600">N煤mero de Escenas</div>
                                        <div class="text-lg font-semibold text-green-900">{{ script.project_data.num_scenes|default:"N/A" }}</div>
                                    </div>
                                    <div class="bg-purple-50 p-4 rounded-lg">
                                        <div class="text-sm font-medium text-purple-600">Idioma</div>
                                        <div class="text-lg font-semibold text-purple-900">{{ script.project_data.language|default:"N/A" }}</div>
                                    </div>
                                    <div class="bg-orange-50 p-4 rounded-lg">
                                        <div class="text-sm font-medium text-orange-600">Duraci贸n Estimada</div>
                                        <div class="text-lg font-semibold text-orange-900">{{ script.project_data.total_estimated_duration_min|default:"N/A" }} min</div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Escenas -->
                            {% if script.scenes %}
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                                    <span class="mr-2"></span>Escenas
                                </h4>
                                <div class="space-y-4" id="scenesAccordion">
                                    {% for scene in script.scenes %}
                                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                                            <button class="w-full px-6 py-4 text-left bg-gray-50 hover:bg-gray-100 transition-colors flex justify-between items-center" 
                                                    onclick="toggleScene({{ forloop.counter }})">
                                                <div class="flex-1">
                                                    <div class="font-semibold text-gray-900">{{ scene.id }}</div>
                                                    <div class="text-sm text-gray-600 mt-1">{{ scene.summary }}</div>
                                                </div>
                                                <div class="flex items-center space-x-3">
                                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded">{{ scene.duration_sec }}s</span>
                                                    <svg class="w-5 h-5 text-gray-400 transform transition-transform" id="icon-{{ forloop.counter }}">
                                                        <path fill="currentColor" d="M7 10l5 5 5-5z"/>
                                                    </svg>
                                                </div>
                                            </button>
                                            <div id="scene-{{ forloop.counter }}" class="hidden px-6 py-4 bg-white border-t border-gray-200">
                                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                    <div class="space-y-4">
                                                        <div>
                                                            <div class="flex justify-between items-center mb-2">
                                                                <h6 class="text-sm font-medium text-gray-700">Texto del Gui贸n</h6>
                                                                <button onclick="copyScriptText({{ forloop.counter }})" 
                                                                        class="px-3 py-1 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded transition-colors flex items-center space-x-1">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                                                    </svg>
                                                                    <span>Copiar</span>
                                                                </button>
                                                            </div>
                                                            <p id="script-text-{{ forloop.counter }}" class="text-sm text-gray-600 bg-gray-50 p-3 rounded border border-gray-200">{{ scene.script_text }}</p>
                                                        </div>
                                                        
                                                        <div class="flex items-center space-x-4">
                                                            <div>
                                                                <h6 class="text-sm font-medium text-gray-700 mb-1">Avatar</h6>
                                                                <span class="px-2 py-1 text-xs font-medium rounded {% if scene.avatar == 'si' %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                                                    {{ scene.avatar|yesno:"S铆,No" }}
                                                                </span>
                                                            </div>
                                                            <div>
                                                                <h6 class="text-sm font-medium text-gray-700 mb-1">Plataforma</h6>
                                                                <span class="px-2 py-1 text-xs font-medium rounded bg-blue-100 text-blue-800">{{ scene.platform }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="space-y-4">
                                                        <div>
                                                            <h6 class="text-sm font-medium text-gray-700 mb-2">B-roll</h6>
                                                            {% if scene.broll %}
                                                                <div class="space-y-1">
                                                                    {% for item in scene.broll %}
                                                                        <div class="flex items-center text-sm text-gray-600">
                                                                            <span class="mr-2"></span>{{ item }}
                                                                        </div>
                                                                    {% endfor %}
                                                                </div>
                                                            {% else %}
                                                                <span class="text-sm text-gray-500">Ninguno</span>
                                                            {% endif %}
                                                        </div>
                                                        
                                                        <div>
                                                            <h6 class="text-sm font-medium text-gray-700 mb-1">Transici贸n</h6>
                                                            <span class="px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-800">{{ scene.transition }}</span>
                                                        </div>
                                                        
                                                        <div>
                                                            <h6 class="text-sm font-medium text-gray-700 mb-1">Texto en Pantalla</h6>
                                                            <p class="text-sm text-gray-600">{{ scene.text_on_screen|default:"N/A" }}</p>
                                                        </div>
                                                        
                                                        <div>
                                                            <h6 class="text-sm font-medium text-gray-700 mb-1">Notas de Audio</h6>
                                                            <p class="text-sm text-gray-600">{{ scene.audio_notes|default:"N/A" }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% elif script.status == 'error' %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Error en el procesamiento:</strong>
                            {% if script.error_message %}
                                {{ script.error_message }}
                            {% else %}
                                Ocurri贸 un error durante el procesamiento del gui贸n.
                            {% endif %}
                        </div>
                    {% elif script.status == 'processing' %}
                        <div class="alert alert-warning">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            <strong>Procesando:</strong> El gui贸n est谩 siendo procesado por n8n. Esto puede tomar unos minutos.
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-clock me-2"></i>
                            <strong>Pendiente:</strong> El gui贸n est谩 en cola para ser procesado.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Funci贸n para toggle de escenas
function toggleScene(sceneNumber) {
    const sceneContent = document.getElementById(`scene-${sceneNumber}`);
    const icon = document.getElementById(`icon-${sceneNumber}`);
    
    if (sceneContent.classList.contains('hidden')) {
        sceneContent.classList.remove('hidden');
        icon.style.transform = 'rotate(180deg)';
    } else {
        sceneContent.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
    }
}

// Funci贸n para copiar el texto del gui贸n de una escena
function copyScriptText(sceneNumber) {
    const textElement = document.getElementById(`script-text-${sceneNumber}`);
    const text = textElement.textContent;
    
    // Copiar al portapapeles
    navigator.clipboard.writeText(text).then(function() {
        // Mostrar feedback visual
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        
        button.innerHTML = `
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            <span>隆Copiado!</span>
        `;
        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        button.classList.add('bg-green-600');
        
        // Restaurar despu茅s de 2 segundos
        setTimeout(function() {
            button.innerHTML = originalHTML;
            button.classList.remove('bg-green-600');
            button.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }, 2000);
    }).catch(function(err) {
        console.error('Error al copiar: ', err);
        alert('Error al copiar el texto');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh del estado si est谩 procesando
    const statusContainer = document.getElementById('script-status-container');
    const scriptStatus = '{{ script.status }}';
    
    if (scriptStatus === 'processing' || scriptStatus === 'pending') {
        // Refrescar cada 5 segundos
        const refreshInterval = setInterval(function() {
            htmx.ajax('GET', '{% url "core:script_status_partial" script_id=script.pk %}', {
                target: '#script-status-container',
                swap: 'innerHTML'
            });
        }, 5000);
        
        // Detener el refresh cuando se complete o haya error
        const checkCompletion = setInterval(function() {
            htmx.ajax('GET', '{% url "core:script_status_partial" script_id=script.pk %}', {
                target: '#script-status-container',
                swap: 'innerHTML',
                onAfterSwap: function() {
                    const newStatus = document.querySelector('#script-status-{{ script.id }} .badge').textContent.trim();
                    if (newStatus === 'Completado' || newStatus === 'Error') {
                        clearInterval(refreshInterval);
                        clearInterval(checkCompletion);
                    }
                }
            });
        }, 10000);
    }
    
    // Auto-expand accordion si hay solo una escena
    const scenesCount = {{ script.scenes|length }};
    if (scenesCount === 1) {
        const firstScene = document.getElementById('scene-1');
        const firstIcon = document.getElementById('icon-1');
        if (firstScene && firstIcon) {
            firstScene.classList.remove('hidden');
            firstIcon.style.transform = 'rotate(180deg)';
        }
    }
});
</script>
{% endblock %}
