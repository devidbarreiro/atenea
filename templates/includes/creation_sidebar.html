{% load static %}
{% include 'includes/voice_selector_modal.html' %}

<script>
    // 1. FUNCIÓN PUENTE GLOBAL
    // Se llama desde el onclick del botón inyectado por Python
    window.openVoiceSelectorFromSidebar = function(provider = 'elevenlabs') {
        if (typeof window.openVoiceSelector === 'function') {
            window.openVoiceSelector(function(voiceId, voiceName, voiceCategory) {
                // Actualizar UI Visualmente
                updateVoiceUI(voiceId, voiceName, voiceCategory);

                // Actualizar Estado de Alpine (para persistencia)
                const sidebar = document.querySelector('[x-data^="creationSidebar"]');
                if (sidebar && sidebar.__x) {
                    sidebar.__x.$data.selectedVoice = {
                        id: voiceId,
                        name: voiceName,
                        category: voiceCategory
                    };
                }
            }, provider); // Pasamos el provider (heygen o elevenlabs)
        } else {
            console.error("El modal de voces no está cargado.");
            alert("Error: No se pudo cargar el selector de voces.");
        }
    };

    // 2. FUNCIÓN AUXILIAR PARA ACTUALIZAR DOM
    function updateVoiceUI(id, name, category) {
        const nameEl = document.getElementById('dynamic-voice-name');
        const catEl = document.getElementById('dynamic-voice-cat');
        const infoEl = document.getElementById('dynamic-voice-info');
        const placeEl = document.getElementById('dynamic-voice-placeholder');
        const inputEl = document.getElementById('dynamic-voice-input');
        const inputNameEl = document.getElementById('dynamic-voice-name-input');

        if (nameEl && catEl && infoEl && placeEl) {
            nameEl.textContent = name;
            catEl.textContent = category || 'ElevenLabs';
            infoEl.classList.remove('hidden');
            placeEl.classList.add('hidden');
        }
        if (inputEl) inputEl.value = id;
        if (inputNameEl) inputNameEl.value = name;
    }

    // 3. EVENTO DE CARGA HTMX (CRÍTICO)
    // Se ejecuta cuando HTMX inyecta el nuevo HTML del formulario.
    // Restaura el estado visual si Alpine ya tenía una voz guardada.
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        // Verificar si se actualizó el contenedor de campos dinámicos
        // (Asegúrate de que el ID coincida con el target de tu hx-get, usualmente #dynamic-fields-container o similar)
        if (evt.target.id === 'dynamic-fields-container' || evt.target.closest('#dynamic-fields-container')) {
            
            // Buscar datos en Alpine
            const sidebar = document.querySelector('[x-data^="creationSidebar"]');
            if (sidebar && sidebar.__x && sidebar.__x.$data.selectedVoice) {
                const v = sidebar.__x.$data.selectedVoice;
                // Restaurar vista
                updateVoiceUI(v.id, v.name, v.category);
            }
        }
    });
</script>

<!-- Definir el componente Alpine de forma global -->
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('creationSidebar', () => ({
        activeTab: '{{ active_tab|default:"video" }}',
        selectedModel: null,
        selectedModelData: null,
        models: {},
        allModels: {},
        loading: false,
        submitting: false,
        prompt: '',
        projectId: {% if project %}'{{ project.uuid }}'{% else %}null{% endif %},
        
        // Template selector state
        selectedTemplate: null,
        manimAnimationType: 'quote', // Nuevo: rastrear tipo de animación manim
        defaultTemplateId: '{{ default_template_id|default_if_none:""|escapejs }}',
        templateModalOpen: false,
        templateList: [],
        templateLoading: false,
        templateTab: 'public',
        templateSearch: '',

        // Voice selector state
        voiceModalOpen: false,
        voiceList: [],
        voiceLoading: false,
        voiceSearch: '',
        selectedVoice: null,
        
        // Manim design selector state
        manimDesignModalOpen: false,
        // Cada diseño mapea a un tipo de animación de Manim
        manimDesigns: [
            {
                id: 'quote_standard',
                name: 'Cita (Texto)',
                category: 'Tipografía y Texto',
                description: 'Animación de texto para citas o frases destacadas.',
                container_color: '#FFFFFF',
                text_color: '#111827',
                font_family: 'normal',
                animation_type: 'quote',
                active: true
            },
            {
                id: 'bar_chart_standard',
                name: 'Gráfico Clásico',
                category: 'Gráficos de Datos',
                description: 'Visualización tradicional con ejes X e Y.',
                container_color: '#F9FAFB',
                text_color: '#111827',
                font_family: 'normal',
                animation_type: 'bar_chart',
                active: true
            },
            {
                id: 'bar_chart_modern',
                name: 'Gráfico Moderno',
                category: 'Gráficos de Datos',
                description: 'Diseño limpio sin ejes, igual a la previsualización.',
                container_color: '#1E293B',
                text_color: '#FFFFFF',
                font_family: 'normal',
                animation_type: 'modern_bar_chart',
                active: true
            },
            {
                id: 'line_chart_placeholder',
                name: 'Gráfico de Líneas',
                category: 'Gráficos de Datos',
                description: 'Visualización de tendencias y series temporales.',
                container_color: '#F9FAFB',
                text_color: '#94A3B8',
                font_family: 'normal',
                animation_type: 'line_chart',
                active: false
            },
            {
                id: 'pie_chart_placeholder',
                name: 'Gráfico de Tarta',
                category: 'Gráficos de Datos',
                description: 'Representación de proporciones y porcentajes.',
                container_color: '#F9FAFB',
                text_color: '#94A3B8',
                font_family: 'normal',
                animation_type: 'pie_chart',
                active: false
            },
        ],
        selectedManimDesignId: null,
        selectedManimDesignName: '',
        selectedManimDesign: null,
        
        init() {
            console.log('Creation Sidebar Initialized. Active Tab:', this.activeTab);
            // Cargar prompt desde caché al inicializar
            this.loadPromptFromCache();
            
            // Guardar prompt en caché cuando cambia
            this.$watch('prompt', (value) => {
                this.savePromptToCache(value);
            });
            
            this.loadModels(this.activeTab);
            // Cargar template por defecto si existe
            if (this.defaultTemplateId && this.defaultTemplateId.trim() !== '') {
                this.loadDefaultTemplate();
            }
            
            // Verificar si hay un modelo ya seleccionado en el dropdown
            this.$nextTick(() => {
                const modelSelect = document.getElementById('model-select');
                if (modelSelect && modelSelect.value) {
                    this.selectedModel = modelSelect.value;
                    // Aplicar lógica de cambio de modelo
                    this.onModelChange();
                }
                
                // Escuchar cambios en el dropdown de modelos
                if (modelSelect) {
                    modelSelect.addEventListener('change', () => {
                        this.selectedModel = modelSelect.value;
                        this.onModelChange();
                    });
                }
            });
        },
        
        loadPromptFromCache() {
            try {
                const cacheKey = `prompt_cache_${this.activeTab}`;
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    this.prompt = cached;
                }
            } catch (error) {
                console.error('Error cargando prompt desde caché:', error);
            }
        },
        
        savePromptToCache(value) {
            try {
                const cacheKey = `prompt_cache_${this.activeTab}`;
                if (value && value.trim()) {
                    localStorage.setItem(cacheKey, value);
                } else {
                    // Si está vacío, no guardar (mantener el anterior)
                }
            } catch (error) {
                console.error('Error guardando prompt en caché:', error);
            }
        },
        
        async loadDefaultTemplate() {
            if (!this.defaultTemplateId || this.defaultTemplateId.trim() === '') return;
            try {
                const response = await fetch('/api/prompt-templates/' + this.defaultTemplateId + '/');
                if (response.ok) {
                    const data = await response.json();
                    this.selectedTemplate = data;
                }
            } catch (error) {
                console.error('Error cargando template por defecto:', error);
            }
        },
        
        // Template selector methods
        async loadTemplates() {
            this.templateLoading = true;
            try {
                const type = this.activeTab === 'audio' ? 'video' : this.activeTab;
                const params = new URLSearchParams({ type: type, tab: this.templateTab });
                if (this.templateSearch) params.append('search', this.templateSearch);
                
                // Verificar caché primero
                const cacheKey = `templates_${type}_${this.templateTab}_${this.templateSearch || ''}`;
                const cached = this.getCachedTemplates(cacheKey);
                if (cached) {
                    this.templateList = cached;
                    this.templateLoading = false;
                    // Cargar en background para actualizar caché
                    this.fetchAndCacheTemplates(params, cacheKey);
                    return;
                }
                
                await this.fetchAndCacheTemplates(params, cacheKey);
            } catch (error) {
                console.error('Error loading templates:', error);
                this.templateList = [];
            } finally {
                this.templateLoading = false;
            }
        },
        
        async fetchAndCacheTemplates(params, cacheKey) {
            try {
                const response = await fetch('/api/prompt-templates/?' + params);
                if (response.ok) {
                    const data = await response.json();
                    const templates = data.templates || [];
                    this.templateList = templates;
                    // Guardar en caché (válido por 1 hora)
                    this.cacheTemplates(cacheKey, templates);
                }
            } catch (error) {
                console.error('Error fetching templates:', error);
            }
        },
        
        getCachedTemplates(cacheKey) {
            try {
                const cached = localStorage.getItem(`template_cache_${cacheKey}`);
                if (cached) {
                    const data = JSON.parse(cached);
                    // Validar estructura de datos
                    if (!data || typeof data !== 'object' || !data.timestamp || !data.templates) {
                        console.warn('Cache data structure invalid, clearing cache');
                        localStorage.removeItem(`template_cache_${cacheKey}`);
                        return null;
                    }
                    // Verificar que no haya expirado (1 hora = 3600000 ms)
                    const cacheAge = Date.now() - data.timestamp;
                    if (cacheAge >= 0 && cacheAge < 3600000) {
                        return data.templates;
                    } else {
                        // Cache expirado, limpiarlo
                        localStorage.removeItem(`template_cache_${cacheKey}`);
                    }
                }
            } catch (e) {
                console.warn('Error reading template cache:', e);
                // Limpiar cache corrupto
                try {
                    localStorage.removeItem(`template_cache_${cacheKey}`);
                } catch (clearError) {
                    console.error('Error clearing corrupted cache:', clearError);
                }
            }
            return null;
        },
        
        cacheTemplates(cacheKey, templates) {
            try {
                const data = {
                    templates: templates,
                    timestamp: Date.now()
                };
                localStorage.setItem(`template_cache_${cacheKey}`, JSON.stringify(data));
            } catch (e) {
                console.warn('Error caching templates:', e);
            }
        },

        async loadVoices() {
            this.voiceLoading = true;
            try {
                const response = await fetch('/api/voices/');
                const data = await response.json();
                this.voiceList = data.voices || [];
            } catch (error) {
                console.error('Error cargando voces:', error);
                window.dispatchEvent(new CustomEvent('show-toast', {
                    detail: {
                        message: 'No se pudieron cargar las voces',
                        type: 'error'
                    }
                }));
                this.voiceList = [];
            } finally {
                this.voiceLoading = false;
            }
        },

        selectVoice(voice) {
            this.selectedVoice = voice;
            this.voiceModalOpen = false;
        },

        openVoiceModal() {
            this.voiceModalOpen = true;
            if (this.voiceList.length === 0) {
                this.loadVoices();
            }
        },
        
        openTemplateModal() {
            this.templateModalOpen = true;
            this.loadTemplates();
        },
        
        selectTemplate(template) {
            this.selectedTemplate = template;
            this.templateModalOpen = false;
        },
        
        clearTemplate() {
            this.selectedTemplate = null;
            this.templateModalOpen = false;
        },
        
        openManimDesignModal() {
            this.manimDesignModalOpen = true;
        },
        
        applyManimDesign(design) {
            if (!design) return;
            
            this.selectedManimDesignId = design.id;
            this.selectedManimDesignName = design.name || '';
            this.selectedManimDesign = design;
            this.manimAnimationType = design.animation_type || 'quote';
            
            console.log('[DEBUG] Manim Design Applied:', {
                id: this.selectedManimDesignId,
                name: this.selectedManimDesignName,
                animation_type: this.manimAnimationType,
                design: design
            });
            
            // Aplicar colores del diseño si existen
            if (design.container_color) {
                const cp = document.getElementById('container-color-picker');
                const ci = document.querySelector('input[name="container_color"]');
                const ct = document.getElementById('container-color-text');
                const cv = document.getElementById('container-color-preview');
                if (cp) cp.value = design.container_color;
                if (ci) ci.value = design.container_color;
                if (ct) ct.value = design.container_color;
                if (cv) cv.style.backgroundColor = design.container_color;
            }
            if (design.text_color) {
                const tp = document.getElementById('text-color-picker');
                const ti = document.querySelector('input[name="text_color"]');
                const tt = document.getElementById('text-color-text');
                const tv = document.getElementById('text-color-preview');
                if (tp) tp.value = design.text_color;
                if (ti) ti.value = design.text_color;
                if (tt) tt.value = design.text_color;
                if (tv) tv.style.backgroundColor = design.text_color;
            }

            // Guardar tipo de animación seleccionada (quote, bar_chart, etc.)
            const manimTypeInput = document.getElementById('manim-animation-type-input');
            if (manimTypeInput) {
                manimTypeInput.value = this.manimAnimationType;
                // Disparar evento para que otros componentes (como el formulario clásico) se enteren
                manimTypeInput.dispatchEvent(new Event('change'));
                manimTypeInput.dispatchEvent(new Event('input'));
            }
            
            // Si el modelo actual es manim-quote, actualizar campos dinámicos
            if (this.selectedModel === 'manim-quote') {
                let url = '/videos/form-fields/?model_id=manim-quote&manim_animation_type=' + this.manimAnimationType;
                
                if (typeof htmx !== 'undefined') {
                    console.log('Updating dynamic fields for Manim type (creation sidebar):', this.manimAnimationType);
                    htmx.ajax('GET', url, {
                        target: '#dynamic-fields-container',
                        swap: 'innerHTML'
                    });
                }
                
                // Actualizar labels del prompt (vía función global si existe)
                if (typeof updateScriptFieldForModel === 'function') {
                    updateScriptFieldForModel('manim-quote');
                }
            }
            
            // Trigger preview refresh
            if (typeof renderLivePreview === 'function') {
                renderLivePreview();
            }
            
            this.manimDesignModalOpen = false;
        },
        
        getServiceDisplayName(service) {
            const names = { 'sora': 'Sora', 'gemini_veo': 'Gemini Veo', 'higgsfield': 'Higgsfield', 'gemini_image': 'Gemini Image', 'agent': 'Agent' };
            return names[service] || service || '';
        },
        
        async loadModels(type) {
            console.log('loadModels: fetching models for type:', type);
            this.loading = true;
            try {
                const response = await fetch('/api/models/config/?type=' + type + '&grouped=true');
                if (!response.ok) throw new Error('API Error: ' + response.status);
                const data = await response.json();
                
                console.log('loadModels: data received:', data);
                
                // Mostrar toast si viene en el response
                if (data.toast) {
                    window.dispatchEvent(new CustomEvent('show-toast', {
                        detail: data.toast
                    }));
                }
                if (data.models) {
                    this.models = data.models;
                    // También cargar versión plana
                    const allResponse = await fetch('/api/models/config/?type=' + type);
                    if (allResponse.ok) {
                        const allData = await allResponse.json();
                        if (allData.models) {
                            this.allModels = {};
                            allData.models.forEach(model => {
                                this.allModels[model.id] = model;
                            });
                        }
                    }
                } else {
                    console.warn('loadModels: No data.models found');
                }
            } catch (error) {
                console.error('Error loading models:', error);
                this.models = {};
                this.allModels = {};
            } finally {
                this.loading = false;
            }
        },
        
        onModelChange() {
            if (this.selectedModel && this.allModels[this.selectedModel]) {
                this.selectedModelData = this.allModels[this.selectedModel];
                
                // Mostrar loader mientras se cargan los campos
                const container = document.getElementById('dynamic-fields-container');
                if (container) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mb-3"></div>
                            <p class="text-xs text-gray-500">Cargando opciones del modelo...</p>
                        </div>
                    `;
                }
                
                // Para Manim, autoseleccionar el diseño de cita texto
                if (this.selectedModel === 'manim-quote') {
                    // Buscar el diseño de cita y aplicarlo automáticamente
                    const quoteDesign = this.manimDesigns.find(d => d.id === 'quote_standard');
                    if (quoteDesign) {
                        this.applyManimDesign(quoteDesign);
                        return; // Salir aquí para evitar recarga doble
                    }
                }
                
                // Cargar campos dinámicos vía HTMX
                if (typeof htmx !== 'undefined') {
                    let url = '/videos/form-fields/?model_id=' + encodeURIComponent(this.selectedModel);
                    
                    // Para Manim, pasar también el tipo de animación seleccionado (diseño)
                    if (this.selectedModel === 'manim-quote') {
                        const manimTypeInput = document.getElementById('manim-animation-type-input');
                        const manimType = manimTypeInput && manimTypeInput.value ? manimTypeInput.value : 'quote';
                        url += '&manim_animation_type=' + encodeURIComponent(manimType);
                    }
                    
                    htmx.ajax('GET', url, {
                        target: '#dynamic-fields-container',
                        swap: 'innerHTML'
                    });
                }
            } else {
                this.selectedModelData = null;
                // Limpiar campos dinámicos
                const container = document.getElementById('dynamic-fields-container');
                if (container) {
                    container.innerHTML = '<div class="text-center py-4 text-gray-400 text-xs"><p>Selecciona un modelo para ver opciones</p></div>';
                }
            }
        },
        
        switchTab(tab) {
            // Guardar prompt actual antes de cambiar de tab
            this.savePromptToCache(this.prompt);
            
            // Navegar a la URL correspondiente
            const projectId = this.projectId;
            let url = '';
            if (projectId) {
                url = '/projects/' + projectId + '/' + tab + 's/';
            } else {
                url = '/' + tab + 's/';
            }
            window.location.href = url;
        },
        
        validateFiles() {
            // Validar archivos antes de enviar
            const fileInputs = [
                document.querySelector('input[name="start_image"]'),
                document.querySelector('input[name="end_image"]'),
                document.querySelector('input[name="style_image"]'),
                document.querySelector('input[name="asset_image_1"]'),
                document.querySelector('input[name="asset_image_2"]'),
                document.querySelector('input[name="asset_image_3"]')
            ].filter(input => input && input.files && input.files[0]);
            
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/jpg'];
            
            for (const fileInput of fileInputs) {
                const file = fileInput.files[0];
                if (file.size > maxSize) {
                    return {
                        valid: false,
                        error: `El archivo "${file.name}" es demasiado grande (máx: 10MB)`
                    };
                }
                if (!allowedTypes.includes(file.type)) {
                    return {
                        valid: false,
                        error: `El archivo "${file.name}" tiene un formato no soportado. Use: JPG, PNG o WEBP`
                    };
                }
            }
            
            // Validar restricciones de referencia para veo-2.0-generate-exp
            if (this.selectedModel === 'veo-2.0-generate-exp') {
                const styleImage = document.querySelector('input[name="style_image"]');
                const assetImage1 = document.querySelector('input[name="asset_image_1"]');
                const assetImage2 = document.querySelector('input[name="asset_image_2"]');
                const assetImage3 = document.querySelector('input[name="asset_image_3"]');
                
                const hasStyle = styleImage && styleImage.files && styleImage.files[0];
                const hasAsset = (assetImage1 && assetImage1.files && assetImage1.files[0]) ||
                                (assetImage2 && assetImage2.files && assetImage2.files[0]) ||
                                (assetImage3 && assetImage3.files && assetImage3.files[0]);
                
                if (hasStyle && hasAsset) {
                    return {
                        valid: false,
                        error: 'Veo 2.0-exp no permite mezclar imágenes de tipo "Style" y "Asset" en la misma generación. Usa solo Style (máx. 1) O solo Asset (máx. 3).'
                    };
                }
                
                // Validar que solo haya 1 style image
                if (hasStyle) {
                    const styleCount = 1; // Solo hay un campo style_image
                    if (styleCount > 1) {
                        return {
                            valid: false,
                            error: 'Solo puedes usar 1 imagen de tipo "Style" en Veo 2.0-exp.'
                        };
                    }
                }
            }
            
            return { valid: true };
        },
        
        showError(message) {
            // Mostrar error en UI en lugar de alert
            // Por ahora usar alert pero se puede mejorar con un componente de notificación
            alert('Error: ' + message);
        },
        
        showSuccess(message) {
            // Mostrar éxito en UI
            alert(message);
        },
        
        async copyPromptToClipboard(event) {
            if (!this.prompt || !this.prompt.trim()) {
                return;
            }
            
            try {
                await navigator.clipboard.writeText(this.prompt);
                // Mostrar feedback visual temporal
                const button = event.target.closest('button');
                if (button) {
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                    button.classList.add('text-green-600');
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.classList.remove('text-green-600');
                    }, 2000);
                }
            } catch (error) {
                console.error('Error copiando al portapapeles:', error);
                // Fallback para navegadores que no soportan clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = this.prompt;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const button = event.target.closest('button');
                    if (button) {
                        const originalHTML = button.innerHTML;
                        button.innerHTML = '<svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                        button.classList.add('text-green-600');
                        setTimeout(() => {
                            button.innerHTML = originalHTML;
                            button.classList.remove('text-green-600');
                        }, 2000);
                    }
                } catch (err) {
                    console.error('Error en fallback de copia:', err);
                }
                document.body.removeChild(textArea);
            }
        },
        
        async submitForm() {
            const isBarChart = this.selectedModel === 'manim-quote' && (this.manimAnimationType === 'bar_chart' || this.manimAnimationType === 'modern_bar_chart');
            
            if (!this.selectedModel || (!this.prompt && !isBarChart)) {
                this.showError('Por favor selecciona un modelo y escribe un prompt');
                return;
            }
            
            // Validar archivos si hay
            const fileValidation = this.validateFiles();
            if (!fileValidation.valid) {
                this.showError(fileValidation.error);
                return;
            }
            
            // Verificar CSRF token
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!token || !token.value) {
                console.error('CSRF token no encontrado');
                this.showError('Error de seguridad. Por favor recarga la página.');
                return;
            }
            
            this.submitting = true;
            
            try {
                // Recoger todos los valores del formulario dinámico
                const settings = {};
                
                // Duración
                const durationInput = document.getElementById('duration-input');
                if (durationInput) {
                    const duration = durationInput.value;
                    if (duration) settings.duration = parseInt(duration);
                }
                
                // Aspect Ratio
                const aspectInput = document.getElementById('aspect-input');
                if (aspectInput) {
                    const aspectRatio = aspectInput.value;
                    if (aspectRatio) settings.aspect_ratio = aspectRatio;
                }
                
                // Resolución
                const resolutionInput = document.getElementById('resolution-input');
                if (resolutionInput) {
                    const resolution = resolutionInput.value;
                    if (resolution) settings.resolution = resolution;
                }
                
                // Audio
                const audioInput = document.getElementById('audio-input');
                if (audioInput) {
                    const audio = audioInput.value;
                    if (audio) settings.generate_audio = audio === 'true';
                }
                
                // Negative Prompt
                const negativePrompt = document.querySelector('textarea[name="negative_prompt"]');
                if (negativePrompt && negativePrompt.value) {
                    settings.negative_prompt = negativePrompt.value;
                }
                
                // Seed
                const seedInput = document.querySelector('input[name="seed"]');
                if (seedInput && seedInput.value) {
                    settings.seed = parseInt(seedInput.value);
                }
                
                // Mode (para Kling)
                const modeInput = document.querySelector('select[name="mode"]');
                if (modeInput && modeInput.value) {
                    settings.mode = modeInput.value;
                }
                
                // Autor (para Manim Quote)
                const authorInput = document.querySelector('input[name="author"]');
                if (authorInput && authorInput.value) {
                    settings.author = authorInput.value;
                }
                
                // Calidad (para Manim Quote)
                const qualityInput = document.getElementById('quality-input');
                if (qualityInput && qualityInput.value) {
                    settings.quality = qualityInput.value;
                }
                
                // Color del Contenedor (para Manim Quote) - puede venir del picker o del input hidden
                const containerColorPicker = document.getElementById('container-color-picker');
                const containerColorInput = document.querySelector('input[name="container_color"]');
                if (containerColorPicker && containerColorPicker.value) {
                    settings.container_color = containerColorPicker.value;
                } else if (containerColorInput && containerColorInput.value) {
                    settings.container_color = containerColorInput.value;
                }
                
                // Color del Texto (para Manim Quote) - puede venir del picker o del input hidden
                const textColorPicker = document.getElementById('text-color-picker');
                const textColorInput = document.querySelector('input[name="text_color"]');
                if (textColorPicker && textColorPicker.value) {
                    settings.text_color = textColorPicker.value;
                } else if (textColorInput && textColorInput.value) {
                    settings.text_color = textColorInput.value;
                }
                
                // Tipo de Fuente (para Manim Quote)
                const fontFamilyInput = document.getElementById('font-family-input');
                if (fontFamilyInput && fontFamilyInput.value) {
                    settings.font_family = fontFamilyInput.value;
                }
                
                // Tipo de animación de Manim (cita, bar_chart, etc.)
                const manimTypeInput = document.getElementById('manim-animation-type-input');
                let manimType = manimTypeInput && manimTypeInput.value ? manimTypeInput.value : 'quote';
                settings.manim_animation_type = manimType;
                
                // Si es bar_chart o modern_bar_chart, recoger datos específicos y empaquetar en prompt
                if (this.selectedModel === 'manim-quote' && (manimType === 'bar_chart' || manimType === 'modern_bar_chart')) {
                    const values = [];
                    const labels = [];
                    const bar_colors = [];
                    const top_texts = [];
                    
                    // Contar cuántas barras hay buscando los inputs generados
                    let barCount = 0;
                    while (document.querySelector(`input[name="bar_label_${barCount + 1}"]:not(#bar-manager-modal input)`)) {
                        barCount++;
                    }
                    
                    for (let i = 1; i <= barCount; i++) {
                        const lInput = document.querySelector(`input[name="bar_label_${i}"]:not(#bar-manager-modal input)`);
                        const vInput = document.querySelector(`input[name="bar_value_${i}"]:not(#bar-manager-modal input)`);
                        const cInput = document.querySelector(`input[name="bar_color_${i}"]:not(#bar-manager-modal input)`);
                        const ttInput = document.querySelector(`input[name="bar_top_text_${i}"]:not(#bar-manager-modal input)`);
                        
                        labels.push(lInput ? lInput.value || `Barra ${i}` : `Barra ${i}`);
                        values.push(vInput ? parseFloat(vInput.value) || 0 : 0);
                        bar_colors.push(cInput ? cInput.value : '#0066CC');
                        top_texts.push(ttInput ? ttInput.value || '' : '');
                    }
                    
                    const cTitle = document.getElementById('chart_title');
                    const xL = document.getElementById('x_axis_label');
                    const yL = document.getElementById('y_axis_label');
                    const bWInput = document.querySelector('input[name="bar_width"]');
                    const sLInput = document.querySelector('input[name="show_labels"]');
                    
                    const chartData = {
                        title: cTitle ? cTitle.value : 'Gráfico de Barras',
                        x_label: xL ? xL.value : 'Categorías',
                        y_label: yL ? yL.value : 'Valores',
                        values: values,
                        labels: labels,
                        bar_colors: bar_colors,
                        top_texts: top_texts,
                        bar_width: bWInput ? parseFloat(bWInput.value) : 0.8,
                        show_labels: sLInput ? sLInput.checked : true
                    };
                    
                    // Sobreescribir el prompt con el JSON de datos
                    this.prompt = JSON.stringify(chartData);
                }
                
                // Para Manim, añadir animation_type a settings (escalable para nuevos tipos)
                if (this.selectedModel === 'manim-quote') {
                    settings.manim_animation_type = this.manimAnimationType;
                    console.log('[DEBUG] Enviando animation_type:', this.manimAnimationType);
                }
                
                // Campos específicos del modelo (HeyGen) - soportar tanto select como input text
                const avatarIdSelect = document.querySelector('select[name="avatar_id"]');
                const avatarIdInput = document.querySelector('input[name="avatar_id"]');
                const avatarId = avatarIdSelect ? avatarIdSelect.value : (avatarIdInput ? avatarIdInput.value : null);
                if (avatarId) {
                    settings.avatar_id = avatarId;
                }
                
                const voiceIdSelect = document.querySelector('select[name="voice_id"]');
                const voiceIdInput = document.querySelector('input[name="voice_id"]');
                const voiceId = voiceIdSelect ? voiceIdSelect.value : (voiceIdInput ? voiceIdInput.value : null);
                if (voiceId) {
                    settings.voice_id = voiceId;
                }
                
                const avatarImageIdSelect = document.querySelector('select[name="avatar_image_id"]');
                const avatarImageIdInput = document.querySelector('input[name="avatar_image_id"]');
                const avatarImageId = avatarImageIdSelect ? avatarImageIdSelect.value : (avatarImageIdInput ? avatarImageIdInput.value : null);
                if (avatarImageId) {
                    settings.avatar_image_id = avatarImageId;
                }
                
                // Obtener prompt_template_id del campo oculto
                const promptTemplateIdInput = document.querySelector('input[name="prompt_template_id"]');
                const promptTemplateId = promptTemplateIdInput ? promptTemplateIdInput.value : null;
                
                // Verificar si hay imágenes de referencia para enviar como FormData
                const startImage = document.querySelector('input[name="start_image"]');
                const endImage = document.querySelector('input[name="end_image"]');
                const styleImage = document.querySelector('input[name="style_image"]');
                const assetImage1 = document.querySelector('input[name="asset_image_1"]');
                const assetImage2 = document.querySelector('input[name="asset_image_2"]');
                const assetImage3 = document.querySelector('input[name="asset_image_3"]');
                
                const hasReferenceImages = (startImage && startImage.files && startImage.files[0]) ||
                                          (endImage && endImage.files && endImage.files[0]) ||
                                          (styleImage && styleImage.files && styleImage.files[0]) ||
                                          (assetImage1 && assetImage1.files && assetImage1.files[0]) ||
                                          (assetImage2 && assetImage2.files && assetImage2.files[0]) ||
                                          (assetImage3 && assetImage3.files && assetImage3.files[0]);
                
                let response;
                
                if (hasReferenceImages) {
                    // Usar FormData para enviar archivos
                    const formData = new FormData();
                    formData.append('type', this.activeTab);
                    formData.append('model_id', this.selectedModel);
                    formData.append('title', 'New ' + this.activeTab);
                    formData.append('prompt', this.prompt);
                    formData.append('script', this.prompt);
                    formData.append('text', this.prompt);
                    if (this.projectId) {
                        formData.append('project_id', this.projectId);
                    }
                    // Añadir prompt_template_id solo si existe y el modelo lo soporta
                    // HeyGen y Manim no usan prompt templates
                    const isHeyGen = this.selectedModel && (this.selectedModel.includes('heygen') || this.selectedModel.includes('heygen'));
                    const isManim = this.selectedModel === 'manim-quote';
                    if (promptTemplateId && !isHeyGen && !isManim) {
                        formData.append('prompt_template_id', promptTemplateId);
                    }
                    // Añadir campos específicos de Manim directamente al FormData también
                    if (settings.author) {
                        formData.append('author', settings.author);
                    }
                    if (settings.quality) {
                        formData.append('quality', settings.quality);
                    }
                    formData.append('settings', JSON.stringify(settings));
                    
                    // Agregar imágenes de referencia
                    if (startImage && startImage.files && startImage.files[0]) {
                        formData.append('start_image', startImage.files[0]);
                    }
                    if (endImage && endImage.files && endImage.files[0]) {
                        formData.append('end_image', endImage.files[0]);
                    }
                    if (styleImage && styleImage.files && styleImage.files[0]) {
                        formData.append('style_image', styleImage.files[0]);
                    }
                    // Múltiples assets (hasta 3)
                    if (assetImage1 && assetImage1.files && assetImage1.files[0]) {
                        formData.append('asset_image_1', assetImage1.files[0]);
                    }
                    if (assetImage2 && assetImage2.files && assetImage2.files[0]) {
                        formData.append('asset_image_2', assetImage2.files[0]);
                    }
                    if (assetImage3 && assetImage3.files && assetImage3.files[0]) {
                        formData.append('asset_image_3', assetImage3.files[0]);
                    }
                    
                    response = await fetch('/api/items/create/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': token.value
                        },
                        body: formData
                    });
                } else {
                    // Usar JSON si no hay imágenes
                    const requestData = {
                        type: this.activeTab,
                        model_id: this.selectedModel,
                        title: 'New ' + this.activeTab,
                        prompt: this.prompt,
                        script: this.prompt,
                        text: this.prompt,
                        project_id: this.projectId,
                        settings: settings
                    };
                    
                    // Añadir prompt_template_id solo si existe y el modelo lo soporta
                    // HeyGen y Manim no usan prompt templates
                    const isHeyGen = this.selectedModel && (this.selectedModel.includes('heygen') || this.selectedModel.includes('heygen'));
                    const isManim = this.selectedModel === 'manim-quote';
                    if (promptTemplateId && !isHeyGen && !isManim) {
                        requestData.prompt_template_id = promptTemplateId;
                    }
                    
                    response = await fetch('/api/items/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': token.value
                        },
                        body: JSON.stringify(requestData)
                    });
                }
                
                // Verificar respuesta HTTP
                if (!response.ok) {
                    let errorMessage = `Error ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                    } catch (e) {
                        // Si no se puede parsear JSON, usar el texto de respuesta
                        const text = await response.text();
                        if (text) {
                            errorMessage = text.substring(0, 200);
                        }
                    }
                    this.showError(errorMessage);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Mostrar toast si viene en el response (reemplaza el showSuccess)
                    if (data.toast) {
                        console.log('Dispatching toast event:', data.toast);
                        window.dispatchEvent(new CustomEvent('show-toast', {
                            detail: data.toast
                        }));
                        // Verificar que el evento se disparó correctamente
                        setTimeout(() => {
                            const container = document.getElementById('toast-container');
                            if (container && container._x_dataStack) {
                                const toastData = container._x_dataStack[0];
                                console.log('Toast container state:', toastData?.toasts?.length || 0, 'toasts');
                            }
                        }, 100);
                    } else {
                        // Fallback: usar toast en lugar de alert nativo
                        console.warn('No toast in response, using fallback toast');
                        window.dispatchEvent(new CustomEvent('show-toast', {
                            detail: {
                                type: 'success',
                                title: 'Creado exitosamente',
                                message: 'El elemento se ha creado correctamente',
                                auto_close: 5
                            }
                        }));
                    }
                    
                    window.dispatchEvent(new CustomEvent('item-created', { detail: data.item }));
                    window.dispatchEvent(new CustomEvent('library-tab-changed', { detail: { tab: this.activeTab } }));
                    this.prompt = '';
                    this.selectedModel = null;
                    this.selectedModelData = null;
                } else {
                    // Mostrar toast de error si viene en el response
                    if (data.toast) {
                        window.dispatchEvent(new CustomEvent('show-toast', {
                            detail: data.toast
                        }));
                    } else {
                        this.showError(data.error || 'Error desconocido');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                this.showError('Error al crear. Por favor intenta de nuevo. ' + (error.message || ''));
            } finally {
                this.submitting = false;
            }
        },
    }));
});
</script>

<div x-data="creationSidebar()">
    
    <!-- Tabs: Image / Video / Audio -->
    <div class="border-b border-gray-200 bg-white sticky top-0 z-10 pt-2 pb-2 sm:pb-3 px-2 sm:px-3">
        <div class="flex items-center justify-center">
            <div class="inline-flex rounded-lg border border-gray-200 p-0.5 sm:p-1 bg-gray-50 w-full sm:w-auto">
                <button @click="switchTab('image')"
                        :class="activeTab === 'image' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'"
                        class="flex-1 sm:flex-none px-3 sm:px-5 py-1.5 text-xs sm:text-sm font-medium rounded-md transition-all">
                    Image
                </button>
                <button @click="switchTab('video')"
                        :class="activeTab === 'video' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'"
                        class="flex-1 sm:flex-none px-3 sm:px-5 py-1.5 text-xs sm:text-sm font-medium rounded-md transition-all">
                    Video
                </button>
                <button @click="switchTab('audio')"
                        :class="activeTab === 'audio' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'"
                        class="flex-1 sm:flex-none px-3 sm:px-5 py-1.5 text-xs sm:text-sm font-medium rounded-md transition-all">
                    Audio
                </button>
            </div>
        </div>
    </div>
    
    <!-- Contenido del Sidebar -->
    <div class="p-3 sm:p-4 lg:p-6 space-y-4 sm:space-y-5">

        <input type="hidden" name="voice_id" id="dynamic-voice-input">

        <input type="hidden" name="voice_name" id="dynamic-voice-name-input">
        
        <!-- Sección PROMPT TEMPLATE (solo para video e image, excluyendo heygen y manim) -->
        <div x-show="(activeTab === 'video' || activeTab === 'image') && (!selectedModel || (selectedModel && !selectedModel.includes('heygen') && selectedModel !== 'manim-quote'))">
            <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">PROMPT TEMPLATE</label>
            
            <!-- Botón selector -->
            <button type="button"
                    @click="openTemplateModal()"
                    class="w-full border-2 rounded-lg overflow-hidden bg-white hover:border-gray-400 transition-colors"
                    :class="selectedTemplate ? 'border-gray-400' : 'border-gray-300 border-dashed'">
                
                <!-- Preview Area -->
                <div class="aspect-video bg-gray-900 flex items-center justify-center relative overflow-hidden rounded-lg">
                    <!-- Video Preview -->
                    <template x-if="selectedTemplate && selectedTemplate.preview_url && (selectedTemplate.preview_url.toLowerCase().includes('.mp4') || selectedTemplate.preview_url.toLowerCase().includes('.webm') || selectedTemplate.preview_url.toLowerCase().includes('.mov') || (activeTab === 'video' && !selectedTemplate.preview_url.toLowerCase().includes('.jpg') && !selectedTemplate.preview_url.toLowerCase().includes('.jpeg') && !selectedTemplate.preview_url.toLowerCase().includes('.png') && !selectedTemplate.preview_url.toLowerCase().includes('.gif') && !selectedTemplate.preview_url.toLowerCase().includes('.webp')))">
                        <video :src="selectedTemplate.preview_url" 
                               class="w-full h-full object-cover"
                               preload="metadata"
                               autoplay
                               loop
                               muted
                               playsinline></video>
                    </template>
                    
                    <!-- Image Preview -->
                    <template x-if="selectedTemplate && selectedTemplate.preview_url && !selectedTemplate.preview_url.toLowerCase().includes('.mp4') && !selectedTemplate.preview_url.toLowerCase().includes('.webm') && !selectedTemplate.preview_url.toLowerCase().includes('.mov')">
                        <img :src="selectedTemplate.preview_url" 
                             class="w-full h-full object-cover"
                             loading="lazy"
                             alt="Template preview">
                    </template>
                    
                    <!-- Overlay oscuro para mejor legibilidad -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
                    
                    <!-- Placeholder (solo icono centrado cuando no hay template) -->
                    <template x-if="!selectedTemplate || !selectedTemplate.preview_url">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fas fa-layer-group text-3xl text-gray-400 opacity-50"></i>
                        </div>
                    </template>
                    
                    <!-- Texto sobre la imagen (siempre visible, pegado al lateral izquierdo) -->
                    <div class="absolute bottom-0 left-0 right-0 pb-4 pl-4 z-10">
                        <div class="text-white font-bold text-lg uppercase tracking-tight mb-1" 
                             style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; text-shadow: 0 2px 8px rgba(0,0,0,0.5);"
                             x-show="selectedTemplate"
                             x-text="selectedTemplate ? selectedTemplate.name.toUpperCase() : ''"></div>
                        <div x-show="selectedTemplate && selectedTemplate.recommended_service" 
                             class="text-gray-300 text-xs font-medium tracking-wide"
                             style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; text-shadow: 0 1px 4px rgba(0,0,0,0.5);"
                             x-text="getServiceDisplayName(selectedTemplate?.recommended_service)"></div>
                    </div>
                    
                    <!-- Change button -->
                    <span @click.stop="openTemplateModal()"
                          class="absolute top-2 right-2 bg-black/60 backdrop-blur-sm px-3 py-1.5 rounded-md text-xs font-medium text-white shadow-lg hover:bg-black/80 transition-all z-20 flex items-center gap-1.5 cursor-pointer"
                          style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Change
                    </span>
                </div>
            </button>
            
            <!-- Hidden input para el form (solo si el modelo soporta prompt templates) -->
            <input type="hidden" 
                   name="prompt_template_id" 
                   :value="selectedTemplate ? selectedTemplate.uuid : ''"
                   x-show="!selectedModel || (selectedModel && !selectedModel.includes('heygen') && selectedModel !== 'manim-quote')">
        </div>
        
        <!-- Sección MANIM DESIGN (solo para Manim) -->
        <div x-show="activeTab === 'video' && selectedModel === 'manim-quote'">
            <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">MANIM DESIGN</label>
            
            <!-- Botón selector (similar al de Prompt Template) -->
            <button type="button"
                    @click="openManimDesignModal()"
                    class="w-full border-2 rounded-lg overflow-hidden bg-white hover:border-gray-400 transition-colors"
                    :class="selectedManimDesignId ? 'border-gray-400' : 'border-gray-300 border-dashed'">
                
                <!-- Preview Area -->
                <div class="aspect-video bg-gray-900 flex items-center justify-center relative overflow-hidden rounded-lg transition-colors p-4"
                     :style="selectedManimDesign ? `background-color: ${selectedManimDesign.container_color}` : ''"
                     :class="selectedManimDesign ? '' : 'bg-gray-900'">
                    
                    <!-- Placeholder cuando no hay diseño -->
                    <template x-if="!selectedManimDesignId">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fas fa-film text-3xl text-gray-400 opacity-50"></i>
                        </div>
                    </template>
                    
                    <!-- Visual Representations (Adapted for selectedManimDesign) -->
                    <!-- Quote -->
                    <template x-if="selectedManimDesign && selectedManimDesign.animation_type === 'quote'">
                        <div class="w-full space-y-2">
                            <div class="w-1/3 h-0.5 rounded-full bg-black/10 mx-auto"></div>
                            <div class="w-full h-0.5 rounded-full bg-black/20"></div>
                            <div class="w-full h-0.5 rounded-full bg-black/20"></div>
                            <div class="w-2/3 h-0.5 rounded-full bg-black/20 mx-auto"></div>
                            <div class="w-1/4 h-0.5 rounded-full bg-black/10 mx-auto"></div>
                        </div>
                    </template>

                    <!-- Classic Bar Chart -->
                    <template x-if="selectedManimDesign && selectedManimDesign.animation_type === 'bar_chart'">
                        <div class="relative w-full h-12 flex flex-col justify-end px-2">
                            <div class="absolute left-0 bottom-0 top-0 w-px bg-black/20"></div>
                            <div class="absolute left-0 right-0 bottom-0 h-px bg-black/20"></div>
                            <div class="flex items-end gap-1.5 justify-center">
                                <div class="w-1.5 h-6 rounded-t-[1px] bg-black/20"></div>
                                <div class="w-1.5 h-10 rounded-t-[1px] bg-black/40"></div>
                                <div class="w-1.5 h-8 rounded-t-[1px] bg-black/30"></div>
                            </div>
                        </div>
                    </template>

                    <!-- Modern Bar Chart -->
                    <template x-if="selectedManimDesign && selectedManimDesign.animation_type === 'modern_bar_chart'">
                        <div class="w-full h-full flex flex-col items-center justify-center p-2">
                            <div class="w-full h-full border border-black/5 rounded-lg flex flex-col items-center justify-center bg-white/50 backdrop-blur-sm shadow-sm relative overflow-hidden">
                                <div class="flex items-end gap-2 h-8">
                                    <div class="w-2 h-4 rounded-sm bg-black/30"></div>
                                    <div class="w-2 h-7 rounded-sm bg-black/50"></div>
                                    <div class="w-2 h-5 rounded-sm bg-black/40"></div>
                                </div>
                                <div class="mt-2 w-1/2 h-0.5 bg-black/10 rounded-full"></div>
                            </div>
                        </div>
                    </template>

                    <template x-if="selectedManimDesign && selectedManimDesign.animation_type === 'line_chart'">
                        <div class="w-full h-12 flex items-center justify-center">
                            <svg class="w-full h-full text-black/20" viewBox="0 0 100 40" fill="none" preserveAspectRatio="none">
                                <path d="M0 35 L20 25 L40 30 L60 10 L80 20 L100 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </template>

                    <template x-if="selectedManimDesign && selectedManimDesign.animation_type === 'pie_chart'">
                        <div class="w-12 h-12 rounded-full border-[8px] border-black/10 relative">
                            <div class="absolute inset-[-8px] rounded-full border-[8px] border-black/20 border-t-transparent border-r-transparent rotate-45"></div>
                        </div>
                    </template>
                    
                    <!-- Texto del diseño seleccionado -->
                    <div class="absolute bottom-0 left-0 right-0 pb-4 pl-4 z-10 pointer-events-none">
                        <div class="text-white font-bold text-lg uppercase tracking-tight mb-1" 
                             style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; text-shadow: 0 2px 8px rgba(0,0,0,0.5);"
                             x-show="selectedManimDesignName"
                             x-text="selectedManimDesignName.toUpperCase()"></div>
                        <div x-show="!selectedManimDesignName" 
                             class="text-gray-300 text-xs font-medium tracking-wide"
                             style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; text-shadow: 0 1px 4px rgba(0,0,0,0.5);">
                             Selecciona un grafo
                        </div>
                    </div>
                    
                    <!-- Botón Change -->
                    <span @click.stop="openManimDesignModal()"
                          class="absolute top-2 right-2 bg-black/60 backdrop-blur-sm px-3 py-1.5 rounded-md text-xs font-medium text-white shadow-lg hover:bg-black/80 transition-all z-20 flex items-center gap-1.5 cursor-pointer"
                          style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Change
                    </span>
                </div>
            </button>
            
            <!-- Hidden input para el tipo de animación de Manim -->
            <input type="hidden" 
                   name="manim_animation_type" 
                   id="manim-animation-type-input"
                   value="quote">
        </div>
        
        <!-- Sección MODEL -->
        <div>
            <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">MODEL</label>
            
            <!-- Dropdown personalizado -->
            <div x-data="{ dropdownOpen: false, searchQuery: '' }" class="relative">
                <!-- Botón de selección -->
                <button type="button"
                        @click="dropdownOpen = !dropdownOpen"
                        class="w-full px-2.5 sm:px-3 py-2 sm:py-2.5 border border-gray-300 rounded-lg bg-white text-xs sm:text-sm text-left flex items-center gap-1.5 sm:gap-2 hover:bg-gray-50 transition-colors">
                    <img x-show="selectedModel && allModels[selectedModel] && allModels[selectedModel].logo" 
                         :src="selectedModel && allModels[selectedModel] ? allModels[selectedModel].logo : ''" 
                         :alt="selectedModel && allModels[selectedModel] ? allModels[selectedModel].service : ''"
                         class="w-4 h-4 sm:w-5 sm:h-5 rounded flex-shrink-0 object-contain"
                         onerror="this.style.display='none'">
                    <div x-show="selectedModel && allModels[selectedModel] && !allModels[selectedModel].logo" class="w-4 h-4 sm:w-5 sm:h-5 rounded bg-gray-200 flex items-center justify-center flex-shrink-0">
                        <span class="text-xs font-semibold text-gray-500" x-text="selectedModel && allModels[selectedModel] ? (allModels[selectedModel].service || allModels[selectedModel].name).charAt(0).toUpperCase() : ''"></span>
                    </div>
                    <span class="truncate flex-1">
                        <span x-text="selectedModel && allModels[selectedModel] ? allModels[selectedModel].name : 'Seleccionar modelo...'"></span>
                        <span x-show="selectedModel === 'vuela-ai'" class="text-xs bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded ml-2">(PRÓXIMAMENTE)</span>
                    </span>
                    <svg class="w-4 h-4 text-gray-400 flex-shrink-0" 
                         :class="dropdownOpen ? 'transform rotate-180' : ''"
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                
                <!-- Dropdown -->
                <div x-show="dropdownOpen"
                     @click.away="dropdownOpen = false"
                     x-cloak
                     class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-[350px] overflow-hidden flex flex-col">
                    <!-- Búsqueda -->
                    <div class="p-3 border-b border-gray-200 bg-white">
                        <input type="text"
                               x-model="searchQuery"
                               @click.stop
                               placeholder="Buscar modelo..."
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    
                    <!-- Lista de modelos -->
                    <div class="overflow-y-auto max-h-[280px]">
                        <div x-show="loading" class="p-4 text-center text-sm text-gray-500">
                            Cargando modelos...
                        </div>
                        
                        <template x-for="[serviceName, serviceModels] in Object.entries(models)" :key="serviceName">
                            <div>
                                <!-- Service Header -->
                                <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                                    <span class="text-xs font-semibold text-gray-700 uppercase" x-text="serviceName"></span>
                                </div>
                                
                                <!-- Models -->
                                <template x-for="model in serviceModels.filter(m => !searchQuery || m.name.toLowerCase().includes(searchQuery.toLowerCase()))" :key="model.id">
                                    <button @click="selectedModel = model.id; onModelChange(); dropdownOpen = false; searchQuery = '';"
                                            :class="selectedModel === model.id ? 'bg-gray-100' : 'hover:bg-gray-50'"
                                            class="w-full text-left px-4 py-2.5 flex items-center gap-3 transition-colors border-b border-gray-100">
                                        <!-- Logo del servicio -->
                                        <img x-show="model.logo" 
                                             :src="model.logo" 
                                             :alt="serviceName"
                                             class="w-6 h-6 rounded object-contain flex-shrink-0"
                                             onerror="this.style.display='none'">
                                        <div x-show="!model.logo" class="w-6 h-6 rounded bg-gray-200 flex items-center justify-center flex-shrink-0">
                                            <span class="text-xs font-bold text-gray-500" x-text="serviceName.charAt(0).toUpperCase()"></span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-sm text-gray-900">
                                                <span x-text="model.name"></span>
                                                <span x-show="model.id === 'vuela-ai'" class="text-xs bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded ml-2">(PRÓXIMAMENTE)</span>
                                            </div>
                                            <div class="text-xs text-gray-500 truncate" x-text="model.description || ''"></div>
                                        </div>
                                        <svg x-show="selectedModel === model.id" class="w-5 h-5 text-black flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </template>
                            </div>
                        </template>
                        
                        <div x-show="!loading && Object.keys(models).length === 0" class="p-4 text-center text-sm text-gray-500">
                            No hay modelos disponibles
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sección PROMPT -->
        <div x-show="selectedModel !== 'manim-quote' || (manimAnimationType !== 'bar_chart' && manimAnimationType !== 'modern_bar_chart')">
            <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">PROMPT</label>
            <div class="relative">
                <textarea x-model="prompt"
                          :placeholder="'Describe tu ' + activeTab + '...'"
                          class="w-full px-3 py-2 sm:py-2.5 pr-8 sm:pr-10 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-black focus:border-black resize-none transition-all"
                          rows="5"></textarea>
                <!-- Botón copiar dentro del textarea -->
                <button @click="copyPromptToClipboard($event)"
                        x-show="prompt && prompt.trim()"
                        x-cloak
                        class="absolute bottom-2 right-2 p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded transition-colors"
                        title="Copiar prompt al portapapeles">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Sección SETTINGS (cargada dinámicamente vía HTMX) -->
        <div id="dynamic-fields-container" 
             x-show="selectedModel"
             x-transition>
            <div x-show="!selectedModel" class="text-center py-6 text-gray-400 text-xs">
                <p>Selecciona un modelo para ver opciones</p>
            </div>
        </div>
        
        
        <!-- Botón Generar con Costo Estimado -->
        <div class="pt-3 sm:pt-4 border-t border-gray-200">
            <button @click="submitForm()"
                    :disabled="!selectedModel || (!prompt && (selectedModel !== 'manim-quote' || (manimAnimationType !== 'bar_chart' && manimAnimationType !== 'modern_bar_chart'))) || submitting"
                    :class="(!selectedModel || (!prompt && (selectedModel !== 'manim-quote' || (manimAnimationType !== 'bar_chart' && manimAnimationType !== 'modern_bar_chart'))) || submitting) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-800'"
                    class="w-full bg-black text-white py-2.5 sm:py-3 px-3 sm:px-4 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 text-sm sm:text-base">
                <span x-show="!submitting">Generar</span>
                <span x-show="submitting">Generando...</span>
                <svg x-show="!submitting" class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <!-- Costo estimado (se carga dinámicamente vía HTMX) -->
                <span id="estimated-cost-container" x-show="!submitting" class="text-xs opacity-75 hidden sm:inline">
                    <!-- Se carga vía HTMX junto con los campos dinámicos -->
                </span>
            </button>
        </div>
        
    </div>
    
    <!-- Modal de selección de Template -->
    <div x-show="templateModalOpen"
         x-cloak
         @click.self="templateModalOpen = false"
         @keydown.escape.window="templateModalOpen = false"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col"
             @click.stop
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100">
            
            <!-- Header -->
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-layer-group mr-2"></i>Seleccionar Template
                </h3>
                <button type="button" @click="templateModalOpen = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Tabs & Search -->
            <div class="p-4 border-b space-y-3">
                <div class="flex gap-2">
                    <button type="button"
                            @click="templateTab = 'public'; loadTemplates()"
                            :class="templateTab === 'public' ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 text-sm font-medium rounded-lg transition-colors">Públicos</button>
                    <button type="button"
                            @click="templateTab = 'my'; loadTemplates()"
                            :class="templateTab === 'my' ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 text-sm font-medium rounded-lg transition-colors">Mis Templates</button>
                    <button type="button"
                            @click="templateTab = 'favorites'; loadTemplates()"
                            :class="templateTab === 'favorites' ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 text-sm font-medium rounded-lg transition-colors">Favoritos</button>
                </div>
                
                <div class="relative">
                    <input type="text"
                           x-model="templateSearch"
                           @input.debounce.300ms="loadTemplates()"
                           placeholder="Buscar por nombre..."
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-900 focus:border-gray-900">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            
            <!-- Grid -->
            <div class="flex-1 overflow-y-auto p-4">
                <!-- Loading -->
                <div x-show="templateLoading" class="flex justify-center items-center py-12">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
                </div>
                
                <!-- Templates Grid -->
                <div x-show="!templateLoading && templateList.length > 0" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <template x-for="tpl in templateList" :key="tpl.uuid">
                        <button type="button"
                                @click="selectTemplate(tpl)"
                                class="border-2 rounded-lg overflow-hidden text-left transition-all hover:border-gray-900 hover:shadow-lg"
                                :class="selectedTemplate && selectedTemplate.uuid === tpl.uuid ? 'border-gray-900 shadow-lg' : 'border-gray-200'">
                            
                            <div class="aspect-video bg-gray-900 flex items-center justify-center relative overflow-hidden">
                                <!-- Video Preview -->
                                <template x-if="tpl.preview_url && (tpl.preview_url.toLowerCase().includes('.mp4') || tpl.preview_url.toLowerCase().includes('.webm') || tpl.preview_url.toLowerCase().includes('.mov') || (activeTab === 'video' && !tpl.preview_url.toLowerCase().includes('.jpg') && !tpl.preview_url.toLowerCase().includes('.jpeg') && !tpl.preview_url.toLowerCase().includes('.png') && !tpl.preview_url.toLowerCase().includes('.gif') && !tpl.preview_url.toLowerCase().includes('.webp')))">
                                    <video :src="tpl.preview_url" 
                                           class="w-full h-full object-cover"
                                           preload="none"
                                           autoplay
                                           loop
                                           muted
                                           playsinline></video>
                                </template>
                                
                                <!-- Image Preview -->
                                <template x-if="tpl.preview_url && !tpl.preview_url.toLowerCase().includes('.mp4') && !tpl.preview_url.toLowerCase().includes('.webm') && !tpl.preview_url.toLowerCase().includes('.mov')">
                                    <img :src="tpl.preview_url" 
                                         class="w-full h-full object-cover"
                                         loading="lazy"
                                         alt="Template preview">
                                </template>
                                
                                <!-- Overlay oscuro para mejor legibilidad -->
                                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
                                
                                <!-- Placeholder (solo icono centrado cuando no hay preview) -->
                                <template x-if="!tpl.preview_url">
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <i class="fas fa-image text-3xl text-gray-300"></i>
                                    </div>
                                </template>
                                
                                <!-- Texto sobre la imagen (siempre visible, pegado al lateral izquierdo) -->
                                <div class="absolute bottom-0 left-0 right-0 pb-3 pl-3 z-10">
                                    <div class="text-white font-bold text-sm uppercase tracking-tight mb-0.5" 
                                         style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; text-shadow: 0 2px 8px rgba(0,0,0,0.5);"
                                         x-text="tpl.name.toUpperCase()"></div>
                                    <div x-show="tpl.recommended_service" 
                                         class="text-gray-300 text-xs font-medium tracking-wide"
                                         style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; text-shadow: 0 1px 4px rgba(0,0,0,0.5);"
                                         x-text="getServiceDisplayName(tpl.recommended_service)"></div>
                                </div>
                            </div>
                        </button>
                    </template>
                </div>
                
                <!-- Empty State -->
                <div x-show="!templateLoading && templateList.length === 0" class="text-center py-12">
                    <i class="fas fa-inbox text-5xl text-gray-300 mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">No hay templates</h3>
                    <p class="text-gray-500 text-sm">No se encontraron templates disponibles</p>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="flex justify-between items-center p-4 border-t bg-gray-50">
                <button type="button"
                        @click="clearTemplate()"
                        x-show="selectedTemplate"
                        class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors">
                    <i class="fas fa-times mr-1"></i>Quitar Template
                </button>
                <div x-show="!selectedTemplate"></div>
                <button type="button"
                        @click="templateModalOpen = false"
                        class="px-4 py-2 text-sm font-medium bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de diseños Manim -->
    <div x-show="manimDesignModalOpen"
         x-cloak
         @click.self="manimDesignModalOpen = false"
         @keydown.escape.window="manimDesignModalOpen = false"
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] flex flex-col"
             @click.stop
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100">
            
            <!-- Header -->
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-film mr-2"></i>Diseños para Manim
                </h3>
                <button type="button" @click="manimDesignModalOpen = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Categorías y Grid de diseños -->
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50/50">
                <div class="space-y-8">
                    <template x-for="categoryName in [...new Set(manimDesigns.map(d => d.category))]" :key="categoryName">
                        <div class="space-y-4">
                            <!-- Category Header -->
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]" x-text="categoryName"></span>
                                <div class="h-px bg-gray-200 flex-1"></div>
                            </div>

                            <!-- Category Grid -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                <template x-for="design in manimDesigns.filter(d => d.category === categoryName)" :key="design.id">
                                    <div class="relative group">
                                        <button type="button"
                                                @click="design.active ? applyManimDesign(design) : null"
                                                class="w-full relative bg-white border border-gray-200 rounded-2xl overflow-hidden transition-all duration-300 flex flex-col h-full"
                                                :class="[
                                                    design.active ? 'hover:shadow-2xl hover:border-black cursor-pointer' : 'cursor-default opacity-60 grayscale',
                                                    selectedManimDesignId === design.id ? 'ring-2 ring-black border-black' : ''
                                                ]">
                                            
                                            <!-- Preview Box -->
                                            <div class="aspect-video w-full relative overflow-hidden flex items-center justify-center p-6 transition-colors"
                                                 :class="design.active ? 'group-hover:bg-white' : ''"
                                                 :style="`background-color: ${design.container_color}`">
                                                
                                                <!-- Visual Representations -->
                                                <!-- Quote -->
                                                <template x-if="design.animation_type === 'quote'">
                                                    <div class="w-full space-y-2">
                                                        <div class="w-1/3 h-0.5 rounded-full bg-black/10 mx-auto"></div>
                                                        <div class="w-full h-0.5 rounded-full bg-black/20"></div>
                                                        <div class="w-full h-0.5 rounded-full bg-black/20"></div>
                                                        <div class="w-2/3 h-0.5 rounded-full bg-black/20 mx-auto"></div>
                                                        <div class="w-1/4 h-0.5 rounded-full bg-black/10 mx-auto"></div>
                                                    </div>
                                                </template>

                                                <!-- Classic Bar Chart (With Axes) -->
                                                <template x-if="design.animation_type === 'bar_chart'">
                                                    <div class="relative w-full h-12 flex flex-col justify-end px-2">
                                                        <div class="absolute left-0 bottom-0 top-0 w-px bg-black/20"></div>
                                                        <div class="absolute left-0 right-0 bottom-0 h-px bg-black/20"></div>
                                                        <div class="flex items-end gap-1.5 justify-center">
                                                            <div class="w-1.5 h-6 rounded-t-[1px] bg-black/20"></div>
                                                            <div class="w-1.5 h-10 rounded-t-[1px] bg-black/40"></div>
                                                            <div class="w-1.5 h-8 rounded-t-[1px] bg-black/30"></div>
                                                        </div>
                                                    </div>
                                                </template>

                                                <!-- Modern Bar Chart (Card Style & Floating) -->
                                                <template x-if="design.animation_type === 'modern_bar_chart'">
                                                    <div class="w-full h-full flex flex-col items-center justify-center p-2">
                                                        <div class="w-full h-full border border-black/5 rounded-lg flex flex-col items-center justify-center bg-white/50 backdrop-blur-sm shadow-sm relative overflow-hidden">
                                                            <div class="flex items-end gap-2 h-8">
                                                                <div class="w-2 h-4 rounded-sm bg-black/30"></div>
                                                                <div class="w-2 h-7 rounded-sm bg-black/50"></div>
                                                                <div class="w-2 h-5 rounded-sm bg-black/40"></div>
                                                            </div>
                                                            <div class="mt-2 w-1/2 h-0.5 bg-black/10 rounded-full"></div>
                                                        </div>
                                                    </div>
                                                </template>

                                                <template x-if="design.animation_type === 'line_chart'">
                                                    <div class="w-full h-12 flex items-center justify-center">
                                                        <svg class="w-full h-full text-black/20" viewBox="0 0 100 40" fill="none" preserveAspectRatio="none">
                                                            <path d="M0 35 L20 25 L40 30 L60 10 L80 20 L100 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                        </svg>
                                                    </div>
                                                </template>

                                                <template x-if="design.animation_type === 'pie_chart'">
                                                    <div class="w-12 h-12 rounded-full border-[8px] border-black/10 relative">
                                                        <div class="absolute inset-[-8px] rounded-full border-[8px] border-black/20 border-t-transparent border-r-transparent rotate-45"></div>
                                                    </div>
                                                </template>

                                                <!-- Status Badge -->
                                                <div x-show="!design.active" 
                                                     class="absolute inset-0 bg-white/40 flex items-center justify-center backdrop-blur-[1px]">
                                                    <span class="bg-white/90 border border-gray-200 px-3 py-1 rounded-full text-[9px] font-black text-gray-400 uppercase tracking-widest shadow-sm">
                                                        Próximamente
                                                    </span>
                                                </div>

                                                <!-- Active Selection Badge -->
                                                <div x-show="selectedManimDesignId === design.id" 
                                                     class="absolute top-3 right-3 bg-black text-white p-1 rounded-full shadow-lg">
                                                    <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path>
                                                    </svg>
                                                </div>
                                            </div>

                                            <!-- Info Box -->
                                            <div class="p-4 flex flex-col gap-1.5 bg-white flex-1">
                                                <h4 class="text-[10px] font-black text-gray-900 uppercase tracking-widest" x-text="design.name"></h4>
                                                <p class="text-[10px] text-gray-400 leading-tight font-medium line-clamp-2" x-text="design.description"></p>
                                                
                                                <div x-show="design.active" class="mt-auto pt-4 flex items-center justify-between">
                                                    <span class="text-[8px] font-bold text-gray-300 uppercase tracking-tighter"
                                                          x-text="design.animation_type === 'quote' ? 'Estructura Texto' : 'Estructura Datos'"></span>
                                                    <i class="fas fa-arrow-right text-gray-200 group-hover:text-black group-hover:translate-x-1 transition-all text-[10px]"></i>
                                                </div>
                                            </div>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="flex justify-end items-center p-4 border-t bg-gray-50">
                <button type="button"
                        @click="manimDesignModalOpen = false"
                        class="px-4 py-2 text-sm font-medium bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        // Al cargar este fragmento, movemos el modal al final del body
        // para asegurar que 'fixed' funcione respecto a la ventana completa.
        const modal = document.getElementById('elevenlabs-voice-modal');
        if (modal && document.body) {
            document.body.appendChild(modal);
        }
    })();
</script>