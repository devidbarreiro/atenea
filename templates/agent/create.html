{% extends 'base.html' %}
{% load static %}

{% block title %}Generar Video con Agente{% if project %} - {{ project.name }}{% endif %}{% endblock %}

{% block content %}
<div class="flex min-h-screen bg-gray-50">
    {% include 'includes/sidebar.html' %}
    {% if project %}
        {% include 'includes/project_sidebar.html' with project=project user_role=user_role project_owner=project_owner project_members=project_members %}
        {% include 'includes/project_tabs_bar.html' with active_tab='agent' project=project %}
    {% endif %}

    <!-- Contenido principal - Con margen para sidebars -->
    <main class="flex-1 min-w-0 {% if project %}lg:ml-80 pt-[57px]{% else %}lg:ml-16 pt-4{% endif %}">
        <div class="p-6 max-w-5xl mx-auto">
            <!-- Progress Bar -->
            <div class="mb-8">
        <div class="flex items-center justify-center space-x-4">
            <!-- Step 1: Content (Active) -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-600 text-white font-bold">
                    1
                </div>
                <span class="ml-2 text-sm font-medium text-gray-900">Contenido</span>
            </div>
            <div class="w-16 h-1 bg-gray-300"></div>
            
            <!-- Step 2: Configure (Inactive) -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-300 text-gray-600 font-bold">
                    2
                </div>
                <span class="ml-2 text-sm font-medium text-gray-500">Configurar</span>
            </div>
            <div class="w-16 h-1 bg-gray-300"></div>
            
            <!-- Step 3: Scenes (Inactive) -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-300 text-gray-600 font-bold">
                    3
                </div>
                <span class="ml-2 text-sm font-medium text-gray-500">Escenas</span>
            </div>
            <div class="w-16 h-1 bg-gray-300"></div>
            
            <!-- Step 4: Final (Inactive) -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-300 text-gray-600 font-bold">
                    4
                </div>
                <span class="ml-2 text-sm font-medium text-gray-500">Final</span>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">Crear Nuevo Video</h1>
        <p class="text-gray-600">Elige c√≥mo quieres proporcionar tu contenido</p>
    </div>

    <!-- Content Options -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Write Script Manually Card -->
        <div id="script-manual-card" 
             onclick="selectContentType('script-manual')"
             class="content-card cursor-pointer bg-white rounded-lg border-2 border-gray-300 p-6 hover:border-blue-600 hover:shadow-xl transition-all duration-300">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Escribir Gui√≥n</h3>
                <p class="text-gray-600 text-sm">Escribe o pega el gui√≥n de tu video directamente</p>
            </div>
        </div>

        <!-- Write Script with AI Card -->
        <div id="script-ai-card" 
             onclick="selectContentType('script-ai')"
             class="content-card cursor-pointer bg-white rounded-lg border-2 border-blue-600 p-6 hover:shadow-xl transition-all duration-300">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Escribir Gui√≥n con IA</h3>
                <p class="text-gray-600 text-sm">Crea tu gui√≥n con ayuda de un asistente inteligente</p>
                <span class="mt-2 text-xs font-medium text-blue-600 bg-blue-50 px-3 py-1 rounded-full">Recomendado</span>
            </div>
        </div>

        <!-- Generar P√≠ldora Card -->
        <div id="script-pill-card" 
             onclick="selectContentType('script-pill')"
             class="content-card cursor-pointer bg-white rounded-lg border-2 border-purple-600 p-6 hover:shadow-xl transition-all duration-300">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Generar P√≠ldora</h3>
                <p class="text-gray-600 text-sm">Crea videos educativos cortos tipo "P√≠ldora" con segmentos</p>
                <span class="mt-2 text-xs font-medium text-purple-600 bg-purple-50 px-3 py-1 rounded-full">Nuevo</span>
            </div>
        </div>

        <!-- Upload PDF Card (Disabled) -->
        <div class="content-card bg-gray-100 rounded-lg border-2 border-gray-300 p-6 opacity-50 cursor-not-allowed">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Subir Gui√≥n</h3>
                <p class="text-gray-500 text-sm">Sube un documento con tu gui√≥n</p>
                <span class="mt-2 text-xs font-medium text-gray-500 bg-gray-200 px-3 py-1 rounded-full">Pr√≥ximamente</span>
            </div>
        </div>
    </div>

    <!-- Pills Script Form -->
    <div id="script-pill-form" class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 hidden">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Gui√≥n de P√≠ldora</h2>
        <p class="text-gray-600 mb-6">Pega tu gui√≥n completo aqu√≠. Nosotros lo dividiremos en segmentos.</p>
        
        <div class="mb-6">
            <label for="pill_script_content" class="block text-sm font-medium text-gray-700 mb-2">
                Contenido del Gui√≥n
            </label>
            <textarea 
                id="pill_script_content" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                rows="10"
                placeholder="Escribe o pega aqu√≠ el gui√≥n completo del video..."
                required
            ></textarea>
        </div>

        <div class="flex justify-end gap-3">
            <button type="button" onclick="resetSelection()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium transition-colors">
                Volver
            </button>
            <button type="button" id="btn-process-pill-step1" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium transition-colors shadow-sm">
                Procesar Gui√≥n
            </button>
        </div>
    </div>

    <!-- Script Form - Manual -->
    <div id="script-manual-form" class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 hidden">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Tu Gui√≥n</h2>
        <p class="text-gray-600 mb-6">Configura tu video e ingresa el gui√≥n</p>

        <form id="agentCreateFormManual" method="post">
            {% csrf_token %}
            <input type="hidden" name="content_type" value="script-manual">

            <!-- Video Type, Format and Orientation -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label for="video_type_manual" class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo de Video
                    </label>
                    <select 
                        id="video_type_manual" 
                        name="video_type" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                    >
                        <option value="general">Video General (Todos los servicios)</option>
                        <option value="ultra">Modo Ultra (Solo Veo3 y Sora2)</option>
                        <option value="avatar">Con Avatares (Principalmente HeyGen)</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Define qu√© servicios de IA estar√°n disponibles</p>
                </div>

                <div>
                    <label for="video_format_manual" class="block text-sm font-medium text-gray-700 mb-2">
                        Formato de Video
                    </label>
                    <select 
                        id="video_format_manual" 
                        name="video_format" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                    >
                        <option value="social">üì± Redes Sociales (Reels/TikTok)</option>
                        <option value="educational" selected>üéì Video Educativo (P√≠ldora)</option>
                        <option value="longform">üé¨ Video Largo (YouTube/Masterclass)</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Define la estructura y duraci√≥n de las escenas</p>
                </div>

                <div>
                    <label for="video_orientation_manual" class="block text-sm font-medium text-gray-700 mb-2">
                        Orientaci√≥n
                    </label>
                    <select 
                        id="video_orientation_manual" 
                        name="video_orientation" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                    >
                        <option value="16:9">Horizontal (16:9)</option>
                        <option value="9:16">Vertical (9:16)</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Se aplicar√° a todas las escenas</p>
                </div>
            </div>

            <!-- Preview Options -->
            <div class="mb-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="flex items-start space-x-3">
                    <input 
                        type="checkbox" 
                        id="generate_previews_manual" 
                        name="generate_previews" 
                        checked
                        class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    >
                    <div class="flex-1">
                        <label for="generate_previews_manual" class="text-sm font-medium text-gray-700 cursor-pointer">
                            Generar previews autom√°ticamente con IA
                        </label>
                        <p class="text-xs text-gray-500 mt-1">Se generar√° una imagen preview para cada escena. Si no est√° marcado, podr√°s a√±adir previews manualmente en el Paso 2.</p>
                    </div>
                </div>
            </div>

            <!-- Audio Options -->
            <div class="mb-6 bg-green-50 rounded-lg p-4 border border-green-200">
                <div class="flex items-start space-x-3 mb-4">
                    <input 
                        type="checkbox" 
                        id="enable_audio_manual" 
                        name="enable_audio" 
                        checked
                        class="mt-1 w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500"
                        onchange="document.getElementById('voice_selection_manual').style.display = this.checked ? 'block' : 'none';"
                    >
                    <div class="flex-1">
                        <label for="enable_audio_manual" class="text-sm font-medium text-gray-700 cursor-pointer">
                            üéôÔ∏è Generar narraci√≥n autom√°tica con ElevenLabs TTS
                        </label>
                        <p class="text-xs text-gray-500 mt-1">Para escenas Veo/Sora: se generar√° voz en off y se combinar√° con el video</p>
                    </div>
                </div>
                
                <!-- Voice Selection -->
                <div id="voice_selection_manual" class="ml-7 mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Voz de narraci√≥n (se aplicar√° a todas las escenas)
                    </label>
                    <input type="hidden" id="default_voice_id_manual" name="default_voice_id" value="pFZP5JQG7iQjIQuC4Bku">
                    <input type="hidden" id="default_voice_name_manual" name="default_voice_name" value="Aria">
                    
                    <div id="voice-selected-manual" class="mb-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-sm font-bold text-green-900" id="selected-voice-name-manual">Aria</p>
                                <p class="text-xs text-green-600" id="selected-voice-category-manual">Voz por defecto en espa√±ol</p>
                            </div>
                            <button type="button" onclick="openVoiceModalManual()" 
                                    class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                                Cambiar
                            </button>
                        </div>
                    </div>

                    {% include 'includes/voice_selector_modal.html' %}
                    
                    <p class="text-xs text-gray-500">Puedes cambiar la voz por escena en el paso 2</p>
                </div>
            </div>

            <!-- Script Content -->
            <div class="mb-6">
                <label for="script_content_manual" class="block text-sm font-medium text-gray-700 mb-2">
                    Contenido del Gui√≥n
                </label>
                <textarea 
                    id="script_content_manual" 
                    name="script_content" 
                    rows="12"
                    placeholder="Escribe tu gui√≥n de video aqu√≠..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    required
                    oninput="calculateEstimatedDuration()"
                ></textarea>
                <p class="mt-2 text-sm text-gray-500">
                    La IA analizar√° este contenido y lo dividir√° en escenas para tu video
                </p>
            </div>

            <!-- Duration -->
            <div class="mb-6">
                <label for="desired_duration_manual" class="block text-sm font-medium text-gray-700 mb-2">
                    Duraci√≥n Deseada
                </label>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <input 
                            type="number" 
                            id="desired_duration_min_manual" 
                            name="desired_duration_min" 
                            value="1" 
                            min="0" 
                            max="60"
                            class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center"
                            onchange="updateDurationTotal()"
                        >
                        <span class="text-gray-600 font-medium">min</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <input 
                            type="number" 
                            id="desired_duration_sec_manual" 
                            name="desired_duration_sec" 
                            value="0" 
                            min="0" 
                            max="59"
                            step="15"
                            class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center"
                            onchange="updateDurationTotal()"
                        >
                        <span class="text-gray-600 font-medium">seg</span>
                    </div>
                    <div class="text-sm text-gray-600 ml-2">
                        <span class="font-medium text-blue-600">Total:</span>
                        <span id="duration_total_manual" class="ml-1 font-semibold">1 min 0 seg</span>
                    </div>
                </div>
                <div id="estimated_duration_manual" class="mt-2 text-sm text-gray-600 hidden">
                    <span class="font-medium text-blue-600">Duraci√≥n estimada:</span>
                    <span id="estimated_duration_value_manual" class="ml-1">-</span>
                </div>
                <p class="mt-2 text-xs text-gray-500">
                    La duraci√≥n estimada se calcula autom√°ticamente seg√∫n el contenido del gui√≥n. Los segundos se ajustan autom√°ticamente a m√∫ltiplos de 15.
                </p>
            </div>

            <!-- Advanced Preferences (Collapsible) -->
            <div class="mb-6 border border-gray-200 rounded-lg overflow-hidden">
                <button 
                    type="button"
                    onclick="toggleAdvancedPreferences()"
                    class="w-full px-6 py-4 bg-gray-50 hover:bg-gray-100 flex items-center justify-between transition-colors"
                    id="advanced-preferences-toggle"
                >
                    <div class="flex items-center space-x-2">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                        </svg>
                        <span class="text-sm font-medium text-gray-700">Preferencias Avanzadas de Modelos</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-600 transform transition-transform" id="advanced-preferences-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                
                <div id="advanced-preferences-content" class="hidden p-6 bg-white border-t border-gray-200">
                    <p class="text-xs text-gray-500 mb-4">
                        Selecciona los modelos por defecto para cada servicio. Si no especificas, se usar√°n los modelos recomendados seg√∫n el tipo de video.
                    </p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Veo Model -->
                        <div>
                            <label for="model_pref_veo_manual" class="block text-sm font-medium text-gray-700 mb-2">
                                <div class="flex items-center gap-2">
                                    <img src="{% static 'img/logos/google.png' %}" alt="Google" class="w-5 h-5">
                                    <span>Modelo Gemini Veo (por defecto)</span>
                                </div>
                            </label>
                            <select 
                                id="model_pref_veo_manual" 
                                name="model_pref_veo"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="">Usar recomendado seg√∫n tipo</option>
                                <option value="veo-3.1-generate-preview" selected>Veo 3.1 Preview (Recomendado)</option>
                                <option value="veo-3.1-fast-generate-preview">Veo 3.1 Fast Preview</option>
                                <option value="veo-3.0-generate-001">Veo 3.0</option>
                                <option value="veo-3.0-fast-generate-001">Veo 3.0 Fast</option>
                                <option value="veo-3.0-generate-preview">Veo 3.0 Preview</option>
                                <option value="veo-2.0-generate-001">Veo 2.0</option>
                                <option value="veo-2.0-generate-exp">Veo 2.0 Experimental</option>
                                <option value="veo-2.0-generate-preview">Veo 2.0 Preview</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500">Se aplicar√° a todas las escenas que usen Veo</p>
                        </div>

                        <!-- Sora Model -->
                        <div>
                            <label for="model_pref_sora_manual" class="block text-sm font-medium text-gray-700 mb-2">
                                <div class="flex items-center gap-2">
                                    <img src="{% static 'img/logos/openai.svg' %}" alt="OpenAI" class="w-5 h-5">
                                    <span>Modelo Sora (por defecto)</span>
                                </div>
                            </label>
                            <select 
                                id="model_pref_sora_manual" 
                                name="model_pref_sora"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="">Usar recomendado seg√∫n tipo</option>
                                <option value="sora-2" selected>Sora 2 (Recomendado)</option>
                                <option value="sora-2-pro">Sora 2 Pro</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500">Se aplicar√° a todas las escenas que usen Sora</p>
                        </div>

                        <!-- HeyGen Service -->
                        <div>
                            <label for="model_pref_heygen_manual" class="block text-sm font-medium text-gray-700 mb-2">
                                <div class="flex items-center gap-2">
                                    <img src="{% static 'img/logos/heygen.png' %}" alt="HeyGen" class="w-5 h-5">
                                    <span>Servicio HeyGen (por defecto)</span>
                                </div>
                            </label>
                            <select 
                                id="model_pref_heygen_manual" 
                                name="model_pref_heygen"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="">Usar recomendado seg√∫n tipo</option>
                                <option value="heygen_v2" selected>HeyGen Avatar V2 (Recomendado)</option>
                                <option value="heygen_avatar_iv">HeyGen Avatar IV</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500">Se aplicar√° a todas las escenas que usen HeyGen</p>
                        </div>
                    </div>
                    
                    <!-- HeyGen Avatar and Voice Selection -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-700 mb-4 flex items-center gap-2">
                            <img src="{% static 'img/logos/heygen.png' %}" alt="HeyGen" class="w-4 h-4">
                            <span>Avatar y Voz por Defecto de HeyGen</span>
                        </h3>
                        <p class="text-xs text-gray-500 mb-4">Se aplicar√°n a todas las escenas que usen HeyGen</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Avatar Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Avatar por Defecto
                                </label>
                                <input type="hidden" id="default_heygen_avatar_id_manual" name="default_heygen_avatar_id" value="">
                                <input type="hidden" id="default_heygen_avatar_name_manual" name="default_heygen_avatar_name" value="">
                                
                                <div id="avatar-selected-manual" class="mb-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm font-bold text-blue-900" id="selected-avatar-name-manual">No seleccionado</p>
                                            <p class="text-xs text-blue-600" id="selected-avatar-gender-manual">Selecciona un avatar</p>
                                        </div>
                                        <button type="button" onclick="openAvatarModalManual()" 
                                                id="select-avatar-btn-manual"
                                                class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition flex items-center gap-2">
                                            <span id="avatar-btn-text">Seleccionar</span>
                                            <span id="avatar-btn-loader" class="hidden">
                                                <svg class="animate-spin h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Voice Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Voz por Defecto
                                </label>
                                <input type="hidden" id="default_heygen_voice_id_manual" name="default_heygen_voice_id" value="">
                                <input type="hidden" id="default_heygen_voice_name_manual" name="default_heygen_voice_name" value="">
                                
                                <div id="heygen-voice-selected-manual" class="mb-2 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm font-bold text-purple-900" id="selected-heygen-voice-name-manual">No seleccionada</p>
                                            <p class="text-xs text-purple-600" id="selected-heygen-voice-language-manual">Selecciona una voz</p>
                                        </div>
                                        <button type="button" onclick="openHeyGenVoiceModalManual()" 
                                                id="select-voice-btn-manual"
                                                class="px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition flex items-center gap-2">
                                            <span id="voice-btn-text">Seleccionar</span>
                                            <span id="voice-btn-loader" class="hidden">
                                                <svg class="animate-spin h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-between items-center">
                <a href="{% if project %}{% url 'core:project_agent' project.uuid %}{% else %}{% url 'core:agent_create_standalone' %}{% endif %}" 
                   class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                    Cancelar
                </a>
                <button 
                    type="submit"
                    class="px-8 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors shadow-sm">
                    Continuar ‚Üí
                </button>
            </div>
        </form>
    </div>

    <!-- Script Form - AI Assisted -->
    <div id="script-ai-form" class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Escritura Asistida con IA</h2>
        <p class="text-gray-600 mb-6">Configura tu video antes de comenzar con el asistente</p>

        <form id="agentCreateFormAI" action="{% if project %}{% url 'core:agent_ai_assistant' project.uuid %}{% else %}#{% endif %}" method="get">
            <!-- Video Type and Orientation -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="video_type_ai" class="block text-sm font-medium text-gray-700 mb-2">
                        Tipo de Video
                    </label>
                    <select 
                        id="video_type_ai" 
                        name="video_type" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                    >
                        <option value="general">Video General (Todos los servicios)</option>
                        <option value="ultra">Modo Ultra (Solo Veo3 y Sora2)</option>
                        <option value="avatar">Con Avatares (Principalmente HeyGen)</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Define qu√© servicios de IA estar√°n disponibles</p>
                </div>

                <div>
                    <label for="video_orientation_ai" class="block text-sm font-medium text-gray-700 mb-2">
                        Orientaci√≥n
                    </label>
                    <select 
                        id="video_orientation_ai" 
                        name="video_orientation" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        required
                    >
                        <option value="16:9">Horizontal (16:9)</option>
                        <option value="9:16">Vertical (9:16)</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Se aplicar√° a todas las escenas</p>
                </div>
            </div>

            <!-- Preview Options -->
            <div class="mb-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
                <div class="flex items-start space-x-3">
                    <input 
                        type="checkbox" 
                        id="generate_previews_ai" 
                        name="generate_previews" 
                        value="true"
                        checked
                        class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    >
                    <div class="flex-1">
                        <label for="generate_previews_ai" class="text-sm font-medium text-gray-700 cursor-pointer">
                            Generar previews autom√°ticamente con IA
                        </label>
                        <p class="text-xs text-gray-500 mt-1">Se generar√° una imagen preview para cada escena</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-center">
                <button 
                    type="submit"
                    class="px-8 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors shadow-sm inline-flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    Comenzar con IA ‚Üí
                </button>
            </div>
        </form>
    </div>
        </div>
    </main>
</div>

<script>
function selectContentType(type) {
    // Resetear todos los cards
    document.getElementById('script-manual-card').classList.remove('border-blue-600', 'border-purple-600');
    document.getElementById('script-manual-card').classList.add('border-gray-300');
    document.getElementById('script-ai-card').classList.remove('border-blue-600');
    document.getElementById('script-ai-card').classList.add('border-gray-300');
    document.getElementById('script-pill-card').classList.remove('border-purple-600');
    document.getElementById('script-pill-card').classList.add('border-gray-300');
    
    // Ocultar todos los forms
    document.getElementById('script-manual-form').classList.add('hidden');
    document.getElementById('script-ai-form').classList.add('hidden');
    document.getElementById('script-pill-form').classList.add('hidden');
    
    // Mostrar el form seleccionado
    if (type === 'script-manual') {
        document.getElementById('script-manual-card').classList.add('border-blue-600');
        document.getElementById('script-manual-card').classList.remove('border-gray-300');
        document.getElementById('script-manual-form').classList.remove('hidden');
        document.getElementById('script-manual-form').scrollIntoView({ behavior: 'smooth' });
    } else if (type === 'script-ai') {
        document.getElementById('script-ai-card').classList.add('border-blue-600');
        document.getElementById('script-ai-card').classList.remove('border-gray-300');
        document.getElementById('script-ai-form').classList.remove('hidden');
        document.getElementById('script-ai-form').scrollIntoView({ behavior: 'smooth' });
    } else if (type === 'script-pill') {
        document.getElementById('script-pill-card').classList.add('border-purple-600');
        document.getElementById('script-pill-card').classList.remove('border-gray-300');
        document.getElementById('script-pill-form').classList.remove('hidden');
        document.getElementById('script-pill-form').scrollIntoView({ behavior: 'smooth' });
    }
}

function resetSelection() {
    // Resetear todos los cards
    document.getElementById('script-manual-card').classList.remove('border-blue-600', 'border-purple-600');
    document.getElementById('script-manual-card').classList.add('border-gray-300');
    document.getElementById('script-ai-card').classList.remove('border-blue-600');
    document.getElementById('script-ai-card').classList.add('border-gray-300');
    document.getElementById('script-pill-card').classList.remove('border-purple-600');
    document.getElementById('script-pill-card').classList.add('border-gray-300');
    
    // Ocultar todos los forms
    document.getElementById('script-manual-form').classList.add('hidden');
    document.getElementById('script-ai-form').classList.add('hidden');
    document.getElementById('script-pill-form').classList.add('hidden');
}

// Por defecto, seleccionar "Escribir con IA"
selectContentType('script-ai');

// Cargar valores guardados desde sessionStorage al iniciar
document.addEventListener('DOMContentLoaded', function() {
    try {
        const savedAvatarId = sessionStorage.getItem('default_heygen_avatar_id');
        const savedAvatarName = sessionStorage.getItem('default_heygen_avatar_name');
        const savedVoiceId = sessionStorage.getItem('default_heygen_voice_id');
        const savedVoiceName = sessionStorage.getItem('default_heygen_voice_name');
        
        if (savedAvatarId && savedAvatarName) {
            document.getElementById('default_heygen_avatar_id_manual').value = savedAvatarId;
            document.getElementById('default_heygen_avatar_name_manual').value = savedAvatarName;
            document.getElementById('selected-avatar-name-manual').textContent = savedAvatarName;
            document.getElementById('selected-avatar-gender-manual').textContent = 'Avatar guardado';
        }
        
        if (savedVoiceId && savedVoiceName) {
            document.getElementById('default_heygen_voice_id_manual').value = savedVoiceId;
            document.getElementById('default_heygen_voice_name_manual').value = savedVoiceName;
            document.getElementById('selected-heygen-voice-name-manual').textContent = savedVoiceName;
            document.getElementById('selected-heygen-voice-language-manual').textContent = 'Voz guardada';
        }
    } catch (e) {
        console.warn('Error cargando valores guardados:', e);
    }
    
    // Cargar avatares y voces autom√°ticamente en background (lazy loading)
    loadHeyGenAssetsLazy();
});

// Funci√≥n para actualizar el total de duraci√≥n
function updateDurationTotal() {
    const minutes = parseInt(document.getElementById('desired_duration_min_manual').value) || 0;
    const seconds = parseInt(document.getElementById('desired_duration_sec_manual').value) || 0;
    
    // Asegurar que los segundos sean m√∫ltiplos de 15
    const adjustedSeconds = Math.round(seconds / 15) * 15;
    if (adjustedSeconds !== seconds) {
        document.getElementById('desired_duration_sec_manual').value = adjustedSeconds;
    }
    
    const totalSeconds = (minutes * 60) + adjustedSeconds;
    const totalMinutes = Math.floor(totalSeconds / 60);
    const remainingSeconds = totalSeconds % 60;
    
    let displayText = '';
    if (totalMinutes > 0) {
        displayText = `${totalMinutes} min`;
        if (remainingSeconds > 0) {
            displayText += ` ${remainingSeconds} seg`;
        }
    } else {
        displayText = `${remainingSeconds} seg`;
    }
    
    document.getElementById('duration_total_manual').textContent = displayText;
}

// Inicializar al cargar
document.addEventListener('DOMContentLoaded', function() {
    updateDurationTotal();
});

document.getElementById('agentCreateFormManual').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const scriptContent = document.getElementById('script_content_manual').value;
    const durationMin = parseInt(document.getElementById('desired_duration_min_manual').value) || 0;
    const durationSec = parseInt(document.getElementById('desired_duration_sec_manual').value) || 0;
    const totalSeconds = (durationMin * 60) + durationSec;
    const durationMinutesDecimal = totalSeconds / 60; // Convertir a minutos decimales (ej: 1.5 para 1 min 30 seg)
    
    const videoType = document.getElementById('video_type_manual').value;
    const videoFormat = document.getElementById('video_format_manual').value;
    const videoOrientation = document.getElementById('video_orientation_manual').value;
    const generatePreviews = document.getElementById('generate_previews_manual').checked;
    
    if (!scriptContent.trim()) {
        alert('Por favor ingresa un gui√≥n');
        return;
    }
    
    // Obtener datos de audio
    const enableAudio = document.getElementById('enable_audio_manual').checked;
    const defaultVoiceId = document.getElementById('default_voice_id_manual').value;
    const defaultVoiceName = document.getElementById('default_voice_name_manual').value;
    
    // HeyGen defaults
    const defaultHeyGenAvatarId = document.getElementById('default_heygen_avatar_id_manual').value;
    const defaultHeyGenAvatarName = document.getElementById('default_heygen_avatar_name_manual').value;
    const defaultHeyGenVoiceId = document.getElementById('default_heygen_voice_id_manual').value;
    const defaultHeyGenVoiceName = document.getElementById('default_heygen_voice_name_manual').value;
    
    // Obtener preferencias de modelos (si est√°n configuradas)
    const modelPrefVeo = document.getElementById('model_pref_veo_manual').value;
    const modelPrefSora = document.getElementById('model_pref_sora_manual').value;
    const modelPrefHeyGen = document.getElementById('model_pref_heygen_manual').value;
    
    // Construir objeto de preferencias de modelos
    const modelPreferences = {};
    if (modelPrefVeo) modelPreferences.gemini_veo = modelPrefVeo;
    if (modelPrefSora) modelPreferences.sora = modelPrefSora;
    if (modelPrefHeyGen) modelPreferences.heygen = modelPrefHeyGen;
    
    // Guardar en sessionStorage con todos los datos
    sessionStorage.setItem('agentContent', JSON.stringify({
        type: 'script',
        content: scriptContent,
        duration: durationMinutesDecimal, // Duraci√≥n en minutos decimales (ej: 1.5 para 1 min 30 seg)
        duration_seconds: totalSeconds, // Duraci√≥n total en segundos
        duration_min: durationMin, // Minutos enteros
        duration_sec: durationSec, // Segundos
        video_type: videoType,
        video_format: videoFormat,
        video_orientation: videoOrientation,
        generate_previews: generatePreviews,
        enable_audio: enableAudio,
        default_voice_id: defaultVoiceId,
        default_voice_name: defaultVoiceName,
        default_heygen_avatar_id: defaultHeyGenAvatarId,
        default_heygen_avatar_name: defaultHeyGenAvatarName,
        default_heygen_voice_id: defaultHeyGenVoiceId,
        default_heygen_voice_name: defaultHeyGenVoiceName,
        model_preferences: modelPreferences
    }));
    
    // Redirigir a configure
    {% if project %}
        window.location.href = "{% url 'core:agent_configure' project.uuid %}";
    {% else %}
        window.location.href = "{% url 'core:agent_configure_standalone' %}";
    {% endif %}
});

// ==================
// VOICE SELECTOR FUNCTIONS
// ==================

let voicesCache = null;

async function openVoiceModalManual() {
    // Usar funci√≥n gen√©rica del modal de voces
    openVoiceSelector(function(voiceId, voiceName, voiceCategory) {
        // L√≥gica espec√≠fica del agente
        document.getElementById('default_voice_id_manual').value = voiceId;
        document.getElementById('default_voice_name_manual').value = voiceName;
        
        document.getElementById('selected-voice-name-manual').textContent = voiceName;
        document.getElementById('selected-voice-category-manual').textContent = voiceCategory;
    });
}

// Funci√≥n obsoleta - eliminada, usar openVoiceModalManual() directamente

// ==================== HEYGEN AVATAR SELECTOR ====================
let heygenAvatarsCache = null;

// Cargar cache desde sessionStorage al iniciar
function loadAvatarsCacheFromSession() {
    try {
        const cached = sessionStorage.getItem('heygen_avatars_cache');
        if (cached) {
            heygenAvatarsCache = JSON.parse(cached);
            console.log('Avatares cargados desde sessionStorage');
        }
    } catch (e) {
        console.warn('Error cargando cache de avatares:', e);
    }
}

// Guardar cache en sessionStorage
function saveAvatarsCacheToSession(avatars) {
    try {
        sessionStorage.setItem('heygen_avatars_cache', JSON.stringify(avatars));
        sessionStorage.setItem('heygen_avatars_cache_timestamp', Date.now().toString());
    } catch (e) {
        console.warn('Error guardando cache de avatares:', e);
    }
}

// Cargar cache al iniciar
loadAvatarsCacheFromSession();

// Funci√≥n para cargar avatares y voces autom√°ticamente en background
async function loadHeyGenAssetsLazy() {
    // Cargar avatares si no est√°n en cache
    if (!heygenAvatarsCache) {
        try {
            console.log('üîÑ Cargando avatares de HeyGen en background...');
            const response = await fetch('{% url "core:api_list_avatars" %}');
            const data = await response.json();
            heygenAvatarsCache = data.avatars || [];
            
            // Guardar en sessionStorage
            saveAvatarsCacheToSession(heygenAvatarsCache);
            console.log(`‚úÖ ${heygenAvatarsCache.length} avatares cargados y cacheados`);
        } catch (error) {
            console.warn('‚ö†Ô∏è Error cargando avatares en background:', error);
            // No mostrar error al usuario, solo log
        }
    } else {
        console.log(`‚úÖ ${heygenAvatarsCache.length} avatares ya en cache`);
    }
    
    // Cargar voces si no est√°n en cache
    if (!heygenVoicesCache) {
        try {
            console.log('üîÑ Cargando voces de HeyGen en background...');
            const response = await fetch('{% url "core:api_list_voices" %}');
            const data = await response.json();
            heygenVoicesCache = data.voices || [];
            
            // Guardar en sessionStorage
            saveVoicesCacheToSession(heygenVoicesCache);
            console.log(`‚úÖ ${heygenVoicesCache.length} voces cargadas y cacheadas`);
        } catch (error) {
            console.warn('‚ö†Ô∏è Error cargando voces en background:', error);
            // No mostrar error al usuario, solo log
        }
    } else {
        console.log(`‚úÖ ${heygenVoicesCache.length} voces ya en cache`);
    }
}

async function openAvatarModalManual() {
    // Si los avatares ya est√°n cargados, mostrar modal directamente
    if (heygenAvatarsCache && heygenAvatarsCache.length > 0) {
        createAvatarModal(false); // false = no mostrar loader
        return;
    }
    
    // Mostrar loader en el bot√≥n
    const btn = document.getElementById('select-avatar-btn-manual');
    const btnText = document.getElementById('avatar-btn-text');
    const btnLoader = document.getElementById('avatar-btn-loader');
    if (btn && btnText && btnLoader) {
        btn.disabled = true;
        btnText.classList.add('hidden');
        btnLoader.classList.remove('hidden');
    }
    
    // Mostrar modal con loader primero
    createAvatarModal(true); // true = mostrar loader
    
    // Cargar avatares si no est√°n en cache
    if (!heygenAvatarsCache) {
        try {
            const response = await fetch('{% url "core:api_list_avatars" %}');
            const data = await response.json();
            heygenAvatarsCache = data.avatars || [];
            
            // Guardar en sessionStorage
            saveAvatarsCacheToSession(heygenAvatarsCache);
        } catch (error) {
            console.error('Error cargando avatares:', error);
            // Ocultar loader del bot√≥n
            if (btn && btnText && btnLoader) {
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
            // Mostrar error en el modal
            const grid = document.getElementById('avatars-grid-manual');
            if (grid) {
                grid.innerHTML = '<div class="col-span-3 text-center py-12"><p class="text-red-500">Error al cargar avatares. Por favor, intenta de nuevo.</p></div>';
            }
            return;
        }
    }
    
    // Ocultar loader del bot√≥n
    if (btn && btnText && btnLoader) {
        btn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoader.classList.add('hidden');
    }
    
    // Actualizar modal con los avatares cargados
    updateAvatarModalContent();
}

function createAvatarModal(showLoader = false) {
    // Eliminar modal anterior si existe
    const existingModal = document.getElementById('avatar-modal-manual');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Crear modal
    const modal = document.createElement('div');
    modal.id = 'avatar-modal-manual';
    modal.className = 'fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4';
    
    const avatarsCount = heygenAvatarsCache ? heygenAvatarsCache.length : 0;
    const gridContent = showLoader ? renderAvatarLoader() : renderAvatarCards();
    
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-5 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-white">Cat√°logo de Avatares HeyGen</h2>
                    <p class="text-blue-100 text-sm mt-1">
                        ${showLoader ? 'Cargando avatares...' : `${avatarsCount} avatares disponibles`}
                    </p>
                </div>
                <button type="button" onclick="closeAvatarModalManual()" 
                        class="text-white hover:text-blue-100 text-3xl leading-none">
                    &times;
                </button>
            </div>
            
            <!-- Buscador y Filtros -->
            <div class="px-6 py-4 bg-gray-50 border-b" ${showLoader ? 'style="display: none;"' : ''}>
                <input type="text" id="avatar-search-manual" placeholder="üîç Buscar por nombre, g√©nero..." 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-3"
                       oninput="applyAvatarFiltersManual()">
                
                <!-- Filtros -->
                <div class="flex flex-wrap gap-2">
                    <span class="text-sm font-medium text-gray-700 self-center">Filtros:</span>
                    
                    <!-- G√©nero -->
                    <button type="button" onclick="toggleAvatarFilterManual('gender', 'all')" 
                            class="avatar-filter-btn px-3 py-1 rounded-full text-sm font-medium transition-colors bg-blue-600 text-white" 
                            data-filter="gender" data-value="all">
                        Todos
                    </button>
                    <button type="button" onclick="toggleAvatarFilterManual('gender', 'male')" 
                            class="avatar-filter-btn px-3 py-1 rounded-full text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300" 
                            data-filter="gender" data-value="male">
                        üë® Masculino
                    </button>
                    <button type="button" onclick="toggleAvatarFilterManual('gender', 'female')" 
                            class="avatar-filter-btn px-3 py-1 rounded-full text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300" 
                            data-filter="gender" data-value="female">
                        üë© Femenino
                    </button>
                </div>
            </div>
            
            <!-- Lista de Avatares -->
            <div class="overflow-y-auto p-6" style="max-height: calc(90vh - 200px);">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="avatars-grid-manual">
                    ${gridContent}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function renderAvatarLoader() {
    return `
        <div class="col-span-3 flex flex-col items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-gray-600 font-medium">Cargando avatares...</p>
            <p class="text-sm text-gray-500 mt-2">Por favor espera</p>
        </div>
    `;
}

function updateAvatarModalContent() {
    const grid = document.getElementById('avatars-grid-manual');
    const headerCount = document.querySelector('#avatar-modal-manual .text-blue-100');
    const searchContainer = document.querySelector('#avatar-modal-manual .bg-gray-50');
    
    if (grid) {
        grid.innerHTML = renderAvatarCards();
    }
    
    if (headerCount && heygenAvatarsCache) {
        headerCount.textContent = `${heygenAvatarsCache.length} avatares disponibles`;
    }
    
    if (searchContainer) {
        searchContainer.style.display = 'block';
    }
}

function renderAvatarCards() {
    if (!heygenAvatarsCache || heygenAvatarsCache.length === 0) {
        return '<div class="col-span-3 text-center py-12"><p class="text-gray-500">No hay avatares disponibles</p></div>';
    }
    
    return heygenAvatarsCache.map(avatar => {
        const gender = avatar.gender || 'unknown';
        const genderEmoji = gender === 'female' ? 'üë©' : gender === 'male' ? 'üë®' : 'üë§';
        const previewUrl = avatar.preview_image_url || avatar.preview_video_url || '';
        
        return `
            <div class="avatar-card border-2 border-gray-200 rounded-xl p-4 hover:border-blue-500 hover:shadow-lg transition-all cursor-pointer bg-white" 
                 data-avatar-id="${avatar.avatar_id}"
                 data-avatar-name="${avatar.avatar_name || avatar.avatar_id}"
                 data-avatar-gender="${gender}"
                 onclick="selectAvatarManual('${avatar.avatar_id}', '${avatar.avatar_name || avatar.avatar_id}', '${gender}')">
                
                ${previewUrl ? `
                    <div class="mb-3 rounded-lg overflow-hidden bg-gray-100" style="aspect-ratio: 16/9;">
                        ${previewUrl.includes('.mp4') || previewUrl.includes('.webm') ? `
                            <video src="${previewUrl}" class="w-full h-full object-cover" muted loop playsinline></video>
                        ` : `
                            <img src="${previewUrl}" alt="${avatar.avatar_name || avatar.avatar_id}" class="w-full h-full object-cover">
                        `}
                    </div>
                ` : `
                    <div class="mb-3 rounded-lg bg-gray-100 flex items-center justify-center" style="aspect-ratio: 16/9; min-height: 120px;">
                        <span class="text-4xl">${genderEmoji}</span>
                    </div>
                `}
                
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-900 text-base">${avatar.avatar_name || avatar.avatar_id}</h3>
                        <p class="text-xs text-gray-500 uppercase tracking-wide mt-1">${gender === 'female' ? 'Mujer' : gender === 'male' ? 'Hombre' : 'Indefinido'}</p>
                    </div>
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-lg">${genderEmoji}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function closeAvatarModalManual() {
    const modal = document.getElementById('avatar-modal-manual');
    if (modal) {
        modal.remove();
    }
}

function selectAvatarManual(avatarId, avatarName, avatarGender) {
    // Actualizar campos hidden
    document.getElementById('default_heygen_avatar_id_manual').value = avatarId;
    document.getElementById('default_heygen_avatar_name_manual').value = avatarName;
    
    // Actualizar UI
    document.getElementById('selected-avatar-name-manual').textContent = avatarName;
    document.getElementById('selected-avatar-gender-manual').textContent = avatarGender === 'female' ? 'Mujer' : avatarGender === 'male' ? 'Hombre' : 'Indefinido';
    
    // Guardar en sessionStorage
    try {
        sessionStorage.setItem('default_heygen_avatar_id', avatarId);
        sessionStorage.setItem('default_heygen_avatar_name', avatarName);
    } catch (e) {
        console.warn('Error guardando avatar en sessionStorage:', e);
    }
    
    // Cerrar modal
    closeAvatarModalManual();
    
    console.log('Avatar seleccionado:', avatarName, avatarId);
}

// Estado de filtros activos para avatares
let avatarFiltersManual = {
    gender: 'all',
    search: ''
};

function toggleAvatarFilterManual(filterType, value) {
    avatarFiltersManual[filterType] = value;
    
    // Actualizar UI de botones
    document.querySelectorAll(`.avatar-filter-btn[data-filter="${filterType}"]`).forEach(btn => {
        if (btn.dataset.value === value) {
            btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            btn.classList.add('bg-blue-600', 'text-white');
        } else {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
        }
    });
    
    applyAvatarFiltersManual();
}

function applyAvatarFiltersManual() {
    const searchTerm = document.getElementById('avatar-search-manual')?.value || '';
    avatarFiltersManual.search = searchTerm.toLowerCase();
    
    const cards = document.querySelectorAll('#avatars-grid-manual .avatar-card');
    let visibleCount = 0;
    
    cards.forEach(card => {
        const avatarName = card.dataset.avatarName.toLowerCase();
        const avatarGender = card.dataset.avatarGender || 'unknown';
        const text = card.textContent.toLowerCase();
        
        const matchesSearch = !avatarFiltersManual.search || 
            avatarName.includes(avatarFiltersManual.search) || 
            text.includes(avatarFiltersManual.search);
        
        const matchesGender = avatarFiltersManual.gender === 'all' || 
            avatarGender === avatarFiltersManual.gender.toLowerCase();
        
        if (matchesSearch && matchesGender) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Actualizar contador
    const countElement = document.querySelector('#avatar-modal-manual .text-blue-100');
    if (countElement) {
        countElement.textContent = `${visibleCount} avatares disponibles`;
    }
}

function filterAvatarsManual(searchTerm) {
    applyAvatarFiltersManual();
}

// ==================== HEYGEN VOICE SELECTOR ====================
let heygenVoicesCache = null;

// Cargar cache desde sessionStorage al iniciar
function loadVoicesCacheFromSession() {
    try {
        const cached = sessionStorage.getItem('heygen_voices_cache');
        if (cached) {
            heygenVoicesCache = JSON.parse(cached);
            console.log('Voces cargadas desde sessionStorage');
        }
    } catch (e) {
        console.warn('Error cargando cache de voces:', e);
    }
}

// Guardar cache en sessionStorage
function saveVoicesCacheToSession(voices) {
    try {
        sessionStorage.setItem('heygen_voices_cache', JSON.stringify(voices));
        sessionStorage.setItem('heygen_voices_cache_timestamp', Date.now().toString());
    } catch (e) {
        console.warn('Error guardando cache de voces:', e);
    }
}

// Cargar cache al iniciar
loadVoicesCacheFromSession();

async function openHeyGenVoiceModalManual() {
    // Si las voces ya est√°n cargadas, mostrar modal directamente
    if (heygenVoicesCache && heygenVoicesCache.length > 0) {
        createHeyGenVoiceModal(false); // false = no mostrar loader
        return;
    }
    
    // Mostrar loader en el bot√≥n
    const btn = document.getElementById('select-voice-btn-manual');
    const btnText = document.getElementById('voice-btn-text');
    const btnLoader = document.getElementById('voice-btn-loader');
    if (btn && btnText && btnLoader) {
        btn.disabled = true;
        btnText.classList.add('hidden');
        btnLoader.classList.remove('hidden');
    }
    
    // Mostrar modal con loader primero
    createHeyGenVoiceModal(true); // true = mostrar loader
    
    // Cargar voces si no est√°n en cache
    if (!heygenVoicesCache) {
        try {
            const response = await fetch('{% url "core:api_list_voices" %}');
            const data = await response.json();
            heygenVoicesCache = data.voices || [];
            
            // Guardar en sessionStorage
            saveVoicesCacheToSession(heygenVoicesCache);
        } catch (error) {
            console.error('Error cargando voces:', error);
            // Ocultar loader del bot√≥n
            if (btn && btnText && btnLoader) {
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
            // Mostrar error en el modal
            const grid = document.getElementById('heygen-voices-grid-manual');
            if (grid) {
                grid.innerHTML = '<div class="col-span-3 text-center py-12"><p class="text-red-500">Error al cargar voces. Por favor, intenta de nuevo.</p></div>';
            }
            return;
        }
    }
    
    // Ocultar loader del bot√≥n
    if (btn && btnText && btnLoader) {
        btn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoader.classList.add('hidden');
    }
    
    // Actualizar modal con las voces cargadas
    updateHeyGenVoiceModalContent();
}

function createHeyGenVoiceModal(showLoader = false) {
    // Eliminar modal anterior si existe
    const existingModal = document.getElementById('heygen-voice-modal-manual');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Crear modal
    const modal = document.createElement('div');
    modal.id = 'heygen-voice-modal-manual';
    modal.className = 'fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4';
    
    const voicesCount = heygenVoicesCache ? heygenVoicesCache.length : 0;
    const gridContent = showLoader ? renderVoiceLoader() : renderHeyGenVoiceCards();
    
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-5 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-white">Cat√°logo de Voces HeyGen</h2>
                    <p class="text-purple-100 text-sm mt-1">
                        ${showLoader ? 'Cargando voces...' : `${voicesCount} voces disponibles`}
                    </p>
                </div>
                <button type="button" onclick="closeHeyGenVoiceModalManual()" 
                        class="text-white hover:text-purple-100 text-3xl leading-none">
                    &times;
                </button>
            </div>
            
            <!-- Buscador y Filtros -->
            <div class="px-6 py-4 bg-gray-50 border-b" ${showLoader ? 'style="display: none;"' : ''}>
                <input type="text" id="heygen-voice-search-manual" placeholder="üîç Buscar por nombre, idioma, g√©nero..." 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 mb-3"
                       oninput="applyHeyGenVoiceFiltersManual()">
                
                <!-- Filtros -->
                <div class="flex flex-wrap gap-2">
                    <span class="text-sm font-medium text-gray-700 self-center">Filtros:</span>
                    
                    <!-- G√©nero -->
                    <button type="button" onclick="toggleHeyGenVoiceFilterManual('gender', 'all')" 
                            class="heygen-voice-filter-btn px-3 py-1 rounded-full text-sm font-medium transition-colors bg-purple-600 text-white" 
                            data-filter="gender" data-value="all">
                        Todos
                    </button>
                    <button type="button" onclick="toggleHeyGenVoiceFilterManual('gender', 'male')" 
                            class="heygen-voice-filter-btn px-3 py-1 rounded-full text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300" 
                            data-filter="gender" data-value="male">
                        üë® Masculino
                    </button>
                    <button type="button" onclick="toggleHeyGenVoiceFilterManual('gender', 'female')" 
                            class="heygen-voice-filter-btn px-3 py-1 rounded-full text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300" 
                            data-filter="gender" data-value="female">
                        üë© Femenino
                    </button>
                    
                    <!-- Idioma -->
                    <button type="button" onclick="toggleHeyGenVoiceFilterManual('language', 'all')" 
                            class="heygen-voice-filter-btn px-3 py-1 rounded-full text-sm font-medium transition-colors bg-purple-600 text-white" 
                            data-filter="language" data-value="all">
                        Todos
                    </button>
                    <button type="button" onclick="toggleHeyGenVoiceFilterManual('language', 'es')" 
                            class="heygen-voice-filter-btn px-3 py-1 rounded-full text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300" 
                            data-filter="language" data-value="es">
                        üá™üá∏ Espa√±ol
                    </button>
                    <button type="button" onclick="toggleHeyGenVoiceFilterManual('language', 'en')" 
                            class="heygen-voice-filter-btn px-3 py-1 rounded-full text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300" 
                            data-filter="language" data-value="en">
                        üá¨üáß Ingl√©s
                    </button>
                </div>
            </div>
            
            <!-- Lista de Voces -->
            <div class="overflow-y-auto p-6" style="max-height: calc(90vh - 200px);">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="heygen-voices-grid-manual">
                    ${gridContent}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function renderVoiceLoader() {
    return `
        <div class="col-span-3 flex flex-col items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"></div>
            <p class="text-gray-600 font-medium">Cargando voces...</p>
            <p class="text-sm text-gray-500 mt-2">Por favor espera</p>
        </div>
    `;
}

function updateHeyGenVoiceModalContent() {
    const grid = document.getElementById('heygen-voices-grid-manual');
    const headerCount = document.querySelector('#heygen-voice-modal-manual .text-purple-100');
    const searchContainer = document.querySelector('#heygen-voice-modal-manual .bg-gray-50');
    
    if (grid) {
        grid.innerHTML = renderHeyGenVoiceCards();
    }
    
    if (headerCount && heygenVoicesCache) {
        headerCount.textContent = `${heygenVoicesCache.length} voces disponibles`;
    }
    
    if (searchContainer) {
        searchContainer.style.display = 'block';
    }
}

function renderHeyGenVoiceCards() {
    if (!heygenVoicesCache || heygenVoicesCache.length === 0) {
        return '<div class="col-span-3 text-center py-12"><p class="text-gray-500">No hay voces disponibles</p></div>';
    }
    
    return heygenVoicesCache.map(voice => {
        // Arreglar nombres undefined - usar name o voice_name o un fallback
        const voiceName = voice.name || voice.voice_name || `Voz ${voice.voice_id?.substring(0, 8) || 'Desconocida'}`;
        const language = voice.language || 'Desconocido';
        const gender = voice.gender || 'unknown';
        const genderEmoji = gender === 'female' ? 'üë©' : gender === 'male' ? 'üë®' : 'üë§';
        const previewAudio = voice.preview_audio || voice.preview_url || null;
        
        return `
            <div class="voice-card border-2 border-gray-200 rounded-xl p-5 hover:border-purple-500 hover:shadow-lg transition-all cursor-pointer bg-white" 
                 data-voice-id="${voice.voice_id}"
                 data-voice-name="${voiceName}"
                 data-voice-language="${language}"
                 data-voice-gender="${gender}"
                 onclick="selectHeyGenVoiceManual('${voice.voice_id}', '${voiceName}', '${language}')">
                
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-900 text-lg">${voiceName}</h3>
                        <p class="text-xs text-gray-500 uppercase tracking-wide mt-1">${language} ‚Ä¢ ${gender === 'female' ? 'Mujer' : gender === 'male' ? 'Hombre' : 'Indefinido'}</p>
                    </div>
                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-xl">${genderEmoji}</span>
                    </div>
                </div>
                
                ${previewAudio ? `
                    <div class="mt-3" onclick="event.stopPropagation();">
                        <audio controls preload="none" class="w-full h-8">
                            <source src="${previewAudio}" type="audio/mpeg">
                        </audio>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function closeHeyGenVoiceModalManual() {
    const modal = document.getElementById('heygen-voice-modal-manual');
    if (modal) {
        modal.remove();
    }
}

function selectHeyGenVoiceManual(voiceId, voiceName, voiceLanguage) {
    // Actualizar campos hidden
    document.getElementById('default_heygen_voice_id_manual').value = voiceId;
    document.getElementById('default_heygen_voice_name_manual').value = voiceName;
    
    // Actualizar UI
    document.getElementById('selected-heygen-voice-name-manual').textContent = voiceName;
    document.getElementById('selected-heygen-voice-language-manual').textContent = voiceLanguage;
    
    // Guardar en sessionStorage
    try {
        sessionStorage.setItem('default_heygen_voice_id', voiceId);
        sessionStorage.setItem('default_heygen_voice_name', voiceName);
    } catch (e) {
        console.warn('Error guardando voz en sessionStorage:', e);
    }
    
    // Cerrar modal
    closeHeyGenVoiceModalManual();
    
    console.log('Voz HeyGen seleccionada:', voiceName, voiceId);
}

// Estado de filtros activos para voces HeyGen
let heygenVoiceFiltersManual = {
    gender: 'all',
    language: 'all',
    search: ''
};

function toggleHeyGenVoiceFilterManual(filterType, value) {
    heygenVoiceFiltersManual[filterType] = value;
    
    // Actualizar UI de botones
    document.querySelectorAll(`.heygen-voice-filter-btn[data-filter="${filterType}"]`).forEach(btn => {
        if (btn.dataset.value === value) {
            btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            btn.classList.add('bg-purple-600', 'text-white');
        } else {
            btn.classList.remove('bg-purple-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
        }
    });
    
    applyHeyGenVoiceFiltersManual();
}

function applyHeyGenVoiceFiltersManual() {
    const searchTerm = document.getElementById('heygen-voice-search-manual')?.value || '';
    heygenVoiceFiltersManual.search = searchTerm.toLowerCase();
    
    const cards = document.querySelectorAll('#heygen-voices-grid-manual .voice-card');
    let visibleCount = 0;
    
    cards.forEach(card => {
        const voiceName = card.dataset.voiceName.toLowerCase();
        const voiceLanguage = card.dataset.voiceLanguage || 'unknown';
        const voiceGender = card.dataset.voiceGender || 'unknown';
        const text = card.textContent.toLowerCase();
        
        const matchesSearch = !heygenVoiceFiltersManual.search || 
            voiceName.includes(heygenVoiceFiltersManual.search) || 
            text.includes(heygenVoiceFiltersManual.search);
        
        const matchesGender = heygenVoiceFiltersManual.gender === 'all' || 
            voiceGender === heygenVoiceFiltersManual.gender.toLowerCase();
        
        const matchesLanguage = heygenVoiceFiltersManual.language === 'all' || 
            voiceLanguage.toLowerCase().includes(heygenVoiceFiltersManual.language.toLowerCase());
        
        if (matchesSearch && matchesGender && matchesLanguage) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Actualizar contador
    const countElement = document.querySelector('#heygen-voice-modal-manual .text-purple-100');
    if (countElement) {
        countElement.textContent = `${visibleCount} voces disponibles`;
    }
}

function filterHeyGenVoicesManual(searchTerm) {
    applyHeyGenVoiceFiltersManual();
}

function toggleAdvancedPreferences() {
    const content = document.getElementById('advanced-preferences-content');
    const arrow = document.getElementById('advanced-preferences-arrow');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        arrow.classList.add('rotate-180');
    } else {
        content.classList.add('hidden');
        arrow.classList.remove('rotate-180');
    }
}

// ==================
// ESTIMATED DURATION CALCULATION
// ==================

/**
 * Calcula la duraci√≥n estimada del video basada en el n√∫mero de palabras del script
 * F√≥rmula: palabras / palabras_por_segundo / 60 = minutos
 * Velocidad promedio de lectura/narraci√≥n: ~2.5 palabras por segundo
 */
function calculateEstimatedDuration() {
    const scriptTextarea = document.getElementById('script_content_manual');
    const estimatedDurationDiv = document.getElementById('estimated_duration_manual');
    const estimatedDurationValue = document.getElementById('estimated_duration_value_manual');
    
    if (!scriptTextarea || !estimatedDurationDiv || !estimatedDurationValue) {
        return;
    }
    
    const scriptText = scriptTextarea.value.trim();
    
    if (!scriptText) {
        estimatedDurationDiv.classList.add('hidden');
        return;
    }
    
    // Contar palabras (separadas por espacios, saltos de l√≠nea, etc.)
    const words = scriptText.split(/\s+/).filter(word => word.length > 0);
    const wordCount = words.length;
    
    if (wordCount === 0) {
        estimatedDurationDiv.classList.add('hidden');
        return;
    }
    
    // Calcular duraci√≥n estimada
    // Velocidad promedio de narraci√≥n: 2.5 palabras por segundo
    const WORDS_PER_SECOND = 2.5;
    const estimatedTotalSeconds = wordCount / WORDS_PER_SECOND;
    const estimatedMinutes = Math.floor(estimatedTotalSeconds / 60);
    const estimatedSeconds = Math.floor(estimatedTotalSeconds % 60);
    
    // Formatear como "X min Y seg"
    let durationText = '';
    if (estimatedMinutes > 0) {
        durationText = `${estimatedMinutes} min`;
        if (estimatedSeconds > 0) {
            durationText += ` ${estimatedSeconds} seg`;
        }
    } else {
        durationText = `${estimatedSeconds} seg`;
    }
    
    estimatedDurationValue.textContent = durationText;
    estimatedDurationDiv.classList.remove('hidden');
}

// Calcular duraci√≥n estimada cuando se carga la p√°gina (por si hay contenido inicial)
document.addEventListener('DOMContentLoaded', function() {
    calculateEstimatedDuration();
});
</script>
{% endblock %}

