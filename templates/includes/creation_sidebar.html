{% load static %}

<!-- Definir el componente Alpine de forma global -->
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('creationSidebar', () => ({
        activeTab: '{{ active_tab|default:"video" }}',
        selectedModel: null,
        selectedModelData: null,
        models: {},
        allModels: {},
        loading: false,
        submitting: false,
        prompt: '',
        projectId: {% if project %}{{ project.id }}{% else %}null{% endif %},
        
        init() {
            this.loadModels(this.activeTab);
        },
        
        async loadModels(type) {
            this.loading = true;
            try {
                const response = await fetch('/api/models/config/?type=' + type + '&grouped=true');
                const data = await response.json();
                if (data.models) {
                    this.models = data.models;
                    const allResponse = await fetch('/api/models/config/?type=' + type);
                    const allData = await allResponse.json();
                    if (allData.models) {
                        this.allModels = {};
                        allData.models.forEach(model => {
                            this.allModels[model.id] = model;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading models:', error);
                this.models = {};
                this.allModels = {};
            } finally {
                this.loading = false;
            }
        },
        
        onModelChange() {
            if (this.selectedModel && this.allModels[this.selectedModel]) {
                this.selectedModelData = this.allModels[this.selectedModel];
            } else {
                this.selectedModelData = null;
            }
        },
        
        switchTab(tab) {
            // Navegar a la URL correspondiente
            const projectId = this.projectId;
            let url = '';
            if (projectId) {
                url = '/projects/' + projectId + '/' + tab + 's/';
            } else {
                url = '/' + tab + 's/';
            }
            window.location.href = url;
        },
        
        async submitForm() {
            if (!this.selectedModel || !this.prompt) {
                alert('Por favor selecciona un modelo y escribe un prompt');
                return;
            }
            
            this.submitting = true;
            
            try {
                const formData = {
                    type: this.activeTab,
                    model_id: this.selectedModel,
                    title: 'New ' + this.activeTab,
                    prompt: this.prompt,
                    script: this.prompt,
                    text: this.prompt,
                    project_id: this.projectId,
                    settings: {}
                };
                
                const token = document.querySelector('[name=csrfmiddlewaretoken]');
                const response = await fetch('/api/items/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': token ? token.value : ''
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.dispatchEvent(new CustomEvent('item-created', { detail: data.item }));
                    window.dispatchEvent(new CustomEvent('library-tab-changed', { detail: { tab: this.activeTab } }));
                    this.prompt = '';
                    this.selectedModel = null;
                    this.selectedModelData = null;
                    alert('¡Creado exitosamente!');
                } else {
                    alert('Error: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al crear. Por favor intenta de nuevo.');
            } finally {
                this.submitting = false;
            }
        }
    }));
});
</script>

<div x-data="creationSidebar()">
    
    <!-- Tabs: Image / Video / Audio -->
    <div class="border-b border-gray-200 bg-white sticky top-0 z-10 pt-2 pb-3 px-3">
        <div class="flex items-center justify-center">
            <div class="inline-flex rounded-lg border border-gray-200 p-1 bg-gray-50">
                <button @click="switchTab('image')"
                        :class="activeTab === 'image' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'"
                        class="px-5 py-1.5 text-sm font-medium rounded-md transition-all">
                    Image
                </button>
                <button @click="switchTab('video')"
                        :class="activeTab === 'video' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'"
                        class="px-5 py-1.5 text-sm font-medium rounded-md transition-all">
                    Video
                </button>
                <button @click="switchTab('audio')"
                        :class="activeTab === 'audio' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'"
                        class="px-5 py-1.5 text-sm font-medium rounded-md transition-all">
                    Audio
                </button>
            </div>
        </div>
    </div>
    
    <!-- Contenido del Sidebar -->
    <div class="p-6 space-y-6">
        
        <!-- Sección MODEL -->
        <div>
            <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">MODEL</label>
            
            <!-- Dropdown personalizado -->
            <div x-data="{ dropdownOpen: false, searchQuery: '' }" class="relative">
                <!-- Botón de selección -->
                <button type="button"
                        @click="dropdownOpen = !dropdownOpen"
                        class="w-full px-3 py-2.5 border border-gray-300 rounded-lg bg-white text-sm text-left flex items-center justify-between hover:bg-gray-50 transition-colors">
                    <span class="truncate" x-text="selectedModel && allModels[selectedModel] ? allModels[selectedModel].name : 'Seleccionar modelo...'"></span>
                    <svg class="w-4 h-4 text-gray-400 flex-shrink-0 ml-2" 
                         :class="dropdownOpen ? 'transform rotate-180' : ''"
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                
                <!-- Dropdown -->
                <div x-show="dropdownOpen"
                     @click.away="dropdownOpen = false"
                     x-cloak
                     class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-[350px] overflow-hidden flex flex-col">
                    <!-- Búsqueda -->
                    <div class="p-3 border-b border-gray-200 bg-white">
                        <input type="text"
                               x-model="searchQuery"
                               @click.stop
                               placeholder="Buscar modelo..."
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    
                    <!-- Lista de modelos -->
                    <div class="overflow-y-auto max-h-[280px]">
                        <div x-show="loading" class="p-4 text-center text-sm text-gray-500">
                            Cargando modelos...
                        </div>
                        
                        <template x-for="[serviceName, serviceModels] in Object.entries(models)" :key="serviceName">
                            <div>
                                <!-- Service Header -->
                                <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
                                    <span class="text-xs font-semibold text-gray-700 uppercase" x-text="serviceName"></span>
                                </div>
                                
                                <!-- Models -->
                                <template x-for="model in serviceModels.filter(m => !searchQuery || m.name.toLowerCase().includes(searchQuery.toLowerCase()))" :key="model.id">
                                    <button @click="selectedModel = model.id; onModelChange(); dropdownOpen = false; searchQuery = '';"
                                            :class="selectedModel === model.id ? 'bg-gray-100' : 'hover:bg-gray-50'"
                                            class="w-full text-left px-4 py-2.5 flex items-center gap-3 transition-colors border-b border-gray-100">
                                        <!-- Logo del servicio -->
                                        <img x-show="model.logo" 
                                             :src="model.logo" 
                                             :alt="serviceName"
                                             class="w-6 h-6 rounded object-contain flex-shrink-0"
                                             onerror="this.style.display='none'">
                                        <div x-show="!model.logo" class="w-6 h-6 rounded bg-gray-200 flex items-center justify-center flex-shrink-0">
                                            <span class="text-xs font-bold text-gray-500" x-text="serviceName.charAt(0).toUpperCase()"></span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-medium text-sm text-gray-900" x-text="model.name"></div>
                                            <div class="text-xs text-gray-500 truncate" x-text="model.description || ''"></div>
                                        </div>
                                        <svg x-show="selectedModel === model.id" class="w-5 h-5 text-black flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </template>
                            </div>
                        </template>
                        
                        <div x-show="!loading && Object.keys(models).length === 0" class="p-4 text-center text-sm text-gray-500">
                            No hay modelos disponibles
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sección PROMPT -->
        <div>
            <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">PROMPT</label>
            <textarea x-model="prompt"
                      :placeholder="'Describe tu ' + activeTab + '...'"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent resize-none"
                      rows="6"></textarea>
        </div>
        
        <!-- Sección SETTINGS (simplificada) -->
        <div x-show="selectedModelData">
            <label class="block text-xs font-semibold text-gray-700 uppercase mb-2">SETTINGS</label>
            <div class="space-y-3">
                <!-- Aspect Ratio -->
                <div x-show="selectedModelData && selectedModelData.supports && selectedModelData.supports.aspect_ratio && selectedModelData.supports.aspect_ratio.length > 0">
                    <label class="block text-xs text-gray-600 mb-1">Aspect Ratio</label>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="ratio in (selectedModelData && selectedModelData.supports && selectedModelData.supports.aspect_ratio) || []" :key="ratio">
                            <button class="px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-100 text-gray-700 hover:bg-gray-200"
                                    x-text="ratio"></button>
                        </template>
                    </div>
                </div>
                
                <!-- Duration -->
                <div x-show="selectedModelData && selectedModelData.supports && selectedModelData.supports.duration">
                    <label class="block text-xs text-gray-600 mb-1">Duration</label>
                    <select x-show="selectedModelData && selectedModelData.supports && selectedModelData.supports.duration && selectedModelData.supports.duration.options" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <template x-for="dur in (selectedModelData && selectedModelData.supports && selectedModelData.supports.duration && selectedModelData.supports.duration.options) || []" :key="dur">
                            <option :value="dur" x-text="dur + 's'"></option>
                        </template>
                    </select>
                    <div x-show="selectedModelData && selectedModelData.supports && selectedModelData.supports.duration && selectedModelData.supports.duration.fixed"
                         class="px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm text-gray-600">
                        <span x-text="(selectedModelData && selectedModelData.supports && selectedModelData.supports.duration) ? selectedModelData.supports.duration.fixed + 's' : ''"></span>
                        <span class="text-xs text-gray-400 ml-2">(fijo)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div x-show="!selectedModelData" class="text-center py-4 text-gray-400 text-xs">
            <p>Selecciona un modelo para ver opciones</p>
        </div>
        
        <!-- Botón Generate -->
        <div class="pt-4 border-t border-gray-200">
            <button @click="submitForm()"
                    :disabled="!selectedModel || !prompt || submitting"
                    :class="(!selectedModel || !prompt || submitting) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-800'"
                    class="w-full bg-black text-white py-3 px-4 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                <span x-show="!submitting">Generate</span>
                <span x-show="submitting">Generando...</span>
                <svg x-show="!submitting" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
            </button>
        </div>
        
    </div>
</div>
